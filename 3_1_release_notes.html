<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8">
<meta content="Ruby on Rails, Ruby, Rails, Rails 3, Rails 4, Rails 5, Rails 6, Rails 6.0, Rails 6.1, Rails 7.0, Rails 7.1 руководство, начинающим, самоучитель, manual, мануал, справочник, учебник, примеры, Руби, рельсы" name="keywords"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" name="description"/>
<meta content="website" property="og:type"/>
<meta content="Rusrails: Заметки о релизе Ruby on Rails 3.1" property="og:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="og:description"/>
<meta content="http://localhost:3000/3_1_release_notes" property="og:url"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="og:image"/>
    <title>
      Rusrails: Заметки о релизе Ruby on Rails 3.1
    </title>
    <link rel="stylesheet" href="/assets/application-f9dfa6ce7fa871006d478e422639671663284ddaa3126cf81ddfe371ac3533c4.css" />
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="/"></a>
          <ul class="nav pull-right top-menu">
            <li>
              <a href="/">Главная</a>
            </li>
            <li class="dropdown">
              <a class="index-popover" href="#">
                Содержание
                <b class="caret"></b>
</a>              <div class="index-popover-content hide">
                  <ul><li><p><strong>С чего начать?</strong></p><ul><li><a href="/getting-started">Rails для начинающих</a>
</li></ul></li><li><p><strong>Модели</strong></p><ul><li><a href="/active-record-basics">Основы Active Record</a>
</li><li><a href="/active-record-migrations">Миграции Active Record</a>
</li><li><a href="/active-record-validations">Валидации Active Record</a>
</li><li><a href="/active-record-callbacks">Колбэки Active Record</a>
</li><li><a href="/active-record-associations">Связи (ассоциации) Active Record</a>
</li><li><a href="/active-record-querying">Интерфейс запросов Active Record</a>
</li><li><a href="/active-model-basics">Основы Active Model</a>
</li></ul></li><li><p><strong>Вью</strong></p><ul><li><a href="/action-view-overview">Обзор Action View</a>
</li><li><a href="/layouts-and-rendering">Макеты и рендеринг в Rails</a>
</li><li><a href="/action-view-helpers">Хелперы Action View</a>
</li><li><a href="/form-helpers">Хелперы форм в Action View</a>
</li></ul></li><li><p><strong>Контроллеры</strong></p><ul><li><a href="/action-controller-overview">Обзор Action Controller</a>
</li><li><a href="/routing">Роутинг в Rails</a>
</li></ul></li><li><p><strong>Другие компоненты</strong></p><ul><li><a href="/active-support-core-extensions">Расширения ядра Active Support</a>
</li><li><a href="/action-mailer-basics">Основы Action Mailer</a>
</li><li><a href="/action-mailbox-basics">Основы Action Mailbox</a>
</li><li><a href="/action-text-overview">Обзор Action Text</a>
</li><li><a href="/active_job_basics">Основы Active Job</a>
</li><li><a href="/active_storage_overview">Обзор Active Storage</a>
</li><li><a href="/action-cable-overview">Обзор Action Cable</a>
</li></ul></li><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/i18n">API интернационализации Rails (I18n)</a>
</li><li><a href="/testing">Тестирование приложений на Rails</a>
</li><li><a href="/security">Безопасность приложений на Rails</a>
</li><li><a href="/error-reporting">Отчет об ошибках в приложениях Rails</a>
</li><li><a href="/debugging-rails-applications">Отладка приложений на Rails</a>
</li></ul></li></ul><p>next_column</p><ul><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/configuring">Конфигурирование приложений на Rails</a>
</li><li><a href="/command-line">Командная строка Rails</a>
</li><li><a href="/asset-pipeline">Asset Pipeline</a>
</li><li><a href="/working-with-javascript-in-rails">Работа с JavaScript в Rails</a>
</li><li><a href="/initialization">Процесс инициализации в Rails</a>
</li><li><a href="/autoloading-and-reloading-constants">Автозагрузка и перезагрузка констант</a>
</li><li><a href="/caching-with-rails">Кэширование с Rails: Обзор</a>
</li><li><a href="/active-support-instrumentation">Инструментарий Active Support</a>
</li><li><a href="/api-app">Использование Rails для API-приложений</a>
</li><li><a href="/active-record-postgresql">Active Record для PostgreSQL</a>
</li><li><a href="/active-record-multiple-databases">Несколько баз данных с Active Record</a>
</li><li><a href="/active-record-encryption">Шифрование Active Record</a>
</li></ul></li><li><p><strong>Расширяем Rails</strong></p><ul><li><a href="/plugins">Основы создания плагинов Rails</a>
</li><li><a href="/rails-on-rack">Rails on Rack</a>
</li><li><a href="/generators">Создание и настройка генераторов и шаблонов Rails</a>
</li><li><a href="/engines">Engine для начинающих</a>
</li><li><a href="/threading_and_code_execution">Треды и выполнение кода в Rails</a>
</li><li><a href="/rails-application-templates">Шаблоны приложения Rails</a>
</li></ul></li><li><p><strong>Вносим вклад в Ruby on Rails</strong></p><ul><li><a href="/contributing_to_ruby_on_rails">Вносим вклад в Ruby on Rails</a>
</li><li><a href="/api_documentation_guidelines">Рекомендации по документированию API</a>
</li><li><a href="/ruby_on_rails_guides_guidelines">Рекомендации для руководств по Ruby on Rails</a>
</li><li><a href="/development_dependencies_install">Установка зависимостей для разработки</a>
</li><li><a href="/maintenance-policy">Политика поддержки (версий)</a>
</li></ul></li><li><p><strong>Заметки о релизах</strong></p><ul><li><a href="/upgrading-ruby-on-rails">Апгрейд Ruby on Rails</a>
</li><li><a href="/7_2_release_notes">Версия 7.2 - ?</a>
</li><li><a href="/7_1_release_notes">Версия 7.1 - Октябрь 2023</a>
</li><li><a href="/7_0_release_notes">Версия 7.0 - Декабрь 2021</a>
</li><li><a href="/6_1_release_notes">Версия 6.1 - Декабрь 2020</a>
</li><li><a href="/6_0_release_notes">Версия 6.0 - Август 2019</a>
</li></ul></li></ul>
              </div>
            </li>
            <li>
              <a href="/search">Поиск</a>
            </li>
            <li>
              <a target="blank" href="http://api.rusrails.ru">Ruby &amp; Rails API</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="content-wrapper">
      <div class="container-fluid">
        <div class="row-fluid">
          <div class="span3 pull-right">
            <div class="well social">
              <h4>Принимаем пожелания и пул-реквесты!</h4>
              <iframe allowtransparency="true" frameborder="0" height="30" src="http://ghbtns.com/github-btn.html?user=rusrails&repo=rusrails&type=watch&count=true&size=large" width="180"></iframe>
            </div>
              <div class="well menu">
                    <ul class="nav nav-list">
      <li>
        <h4>
          <a href="#upgrading-to-rails-3-1">1. Апгрейд до Rails 3.1</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#rails-3-1-trebuet-kak-minimum-ruby-1-8-7">1.1. Rails 3.1 требует как минимум Ruby 1.8.7</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#chto-obnovit-v-prilozhenii">1.2. Что обновить в приложении</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#gemfile">1.2.1. Gemfile</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#config-application-rb">1.2.2. config/application.rb</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#config-environments-development-rb">1.2.3. config/environments/development.rb</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#config-environments-production-rb">1.2.4. config/environments/production.rb</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#config-environments-test-rb">1.2.5. config/environments/test.rb</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#config-initializers-wrap_parameters-rb">1.2.6. config/initializers/wrap_parameters.rb</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#uberite-optsii-cache-i-concat-v-helperah-assetov-vo-vyu">1.2.7. Уберите опции :cache и :concat в хелперах ассетов во вью</a>
</h6>      </li>
      <li>
        <h4>
          <a href="#sozdanie-prilozheniya-rails-3-1">2. Создание приложения Rails 3.1</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#storonnie-gemy">2.1. Сторонние гемы</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#zhivite-na-grani">2.2. Живите на грани</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#arhitekturnye-izmeneniya-rails">3. Архитектурные изменения Rails</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#konveyer-resursov-assets-pipeline">3.1. Конвейер ресурсов (Assets Pipeline)</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#http-streaming">3.2. HTTP Streaming</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#biblioteka-js-po-umolchaniyu-teper-jquery">3.3. Библиотека JS по умолчанию теперь jQuery</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#identity-map">3.4. Identity Map</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#railties">4. Railties</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#action-pack">5. Action Pack</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#action-controller">5.1. Action Controller</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#action-dispatch">5.2. Action Dispatch</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#action-view">5.3. Action View</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#active-record">6. Active Record</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#active-model">7. Active Model</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#active-resource">8. Active Resource</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#active-support">9. Active Support</a>
</h4>      </li>
</ul>

              </div>
            <div class="well banner300 banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<!-- sidebar rusrails -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:600px"
     data-ad-client="ca-pub-7764391801669990"
     data-ad-slot="6089520660"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
          <div class="span9 content pull-left">
            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <!-- top rusrails -->
  <ins class="adsbygoogle"
       style="display:inline-block;width:980px;height:120px"
       data-ad-client="ca-pub-7764391801669990"
       data-ad-slot="4891989065"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
              <h2 id='zametki-o-relize-ruby-on-rails-3-1' class='inside_page_header'> Заметки о релизе Ruby on Rails 3.1</h2><p>Ключевые новинки в Rails 3.1:</p><ul><li>Streaming
</li><li>Обратимые миграции
</li><li>Конвейер ресурсов (Assets Pipeline)
</li><li>jQuery как библиотека JavaScript по умолчанию
</li></ul><p>Эти заметки о релизе покрывают только основные изменения. Чтобы узнать о различных исправлениях программных ошибок и изменениях, обратитесь к логам изменений или к <a href="https://github.com/rails/rails/commits/3-1-stable">списку коммитов</a> в главном репозитории Rails на GitHub.</p>
<hr>
<h3 id='upgrading-to-rails-3-1' class='inside_page_header'><a href="#upgrading-to-rails-3-1">1.</a> Апгрейд до Rails 3.1</h3><p>Прежде чем апгрейднуть существующее приложение, было бы хорошо иметь перед этим покрытие тестами. Также, до попытки обновиться до Rails 3.1, необходимо сначала произвести апгрейд до Rails 3 и убедиться, что приложение все еще выполняется так, как нужно. Затем обратите внимание на следующие изменения:</p><h4 id='rails-3-1-trebuet-kak-minimum-ruby-1-8-7' class='inside_page_header'><a href="#rails-3-1-trebuet-kak-minimum-ruby-1-8-7">1.1.</a> Rails 3.1 требует как минимум Ruby 1.8.7</h4><p>Rails 3.1 требует Ruby 1.8.7 или выше. Поддержка всех прежних версий Ruby была официально прекращена, и следует произвести апгрейд как можно раньше. Rails 3.1 также совместим с Ruby 1.9.2.</p><div class="info"><p>Отметьте, что в Ruby 1.8.7 p248 и p249 имеются программные ошибки маршаллинга, ломающие Rails. Хотя в Ruby Enterprise Edition это было исправлено, начиная с релиза 1.8.7-2010.02. В ветке 1.9, Ruby 1.9.1 не пригоден к использованию, поскольку он иногда вылетает, поэтому, если хотите использовать 1.9.x перепрыгивайте на 1.9.2 для гладкой работы.</p></div><h4 id='chto-obnovit-v-prilozhenii' class='inside_page_header'><a href="#chto-obnovit-v-prilozhenii">1.2.</a> Что обновить в приложении</h4><p>Следующие изменения предназначены для апгрейда приложения до Rails 3.1.3, последней версии 3.1.x Rails.</p><h5 id='gemfile' class='inside_page_header'><a href="#gemfile">1.2.1.</a> Gemfile</h5><p>Сделайте изменения в вашем <code>Gemfile</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">gem</span> <span class="s2">"rails"</span><span class="p">,</span> <span class="s2">"= 3.1.3"</span>
<span class="n">gem</span> <span class="s2">"mysql2"</span>

<span class="c1"># Необходимо для нового asset pipeline</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s2">"sass-rails"</span><span class="p">,</span>   <span class="s2">"~&gt; 3.1.5"</span>
  <span class="n">gem</span> <span class="s2">"coffee-rails"</span><span class="p">,</span> <span class="s2">"~&gt; 3.1.1"</span>
  <span class="n">gem</span> <span class="s2">"uglifier"</span><span class="p">,</span>     <span class="s2">"&gt;= 1.0.3"</span>
<span class="k">end</span>

<span class="c1"># jQuery это библиотека JavaScript по умолчанию в Rails 3.1</span>
<span class="n">gem</span> <span class="s2">"jquery-rails"</span>
</code></pre>
</div>
<h5 id='config-application-rb' class='inside_page_header'><a href="#config-application-rb">1.2.2.</a> config/application.rb</h5><ul><li><p>Конвейер ресурсов требует следующие добавления:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">version</span> <span class="o">=</span> <span class="s1">'1.0'</span>
</code></pre>
</div>
</li><li><p>Если ваше приложение использует маршрут &quot;/assets&quot;, можно изменить префикс, используемый для ассетов, чтобы избежать конфликтов:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Defaults to '/assets'</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">prefix</span> <span class="o">=</span> <span class="s1">'/asset-files'</span>
</code></pre>
</div>
</li></ul><h5 id='config-environments-development-rb' class='inside_page_header'><a href="#config-environments-development-rb">1.2.3.</a> config/environments/development.rb</h5><ul><li><p>Уберите настройку RJS <code>config.action_view.debug_rjs = true</code>.</p></li><li><p>Добавьте следующее, если хотите включить конвейер ресурсов.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Do not compress assets</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compress</span> <span class="o">=</span> <span class="kp">false</span>

<span class="c1"># Expands the lines which load the assets</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">debug</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
</div>
</li></ul><h5 id='config-environments-production-rb' class='inside_page_header'><a href="#config-environments-production-rb">1.2.4.</a> config/environments/production.rb</h5><ul><li><p>Снова, большинство изменений относится к конвейеру ресурсов. Подробнее о них можно прочитать в руководстве <a href="/asset-pipeline">Asset Pipeline</a>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Compress JavaScripts and CSS</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compress</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># Don't fallback to assets pipeline if a precompiled asset is missed</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compile</span> <span class="o">=</span> <span class="kp">false</span>

<span class="c1"># Generate digests for assets URLs</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">digest</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># Defaults to Rails.root.join("public/assets")</span>
<span class="c1"># config.assets.manifest = YOUR_PATH</span>

<span class="c1"># Precompile additional assets (application.js, application.css, and all non-JS/CSS are already added)</span>
<span class="c1"># config.assets.precompile `= %w( admin.js admin.css )</span>

<span class="c1"># Force all access to the app over SSL, use Strict-Transport-Security, and use secure cookies.</span>
<span class="c1"># config.force_ssl = true</span>
</code></pre>
</div>
</li></ul><h5 id='config-environments-test-rb' class='inside_page_header'><a href="#config-environments-test-rb">1.2.5.</a> config/environments/test.rb</h5><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Configure static asset server for tests with Cache-Control for performance</span>
<span class="n">config</span><span class="p">.</span><span class="nf">serve_static_assets</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">config</span><span class="p">.</span><span class="nf">static_cache_control</span> <span class="o">=</span> <span class="s2">"public, max-age=3600"</span>
</code></pre>
</div>
<h5 id='config-initializers-wrap_parameters-rb' class='inside_page_header'><a href="#config-initializers-wrap_parameters-rb">1.2.6.</a> config/initializers/wrap_parameters.rb</h5><ul><li><p>Добавьте этот файл со следующим содержимым, если хотите оборачивать параметры во вложенный хэш. По умолчанию это включено в новых приложениях.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Be sure to restart your server when you modify this file.</span>
<span class="c1"># This file contains settings for ActionController::ParamsWrapper which</span>
<span class="c1"># is enabled by default.</span>

<span class="c1"># Enable parameter wrapping for JSON. You can disable this by setting :format to an empty array.</span>
<span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">on_load</span><span class="p">(</span><span class="ss">:action_controller</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">wrap_parameters</span> <span class="ss">:format</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:json</span><span class="p">]</span>
<span class="k">end</span>

<span class="c1"># Disable root element in JSON by default.</span>
<span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">on_load</span><span class="p">(</span><span class="ss">:active_record</span><span class="p">)</span> <span class="k">do</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">include_root_in_json</span> <span class="o">=</span> <span class="kp">false</span>
<span class="k">end</span>
</code></pre>
</div>
</li></ul><h5 id='uberite-optsii-cache-i-concat-v-helperah-assetov-vo-vyu' class='inside_page_header'><a href="#uberite-optsii-cache-i-concat-v-helperah-assetov-vo-vyu">1.2.7.</a> Уберите опции :cache и :concat в хелперах ассетов во вью</h5><ul><li>Вместе с Asset Pipeline опции :cache и :concat больше не используются, удалите эти опции из своих вью.
</li></ul><h3 id='sozdanie-prilozheniya-rails-3-1' class='inside_page_header'><a href="#sozdanie-prilozheniya-rails-3-1">2.</a> Создание приложения Rails 3.1</h3><div class="code_container">
  <pre><code class="highlight console"><span class="gp">#</span><span class="w"> </span>Нужен установленный руби-гем <span class="s1">'rails'</span>
<span class="gp">$</span><span class="w"> </span><span class="nb">rails </span>new myapp
<span class="gp">$</span><span class="w"> </span><span class="nb">cd </span>myapp
</code></pre>
</div>
<h4 id='storonnie-gemy' class='inside_page_header'><a href="#storonnie-gemy">2.1.</a> Сторонние гемы</h4><p>Сейчас Rails использует <code>Gemfile</code> в корне приложения, чтобы определить гемы, требуемые для запуска вашего приложения. Этот <code>Gemfile</code> обрабатывается <a href="http://github.com/carlhuda/bundler">Bundler</a>, который затем устанавливает все зависимости. Он может даже установить все зависимости локально в ваше приложение, и оно не будет зависеть от системных гемов.</p><p>Подробнее: - <a href="https://bundler.io/">домашняя страница Bundler</a></p><h4 id='zhivite-na-grani' class='inside_page_header'><a href="#zhivite-na-grani">2.2.</a> Живите на грани</h4><p><code>Bundler</code> и <code>Gemfile</code> замораживает ваше приложение Rails с помощью новой отдельной команды <code>bundle</code>. Если хотите установить напрямую из репозитория Git, передайте флажок <code>--edge</code>:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">rails </span>new myapp <span class="nt">--edge</span>
</code></pre>
</div>
<p>Если имеется локальная копия репозитория Rails, и необходимо сгенерировать приложение используя ее, передайте флажок <code>--dev</code>:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">ruby</span> /path/to/rails/railties/bin/rails new myapp <span class="nt">--dev</span>
</code></pre>
</div>
<h3 id='arhitekturnye-izmeneniya-rails' class='inside_page_header'><a href="#arhitekturnye-izmeneniya-rails">3.</a> Архитектурные изменения Rails</h3><h4 id='konveyer-resursov-assets-pipeline' class='inside_page_header'><a href="#konveyer-resursov-assets-pipeline">3.1.</a> Конвейер ресурсов (Assets Pipeline)</h4><p>Основное изменение в Rails 3.1 это Assets Pipeline. Он делает CSS и JavaScript первосортным кодом, и делает доступной надлежащую организацию, включая использование в плагинах и engine-ах.</p><p>Конвейер ресурсов работает с помощью <a href="https://github.com/rails/sprockets">Sprockets</a> и раскрывается в руководстве <a href="/asset-pipeline">Asset Pipeline</a>.</p><h4 id='http-streaming' class='inside_page_header'><a href="#http-streaming">3.2.</a> HTTP Streaming</h4><p>HTTP Streaming это другое новшество в Rails 3.1. Он позволяет браузеру загружать таблицы стилей и файлы JavaScript, пока сервер все еще генерирует отклик. Это требует Ruby 1.9.2, является опциональным, а также требует настройки веб-сервера, но популярная связка NGINX и Unicorn уже готова предоставлять это преимущество.</p><h4 id='biblioteka-js-po-umolchaniyu-teper-jquery' class='inside_page_header'><a href="#biblioteka-js-po-umolchaniyu-teper-jquery">3.3.</a> Библиотека JS по умолчанию теперь jQuery</h4><p>jQuery является библиотекой JavaScript по умолчанию, которая поставляется вместе с Rails 3.1. Но если вы используете Prototype, это просто переключить.</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">rails </span>new myapp <span class="nt">-j</span> prototype
</code></pre>
</div>
<h4 id='identity-map' class='inside_page_header'><a href="#identity-map">3.4.</a> Identity Map</h4><p>В Active Record имеется Identity Map в Rails 3.1. Identity map содержит ранее загруженные экземпляры записей и возвращает объект, связанный с записью, если к нему обращаются снова. Identity map создается при каждом запросе и уничтожается при его завершении.</p><p>Rails 3.1 поставляется с отключенной по умолчанию identity map.</p><h3 id='railties' class='inside_page_header'><a href="#railties">4.</a> Railties</h3><ul><li><p>jQuery является новой библиотекой JavaScript по умолчанию.</p></li><li><p>jQuery и Prototype более не встроенные, а предоставляются как гемы <code>jquery-rails</code> и <code>prototype-rails</code>.</p></li><li><p>Генератор приложения принимает опцию <code>-j</code>, которая может быть произвольной строкой. Если передать &quot;foo&quot;, в <code>Gemfile</code> будет добавлен гем &quot;foo-rails&quot;, и манифест JavaScript приложения затребует &quot;foo&quot; и &quot;foo_ujs&quot;. В данный момент существуют только &quot;prototype-rails&quot; и &quot;jquery-rails&quot;, и эти файлы предоставляются через конвейер ресурсов.</p></li><li><p>Генерация приложение или плагина запускает <code>bundle install</code>, если не определено <code>--skip-gemfile</code> или <code>--skip-bundle</code>.</p></li><li><p>Генераторы контроллера и ресурса теперь автоматически создадут заглушки для ассетов (это может быть отключено с помощью <code>--skip-assets</code>). Эти заглушки будут использовать CoffeeScript и Sass, если эти библиотеки доступны.</p></li><li><p>Генераторы скаффолда и приложения используют стиль хэшей из Ruby 1.9, когда запущены на Ruby 1.9. Чтобы генерировать старый стиль хэшей, должно быть передано <code>--old-style-hash</code>.</p></li><li><p>Генератор скаффолда контроллера создает блок формата для JSON вместо XML.</p></li><li><p>Логирование Active Record направлено в STDOUT и показывается в консоли.</p></li><li><p>Добавлена конфигурация <code>config.force_ssl</code>, загружающая промежуточную программу <code>Rack::SSL</code> и принуждающую все запросы быть под протоколом HTTPS.</p></li><li><p>Добавлена команда <code>rails plugin new</code>, генерирующая плагин Rails с gemspec, тестами и пустым приложением для тестирования.</p></li><li><p>К стеку промежуточных программ по умолчанию добавлены <code>Rack::Etag</code> и <code>Rack::ConditionalGet</code>.</p></li><li><p>К стеку промежуточных программ по умолчанию добавлена <code>Rack::Cache</code>.</p></li><li><p>Engine-ы получили большое обновление - их можно монтировать на любой путь, включать ассеты. запускать генераторы и т.д.</p></li></ul><h3 id='action-pack' class='inside_page_header'><a href="#action-pack">5.</a> Action Pack</h3><h4 id='action-controller' class='inside_page_header'><a href="#action-controller">5.1.</a> Action Controller</h4><ul><li><p>Выдается предупреждение, если токен аутентификации CSRF не может быть верифицирован.</p></li><li><p>Определите <code>force_ssl</code> в контроллере. чтобы принудить браузер передавать данные через протокол HTTPS на конкретно этот контроллер. Для ограничения отдельных экшнов могут быть использованы <code>:only</code> или <code>:except</code>.</p></li><li><p>Чувствительные параметры строки запроса, определенные в <code>config.filter_parameters</code>, теперь будут отфильтрованы в логе и из пути запроса.</p></li><li><p>Параметры URL, возвращающие <code>nil</code> на <code>to_param</code>. теперь будут убраны из строки запроса.</p></li><li><p>Добавлен <code>ActionController::ParamsWrapper</code> для оборачивания параметров во вложенный хэш, и он будет включен в новых приложениях по умолчанию для запроса JSON. Это может быть настроено в <code>config/initializers/wrap_parameters.rb</code>.</p></li><li><p>Добавлен <code>config.action_controller.include_all_helpers</code>. По умолчанию выполняет <code>helper :all</code> в <code>ActionController::Base</code>, что включает все хелперы по умолчанию. Установка <code>include_all_helpers</code> в <code>false</code> приведет к включению только application_helper и хелпера. соответствующего контроллеру (подобно foo_helper для foo_controller).</p></li><li><p><code>url_for</code> и именованные хелперы URL теперь принимают как опции <code>:subdomain</code> и <code>:domain</code>.</p></li><li><p>Добавлен <code>Base.http_basic_authenticate_with</code> для базовой аутентификации HTTP с помощью единственного вызова метода класса.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="no">USER_NAME</span><span class="p">,</span> <span class="no">PASSWORD</span> <span class="o">=</span> <span class="s2">"dhh"</span><span class="p">,</span> <span class="s2">"secret"</span>

  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="ss">:index</span> <span class="p">]</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">"Everyone can see me!"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="n">render</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">"I'm only accessible if you know the password"</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">authenticate</span>
      <span class="n">authenticate_or_request_with_http_basic</span> <span class="k">do</span> <span class="o">|</span><span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="o">|</span>
        <span class="n">user_name</span> <span class="o">==</span> <span class="no">USER_NAME</span> <span class="o">&amp;&amp;</span> <span class="n">password</span> <span class="o">==</span> <span class="no">PASSWORD</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>..теперь может быть написано как</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">http_basic_authenticate_with</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"dhh"</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">"secret"</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="ss">:index</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">"Everyone can see me!"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="n">render</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">"I'm only accessible if you know the password"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
</li><li><p>Добавлена поддержка streaming, ее можно включить с помощью:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">stream</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Можно ограничить некоторые экшны от этого с использованием <code>:only</code> или <code>:except</code>. Подробности можно прочитать в документации по <a href="https://api.rubyonrails.org/v3.1.0/classes/ActionController/Streaming.html"><code>ActionController::Streaming</code></a>.</p></li><li><p>Маршрутный метод redirect теперь принимает хэш опций, меняющих только рассматриваемые части URL, или объект, отвечающий на вызов, позволяя повторно использовать редиректы.</p></li></ul><h4 id='action-dispatch' class='inside_page_header'><a href="#action-dispatch">5.2.</a> Action Dispatch</h4><ul><li><p><code>config.action_dispatch.x_sendfile_header</code> теперь по умолчанию <code>nil</code> и <code>config/environments/production.rb</code> не устанавливает какое-либо значение для этого. Это позволяет серверам устанавливать его через <code>X-Sendfile-Type</code>.</p></li><li><p><code>ActionDispatch::MiddlewareStack</code> теперь использует наследуемую структуру, и больше не является массивом.</p></li><li><p>Добавлен <code>ActionDispatch::Request.ignore_accept_header</code> для игнорирования заголовков accept.</p></li><li><p>Добавлена <code>Rack::Cache</code> в стек по умолчанию.</p></li><li><p>Ответственность за etag перенесена от <code>ActionDispatch::Response</code> в стек промежуточных программ.</p></li><li><p>API хранения <code>Rack::Session</code> стало более совместимым с остальным в мире Ruby. Оно обратно несовместимо, так как теперь в <code>Rack::Session</code> ожидается, что <code>#get_session</code> принимает четыре аргумента, и требует <code>#destroy_session</code> вместо простого <code>#destroy</code>.</p></li><li><p>Поиск шаблонов теперь ищет глубже в цепи наследования.</p></li></ul><h4 id='action-view' class='inside_page_header'><a href="#action-view">5.3.</a> Action View</h4><ul><li><p>Добавлена опция <code>:authenticity_token</code> к <code>form_tag</code> для ручного управления, или для отмены, если передать <code>:authenticity_token =&gt; false</code>.</p></li><li><p>Создан <code>ActionView::Renderer</code> и определен API для <code>ActionView::Context</code>.</p></li><li><p>Встроенные мутации <code>SafeBuffer</code> запрещены в Rails 3.1.</p></li><li><p>Добавлен HTML5 хелпер <code>button_tag</code>.</p></li><li><p><code>file_field</code> автоматически добавляет <code>:multipart =&gt; true</code> к внешним формам.</p></li><li><p>Добавлена удобная идиома генерировать HTML5 атрибуты data-* в хелперах тегов с хэшем опций <code>:data</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">tag</span><span class="p">(</span><span class="s2">"div"</span><span class="p">,</span> <span class="ss">:data</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Stephen'</span><span class="p">,</span> <span class="ss">:city_state</span> <span class="o">=&gt;</span> <span class="sx">%w(Chicago IL)</span><span class="p">})</span>
<span class="c1"># =&gt; &lt;div data-name="Stephen" data-city-state="[&amp;quot;Chicago&amp;quot;,&amp;quot;IL&amp;quot;]" /&gt;</span>
</code></pre>
</div>
</li></ul><p>Ключи преобразуются в дефисные. Значения кодируются в JSON, кроме строк и символов.</p><ul><li><p><code>csrf_meta_tag</code> переименован в <code>csrf_meta_tags</code> и для него сделан псевдоним <code>csrf_meta_tag</code> для обратной совместимости.</p></li><li><p>Старое API обработки шаблонов устарело, а новое API просто требует обработчик шаблонов для отклика на вызов.</p></li><li><p>rhtml и rxml окончательно убраны из обработчиков шаблонов.</p></li><li><p>Вернули <code>config.action_view.cache_template_loading</code>, позволяющий решить, должны ли быть кэшированы шаблоны, или нет.</p></li><li><p>Хелпер формы submit больше не генерирует id &quot;object_name_id&quot;.</p></li><li><p>Позволяет <code>FormHelper#form_for</code> определить <code>:method</code> как опцию первого уровня вместо вкладывания в хэш <code>:html</code>. <code>form_for(==@==post, remote: true, method: :delete)</code> вместо <code>form_for(==@==post, remote: true, html: { method: :delete })</code>.</p></li><li><p>Предоставлен <code>JavaScriptHelper#j()</code> как псевдоним для <code>JavaScriptHelper#escape_javascript()</code>. Это заменило метод <code>Object#j()</code>, добавляемый гемом JSON в шаблоны при использовании JavaScriptHelper.</p></li><li><p>Позволяет формат AM/PM в datetime selectors.</p></li><li><p><code>auto_link</code> был убран из Rails и выделен в <a href="https://github.com/tenderlove/rails_autolink">гем rails_autolink</a></p></li></ul><h3 id='active-record' class='inside_page_header'><a href="#active-record">6.</a> Active Record</h3><ul><li><p>Добавлен метод класса <code>pluralize_table_names</code> для склонения по числу имен таблиц отдельных моделей. Ранее это можно было сделать только глобально для всех моделей с помощью <code>ActiveRecord::Base.pluralize_table_names</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">pluralize_table_names</span> <span class="o">=</span> <span class="kp">false</span>
<span class="k">end</span>
</code></pre>
</div>
</li><li><p>Добавлен блок настроек для одиночных связей. Блок будет вызван после того, как экземпляр будет инициализирован.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="n">user</span><span class="p">.</span><span class="nf">build_account</span><span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="p">.</span><span class="nf">credit_limit</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="p">}</span>
</code></pre>
</div>
</li><li><p>Добавлен <code>ActiveRecord::Base.attribute_names</code>, возвращающий список имен атрибутов. Он возвратит пустой массив, если модель абстрактная, или таблица не существует.</p></li><li><p>Фикстуры CSV устарели и их поддержка будет убрана в Rails 3.2.0.</p></li><li><p><code>ActiveRecord#new</code>, <code>ActiveRecord#create</code> и <code>ActiveRecord#update_attributes</code> принимают второй хэш как опцию, позволяющую определить рассматриваемую роль при назначении атрибутов. Это основа новой возможности массового назначения Active Model:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:title</span>
  <span class="n">attr_accessible</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:published_at</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:admin</span>
<span class="k">end</span>

<span class="no">Post</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:post</span><span class="p">],</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:admin</span><span class="p">)</span>
</code></pre>
</div>
</li><li><p><code>default_scope</code> теперь может принимать блок, lambda или любой другой объект, отвечающий на call для ленивых вычислений.</p></li><li><p>Дефолтные скоупы теперь вычисляются в самый последний момент для избегания проблем, когда могут быть созданы скоупы, которые неявно содержат дефолтный скоуп, от которого впоследствии невозможно будет избавиться с помощью Model.unscoped.</p></li><li><p>Адаптер PostgreSQL теперь поддерживает только PostgreSQL версии 8.2 и выше.</p></li><li><p>Промежуточная программа <code>ConnectionManagement</code> изменилась, чтобы очищать пул соединения после того, как тело rack было уничтожено.</p></li><li><p>В Active Record добавлен метод <code>update_column</code>. Этот новый метод обновляет заданный атрибут у объекта, пропуская валидации и колбэки. Рекомендовано использовать <code>update_attributes</code> или <code>update_attribute</code> если вы не уверенны, что не хотите выполнять какой-либо колбэк, включая модификацию столбца <code>updated_at</code>. Он не может быть вызван на новых записях.</p></li><li><p>Связи с опцией <code>:through</code> теперь могут использовать любые связи как посредника или источника, включая другие связи, имеющие опцию <code>:through</code>, и связи <code>has_and_belongs_to_many</code>.</p></li><li><p>Конфигурация для текущего соединения с базой данных теперь доступна с помощью <code>ActiveRecord::Base.connection_config</code>.</p></li><li><p>Лимиты и смещения убираются из запросов COUNT, кроме случая, когда они оба представлены.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">People</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">count</span>           <span class="c1"># =&gt; 'SELECT COUNT(*) FROM people'</span>
<span class="no">People</span><span class="p">.</span><span class="nf">offset</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">count</span>          <span class="c1"># =&gt; 'SELECT COUNT(*) FROM people'</span>
<span class="no">People</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">offset</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">count</span> <span class="c1"># =&gt; 'SELECT COUNT(*) FROM people LIMIT 1 OFFSET 1'</span>
</code></pre>
</div>
</li><li><p><code>ActiveRecord::Associations::AssociationProxy</code> был разделен. Теперь имеется класс <code>Association</code> (и подклассы), ответственные за работу со связями, и отдельная &quot;тонкая&quot; обертка по имени <code>CollectionProxy</code>, передающая связи коллекции. Это предотвращает загрязнение пространства имен, разделяет решаемые проблемы, и позволяет дальнейший рефакторинг.</p></li><li><p>Одиночные связи (<code>has_one</code>, <code>belongs_to</code>) больше не имеют прокси, и просто возвращают связанную запись или <code>nil</code>. Это означает, что больше не следует использовать недокументированные методы наподобие <code>bob.mother.create</code> - используйте вместо этого <code>bob.create_mother</code>.</p></li><li><p>Поддержка опции <code>:dependent</code> для связи <code>has_many :through</code>. По историческим и практическим причинам, <code>:delete_all</code> является стратегией удаления по умолчанию, используемой в <code>association.delete(*records)</code>, несмотря на то, что стратегией по умолчанию для обычного has_many является <code>:nullify</code>. Кроме того, это работает только при условии, что вторая сторона связи belongs_to. В других ситуациях следует напрямую модифицировать связь through.</p></li><li><p>Изменилось поведение <code>association.destroy</code> для <code>has_and_belongs_to_many</code> и <code>has_many :through</code>. Теперь &#39;destroy&#39; или &#39;delete&#39; на связи будет означать &#39;избавиться от связи&#39;, а не (обязательно) &#39;избавиться от связанных записей&#39;.</p></li><li><p>Раньше <code>has_and_belongs_to_many.destroy(*records)</code> уничтожал сами записи. Он не удалял какие-либо записи в соединительной таблице. Теперь он удаляет записи в соединительной таблице.</p></li><li><p>Раньше <code>has_many_through.destroy(*records)</code> удалял сами записи и записи в соединительной таблице. [Отметьте: Это не всегда было так; ранние версии Rails удаляли только сами записи.] Теперь от уничтожает только записи в соединительной таблице.</p></li><li><p>Отметьте, что это изменение в некоторой степени обратно не совместимо, но, к сожалению, нет никакого способа объявить его &#39;deprecate&#39; перед изменением. Изменение было сделано для единообразия в понятиях &#39;destroy&#39; или &#39;delete&#39; для различных типов связи. Если хотите уничтожить сами записи, следует выполнить <code>records.association.each(&amp;:destroy)</code>.</p></li><li><p>В <code>change_table</code> добавлена опция <code>:bulk =&gt; true</code>, чтобы выполнить все изменения схемы, определенные в блоке, с использование одного выражения ALTER.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">change_table</span><span class="p">(</span><span class="ss">:users</span><span class="p">,</span> <span class="ss">:bulk</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:company_name</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">change</span> <span class="ss">:birthdate</span><span class="p">,</span> <span class="ss">:datetime</span>
<span class="k">end</span>
</code></pre>
</div>
</li><li><p>Убрана поддержка доступа к атрибутами в соединительной таблице <code>has_and_belongs_to_many</code>. Следует использовать <code>has_many :through</code>.</p></li><li><p>Добавлен метод <code>create_association!</code> для связей <code>has_one</code> и <code>belongs_to</code>.</p></li><li><p>Миграции теперь обратимы, что означает, что Rails теперь понимает, как обратить ваши миграции. Для использования обратимых миграций просто определите метод <code>change</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">MyMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span><span class="p">(</span><span class="ss">:horses</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">column</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:text</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">column</span> <span class="ss">:remind_at</span><span class="p">,</span> <span class="ss">:datetime</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
</li><li><p>Некоторые вещи не могут быть автоматически обратимы. Если вы знаете, как их обратить. следует в миграциях определить <code>up</code> и <code>down</code>. Если вы определите какое-либо изменение в change, которое не может быть обращено, при откате миграции будет вызвано исключение <code>IrreversibleMigration</code>.</p></li><li><p>Теперь миграции используют методы экземпляра вместо методов класса:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">FooMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">up</span> <span class="c1"># Не self.up</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
</li><li><p>Файлы миграции, сгенерированные с помощью генераторов модели и конструктивной миграции (для примера, add_name_to_users), используют метод обратимой миграции <code>change</code> вместо обычных методов <code>up</code> и <code>down</code>.</p></li><li><p>Убрана поддержка интерполяции строк с условиями SQL на связях. Вместо этого должен быть использован proc.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">has_many</span> <span class="ss">:things</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="s1">'foo = #{bar}'</span>          <span class="c1"># до</span>
<span class="n">has_many</span> <span class="ss">:things</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="nb">proc</span> <span class="p">{</span> <span class="s2">"foo = </span><span class="si">#{</span><span class="n">bar</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span> <span class="c1"># после</span>
</code></pre>
</div>
<p>Внутри proc, <code>self</code> это объект, являющийся владельцем связи, за исключением случая, когда связь лениво загружается, в этом случае <code>self</code> это класс, в котором определена связь.</p><p>Внутри proc можно иметь &quot;нормальные&quot; условия, поэтому следующее будет работать:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">has_many</span> <span class="ss">:things</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="nb">proc</span> <span class="p">{</span> <span class="p">[</span><span class="s2">"foo = ?"</span><span class="p">,</span> <span class="n">bar</span><span class="p">]</span> <span class="p">}</span>
</code></pre>
</div>
</li><li><p>Ранее <code>:insert_sql</code> и <code>:delete_sql</code> на связи <code>has_and_belongs_to_many</code> позволяли вызвать &#39;record&#39; для получения записи, которую нужно вставить или удалить. Теперь это передается как аргумент в proc.</p></li><li><p>Добавлен <code>ActiveRecord::Base#has_secure_password</code> (через <code>ActiveModel::SecurePassword</code>) для инкапсуляции элементарного пароля с использованием шифрования BCrypt и соли.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Schema: User(name:string, password_digest:string, password_salt:string)</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_secure_password</span>
<span class="k">end</span>
</code></pre>
</div>
</li><li><p>При генерации модели по умолчанию добавляется <code>add_index</code> для столбцов <code>belongs_to</code> или <code>references</code>.</p></li><li><p>Установление id для объекта в <code>belongs_to</code> обновляет связь с объектом.</p></li><li><p>Изменилась семантика <code>ActiveRecord::Base#dup</code> и <code>ActiveRecord::Base#clone</code>, чтобы более соответствовать семантике обычных методов Ruby dup и clone.</p></li><li><p>Вызов <code>ActiveRecord::Base#clone</code> приведет к неполной копии записи, включая копирования состояния заморозки. Ни один колбэк не будет вызван.</p></li><li><p>Вызов <code>ActiveRecord::Base#dup</code> продублирует запись, включая вызов пост-инициализационных хуков. Состояние заморозки не будет скопировано, и все связи будут очищены. Дублированная запись возвратит <code>true</code> для <code>new_record?</code>, будет иметь <code>nil</code> в поле id, и ее можно будет сохранить.</p></li><li><p>Кэш запросов теперь работает с prepared statements. Никаких изменений в приложении не требуется.</p></li></ul><h3 id='active-model' class='inside_page_header'><a href="#active-model">7.</a> Active Model</h3><ul><li><p><code>attr_accessible</code> принимает опцию <code>:as</code> для определении роли.</p></li><li><p>Теперь <code>InclusionValidator</code>, <code>ExclusionValidator</code> и <code>FormatValidator</code> принимают опцию, которая может быть proc, lambda или что угодно, что отвечает на <code>call</code>. Эта опция будет вызвана с текущей записью в качестве аргумента, и возвратит объект, отвечающий на <code>include?</code> для <code>InclusionValidator</code> и <code>ExclusionValidator</code>, и возвратит регулярное выражение для <code>FormatValidator</code>.</p></li><li><p>Добавлен <code>ActiveModel::SecurePassword</code> для инкапсуляции элементарного пароля с использованием шифрования BCrypt и соли.</p></li><li><p><code>ActiveModel::AttributeMethods</code> Допускает атрибуты, определяемые по требованию.</p></li><li><p>Добавлена поддержка для выборочного включения и отключения обсерверов.</p></li><li><p>Альтернативный поиск в пространстве имен <code>I18n</code> более не поддерживается.</p></li></ul><h3 id='active-resource' class='inside_page_header'><a href="#active-resource">8.</a> Active Resource</h3><ul><li><p>Для всех запросов формат по умолчанию был изменен на JSON. Если хотите продолжить использование XML, следует установить <code>self.format = :xml</code> в классе. Например,</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveResource</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">format</span> <span class="o">=</span> <span class="ss">:xml</span>
<span class="k">end</span>
</code></pre>
</div>
</li></ul><h3 id='active-support' class='inside_page_header'><a href="#active-support">9.</a> Active Support</h3><ul><li><p><code>ActiveSupport::Dependencies</code> теперь вызывает <code>NameError</code>, если находит существующую константу в <code>load_missing_constant</code>.</p></li><li><p>Добавлен новый метод <code>Kernel#quietly</code>, приглушающий <code>STDOUT</code> и <code>STDERR</code>.</p></li><li><p>Добавлен <code>String#inquiry</code> как удобный метод для преобразования String в объект <code>StringInquirer</code>.</p></li><li><p>Добавлен <code>Object#in?</code> для проверки, включен ли объект в другой объект.</p></li><li><p>Теперь стратегия <code>LocalCache</code> является настоящим классом промежуточной программы, а не анонимным классом.</p></li><li><p>Был представлен класс <code>ActiveSupport::Dependencies::ClassCache</code> как содержащий ссылки на перегружаемые классы.</p></li><li><p>Был отрефакторен <code>ActiveSupport::Dependencies::Reference</code>, чтобы пользоваться преимуществами нового <code>ClassCache</code>.</p></li><li><p>Бэкпортирован <code>Range#cover?</code> как псевдоним <code>Range#include?</code> в Ruby 1.8.</p></li><li><p>Добавлены <code>weeks_ago</code> и <code>prev_week</code> в Date/DateTime/Time.</p></li><li><p>Добавлен колбэк <code>before_remove_const</code> к <code>ActiveSupport::Dependencies.remove_unloadable_constants!</code>.</p></li></ul><p>Устарело:</p><ul><li><code>ActiveSupport::SecureRandom</code> устарел в пользу <code>SecureRandom</code> из стандартной библиотеки Ruby.
</li></ul>

            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

   <!-- bottom rusrails -->
   <ins class="adsbygoogle"
        style="display:inline-block;width:580px;height:400px"
        data-ad-client="ca-pub-7764391801669990"
        data-ad-slot="7566253867"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
        </div>
        <div class="row-fluid">
          <div class="span12" id="footer">
            <p>
              <a target="blank" href="https://github.com/rusrails/rusrails"><img src="/assets/github-7cc23602a5ac2465f14c19492358a5a67dc24636761cc723e4d621cea0c09225.png" /></a>
            </p>
            <p>
              <a href="https://creativecommons.org/licenses/by-sa/4.0/">Лицензия CC BY-SA 4.0</a>
              "Rails", "Ruby on Rails" и логотип Rails - торговые марки DHH
              <!-- Yandex.Metrika counter -->
<script>
  (function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter1006929 = new Ya.Metrika({id:1006929,
                    webvisor:true,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true});
        } catch(e) { }
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>

<noscript>
  <div>
    <img style="position:absolute; left:-9999px;" alt="" src="//mc.yandex.ru/watch/1006929" />
  </div>
</noscript>
<!-- /Yandex.Metrika counter -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64955373-1', 'auto');
  ga('send', 'pageview');

  var trackOutboundLink = function(url) {
    ga('send', 'event', 'outbound', 'click', url, {
      'transport': 'beacon',
      'hitCallback': function(){ }
    });
  }
</script>

            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="to_top" style="display: block">
      <div class="to_top_panel"></div>
    </div>
    <script src="/assets/application-48ac5c5be8858f5558a99606c2d341f9fee482f22db6deee5def03837c505584.js"></script>
  </body>
</html>
