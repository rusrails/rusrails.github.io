<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8">
<meta content="Ruby on Rails, Ruby, Rails, Rails 3, Rails 4, Rails 5, Rails 6, Rails 6.0, Rails 6.1, Rails 7.0, Rails 7.1 руководство, начинающим, самоучитель, manual, мануал, справочник, учебник, примеры, Руби, рельсы" name="keywords"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" name="description"/>
<meta content="product" property="twitter:card"/>
<meta content="@rusrails" property="twitter:site"/>
<meta content="Rusrails: Основы Action Mailer" property="twitter:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="twitter:description"/>
<meta content="@rusrails" property="twitter:creator"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="twitter:image"/>
<meta content="website" property="og:type"/>
<meta content="Rusrails: Основы Action Mailer" property="og:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="og:description"/>
<meta content="http://localhost:3000/action-mailer-basics" property="og:url"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="og:image"/>
    <title>
      Rusrails: Основы Action Mailer
    </title>
    <link rel="stylesheet" href="/assets/application-f9dfa6ce7fa871006d478e422639671663284ddaa3126cf81ddfe371ac3533c4.css" />
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="/"></a>
          <ul class="nav pull-right top-menu">
            <li>
              <a href="/">Главная</a>
            </li>
            <li class="dropdown">
              <a class="index-popover" href="#">
                Содержание
                <b class="caret"></b>
</a>              <div class="index-popover-content hide">
                  <ul><li><p><strong>С чего начать?</strong></p><ul><li><a href="/getting-started">Rails для начинающих</a>
</li></ul></li><li><p><strong>Модели</strong></p><ul><li><a href="/active-record-basics">Основы Active Record</a>
</li><li><a href="/active-record-migrations">Миграции Active Record</a>
</li><li><a href="/active-record-validations">Валидации Active Record</a>
</li><li><a href="/active-record-callbacks">Колбэки Active Record</a>
</li><li><a href="/active-record-associations">Связи (ассоциации) Active Record</a>
</li><li><a href="/active-record-querying">Интерфейс запросов Active Record</a>
</li><li><a href="/active-model-basics">Основы Active Model</a>
</li></ul></li><li><p><strong>Вью</strong></p><ul><li><a href="/action-view-overview">Обзор Action View</a>
</li><li><a href="/layouts-and-rendering">Макеты и рендеринг в Rails</a>
</li><li><a href="/action-view-helpers">Хелперы Action View</a>
</li><li><a href="/form-helpers">Хелперы форм в Action View</a>
</li></ul></li><li><p><strong>Контроллеры</strong></p><ul><li><a href="/action-controller-overview">Обзор Action Controller</a>
</li><li><a href="/routing">Роутинг в Rails</a>
</li></ul></li><li><p><strong>Другие компоненты</strong></p><ul><li><a href="/active-support-core-extensions">Расширения ядра Active Support</a>
</li><li><a href="/action-mailer-basics">Основы Action Mailer</a>
</li><li><a href="/action-mailbox-basics">Основы Action Mailbox</a>
</li><li><a href="/action-text-overview">Обзор Action Text</a>
</li><li><a href="/active_job_basics">Основы Active Job</a>
</li><li><a href="/active_storage_overview">Обзор Active Storage</a>
</li><li><a href="/action-cable-overview">Обзор Action Cable</a>
</li></ul></li><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/i18n">API интернационализации Rails (I18n)</a>
</li><li><a href="/testing">Тестирование приложений на Rails</a>
</li><li><a href="/security">Безопасность приложений на Rails</a>
</li><li><a href="/error-reporting">Отчет об ошибках в приложениях Rails</a>
</li><li><a href="/debugging-rails-applications">Отладка приложений на Rails</a>
</li></ul></li></ul><p>next_column</p><ul><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/configuring">Конфигурирование приложений на Rails</a>
</li><li><a href="/command-line">Командная строка Rails</a>
</li><li><a href="/asset-pipeline">Asset Pipeline</a>
</li><li><a href="/working-with-javascript-in-rails">Работа с JavaScript в Rails</a>
</li><li><a href="/initialization">Процесс инициализации в Rails</a>
</li><li><a href="/autoloading-and-reloading-constants">Автозагрузка и перезагрузка констант</a>
</li><li><a href="/caching-with-rails">Кэширование с Rails: Обзор</a>
</li><li><a href="/active-support-instrumentation">Инструментарий Active Support</a>
</li><li><a href="/api-app">Использование Rails для API-приложений</a>
</li><li><a href="/active-record-postgresql">Active Record для PostgreSQL</a>
</li><li><a href="/active-record-multiple-databases">Несколько баз данных с Active Record</a>
</li><li><a href="/active-record-encryption">Шифрование Active Record</a>
</li></ul></li><li><p><strong>Расширяем Rails</strong></p><ul><li><a href="/plugins">Основы создания плагинов Rails</a>
</li><li><a href="/rails-on-rack">Rails on Rack</a>
</li><li><a href="/generators">Создание и настройка генераторов и шаблонов Rails</a>
</li><li><a href="/engines">Engine для начинающих</a>
</li><li><a href="/threading_and_code_execution">Треды и выполнение кода в Rails</a>
</li><li><a href="/rails-application-templates">Шаблоны приложения Rails</a>
</li></ul></li><li><p><strong>Вносим вклад в Ruby on Rails</strong></p><ul><li><a href="/contributing_to_ruby_on_rails">Вносим вклад в Ruby on Rails</a>
</li><li><a href="/api_documentation_guidelines">Рекомендации по документированию API</a>
</li><li><a href="/ruby_on_rails_guides_guidelines">Рекомендации для руководств по Ruby on Rails</a>
</li><li><a href="/development_dependencies_install">Установка зависимостей для разработки</a>
</li><li><a href="/maintenance-policy">Политика поддержки (версий)</a>
</li></ul></li><li><p><strong>Заметки о релизах</strong></p><ul><li><a href="/upgrading-ruby-on-rails">Апгрейд Ruby on Rails</a>
</li><li><a href="/7_2_release_notes">Версия 7.2 - ?</a>
</li><li><a href="/7_1_release_notes">Версия 7.1 - Октябрь 2023</a>
</li><li><a href="/7_0_release_notes">Версия 7.0 - Декабрь 2021</a>
</li><li><a href="/6_1_release_notes">Версия 6.1 - Декабрь 2020</a>
</li><li><a href="/6_0_release_notes">Версия 6.0 - Август 2019</a>
</li></ul></li></ul>
              </div>
            </li>
            <li>
              <a href="/search">Поиск</a>
            </li>
            <li>
              <a target="blank" href="http://api.rusrails.ru">Ruby &amp; Rails API</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="content-wrapper">
      <div class="container-fluid">
        <div class="row-fluid">
          <div class="span3 pull-right">
            <div class="well social">
              <h4>Принимаем пожелания и пул-реквесты!</h4>
              <iframe allowtransparency="true" frameborder="0" height="30" src="http://ghbtns.com/github-btn.html?user=rusrails&repo=rusrails&type=watch&count=true&size=large" width="180"></iframe>
              <p></p>
              <a class="twitter-follow-button" data-lang="ru" href="https://twitter.com/rusrails"></a>
            </div>
              <div class="well menu">
                    <ul class="nav nav-list">
      <li>
        <h4>
          <a href="#chto-takoe-action-mailer">1. Что такое Action Mailer?</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#rassylschiki-pohozhi-na-kontrollery">1.1. Рассыльщики похожи на контроллеры</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#otpravka-elektronnoy-pochty">2. Отправка электронной почты</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#poshagovoe-rukovodstvo-po-generatsii-rassylschika">2.1. Пошаговое руководство по генерации рассыльщика</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#sozdaem-rassylschik">2.1.1. Создаем рассыльщик</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#redaktiruem-rassylschik">2.1.2. Редактируем рассыльщик</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#sozdaem-vyu-rassylschika">2.1.3. Создаем вью рассыльщика</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#vyzov-rassylschika">2.1.4. Вызов рассыльщика</a>
</h6>      </li>
      <li>
        <h5>
          <a href="#avtomaticheskoe-kodirovanie-znacheniy-zagolovka">2.2. Автоматическое кодирование значений заголовка</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#complete-list-of-action-mailer-user-settable-attributes">2.3. Полный перечень методов Action Mailer</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#dobavlenie-prikreplennyh-faylov">2.3.1. Добавление прикрепленных файлов</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#sozdanie-vstroennyh-prikreplennyh-faylov">2.3.2. Создание встроенных прикрепленных файлов</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#rassylka-email-neskolkim-poluchatelyam">2.3.3. Рассылка Email нескольким получателям</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#rassylka-email-s-imenem">2.3.4. Рассылка Email с именем</a>
</h6>      </li>
      <li>
        <h5>
          <a href="#vyu-rassylschika">2.4. Вью рассыльщика</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#keshirovanie-vyu-rassylschika">2.4.1. Кэширование вью рассыльщика</a>
</h6>      </li>
      <li>
        <h5>
          <a href="#makety-action-mailer">2.5. Макеты Action Mailer</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#predprosmotr-pisem">2.6. Предпросмотр писем</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#generiruem-url-vo-vyu-action-mailer">2.7. Генерируем URL во вью Action Mailer</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#generatsiya-url-s-pomoschyu-url_for">2.7.1. Генерация URL с помощью <code>url_for</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#generatsiya-url-s-pomoschyu-imenovannyh-marshrutov">2.7.2. Генерация URL с помощью именованных маршрутов</a>
</h6>      </li>
      <li>
        <h5>
          <a href="#dobavlenie-kartinok-vo-vyu-action-mailer">2.8. Добавление картинок во вью Action Mailer</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#rassylka-multipart-email">2.9. Рассылка multipart email</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#rassylka-pisem-s-dinamicheskimi-optsiyami-dostavki">2.10. Рассылка писем с динамическими опциями доставки</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#rassylka-pisem-bez-renderinga-shablona">2.11. Рассылка писем без рендеринга шаблона</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#kolbeki-action-mailer">3. Колбэки Action Mailer</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#ispolzovanie-helperov-action-mailer">4. Использование хелперов Action Mailer</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#action-mailer-configuration">5. Настройка Action Mailer</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#primer-nastroyki-action-mailer">5.1. Пример настройки Action Mailer</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#nastroyka-action-mailer-dlya-gmail">5.2. Настройка Action Mailer для Gmail</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#testirovanie-rassylschika">6. Тестирование рассыльщика</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#perehvat-i-obzor-pisem">7. Перехват и обзор писем</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#perehvat-pisem">7.1. Перехват писем</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#obzor-pisem">7.2. Обзор писем</a>
</h5>      </li>
</ul>

              </div>
            <div class="well banner300 banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<!-- sidebar rusrails -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:600px"
     data-ad-client="ca-pub-7764391801669990"
     data-ad-slot="6089520660"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
          <div class="span9 content pull-left">
            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <!-- top rusrails -->
  <ins class="adsbygoogle"
       style="display:inline-block;width:980px;height:120px"
       data-ad-client="ca-pub-7764391801669990"
       data-ad-slot="4891989065"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
              <h2 id='osnovy-action-mailer' class='inside_page_header'> Основы Action Mailer</h2><p>Это руководство представит вам все, что нужно для того, чтобы отправлять электронную почту в вашем приложении, и раскроет множество внутренних методов Action Mailer. Оно также раскроет, как тестировать ваши рассыльщики.</p><p>После прочтения этого руководства, вы узнаете:</p><ul><li>Как отправлять письма в приложении Rails.
</li><li>Как генерировать и редактировать класс Action Mailer и вью рассыльщика.
</li><li>Как настраивать Action Mailer для своей среды.
</li><li>Как тестировать свои классы Action Mailer.
</li></ul><h3 id='chto-takoe-action-mailer' class='inside_page_header'><a href="#chto-takoe-action-mailer">1.</a> Что такое Action Mailer?</h3><p>Action Mailer позволяет отправлять электронные письма из приложения, используя классы и вью рассыльщика.</p><h4 id='rassylschiki-pohozhi-na-kontrollery' class='inside_page_header'><a href="#rassylschiki-pohozhi-na-kontrollery">1.1.</a> Рассыльщики похожи на контроллеры</h4><p>Они наследуются от <a href="https://api.rubyonrails.org/classes/ActionMailer/Base.html"><code>ActionMailer::Base</code></a> и находятся в <code>app/mailers</code>. Рассыльщики также работают подобно контроллерами. Некоторые общие черты перечислены ниже. У рассыльщиков есть:</p><ul><li>Экшны, а также связанные вью, которые располагаются в <code>app/views</code>.
</li><li>Переменные экземпляра, доступные во вью.
</li><li>Возможность использовать макеты и партиалы.
</li><li>Возможность доступа к хэшу params.
</li></ul><h3 id='otpravka-elektronnoy-pochty' class='inside_page_header'><a href="#otpravka-elektronnoy-pochty">2.</a> Отправка электронной почты</h3><p>Этот раздел предоставляет пошаговое руководство по созданию рассыльщика и его вью.</p><h4 id='poshagovoe-rukovodstvo-po-generatsii-rassylschika' class='inside_page_header'><a href="#poshagovoe-rukovodstvo-po-generatsii-rassylschika">2.1.</a> Пошаговое руководство по генерации рассыльщика</h4><h5 id='sozdaem-rassylschik' class='inside_page_header'><a href="#sozdaem-rassylschik">2.1.1.</a> Создаем рассыльщик</h5><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate mailer User
<span class="go">create  app/mailers/user_mailer.rb
create  app/mailers/application_mailer.rb
invoke  erb
create    app/views/user_mailer
create    app/views/layouts/mailer.text.erb
create    app/views/layouts/mailer.html.erb
invoke  test_unit
create    test/mailers/user_mailer_test.rb
create    test/mailers/previews/user_mailer_preview.rb
</span></code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/mailers/application_mailer.rb</span>
<span class="k">class</span> <span class="nc">ApplicationMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default</span> <span class="ss">from: </span><span class="s2">"from@example.com"</span>
  <span class="n">layout</span> <span class="s1">'mailer'</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/mailers/user_mailer.rb</span>
<span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Как видите, можно генерировать рассыльщик одним из генератором Rails.</p><p>Если не хотите использовать генератор, можно создать свой файл в <code>app/mailers</code>, просто убедитесь, что он унаследован от <code>ActionMailer::Base</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">MyMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='redaktiruem-rassylschik' class='inside_page_header'><a href="#redaktiruem-rassylschik">2.1.2.</a> Редактируем рассыльщик</h5><p>У рассыльщиков есть методы, называемые &quot;экшнами&quot;, и они используют вью для структурирования своего контента. В то время, когда контроллер генерирует контент, например HTML, для возврата его на клиент, рассыльщик создает сообщение для доставки по электронной почте.</p><p><code>app/mailers/user_mailer.rb</code> содержит пустой рассыльщик:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Давайте добавим метод, названный <code>welcome_email</code>, который будет посылать email на зарегистрированный адрес email пользователя:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="n">default</span> <span class="ss">from: </span><span class="s1">'notifications@example.com'</span>

  <span class="k">def</span> <span class="nf">welcome_email</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:user</span><span class="p">]</span>
    <span class="vi">@url</span>  <span class="o">=</span> <span class="s1">'http://example.com/login'</span>
    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">subject: </span><span class="s1">'Welcome to My Awesome Site'</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre>
</div>
<p>Вот краткое описание элементов, представленных в этом методе. Для полного списка всех доступных опций, обратитесь к <a href="#complete-list-of-action-mailer-user-settable-attributes">соответствующему разделу</a>.</p><ul><li>Метод <a href="https://api.rubyonrails.org/classes/ActionMailer/Base.html#method-c-default"><code>default</code></a> устанавливает значения по умолчанию для всех рассылаемых email из этого рассыльщика. В этом случае мы используем его, чтобы назначить заголовку <code>:from</code> значение для всех сообщений в этом классе. Это может быть переопределено для отдельного письма.
</li><li>Метод <a href="https://api.rubyonrails.org/classes/ActionMailer/Base.html#method-i-mail"><code>mail</code></a> создает фактическое сообщение email. Мы используем его, чтобы определить значения заголовков, таких как <code>:to</code> и <code>:subject</code> для этого email.
</li></ul><h5 id='sozdaem-vyu-rassylschika' class='inside_page_header'><a href="#sozdaem-vyu-rassylschika">2.1.3.</a> Создаем вью рассыльщика</h5><p>Создадим файл, названный <code>welcome_email.html.erb</code> в <code>app/views/user_mailer/</code>. Это будет шаблоном, используемым для email, форматированным в HTML:</p><div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">content=</span><span class="s">'text/html; charset=UTF-8'</span> <span class="na">http-equiv=</span><span class="s">'Content-Type'</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Welcome to example.com, <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      You have successfully signed up to example.com,
      your username is: <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">login</span> <span class="cp">%&gt;</span>.<span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      To login to the site, just follow this link: <span class="cp">&lt;%=</span> <span class="vi">@url</span> <span class="cp">%&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>Thanks for joining and have a great day!<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>
<p>Давайте также создадим текстовую часть для этого email. Не все клиенты предпочитают письма HTML, и рассылка обоих является лучшей практикой. Для этого создайте файл с именем <code>welcome_email.text.erb</code> в <code>app/views/user_mailer/</code>.</p><div class="code_container">
  <pre><code class="highlight erb">Welcome to example.com, <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span>
===============================================

You have successfully signed up to example.com,
your username is: <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">login</span> <span class="cp">%&gt;</span>.

To login to the site, just follow this link: <span class="cp">&lt;%=</span> <span class="vi">@url</span> <span class="cp">%&gt;</span>.

Thanks for joining and have a great day!
</code></pre>
</div>
<p>Теперь при вызове метода <code>mail</code>, Action Mailer обнаружит два шаблона (text и HTML) и автоматически сгенерирует <code>multipart/alternative</code> email.</p><h5 id='vyzov-rassylschika' class='inside_page_header'><a href="#vyzov-rassylschika">2.1.4.</a> Вызов рассыльщика</h5><p>Рассыльщики - это всего лишь другой способ отрендерить вью. Вместо рендеринга вью и отсылки ее по протоколу HTTP, они вместо этого отправляют ее по протоколам email. Благодаря этому имеет смысл, чтобы контроллер сказал рассыльщику отослать письмо тогда, когда пользователь был успешно создан.</p><p>Настроить это просто.</p><p>Во первых, давайте создадим скаффолд <code>User</code>:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate scaffold user name email login
<span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>db:migrate
</code></pre>
</div>
<p>Теперь, когда у нас есть модель user, с которой мы играем, надо отредактировать файл <code>app/controllers/users_controller.rb</code>, чтобы поручить <code>UserMailer</code> доставлять email каждому вновь созданному пользователю, изменив экшн <code>create</code> и вставив вызов <code>UserMailer.with(user: @user).welcome_email</code> сразу после того, как пользователь был успешно сохранен.</p><p>Мы поставим этот email в очередь отправки с помощью <a href="https://api.rubyonrails.org/classes/ActionMailer/MessageDelivery.html#method-i-deliver_later"><code>deliver_later</code></a>, который поддерживается Active Job. Таким образом, экшн контроллера может продолжать без ожидания завершения отправки.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>

  <span class="c1"># POST /users or /users.json</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>

    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">save</span>
        <span class="c1"># Сказать UserMailer отослать приветственное письмо после сохранения</span>
        <span class="no">UserMailer</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="ss">user: </span><span class="vi">@user</span><span class="p">).</span><span class="nf">welcome_email</span><span class="p">.</span><span class="nf">deliver_later</span>

        <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">redirect_to</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">notice: </span><span class="s1">'User was successfully created.'</span><span class="p">)</span> <span class="p">}</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">status: :created</span><span class="p">,</span> <span class="ss">location: </span><span class="vi">@user</span> <span class="p">}</span>
      <span class="k">else</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">action: </span><span class="s1">'new'</span> <span class="p">}</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">errors</span><span class="p">,</span> <span class="ss">status: :unprocessable_entity</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="note"><p>Поведением Active Job по умолчанию является выполнение заданий с помощью адаптера <code>:async</code>. Поэтому можно использовать <code>deliver_later</code> для отсылки писем асинхронно. Адаптер Active Job по умолчанию запускает задания с помощью пула тредов внутри процесса. Это хорошо подходит для сред development/test, так как не требует какой-либо внешней инфраструктуры, но плохо подходит для production, так как он теряет отложенные задания при перезагрузке. Если нужен персистентный бэкенд, необходимо использовать адаптер Active Job, у которого такой бэкенд есть (Sidekiq, Resque и т.п.).</p></div><p>Если хотите отправлять письма прямо сейчас в любом случае (например, из крона) просто вызовите <a href="https://api.rubyonrails.org/classes/ActionMailer/MessageDelivery.html#method-i-deliver_now"><code>deliver_now</code></a>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">SendWeeklySummary</span>
  <span class="k">def</span> <span class="nf">run</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">find_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="no">UserMailer</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="ss">user: </span><span class="n">user</span><span class="p">).</span><span class="nf">weekly_summary</span><span class="p">.</span><span class="nf">deliver_now</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Любая пара ключ/значение, переданная в <a href="https://api.rubyonrails.org/classes/ActionMailer/Parameterized/ClassMethods.html#method-i-with"><code>with</code></a>, просто становится <code>params</code> для экшна рассыльщика. Поэтому <code>with(user: @user, account: @user.account)</code> делает <code>params[:user]</code> и <code>params[:account]</code> доступными в экшне рассыльщика. Это такой же params, который есть в контроллерах.</p><p>Метод <code>welcome_email</code> возвращает объект <a href="https://api.rubyonrails.org/classes/ActionMailer/MessageDelivery.html"><code>ActionMailer::MessageDelivery</code></a>, которому затем можно сказать <code>deliver_now</code> или <code>deliver_later</code>, чтобы он сам себя отослал. Объект <code>ActionMailer::MessageDelivery</code> — это обертка для <code>Mail::Message</code>. Если хотите исследовать, изменить или еще что-то сделать с объектом <code>Mail::Message</code>, к нему можно получить доступ с помощью метода <a href="https://api.rubyonrails.org/classes/ActionMailer/MessageDelivery.html#method-i-message"><code>message</code></a> на объекте <code>ActionMailer::MessageDelivery</code>.</p><h4 id='avtomaticheskoe-kodirovanie-znacheniy-zagolovka' class='inside_page_header'><a href="#avtomaticheskoe-kodirovanie-znacheniy-zagolovka">2.2.</a> Автоматическое кодирование значений заголовка</h4><p>Action Mailer осуществляет автоматическое кодирование многобайтовых символов в заголовках и телах.</p><p>Для более сложных примеров, таких, как определение альтернативных кодировок или самокодировок текста, обратитесь к библиотеке <a href="https://github.com/mikel/mail">Mail</a>.</p><h4 id='complete-list-of-action-mailer-user-settable-attributes' class='inside_page_header'><a href="#complete-list-of-action-mailer-user-settable-attributes">2.3.</a> Полный перечень методов Action Mailer</h4><p>Имеется всего три метода, необходимых для рассылки почти любых сообщений email:</p><ul><li><a href="https://api.rubyonrails.org/classes/ActionMailer/Base.html#method-i-headers"><code>headers</code></a> - Определяет любой заголовок email. Можно передать хэш пар имен и значений полей заголовка, или можно вызвать <code>headers[:field_name] = &#39;value&#39;</code>
</li><li><a href="https://api.rubyonrails.org/classes/ActionMailer/Base.html#method-i-attachments"><code>attachments</code></a> - Позволяет добавить прикрепленные файлы в email. Например, <code>attachments[&#39;file-name.jpg&#39;] = File.read(&#39;file-name.jpg&#39;)</code>
</li><li><a href="https://api.rubyonrails.org/classes/ActionMailer/Base.html#method-i-mail"><code>mail</code></a> - Создает сам email. Можете передать в <code>headers</code> хэш к методу <code>mail</code> как параметр. <code>mail</code> затем создаст email - или чистый текст, или multipart - в зависимости от определенных вами шаблонов email.
</li></ul><h5 id='dobavlenie-prikreplennyh-faylov' class='inside_page_header'><a href="#dobavlenie-prikreplennyh-faylov">2.3.1.</a> Добавление прикрепленных файлов</h5><p>В Action Mailer очень просто добавить прикрепленные файлы.</p><ul><li><p>Передайте имя файла и содержимое, и Action Mailer и <a href="https://github.com/mikel/mail">гем Mail</a> автоматически определят <code>mime_type</code>, установят <code>encoding</code> и создадут прикрепленные файлы.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">attachments</span><span class="p">[</span><span class="s1">'filename.jpg'</span><span class="p">]</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'/path/to/filename.jpg'</span><span class="p">)</span>
</code></pre>
</div>
</li></ul><p>  Когда будет вызван метод <code>mail</code>, он отправит multipart email с прикрепленным файлом, должным образом вложенным в верхний уровень, являющийся <code>multipart/mixed</code>, и первая часть будет <code>multipart/alternative</code>, содержащая чистый текст и сообщения HTML.</p><div class="note"><p>Mail автоматически кодирует прикрепленный файл в Base64. Если хотите что-то иное, закодируйте свое содержимое и передайте в кодированном содержимом, и укажите кодировку в хэше в методе <code>attachments</code>.</p></div><ul><li><p>Передайте имя файла и определите заголовки и содержимое, и Action Mailer и Mail будут использовать переданные вами настройки.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">encoded_content</span> <span class="o">=</span> <span class="no">SpecialEncode</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'/path/to/filename.jpg'</span><span class="p">))</span>
<span class="n">attachments</span><span class="p">[</span><span class="s1">'filename.jpg'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">mime_type: </span><span class="s1">'application/gzip'</span><span class="p">,</span>
  <span class="ss">encoding: </span><span class="s1">'SpecialEncoding'</span><span class="p">,</span>
  <span class="ss">content: </span><span class="n">encoded_content</span>
<span class="p">}</span>
</code></pre>
</div>
</li></ul><div class="note"><p>Если указать кодировку, Mail будет полагать, что ваше содержимое уже кодировано в ней и не попытается кодировать в Base64.</p></div><h5 id='sozdanie-vstroennyh-prikreplennyh-faylov' class='inside_page_header'><a href="#sozdanie-vstroennyh-prikreplennyh-faylov">2.3.2.</a> Создание встроенных прикрепленных файлов</h5><p>Action Mailer 3.0 создает встроенные прикрепленные файлы, которые вовлекали множество хаков в версиях до 3.0, более просто и обычно, так, как и должно было быть.</p><ul><li><p>Сперва, чтобы сказать Mail превратить прикрепленные файлы во встроенные прикрепленные файлы, надо всего лишь вызвать <code>#inline</code> на методе attachments в рассыльщике:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">welcome</span>
  <span class="n">attachments</span><span class="p">.</span><span class="nf">inline</span><span class="p">[</span><span class="s1">'image.jpg'</span><span class="p">]</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'/path/to/image.jpg'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>
</li><li><p>Затем, во вью можно просто сослаться на <code>attachments</code> как хэш и определить, какой прикрепленный файл необходимо отобразить, вызвав <code>url</code> на нем, и затем передать результат в метод <code>image_tag</code>:</p><div class="code_container">
  <pre><code class="highlight erb"><span class="nt">&lt;p&gt;</span>Hello there, this is our image<span class="nt">&lt;/p&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">attachments</span><span class="p">[</span><span class="s1">'image.jpg'</span><span class="p">].</span><span class="nf">url</span> <span class="cp">%&gt;</span>
</code></pre>
</div>
</li><li><p>Так как это стандартный вызов <code>image_tag</code>, можно передать хэш опций после URL прикрепленного файла, как это делается для любого другого изображения:</p><div class="code_container">
  <pre><code class="highlight erb"><span class="nt">&lt;p&gt;</span>Hello there, this is our image<span class="nt">&lt;/p&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">attachments</span><span class="p">[</span><span class="s1">'image.jpg'</span><span class="p">].</span><span class="nf">url</span><span class="p">,</span> <span class="ss">alt: </span><span class="s1">'My Photo'</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'photos'</span> <span class="cp">%&gt;</span>
</code></pre>
</div>
</li></ul><h5 id='rassylka-email-neskolkim-poluchatelyam' class='inside_page_header'><a href="#rassylka-email-neskolkim-poluchatelyam">2.3.3.</a> Рассылка Email нескольким получателям</h5><p>Возможно отослать email одному и более получателям в одном письме (например, информируя всех админов о новой регистрации пользователя), настроив список адресов email в ключе <code>:to</code>. Перечень email может быть массивом или отдельной строкой с адресами, разделенными запятыми.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AdminMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="n">default</span> <span class="ss">to: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="no">Admin</span><span class="p">.</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">},</span>
          <span class="ss">from: </span><span class="s1">'notification@example.com'</span>

  <span class="k">def</span> <span class="nf">new_registration</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="n">mail</span><span class="p">(</span><span class="ss">subject: </span><span class="s2">"New User Signup: </span><span class="si">#{</span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Тот же формат может быть использован для назначения получателей копии (Cc:) и скрытой копии (Bcc:), при использовании ключей <code>:cc</code> и <code>:bcc</code> соответственно.</p><h5 id='rassylka-email-s-imenem' class='inside_page_header'><a href="#rassylka-email-s-imenem">2.3.4.</a> Рассылка Email с именем</h5><p>Иногда хочется показать имена людей вместо их электронных адресов, при получении ими email. Для этого можно использовать <a href="https://api.rubyonrails.org/classes/ActionMailer/Base.html#method-i-email_address_with_name"><code>email_address_with_name</code></a>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">welcome_email</span>
  <span class="n">mail</span><span class="p">(</span>
    <span class="ss">to: </span><span class="n">email_address_with_name</span><span class="p">(</span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">name</span><span class="p">),</span>
    <span class="ss">subject: </span><span class="s1">'Welcome to My Awesome Site'</span>
  <span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Та же техника работает, чтобы указать имя отправления:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="n">default</span> <span class="ss">from: </span><span class="n">email_address_with_name</span><span class="p">(</span><span class="s1">'notification@example.com'</span><span class="p">,</span> <span class="s1">'Example Company Notifications'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Если имя пустая строка, он возвращает только адрес.</p><h4 id='vyu-rassylschika' class='inside_page_header'><a href="#vyu-rassylschika">2.4.</a> Вью рассыльщика</h4><p>Вью рассыльщика расположены в директории <code>app/views/name_of_mailer_class</code>. Определенная вью рассыльщика известна классу, поскольку у нее имя такое же, как у метода рассыльщика. Так, в нашем примере, вью рассыльщика для метода <code>welcome_email</code> будет в <code>app/views/user_mailer/welcome_email.html.erb</code> для версии HTML и <code>welcome_email.text.erb</code> для обычной текстовой версии.</p><p>Чтобы изменить вью рассыльщика по умолчанию для вашего экшна, сделайте так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="n">default</span> <span class="ss">from: </span><span class="s1">'notifications@example.com'</span>

  <span class="k">def</span> <span class="nf">welcome_email</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:user</span><span class="p">]</span>
    <span class="vi">@url</span>  <span class="o">=</span> <span class="s1">'http://example.com/login'</span>
    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
         <span class="ss">subject: </span><span class="s1">'Welcome to My Awesome Site'</span><span class="p">,</span>
         <span class="ss">template_path: </span><span class="s1">'notifications'</span><span class="p">,</span>
         <span class="ss">template_name: </span><span class="s1">'another'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>В этом случае он будет искать шаблон в <code>app/views/notifications</code> с именем <code>another</code>. Также можно определить массив путей для <code>template_path</code>, и они будут искаться в указанном порядке.</p><p>Если желаете большей гибкости, также возможно передать блок и рендерить определенный шаблон или даже рендерить вложенный код или текст без использования файла шаблона:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="n">default</span> <span class="ss">from: </span><span class="s1">'notifications@example.com'</span>

  <span class="k">def</span> <span class="nf">welcome_email</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:user</span><span class="p">]</span>
    <span class="vi">@url</span>  <span class="o">=</span> <span class="s1">'http://example.com/login'</span>
    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
         <span class="ss">subject: </span><span class="s1">'Welcome to My Awesome Site'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">render</span> <span class="s1">'another_template'</span> <span class="p">}</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">text</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">plain: </span><span class="s1">'Render text'</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre>
</div>
<p>Это отрендерит шаблон &#39;another_template.html.erb&#39; для HTML части и использует &#39;Render text&#39; для текстовой части. Команда <code>render</code> та же самая, что используется в Action Controller, поэтому можете использовать те же опции, такие как <code>:text</code>, <code>:inline</code> и т.д.</p><p>Если хотите отрендерить шаблон, расположенный вне директории по умолчанию <code>app/views/mailer_name/</code>, можно применить <a href="https://api.rubyonrails.org/classes/ActionView/ViewPaths/ClassMethods.html#method-i-prepend_view_path"><code>prepend_view_path</code></a>, следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="n">prepend_view_path</span> <span class="s2">"custom/path/to/mailer/view"</span>

  <span class="c1"># Это попытается загрузить шаблон "custom/path/to/mailer/view/welcome_email"</span>
  <span class="k">def</span> <span class="nf">welcome_email</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Также рассмотрите использование метода <a href="https://api.rubyonrails.org/classes/ActionView/ViewPaths/ClassMethods.html#method-i-append_view_path"><code>append_view_path</code></a> method.</p><h5 id='keshirovanie-vyu-rassylschika' class='inside_page_header'><a href="#keshirovanie-vyu-rassylschika">2.4.1.</a> Кэширование вью рассыльщика</h5><p>Во вью рассыльщика можно выполнять кэширование фрагментов так же, как и во вью приложения, с помощью метода <code>cache</code>.</p><div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="n">cache</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="vi">@company</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
</div>
<p>И чтобы использовать эту особенность, необходимо настроить приложение следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">perform_caching</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
</div>
<p>Кэширование фрагментов также поддерживается в multipart письмах.
Подробнее читайте в руководстве <a href="/caching-with-rails">Кэширование с Rails: Обзор</a>.</p><h4 id='makety-action-mailer' class='inside_page_header'><a href="#makety-action-mailer">2.5.</a> Макеты Action Mailer</h4><p>Как и во вью контроллера, можно также иметь макеты рассыльщика. Имя макета должно быть таким же, как у вашего рассыльщика, таким как <code>user_mailer.html.erb</code> и <code>user_mailer.text.erb</code>, чтобы автоматически распознаваться вашим рассыльщиком как макет.</p><p>Чтобы использовать другой файл, вызовите <a href="https://api.rubyonrails.org/classes/ActionView/Layouts/ClassMethods.html#method-i-layout"><code>layout</code></a> в своем рассыльщике:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="n">layout</span> <span class="s1">'awesome'</span> <span class="c1"># использовать awesome.(html|text).erb как макет</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Подобно вью контроллера, используйте <code>yield</code> для рендеринга вью внутри макета.</p><p>Также можно передать опцию <code>layout: &#39;layout_name&#39;</code> в вызов render в формате блока, чтобы определить различные макеты для различных форматов:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="k">def</span> <span class="nf">welcome_email</span>
    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="n">params</span><span class="p">[</span><span class="ss">:user</span><span class="p">].</span><span class="nf">email</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">layout: </span><span class="s1">'my_layout'</span> <span class="p">}</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">text</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Отрендерит часть в HTML, используя файл <code>my_layout.html.erb</code>, и текстовую часть с обычным файлом <code>user_mailer.text.erb</code>, если он существует.</p><h4 id='predprosmotr-pisem' class='inside_page_header'><a href="#predprosmotr-pisem">2.6.</a> Предпросмотр писем</h4><p>Предпросмотр Action Mailer предоставляет способ увидеть, как выглядят письма, посетив специальный URL, который отображает их. В приведенном выше примере, класс предпросмотра для <code>UserMailer</code> должен называться <code>UserMailerPreview</code> и находится в <code>test/mailers/previews/user_mailer_preview</code>. Чтобы увидеть предпросмотр <code>welcome_email</code>, реализуйте метод с таким же именем и вызовом <code>UserMailer.welcome_email</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UserMailerPreview</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Preview</span>
  <span class="k">def</span> <span class="nf">welcome_email</span>
    <span class="no">UserMailer</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="ss">user: </span><span class="no">User</span><span class="p">.</span><span class="nf">first</span><span class="p">).</span><span class="nf">welcome_email</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Тогда предпросмотр будет доступно по адресу <a href="http://localhost:3000/rails/mailers/user_mailer/welcome_email">http://localhost:3000/rails/mailers/user_mailer/welcome_email</a>.</p><p>Если вы поменяете что-то в <code>app/views/user_mailer/welcome_email.html.erb</code> или в самом рассыльщике, это автоматически перезагрузится и отрендерится, таким образом, вы можете увидеть новые стили мгновенно. Список для предпросмотра также доступен по адресу <a href="http://localhost:3000/rails/mailers">http://localhost:3000/rails/mailers</a>.</p><p>По умолчанию, классы предпросмотра находятся в <code>test/mailers/previews</code>. Это может быть изменено с помощью опции <code>preview_paths</code>. Например, если вы добавить к ним <code>lib/mailer_previews</code>, вы можете указать в <code>config/application.rb</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">preview_paths</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/lib/mailer_previews"</span>
</code></pre>
</div>
<h4 id='generiruem-url-vo-vyu-action-mailer' class='inside_page_header'><a href="#generiruem-url-vo-vyu-action-mailer">2.7.</a> Генерируем URL во вью Action Mailer</h4><p>В отличие от контроллеров, экземпляр рассыльщика не может использовать какой-либо контекст относительно входящего запроса, поэтому необходимо предоставить параметр <code>:host</code> самостоятельно.</p><p>Так как <code>:host</code> обычно одинаковый для всего приложения, его можно настроить глобально в <code>config/application.rb</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host: </span><span class="s1">'example.com'</span> <span class="p">}</span>
</code></pre>
</div>
<p>В связи с таким поведением в письме нельзя использовать любые хелперы <code>*_path</code>. Вместо них можно использовать связанные хелперы <code>*_url</code>. Например, вместо использования</p><div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'welcome'</span><span class="p">,</span> <span class="n">welcome_path</span> <span class="cp">%&gt;</span>
</code></pre>
</div>
<p>Нужно использовать:</p><div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'welcome'</span><span class="p">,</span> <span class="n">welcome_url</span> <span class="cp">%&gt;</span>
</code></pre>
</div>
<p>При использовании полного URL ваши ссылки в письмах будут работать.</p><h5 id='generatsiya-url-s-pomoschyu-url_for' class='inside_page_header'><a href="#generatsiya-url-s-pomoschyu-url_for">2.7.1.</a> Генерация URL с помощью <code>url_for</code></h5><p><a href="https://api.rubyonrails.org/classes/ActionView/RoutingUrlFor.html#method-i-url_for"><code>url_for</code></a> генерирует полный URL по умолчанию в шаблонах.</p><p>Если вы не настроили опцию <code>:host</code> глобально, убедитесь, что передали ее в <code>url_for</code>.</p><div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">url_for</span><span class="p">(</span><span class="ss">host: </span><span class="s1">'example.com'</span><span class="p">,</span>
            <span class="ss">controller: </span><span class="s1">'welcome'</span><span class="p">,</span>
            <span class="ss">action: </span><span class="s1">'greeting'</span><span class="p">)</span> <span class="cp">%&gt;</span>
</code></pre>
</div>
<h5 id='generatsiya-url-s-pomoschyu-imenovannyh-marshrutov' class='inside_page_header'><a href="#generatsiya-url-s-pomoschyu-imenovannyh-marshrutov">2.7.2.</a> Генерация URL с помощью именованных маршрутов</h5><p>У клиентов email отсутствует веб-контекст, таким образом у путей нет базового URL для формирования полного веб-адреса. Поэтому следует всегда использовать только вариант <code>*_url</code> именованных маршрутных хелперов.</p><p>Если вы не настроили опцию <code>:host</code> глобально, убедитесь, что передали ее в хелпер URL.</p><div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">host: </span><span class="s1">'example.com'</span><span class="p">)</span> <span class="cp">%&gt;</span>
</code></pre>
</div>
<div class="note"><p>не <code>GET</code> ссылки требуют <a href="https://github.com/rails/rails/blob/main/actionview/app/assets/javascripts">rails-ujs</a> или <a href="https://github.com/rails/jquery-ujs">jQuery UJS</a>
и не будут работать в шаблонах рассыльщика. Они будут заменятся на простые <code>GET</code> запросы.</p></div><h4 id='dobavlenie-kartinok-vo-vyu-action-mailer' class='inside_page_header'><a href="#dobavlenie-kartinok-vo-vyu-action-mailer">2.8.</a> Добавление картинок во вью Action Mailer</h4><p>В отличие от контроллеров, экземпляр рассыльщика не может использовать какой-либо контекст относительно входящего запроса, поэтому необходимо предоставить параметр <code>:asset_host</code> самостоятельно.</p><p>Так как <code>:asset_host</code> обычно одинаковый для всего приложения, его можно настроить глобально в <code>config/application.rb</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">asset_host</span> <span class="o">=</span> <span class="s1">'http://example.com'</span>
</code></pre>
</div>
<p>Теперь вы можете отображать картинки внутри вашего письма.</p><div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="s1">'image.jpg'</span> <span class="cp">%&gt;</span>
</code></pre>
</div>
<h4 id='rassylka-multipart-email' class='inside_page_header'><a href="#rassylka-multipart-email">2.9.</a> Рассылка multipart email</h4><p>Action Mailer автоматически посылает multipart email, если имеются разные шаблоны для одного и того же экшна. Таким образом, для нашего примера <code>UserMailer</code>, если есть <code>welcome_email.text.erb</code> и <code>welcome_email.html.erb</code> в <code>app/views/user_mailer</code>, то Action Mailer автоматически пошлет multipart email с версиями HTML и текстовой, настроенными как разные части.</p><p>Порядок, в котором части будут вставлены, определяется <code>:parts_order</code> в методе <code>ActionMailer::Base.default</code>.</p><h4 id='rassylka-pisem-s-dinamicheskimi-optsiyami-dostavki' class='inside_page_header'><a href="#rassylka-pisem-s-dinamicheskimi-optsiyami-dostavki">2.10.</a> Рассылка писем с динамическими опциями доставки</h4><p>Если хотите переопределить опции доставки по умолчанию (т.е. учетные данные SMTP) во время доставки писем, можно использовать <code>delivery_method_options</code> в экшне рассыльщика.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="k">def</span> <span class="nf">welcome_email</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:user</span><span class="p">]</span>
    <span class="vi">@url</span>  <span class="o">=</span> <span class="n">user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">delivery_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">user_name: </span><span class="n">params</span><span class="p">[</span><span class="ss">:company</span><span class="p">].</span><span class="nf">smtp_user</span><span class="p">,</span>
                         <span class="ss">password: </span><span class="n">params</span><span class="p">[</span><span class="ss">:company</span><span class="p">].</span><span class="nf">smtp_password</span><span class="p">,</span>
                         <span class="ss">address: </span><span class="n">params</span><span class="p">[</span><span class="ss">:company</span><span class="p">].</span><span class="nf">smtp_host</span> <span class="p">}</span>
    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
         <span class="ss">subject: </span><span class="s2">"Please see the Terms and Conditions attached"</span><span class="p">,</span>
         <span class="ss">delivery_method_options: </span><span class="n">delivery_options</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='rassylka-pisem-bez-renderinga-shablona' class='inside_page_header'><a href="#rassylka-pisem-bez-renderinga-shablona">2.11.</a> Рассылка писем без рендеринга шаблона</h4><p>Бывают ситуации, когда вы хотите пропустить шаг рендеринга шаблона и предоставить тело письма, как строку. Это достигается с использованием опции <code>:body</code>. В таком случае, не забудьте добавить опцию <code>:content_type</code>. Иначе Rails использует по умолчанию <code>text/plain</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="k">def</span> <span class="nf">welcome_email</span>
    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="n">params</span><span class="p">[</span><span class="ss">:user</span><span class="p">].</span><span class="nf">email</span><span class="p">,</span>
         <span class="ss">body: </span><span class="n">params</span><span class="p">[</span><span class="ss">:email_body</span><span class="p">],</span>
         <span class="ss">content_type: </span><span class="s2">"text/html"</span><span class="p">,</span>
         <span class="ss">subject: </span><span class="s2">"Already rendered!"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<h3 id='kolbeki-action-mailer' class='inside_page_header'><a href="#kolbeki-action-mailer">3.</a> Колбэки Action Mailer</h3><p>Action Mailer позволяет определить <a href="https://api.rubyonrails.org/classes/AbstractController/Callbacks/ClassMethods.html#method-i-before_action"><code>before_action</code></a>, <a href="https://api.rubyonrails.org/classes/AbstractController/Callbacks/ClassMethods.html#method-i-after_action"><code>after_action</code></a> и <a href="https://api.rubyonrails.org/classes/AbstractController/Callbacks/ClassMethods.html#method-i-around_action"><code>around_action</code></a>.</p><ul><li><p>Фильтры могут быть определены в блоке или символом с именем метода рассыльщика, подобно контроллерам.</p></li><li><p><code>before_action</code> можно использовать для присвоения переменным экземпляра, заполнения объекта mail значениями по умолчанию или вставки дефолтных заголовков и прикрепленных файлов.</p></li></ul><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">InvitationsMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="n">before_action</span> <span class="ss">:set_inviter_and_invitee</span>
  <span class="n">before_action</span> <span class="p">{</span> <span class="vi">@account</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:inviter</span><span class="p">].</span><span class="nf">account</span> <span class="p">}</span>

  <span class="n">default</span> <span class="ss">to:       </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="vi">@invitee</span><span class="p">.</span><span class="nf">email_address</span> <span class="p">},</span>
          <span class="ss">from:     </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="n">common_address</span><span class="p">(</span><span class="vi">@inviter</span><span class="p">)</span> <span class="p">},</span>
          <span class="ss">reply_to: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="vi">@inviter</span><span class="p">.</span><span class="nf">email_address_with_name</span> <span class="p">}</span>

  <span class="k">def</span> <span class="nf">account_invitation</span>
    <span class="n">mail</span> <span class="ss">subject: </span><span class="s2">"</span><span class="si">#{</span><span class="vi">@inviter</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2"> invited you to their Basecamp (</span><span class="si">#{</span><span class="vi">@account</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">)"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">project_invitation</span>
    <span class="vi">@project</span>    <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:project</span><span class="p">]</span>
    <span class="vi">@summarizer</span> <span class="o">=</span> <span class="no">ProjectInvitationSummarizer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@project</span><span class="p">.</span><span class="nf">bucket</span><span class="p">)</span>

    <span class="n">mail</span> <span class="ss">subject: </span><span class="s2">"</span><span class="si">#{</span><span class="vi">@inviter</span><span class="p">.</span><span class="nf">name</span><span class="p">.</span><span class="nf">familiar</span><span class="si">}</span><span class="s2"> added you to a project in Basecamp (</span><span class="si">#{</span><span class="vi">@account</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">)"</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">set_inviter_and_invitee</span>
    <span class="vi">@inviter</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:inviter</span><span class="p">]</span>
    <span class="vi">@invitee</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:invitee</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<ul><li><p><code>after_action</code> можно использовать для подобной настройки, как и в <code>before_action</code>, но используя переменные экземпляра, установленные в экшне рассыльщика.</p></li><li><p>Использование колбэка <code>after_action</code> также позволяет переопределить настройки метода доставки, обновляя <code>mail.delivery_method.settings</code>.</p></li></ul><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="n">before_action</span> <span class="p">{</span> <span class="vi">@business</span><span class="p">,</span> <span class="vi">@user</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:business</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="ss">:user</span><span class="p">]</span> <span class="p">}</span>

  <span class="n">after_action</span> <span class="ss">:set_delivery_options</span><span class="p">,</span>
               <span class="ss">:prevent_delivery_to_guests</span><span class="p">,</span>
               <span class="ss">:set_business_headers</span>

  <span class="k">def</span> <span class="nf">feedback_message</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">campaign_message</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">set_delivery_options</span>
      <span class="c1"># Тут у вас есть доступ к экземпляру mail и переменным экземпляра</span>
      <span class="c1"># @business и @user</span>
      <span class="k">if</span> <span class="vi">@business</span> <span class="o">&amp;&amp;</span> <span class="vi">@business</span><span class="p">.</span><span class="nf">has_smtp_settings?</span>
        <span class="n">mail</span><span class="p">.</span><span class="nf">delivery_method</span><span class="p">.</span><span class="nf">settings</span><span class="p">.</span><span class="nf">merge!</span><span class="p">(</span><span class="vi">@business</span><span class="p">.</span><span class="nf">smtp_settings</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">prevent_delivery_to_guests</span>
      <span class="k">if</span> <span class="vi">@user</span> <span class="o">&amp;&amp;</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">guest?</span>
        <span class="n">mail</span><span class="p">.</span><span class="nf">perform_deliveries</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">set_business_headers</span>
      <span class="k">if</span> <span class="vi">@business</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">"X-SMTPAPI-CATEGORY"</span><span class="p">]</span> <span class="o">=</span> <span class="vi">@business</span><span class="p">.</span><span class="nf">code</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<ul><li>Фильтры рассыльщика прерывают дальнейшую обработку, если body установлено в не-nil значение.
</li></ul><h3 id='ispolzovanie-helperov-action-mailer' class='inside_page_header'><a href="#ispolzovanie-helperov-action-mailer">4.</a> Использование хелперов Action Mailer</h3><p>Action Mailer наследуется от <code>AbstractController</code>, поэтому у вас есть доступ к тем же общим хелперам, как и в Action Controller.</p><p>также есть несколько специфичных для Action Mailer вспомогательных методов, доступных в <a href="https://api.rubyonrails.org/classes/ActionMailer/MailHelper.html"><code>ActionMailer::MailHelper</code></a>. Например, позволяют получить доступ к экземпляру рассыльщика с помощью <a href="https://api.rubyonrails.org/classes/ActionMailer/MailHelper.html#method-i-mailer"><code>mailer</code></a>, и к сообщению как <a href="https://api.rubyonrails.org/classes/ActionMailer/MailHelper.html#method-i-message"><code>message</code></a>:</p><div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="n">mailer</span><span class="p">.</span><span class="nf">name</span><span class="p">.</span><span class="nf">underscore</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="n">message</span><span class="p">.</span><span class="nf">subject</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
</code></pre>
</div>
<h3 id='action-mailer-configuration' class='inside_page_header'><a href="#action-mailer-configuration">5.</a> Настройка Action Mailer</h3><p>Следующие конфигурационные опции лучше всего делать в одном из файлов среды разработки (environment.rb, production.rb, и т.д...)</p><table class='table table-striped'><tr>
<th>Конфигурация</th>
<th>Описание</th>
</tr>
<tr>
<td><code>logger</code></td>
<td>logger используется для генерации информации на ходу, если возможно. Можно установить как <code>nil</code> для отсутствия логирования. Совместим как с <code>Logger</code> в Ruby, так и с логгером <code>Log4r</code>.</td>
</tr>
<tr>
<td><code>smtp_settings</code></td>
<td>Позволяет подробную настройку для метода доставки <code>:smtp</code>:<ul><li><code>:address</code> - Позволяет использовать удаленный почтовый сервер. Просто измените его изначальное значение &quot;localhost&quot;.</li><li><code>:port</code> - В случае, если почтовый сервер не работает с 25 портом, можете изменить его.</li><li><code>:domain</code> - Если необходимо определить домен HELO, это можно сделать здесь.</li><li><code>:user_name</code> - Если почтовый сервер требует аутентификацию, установите имя пользователя этой настройкой.</li><li><code>:password</code> - Если почтовый сервер требует аутентификацию, установите пароль этой настройкой. </li><li><code>:authentication</code> - Если почтовый сервер требует аутентификацию, здесь нужно определить тип аутентификации. Это один из символов <code>:plain</code> (будет отправлять пароль в открытом виде), <code>:login</code> (будет отправлять пароль закодированным Base64) или <code>:cram_md5</code> (сочетает в себе механизм Challenge/Response для обмена информацией и криптографический алгоритм MD5 (Message Digest 5) хэширования важной информации)</li><li><code>:enable_starttls_auto</code> - Определяет, включен ли STARTTLS в вашем SMTP сервере и будет использовать это. По умолчанию, <code>true</code>.</li><li><code>:openssl_verify_mode</code> - При использовании TLS, вы можете установить, как OpenSSL проверяет сертификат. Это действительно полезно, если вам нужно производить проверку самостоятельно созданного и/или группового сертификата. Вы можете использовать название проверяющей константы OpenSSL (&#39;none&#39; или &#39;peer&#39;) или непосредственно константу (<code>OpenSSL::SSL::VERIFY_NONE</code> или <code>OpenSSL::SSL::VERIFY_PEER</code>).</li><li><code>:ssl/:tls</code> - Включает для соединения SMTP использование SMTP/TLS (SMTPS: SMTP над прямым соединением TLS)</li><li><code>:open_timeout</code> - Количество секунд ожидания попыток открыть соединение.</li><li><code>:read_timeout</code> - Количество секунд ожидания до вызова таймаута в read(2).</li></ul></td>
</tr>
<tr>
<td><code>sendmail_settings</code></td>
<td>Позволяет переопределить опции для метода доставки <code>:sendmail</code>.<ul><li><code>:location</code> - Место расположения исполняемого sendmail. По умолчанию <code>/usr/sbin/sendmail</code>.</li><li><code>:arguments</code> - Аргументы командной строки. По умолчанию [<code>-i</code>].</li></ul></td>
</tr>
<tr>
<td><code>raise_delivery_errors</code></td>
<td>Должны ли быть вызваны ошибки, если email не может быть доставлен. Это работает, если внешний сервер email настроен на немедленную доставку. По умолчанию <code>true</code>.</td>
</tr>
<tr>
<td><code>delivery_method</code></td>
<td>Определяет метод доставки. Возможные значения: <ul><li><code>:smtp</code> (по умолчанию), может быть настроен с помощью <a href="/configuring#config-action-mailer-smtp-settings"><code>config.action_mailer.smtp_settings</code></a>.</li><li><code>:sendmail</code>, может быть настроен с помощью <a href="/configuring#config-action-mailer-sendmail-settings"><code>config.action_mailer.sendmail_settings</code></a>.</li><li><code>:file</code>: сохраняет письма в файлы; может быть настроен с помощью <code>config.action_mailer.file_settings</code>.</li><li><code>:test</code>: сохраняет письма в массив <code>ActionMailer::Base.deliveries</code>.</li></ul>Подробнее смотрите в <a href="https://api.rubyonrails.org/classes/ActionMailer/Base.html">API docs</a>.</td>
</tr>
<tr>
<td><code>perform_deliveries</code></td>
<td>Определяет, должны ли методы deliver_* фактически выполняться. По умолчанию должны, но это можно отключить для функционального тестирования. Если это значение <code>false</code>, массив <code>deliveries</code> не будет заполняться, даже если <code>delivery_method</code> это <code>:test</code>.</td>
</tr>
<tr>
<td><code>deliveries</code></td>
<td>Содержит массив всех электронных писем, отправленных через Action Mailer с помощью delivery_method :test. Очень полезно для юнит- и функционального тестирования.</td>
</tr>
<tr>
<td><code>delivery_job</code></td>
<td>Класс задания, используемый для <code>deliver_later</code>. По умолчанию <code>ActionMailer::MailDeliveryJob</code>.</td>
</tr>
<tr>
<td><code>deliver_later_queue_name</code></td>
<td>Имя очереди, используемой для <code>deliver_later</code>.</td>
</tr>
<tr>
<td><code>default_options</code></td>
<td>Позволит вам установить значения по умолчанию для опций метода <code>mail</code> (<code>:from</code>, <code>:reply_to</code> и т.д.).</td>
</tr>
</table><p>Подробное описание возможных конфигураций смотрите в <a href="/configuring#configuring-action-mailer">разделе про настройку Action Mailer</a> нашего руководства по конфигурированию приложений на Rails.</p><h4 id='primer-nastroyki-action-mailer' class='inside_page_header'><a href="#primer-nastroyki-action-mailer">5.1.</a> Пример настройки Action Mailer</h4><p>Примером может быть добавление следующего в подходящий файл <code>config/environments/$RAILS_ENV.rb</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:sendmail</span>
<span class="c1"># Defaults to:</span>
<span class="c1"># config.action_mailer.sendmail_settings = {</span>
<span class="c1">#   location: '/usr/sbin/sendmail',</span>
<span class="c1">#   arguments: %w[ -i ]</span>
<span class="c1"># }</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">perform_deliveries</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">raise_delivery_errors</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">default_options</span> <span class="o">=</span> <span class="p">{</span><span class="ss">from: </span><span class="s1">'no-reply@example.com'</span><span class="p">}</span>
</code></pre>
</div>
<h4 id='nastroyka-action-mailer-dlya-gmail' class='inside_page_header'><a href="#nastroyka-action-mailer-dlya-gmail">5.2.</a> Настройка Action Mailer для Gmail</h4><p>Action Mailer использует <a href="https://github.com/mikel/mail">гем Mail</a> и принимает похожую конфигурацию. Добавьте это в свой файл <code>config/environments/$RAILS_ENV.rb</code>, чтобы посылать через Gmail:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">smtp_settings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">address:         </span><span class="s1">'smtp.gmail.com'</span><span class="p">,</span>
  <span class="ss">port:            </span><span class="mi">587</span><span class="p">,</span>
  <span class="ss">domain:          </span><span class="s1">'example.com'</span><span class="p">,</span>
  <span class="ss">user_name:       </span><span class="s1">'&lt;username&gt;'</span><span class="p">,</span>
  <span class="ss">password:        </span><span class="s1">'&lt;password&gt;'</span><span class="p">,</span>
  <span class="ss">authentication:  </span><span class="s1">'plain'</span><span class="p">,</span>
  <span class="ss">enable_starttls: </span><span class="kp">true</span><span class="p">,</span>
  <span class="ss">open_timeout:    </span><span class="mi">5</span><span class="p">,</span>
  <span class="ss">read_timeout:    </span><span class="mi">5</span> <span class="p">}</span>
</code></pre>
</div>
<p>Если используется старая версия гема Mail (2.6.x или ранняя), используйте <code>enable_starttls_auto</code> вместо <code>enable_starttls</code>.</p><div class="note"><p>Google <a href="https://support.google.com/accounts/answer/6010255">блокирует вход</a> от приложений, которые они считают менее безопасным. Вы можете изменить ваши настройки gmail <a href="https://www.google.com/settings/security/lesssecureapps">здесь</a>, чтобы позволить попытки. Если ваша учетная запись Gmail активирована с использованием двухфакторной аутентификации, вам нужно будет установить <a href="https://myaccount.google.com/apppasswords">пароль приложения</a> и использовать ее вместо обычного пароля.</p></div><h3 id='testirovanie-rassylschika' class='inside_page_header'><a href="#testirovanie-rassylschika">6.</a> Тестирование рассыльщика</h3><p>Подробные инструкции, как тестировать ваши рассыльщики, можно найти в руководстве <a href="testing#testing-your-mailers">Тестирование приложений на Rails</a></p><h3 id='perehvat-i-obzor-pisem' class='inside_page_header'><a href="#perehvat-i-obzor-pisem">7.</a> Перехват и обзор писем</h3><p>Action Mailer предоставляет хуки в методы обозревателя и перехватчика Mail. Они позволяют зарегистрировать классы, которые будут вызваны в течение жизненного цикла доставки письма каждого посланного письма.</p><h4 id='perehvat-pisem' class='inside_page_header'><a href="#perehvat-pisem">7.1.</a> Перехват писем</h4><p>Перехватчики позволяют сделать изменения в письма перед тем, как они будут переданы агентам доставки. Класс перехватчика должен реализовывать метод <code>::delivering_email(message)</code>, который будет вызван перед отправкой письма.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">SandboxEmailInterceptor</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">delivering_email</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">message</span><span class="p">.</span><span class="nf">to</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'sandbox@example.com'</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Прежде чем перехватчик сможет выполнить свое задание, необходимо зарегистрировать его с помощью конфигурационной опции <code>interceptors</code>. Это можно сделать в файле инициализатора. наподобие <code>config/initializers/mail_interceptors.rb</code></p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">staging?</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">interceptors</span> <span class="o">=</span> <span class="sx">%w[SandboxEmailInterceptor]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="note"><p>Вышеприведенный пример использует пользовательское окружение по имени &quot;staging&quot; для сервера, похожего на production, но для целей тестирования. Подробнее о пользовательских окружениях в Rails можно прочитать в <a href="/configuring#creating-rails-environments">Создание сред Rails</a>.</p></div><h4 id='obzor-pisem' class='inside_page_header'><a href="#obzor-pisem">7.2.</a> Обзор писем</h4><p>Обозреватели дают доступ к сообщению письма после его отправки. Класс обозревателя должен реализовывать метод <code>:delivered_email(message)</code>, который будет вызван после отправки письма.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">EmailDeliveryObserver</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">delivered_email</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="no">EmailDelivery</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Подобно перехватчикам, обозреватели нужно зарегистрировать с помощью конфигурационной опции <code>observers</code>. Это можно сделать в файле инициализатора, наподобие <code>config/initializers/mail_observers.rb</code></p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">observers</span> <span class="o">=</span> <span class="sx">%w[EmailDeliveryObserver]</span>
<span class="k">end</span>
</code></pre>
</div>


            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

   <!-- bottom rusrails -->
   <ins class="adsbygoogle"
        style="display:inline-block;width:580px;height:400px"
        data-ad-client="ca-pub-7764391801669990"
        data-ad-slot="7566253867"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
        </div>
        <div class="row-fluid">
          <div class="span12" id="footer">
            <p>
              <a target="blank" href="https://github.com/rusrails/rusrails"><img src="/assets/github-7cc23602a5ac2465f14c19492358a5a67dc24636761cc723e4d621cea0c09225.png" /></a>
              <a target="blank" href="http://twitter.com/rusrails"><img src="/assets/twitter-50e0e767c8793dec313a7dc5cfbcfe2067e3e89ea6ec64784eb7c6640f578758.png" /></a>
            </p>
            <p>
              <a href="https://creativecommons.org/licenses/by-sa/4.0/">Лицензия CC BY-SA 4.0</a>
              "Rails", "Ruby on Rails" и логотип Rails - торговые марки DHH
              <!-- Yandex.Metrika counter -->
<script>
  (function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter1006929 = new Ya.Metrika({id:1006929,
                    webvisor:true,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true});
        } catch(e) { }
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>

<noscript>
  <div>
    <img style="position:absolute; left:-9999px;" alt="" src="//mc.yandex.ru/watch/1006929" />
  </div>
</noscript>
<!-- /Yandex.Metrika counter -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64955373-1', 'auto');
  ga('send', 'pageview');

  var trackOutboundLink = function(url) {
    ga('send', 'event', 'outbound', 'click', url, {
      'transport': 'beacon',
      'hitCallback': function(){ }
    });
  }
</script>

            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="to_top" style="display: block">
      <div class="to_top_panel"></div>
    </div>
    <script src="/assets/application-8ee447905888b153d8458707061a14b1f15f69b6733e871a3ad91d80ae89e87b.js"></script>
  </body>
</html>
