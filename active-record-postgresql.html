<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8">
<meta content="Ruby on Rails, Ruby, Rails, Rails 3, Rails 4, Rails 5, Rails 6, Rails 6.0, Rails 6.1, Rails 7.0, Rails 7.1 руководство, начинающим, самоучитель, manual, мануал, справочник, учебник, примеры, Руби, рельсы" name="keywords"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" name="description"/>
<meta content="product" property="twitter:card"/>
<meta content="@rusrails" property="twitter:site"/>
<meta content="Rusrails: Active Record для PostgreSQL" property="twitter:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="twitter:description"/>
<meta content="@rusrails" property="twitter:creator"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="twitter:image"/>
<meta content="website" property="og:type"/>
<meta content="Rusrails: Active Record для PostgreSQL" property="og:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="og:description"/>
<meta content="http://localhost:3000/active-record-postgresql" property="og:url"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="og:image"/>
    <title>
      Rusrails: Active Record для PostgreSQL
    </title>
    <link rel="stylesheet" media="screen" href="/assets/application-4f65588939909a694017a295c9ca934821f6a6358454c26c5360579d7ee0054d.css" />
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="/"></a>
          <ul class="nav pull-right top-menu">
            <li>
              <a href="/">Главная</a>
            </li>
            <li class="dropdown">
              <a class="index-popover" href="#">
                Содержание
                <b class="caret"></b>
</a>              <div class="index-popover-content hide">
                  <ul><li><p><strong>С чего начать?</strong></p><ul><li><a href="/getting-started">Rails для начинающих</a>
</li></ul></li><li><p><strong>Модели</strong></p><ul><li><a href="/active-record-basics">Основы Active Record</a>
</li><li><a href="/active-record-migrations">Миграции Active Record</a>
</li><li><a href="/active-record-validations">Валидации Active Record</a>
</li><li><a href="/active-record-callbacks">Колбэки Active Record</a>
</li><li><a href="/active-record-associations">Связи (ассоциации) Active Record</a>
</li><li><a href="/active-record-querying">Интерфейс запросов Active Record</a>
</li><li><a href="/active-model-basics">Основы Active Model</a>
</li></ul></li><li><p><strong>Вью</strong></p><ul><li><a href="/action-view-overview">Обзор Action View</a>
</li><li><a href="/layouts-and-rendering">Макеты и рендеринг в Rails</a>
</li><li><a href="/action-view-helpers">Хелперы Action View</a>
</li><li><a href="/form-helpers">Хелперы форм в Action View</a>
</li></ul></li><li><p><strong>Контроллеры</strong></p><ul><li><a href="/action-controller-overview">Обзор Action Controller</a>
</li><li><a href="/routing">Роутинг в Rails</a>
</li></ul></li><li><p><strong>Другие компоненты</strong></p><ul><li><a href="/active-support-core-extensions">Расширения ядра Active Support</a>
</li><li><a href="/action-mailer-basics">Основы Action Mailer</a>
</li><li><a href="/action-mailbox-basics">Основы Action Mailbox</a>
</li><li><a href="/action-text-overview">Обзор Action Text</a>
</li><li><a href="/active_job_basics">Основы Active Job</a>
</li><li><a href="/active_storage_overview">Обзор Active Storage</a>
</li><li><a href="/action-cable-overview">Обзор Action Cable</a>
</li></ul></li><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/i18n">API интернационализации Rails (I18n)</a>
</li><li><a href="/testing">Тестирование приложений на Rails</a>
</li><li><a href="/security">Безопасность приложений на Rails</a>
</li><li><a href="/error-reporting">Отчет об ошибках в приложениях Rails</a>
</li></ul></li></ul><p>next_column</p><ul><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/debugging-rails-applications">Отладка приложений на Rails</a>
</li><li><a href="/configuring">Конфигурирование приложений на Rails</a>
</li><li><a href="/command-line">Командная строка Rails</a>
</li><li><a href="/asset-pipeline">Asset Pipeline</a>
</li><li><a href="/working-with-javascript-in-rails">Работа с JavaScript в Rails</a>
</li><li><a href="/initialization">Процесс инициализации в Rails</a>
</li><li><a href="/autoloading-and-reloading-constants">Автозагрузка и перезагрузка констант</a>
</li><li><a href="/classic-to-zeitwerk-howto">Как перейти с Classic на Zeitwerk</a>
</li><li><a href="/caching-with-rails">Кэширование с Rails: Обзор</a>
</li><li><a href="/active-support-instrumentation">Инструментарий Active Support</a>
</li><li><a href="/api-app">Использование Rails для API-приложений</a>
</li><li><a href="/active-record-postgresql">Active Record для PostgreSQL</a>
</li><li><a href="/active-record-multiple-databases">Несколько баз данных с Active Record</a>
</li><li><a href="/active-record-encryption">Шифрование Active Record</a>
</li></ul></li><li><p><strong>Расширяем Rails</strong></p><ul><li><a href="/plugins">Основы создания плагинов Rails</a>
</li><li><a href="/rails-on-rack">Rails on Rack</a>
</li><li><a href="/generators">Создание и настройка генераторов и шаблонов Rails</a>
</li><li><a href="/engines">Engine для начинающих</a>
</li><li><a href="/threading_and_code_execution">Треды и выполнение кода в Rails</a>
</li><li><a href="/rails-application-templates">Шаблоны приложения Rails</a>
</li></ul></li><li><p><strong>Вносим вклад в Ruby on Rails</strong></p><ul><li><a href="/contributing_to_ruby_on_rails">Вносим вклад в Ruby on Rails</a>
</li><li><a href="/api_documentation_guidelines">Рекомендации по документированию API</a>
</li><li><a href="/ruby_on_rails_guides_guidelines">Рекомендации для руководств по Ruby on Rails</a>
</li><li><a href="/development_dependencies_install">Установка зависимостей для разработки</a>
</li><li><a href="/maintenance-policy">Политика поддержки (версий)</a>
</li></ul></li><li><p><strong>Заметки о релизах</strong></p><ul><li><a href="/upgrading-ruby-on-rails">Апгрейд Ruby on Rails</a>
</li><li><a href="/7_1_release_notes">Версия 7.1 - ?</a>
</li><li><a href="/7_0_release_notes">Версия 7.0 - Декабрь 2021</a>
</li><li><a href="/6_1_release_notes">Версия 6.1 - Декабрь 2020</a>
</li><li><a href="/6_0_release_notes">Версия 6.0 - Август 2019</a>
</li></ul></li></ul>
              </div>
            </li>
            <li>
              <a href="/search">Поиск</a>
            </li>
            <li>
              <a target="blank" href="http://api.rusrails.ru">Ruby &amp; Rails API</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="content-wrapper">
      <div class="container-fluid">
        <div class="row-fluid">
          <div class="span3 pull-right">
            <div class="well social">
              <h4>Принимаем пожелания и пул-реквесты!</h4>
              <iframe allowtransparency="true" frameborder="0" height="30" src="http://ghbtns.com/github-btn.html?user=rusrails&repo=rusrails&type=watch&count=true&size=large" width="180"></iframe>
              <p></p>
              <a class="twitter-follow-button" data-lang="ru" href="https://twitter.com/rusrails"></a>
            </div>
              <div class="well menu">
                    <ul class="nav nav-list">
      <li>
        <h4>
          <a href="#tipy-dannyh">1. Типы данных</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#dvoichnye-tipy-dannyh">1.1. Двоичные типы данных</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#massivy">1.2. Массивы</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#hstore">1.3. Hstore</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#json-i-jsonb">1.4. JSON и JSONB</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#diapazonnye-tipy">1.5. Диапазонные типы</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#sostavnye-tipy">1.6. Составные типы</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#tipy-perechisleniy">1.7. Типы перечислений</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#tip-uuid">1.8. Тип UUID</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#bitovye-stroki">1.9. Битовые строки</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#tipy-opisyvayuschie-setevye-adresa">1.10. Типы, описывающие сетевые адреса</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#geometricheskie-tipy">1.11. Геометрические типы</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#interval">1.12. Интервал</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#uuid-primary-keys">2.  Первичные ключи UUID</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#generiruemye-stolbtsy">3. Генерируемые столбцы</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#otlozhennye-vneshnie-klyuchi">4. Отложенные внешние ключи</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#polnotekstovyy-poisk">5. Полнотекстовый поиск</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#predstavlenie-bazy-dannyh">6. Представление базы данных</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#vygruzki-struktury">7. Выгрузки структуры</a>
</h4>      </li>
</ul>

              </div>
            <div class="well banner300 banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<!-- sidebar rusrails -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:600px"
     data-ad-client="ca-pub-7764391801669990"
     data-ad-slot="6089520660"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
          <div class="span9 content pull-left">
            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <!-- top rusrails -->
  <ins class="adsbygoogle"
       style="display:inline-block;width:980px;height:120px"
       data-ad-client="ca-pub-7764391801669990"
       data-ad-slot="4891989065"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
              <h2 id='active-record-dlya-postgresql' class='inside_page_header'> Active Record для PostgreSQL</h2><p>Данное руководство рассказывает о специфике использования PostgreSQL с Active Record.</p><p>После прочтения этого руководства, вы узнаете о том:</p><ul><li>Как использовать типы данных PostgreSQL.
</li><li>Как использовать первичные ключи UUID.
</li><li>Как использовать отложенные внешние ключи.
</li><li>Как реализовать полнотекстовый поиск с помощью PostgreSQL.
</li><li>Как возвращать ваши модели Active Record, используя представление базы данных.
</li></ul>
<hr>
<p>Для использования адаптера PostgreSQL необходимо установить как минимум версию 9.3.
Предыдущие версии не поддерживаются.</p><p>Для начала работы с PostgreSQL почитайте руководство <a href="/configuring#konfigurirovanie-bazy-dannyh-postgresql">Конфигурирование приложений на Rails</a>.
Там описано как правильно настроить Active Record для PostgreSQL.</p><h3 id='tipy-dannyh' class='inside_page_header'><a href="#tipy-dannyh">1.</a> Типы данных</h3><p>PostgreSQL предлагает достаточное количество специфичных типов данных. Далее представлен список типов, которые поддерживаются адаптером PostgreSQL.</p><h4 id='dvoichnye-tipy-dannyh' class='inside_page_header'><a href="#dvoichnye-tipy-dannyh">1.1.</a> Двоичные типы данных</h4><ul><li><a href="https://postgrespro.ru/docs/postgrespro/current/datatype-binary.html">определение типа</a>
</li><li><a href="https://postgrespro.ru/docs/postgrespro/current/functions-binarystring.html">функции и операторы</a>
</li></ul><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20140207133952_create_documents.rb</span>
<span class="n">create_table</span> <span class="ss">:documents</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">binary</span> <span class="s1">'payload'</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/document.rb</span>
<span class="k">class</span> <span class="nc">Document</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Использование</span>
<span class="n">data</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span> <span class="o">+</span> <span class="s2">"tmp/output.pdf"</span><span class="p">)</span>
<span class="no">Document</span><span class="p">.</span><span class="nf">create</span> <span class="ss">payload: </span><span class="n">data</span>
</code></pre>
</div>
<h4 id='massivy' class='inside_page_header'><a href="#massivy">1.2.</a> Массивы</h4><ul><li><a href="https://postgrespro.ru/docs/postgrespro/current/arrays.html">определение типа</a>
</li><li><a href="https://postgrespro.ru/docs/postgrespro/current/functions-array.html">функции и операторы</a>
</li></ul><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20140207133952_create_books.rb</span>
<span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s1">'title'</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s1">'tags'</span><span class="p">,</span> <span class="ss">array: </span><span class="kp">true</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="s1">'ratings'</span><span class="p">,</span> <span class="ss">array: </span><span class="kp">true</span>
<span class="k">end</span>
<span class="n">add_index</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">:tags</span><span class="p">,</span> <span class="ss">using: </span><span class="s1">'gin'</span>
<span class="n">add_index</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">:ratings</span><span class="p">,</span> <span class="ss">using: </span><span class="s1">'gin'</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/book.rb</span>
<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Использование</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">create</span> <span class="ss">title: </span><span class="s2">"Brave New World"</span><span class="p">,</span>
            <span class="ss">tags: </span><span class="p">[</span><span class="s2">"fantasy"</span><span class="p">,</span> <span class="s2">"fiction"</span><span class="p">],</span>
            <span class="ss">ratings: </span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="c1">## Книги с одним тегом</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"'fantasy' = ANY (tags)"</span><span class="p">)</span>

<span class="c1">## Книги с несколькими тегами</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"tags @&gt; ARRAY[?]::varchar[]"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"fantasy"</span><span class="p">,</span> <span class="s2">"fiction"</span><span class="p">])</span>

<span class="c1">## Книги с рейтингом 3 и более</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"array_length(ratings, 1) &gt;= 3"</span><span class="p">)</span>
</code></pre>
</div>
<h4 id='hstore' class='inside_page_header'><a href="#hstore">1.3.</a> Hstore</h4><ul><li><a href="https://postgrespro.ru/docs/postgrespro/current/hstore.html">определение типа</a>
</li><li><a href="https://postgrespro.ru/docs/postgrespro/current/hstore.html#idm45576084647360">функции и операторы</a>
</li></ul><div class="note"><p>Чтобы использовать hstore, необходимо включить расширение <code>hstore</code>.</p></div><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20131009135255_create_profiles.rb</span>
<span class="k">class</span> <span class="nc">CreateProfiles</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="n">enable_extension</span> <span class="s1">'hstore'</span> <span class="k">unless</span> <span class="n">extension_enabled?</span><span class="p">(</span><span class="s1">'hstore'</span><span class="p">)</span>
  <span class="n">create_table</span> <span class="ss">:profiles</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">hstore</span> <span class="s1">'settings'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/profile.rb</span>
<span class="k">class</span> <span class="nc">Profile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Profile</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">settings: </span><span class="p">{</span> <span class="s2">"color"</span> <span class="o">=&gt;</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="s2">"resolution"</span> <span class="o">=&gt;</span> <span class="s2">"800x600"</span> <span class="p">})</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">profile</span> <span class="o">=</span> <span class="no">Profile</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">profile</span><span class="p">.</span><span class="nf">settings</span>
<span class="p">=&gt;</span> <span class="p">{</span><span class="s2">"color"</span><span class="o">=&gt;</span><span class="s2">"blue"</span><span class="p">,</span> <span class="s2">"resolution"</span><span class="o">=&gt;</span><span class="s2">"800x600"</span><span class="p">}</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">profile</span><span class="p">.</span><span class="nf">settings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"color"</span> <span class="o">=&gt;</span> <span class="s2">"yellow"</span><span class="p">,</span> <span class="s2">"resolution"</span> <span class="o">=&gt;</span> <span class="s2">"1280x1024"</span><span class="p">}</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">profile</span><span class="p">.</span><span class="nf">save!</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Profile</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"settings-&gt;'color' = ?"</span><span class="p">,</span> <span class="s2">"yellow"</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Relation</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Profile</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">settings: </span><span class="p">{</span><span class="s2">"color"</span><span class="o">=</span><span class="kt">&gt;</span><span class="s2">"yellow"</span><span class="p">,</span> <span class="s2">"resolution"</span><span class="o">=</span><span class="kt">&gt;</span><span class="s2">"1280x1024"</span><span class="p">}</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span>
</code></pre>
</div>
<h4 id='json-i-jsonb' class='inside_page_header'><a href="#json-i-jsonb">1.4.</a> JSON и JSONB</h4><ul><li><a href="https://postgrespro.ru/docs/postgrespro/current/datatype-json.html">определение типа</a>
</li><li><a href="https://postgrespro.ru/docs/postgrespro/current/functions-json.html">функции и операторы</a>
</li></ul><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_events.rb</span>
<span class="c1"># ... для типа данных json:</span>
<span class="n">create_table</span> <span class="ss">:events</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">json</span> <span class="s1">'payload'</span>
<span class="k">end</span>
<span class="c1"># ... или для типа данных jsonb:</span>
<span class="n">create_table</span> <span class="ss">:events</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">jsonb</span> <span class="s1">'payload'</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/event.rb</span>
<span class="k">class</span> <span class="nc">Event</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Event</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">payload: </span><span class="p">{</span> <span class="ss">kind: </span><span class="s2">"user_renamed"</span><span class="p">,</span> <span class="ss">change: </span><span class="p">[</span><span class="s2">"jack"</span><span class="p">,</span> <span class="s2">"john"</span><span class="p">]})</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="nf">payload</span>
<span class="p">=&gt;</span> <span class="p">{</span><span class="s2">"kind"</span><span class="o">=&gt;</span><span class="s2">"user_renamed"</span><span class="p">,</span> <span class="s2">"change"</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">"jack"</span><span class="p">,</span> <span class="s2">"john"</span><span class="p">]}</span>

<span class="c">## Запрос, основанный на JSON документе
# Оператор -&gt; возвращает исходный JSON тип (который может быть объектом), где -&gt;&gt; возвращает текст
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Event</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"payload-&gt;&gt;'kind' = ?"</span><span class="p">,</span> <span class="s2">"user_renamed"</span><span class="p">)</span>
</code></pre>
</div>
<h4 id='diapazonnye-tipy' class='inside_page_header'><a href="#diapazonnye-tipy">1.5.</a> Диапазонные типы</h4><ul><li><a href="https://postgrespro.ru/docs/postgrespro/current/rangetypes.html">определение типа</a>
</li><li><a href="https://postgrespro.ru/docs/postgrespro/current/functions-range.html">функции и операторы</a>
</li></ul><p>Этот тип преобразуется в Ruby <a href="https://ruby-doc.org/core-2.7.0/Range.html"><code>Range</code></a> объекты.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20130923065404_create_events.rb</span>
<span class="n">create_table</span> <span class="ss">:events</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">daterange</span> <span class="s1">'duration'</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/event.rb</span>
<span class="k">class</span> <span class="nc">Event</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Event</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">duration: </span><span class="no">Date</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span><span class="o">..</span><span class="no">Date</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span>
<span class="p">=&gt;</span> <span class="no">Tue</span><span class="p">,</span> <span class="mi">11</span> <span class="no">Feb</span> <span class="mi">2014</span><span class="o">...</span><span class="no">Thu</span><span class="p">,</span> <span class="mi">13</span> <span class="no">Feb</span> <span class="mi">2014</span>

<span class="c">## Все события в заданную дату
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Event</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"duration @&gt; ?::date"</span><span class="p">,</span> <span class="no">Date</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="err">
</span><span class="c">## Работает с границами диапазона
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">"lower(duration) AS starts_at"</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="s2">"upper(duration) AS ends_at"</span><span class="p">).</span><span class="nf">first</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="nf">starts_at</span>
<span class="p">=&gt;</span> <span class="no">Tue</span><span class="p">,</span> <span class="mi">11</span> <span class="no">Feb</span> <span class="mi">2014</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="nf">ends_at</span>
<span class="p">=&gt;</span> <span class="no">Thu</span><span class="p">,</span> <span class="mi">13</span> <span class="no">Feb</span> <span class="mi">2014</span>
</code></pre>
</div>
<h4 id='sostavnye-tipy' class='inside_page_header'><a href="#sostavnye-tipy">1.6.</a> Составные типы</h4><ul><li><a href="https://postgrespro.ru/docs/postgrespro/current/rowtypes.html">определение типа</a>
</li></ul><p>На данный момент нет специальной поддержки для составных типов. Они преобразуются к обычным текстовым столбцам:</p><div class="code_container">
  <pre><code class="highlight sql"><span class="k">CREATE</span> <span class="k">TYPE</span> <span class="n">full_address</span> <span class="k">AS</span>
<span class="p">(</span>
  <span class="n">city</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">90</span><span class="p">),</span>
  <span class="n">street</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
<span class="p">);</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20140207133952_create_contacts.rb</span>
<span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
  CREATE TYPE full_address AS
  (
    city VARCHAR(90),
    street VARCHAR(90)
  );
</span><span class="no">SQL</span>
<span class="n">create_table</span> <span class="ss">:contacts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">column</span> <span class="ss">:address</span><span class="p">,</span> <span class="ss">:full_address</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/contact.rb</span>
<span class="k">class</span> <span class="nc">Contact</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Contact</span><span class="p">.</span><span class="nf">create</span> <span class="ss">address: </span><span class="s2">"(Paris,Champs-Élysées)"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">contact</span> <span class="o">=</span> <span class="no">Contact</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">contact</span><span class="p">.</span><span class="nf">address</span>
<span class="p">=&gt;</span> <span class="s2">"(Paris,Champs-Élysées)"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">contact</span><span class="p">.</span><span class="nf">address</span> <span class="o">=</span> <span class="s2">"(Paris,Rue Basse)"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">contact</span><span class="p">.</span><span class="nf">save!</span>
</code></pre>
</div>
<h4 id='tipy-perechisleniy' class='inside_page_header'><a href="#tipy-perechisleniy">1.7.</a> Типы перечислений</h4><ul><li><a href="https://postgrespro.ru/docs/postgrespro/current/datatype-enum.html">определение типа</a>
</li></ul><p>Тип может быть соотнесен как обычный текстовый столбец, или <a href="https://api.rubyonrails.org/classes/ActiveRecord/Enum.html"><code>ActiveRecord::Enum</code></a>.</p><p>На данный момент нет специальной поддержки для типов перечислений. Они преобразуются к обычным текстовым столбцам:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_articles.rb</span>
<span class="k">def</span> <span class="nf">up</span>
  <span class="n">create_enum</span> <span class="ss">:article_status</span><span class="p">,</span> <span class="p">[</span><span class="s2">"draft"</span><span class="p">,</span> <span class="s2">"published"</span><span class="p">]</span>

  <span class="n">create_table</span> <span class="ss">:articles</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">enum</span> <span class="ss">:status</span><span class="p">,</span> <span class="ss">enum_type: :article_status</span><span class="p">,</span> <span class="ss">default: </span><span class="s2">"draft"</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Вышеприведенная миграция является обратимой (при использовании #change),</span>
<span class="c1"># но также можно определить метод #down:</span>
<span class="k">def</span> <span class="nf">down</span>
  <span class="n">drop_table</span> <span class="ss">:articles</span>

  <span class="n">drop_enum</span> <span class="ss">:article_status</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/article.rb</span>
<span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">enum</span> <span class="ss">status: </span><span class="p">{</span>
    <span class="ss">draft: </span><span class="s2">"draft"</span><span class="p">,</span> <span class="ss">published: </span><span class="s2">"published"</span>
  <span class="p">},</span> <span class="ss">_prefix: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Article</span><span class="p">.</span><span class="nf">create</span> <span class="ss">status: </span><span class="s2">"draft"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span><span class="p">.</span><span class="nf">status_draft!</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span><span class="p">.</span><span class="nf">status</span>
<span class="p">=&gt;</span> <span class="s2">"draft"</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span><span class="p">.</span><span class="nf">status_published?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
</div>
<p>Чтобы добавить новое значение до/после существующего, следует использовать <a href="https://postgrespro.ru/docs/postgrespro/current/sql-altertype.html">ALTER TYPE</a>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20150720144913_add_new_state_to_articles.rb</span>
<span class="c1"># NOTE: ALTER TYPE ... ADD VALUE нельзя выполнить в блоке транзакции, поэтому используется disable_ddl_transaction!</span>
<span class="n">disable_ddl_transaction!</span>

<span class="k">def</span> <span class="nf">up</span>
  <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
    ALTER TYPE article_status ADD VALUE IF NOT EXISTS 'archived' AFTER 'published';
</span><span class="no">  SQL</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="note"><p>Значения enum нельзя удалять. Можно прочесть почему <a href="http://www.postgresql.org/message-id/29F36C7C98AB09499B1A209D48EAA615B7653DBC8A@mail2a.alliedtesting.com">здесь</a>.</p></div><p>Hint: Чтобы показать все имеющиеся значения enum, можно выполнить этот запрос в консоле <code>bin/rails db</code> или <code>psql</code>:</p><div class="code_container">
  <pre><code class="highlight sql"><span class="k">SELECT</span> <span class="n">n</span><span class="p">.</span><span class="n">nspname</span> <span class="k">AS</span> <span class="n">enum_schema</span><span class="p">,</span>
       <span class="n">t</span><span class="p">.</span><span class="n">typname</span> <span class="k">AS</span> <span class="n">enum_name</span><span class="p">,</span>
       <span class="n">e</span><span class="p">.</span><span class="n">enumlabel</span> <span class="k">AS</span> <span class="n">enum_value</span>
  <span class="k">FROM</span> <span class="n">pg_type</span> <span class="n">t</span>
      <span class="k">JOIN</span> <span class="n">pg_enum</span> <span class="n">e</span> <span class="k">ON</span> <span class="n">t</span><span class="p">.</span><span class="n">oid</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">enumtypid</span>
      <span class="k">JOIN</span> <span class="n">pg_catalog</span><span class="p">.</span><span class="n">pg_namespace</span> <span class="n">n</span> <span class="k">ON</span> <span class="n">n</span><span class="p">.</span><span class="n">oid</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">typnamespace</span>
</code></pre>
</div>
<h4 id='tip-uuid' class='inside_page_header'><a href="#tip-uuid">1.8.</a> Тип UUID</h4><ul><li><a href="https://postgrespro.ru/docs/postgrespro/current/datatype-uuid.html">определение типа</a>
</li><li><a href="https://www.postgresql.org/docs/current/static/pgcrypto.html">функция генератора pgcrypto</a>
</li><li><a href="https://postgrespro.ru/docs/postgrespro/current/uuid-ossp.html">функции генератора uuid-ossp</a>
</li></ul><div class="note"><p>Для использования uuid необходимо включить расширение <code>pgcrypto</code> (только PostgreSQL &gt;= 9.4).</p></div><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_revisions.rb</span>
<span class="n">create_table</span> <span class="ss">:revisions</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">uuid</span> <span class="ss">:identifier</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/revision.rb</span>
<span class="k">class</span> <span class="nc">Revision</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Revision</span><span class="p">.</span><span class="nf">create</span> <span class="ss">identifier: </span><span class="s2">"A0EEBC99-9C0B-4EF8-BB6D-6BB9BD380A11"</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">revision</span> <span class="o">=</span> <span class="no">Revision</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">revision</span><span class="p">.</span><span class="nf">identifier</span>
<span class="p">=&gt;</span> <span class="s2">"a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"</span>
</code></pre>
</div>
<p>Вы можете использовать тип <code>uuid</code> для определения ссылок в миграции:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20150418012400_create_blog.rb</span>
<span class="n">enable_extension</span> <span class="s1">'pgcrypto'</span> <span class="k">unless</span> <span class="n">extension_enabled?</span><span class="p">(</span><span class="s1">'pgcrypto'</span><span class="p">)</span>
<span class="n">create_table</span> <span class="ss">:posts</span><span class="p">,</span> <span class="ss">id: :uuid</span>

<span class="n">create_table</span> <span class="ss">:comments</span><span class="p">,</span> <span class="ss">id: :uuid</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="c1"># t.belongs_to :post, type: :uuid</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">type: :uuid</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/post.rb</span>
<span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:comments</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/comment.rb</span>
<span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:post</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Смотрите <a href="#uuid-primary-keys">этот раздел</a> для получения более подробной информации об использовании UUID в качестве первичного ключа.</p><h4 id='bitovye-stroki' class='inside_page_header'><a href="#bitovye-stroki">1.9.</a> Битовые строки</h4><ul><li><a href="https://postgrespro.ru/docs/postgrespro/current/datatype-bit.html">определение типа</a>
</li><li><a href="https://postgrespro.ru/docs/postgrespro/current/functions-bitstring.html">функции и операторы</a>
</li></ul><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_users.rb</span>
<span class="n">create_table</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">force: </span><span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">column</span> <span class="ss">:settings</span><span class="p">,</span> <span class="s2">"bit(8)"</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/user.rb</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">User</span><span class="p">.</span><span class="nf">create</span> <span class="ss">settings: </span><span class="s2">"01010011"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">settings</span>
<span class="p">=&gt;</span> <span class="s2">"01010011"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">settings</span> <span class="o">=</span> <span class="s2">"0xAF"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">settings</span>
<span class="p">=&gt;</span> <span class="s2">"10101111"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">save!</span>
</code></pre>
</div>
<h4 id='tipy-opisyvayuschie-setevye-adresa' class='inside_page_header'><a href="#tipy-opisyvayuschie-setevye-adresa">1.10.</a> Типы, описывающие сетевые адреса</h4><ul><li><a href="https://postgrespro.ru/docs/postgrespro/current/datatype-net-types.html">определение типа</a>
</li></ul><p>Типы <code>inet</code> и <code>cidr</code> преобразуются в Ruby <a href="https://ruby-doc.org/stdlib-2.7.0/libdoc/ipaddr/rdoc/IPAddr.html"><code>IPAddr</code></a> объекты. Тип <code>macaddr</code> преобразуется в обычный текст.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20140508144913_create_devices.rb</span>
<span class="n">create_table</span><span class="p">(</span><span class="ss">:devices</span><span class="p">,</span> <span class="ss">force: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">inet</span> <span class="s1">'ip'</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">cidr</span> <span class="s1">'network'</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">macaddr</span> <span class="s1">'address'</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/device.rb</span>
<span class="k">class</span> <span class="nc">Device</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">macbook</span> <span class="o">=</span> <span class="no">Device</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">ip: </span><span class="s2">"192.168.1.12"</span><span class="p">,</span> <span class="ss">network: </span><span class="s2">"192.168.2.0/24"</span><span class="p">,</span> <span class="ss">address: </span><span class="s2">"32:01:16:6d:05:ef"</span><span class="p">)</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">macbook</span><span class="p">.</span><span class="nf">ip</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">IPAddr</span><span class="p">:</span> <span class="no">IPv4</span><span class="p">:</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.12</span><span class="o">/</span><span class="mf">255.255</span><span class="o">.</span><span class="mf">255.255</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">macbook</span><span class="p">.</span><span class="nf">network</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">IPAddr</span><span class="p">:</span> <span class="no">IPv4</span><span class="p">:</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">255.255</span><span class="o">.</span><span class="mf">255.0</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">macbook</span><span class="p">.</span><span class="nf">address</span>
<span class="p">=&gt;</span> <span class="s2">"32:01:16:6d:05:ef"</span>
</code></pre>
</div>
<h4 id='geometricheskie-tipy' class='inside_page_header'><a href="#geometricheskie-tipy">1.11.</a> Геометрические типы</h4><ul><li><a href="https://postgrespro.ru/docs/postgrespro/current/datatype-geometric.html">определение типа</a>
</li></ul><p>Все геометрические типы, за исключением <code>points</code> преобразуются в обычный текст.
А тип <code>point</code> соответствует массиву, содержащему координаты <code>x</code> и <code>y</code>.</p><h4 id='interval' class='inside_page_header'><a href="#interval">1.12.</a> Интервал</h4><ul><li><a href="https://www.postgresql.org/docs/current/static/datatype-datetime.html#DATATYPE-INTERVAL-INPUT">определение типа</a>
</li><li><a href="https://www.postgresql.org/docs/current/static/functions-datetime.html">функции и операторы</a>
</li></ul><p>Этот тип преобразуется в объекты <a href="https://api.rubyonrails.org/classes/ActiveSupport/Duration.html"><code>ActiveSupport::Duration</code></a>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20200120000000_create_events.rb</span>
<span class="n">create_table</span> <span class="ss">:events</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">interval</span> <span class="s1">'duration'</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/event.rb</span>
<span class="k">class</span> <span class="nc">Event</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Event</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">duration: </span><span class="mi">2</span><span class="p">.</span><span class="nf">days</span><span class="p">)</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span>
<span class="p">=&gt;</span> <span class="mi">2</span> <span class="n">days</span>
</code></pre>
</div>
<h3 id='uuid-primary-keys' class='inside_page_header'><a href="#uuid-primary-keys">2.</a>  Первичные ключи UUID</h3><div class="note"><p>Если используете PostgreSQL более ранний, чем версия 13.0, необходимо включить специальные расширения для использования UUID. Включите расширение <code>pgcrypto</code> (PostgreSQL &gt;= 9.4) или расширения <code>uuid-ossp</code> (для более ранних релизов).</p></div><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_devices.rb</span>
<span class="n">enable_extension</span> <span class="s1">'pgcrypto'</span> <span class="k">unless</span> <span class="n">extension_enabled?</span><span class="p">(</span><span class="s1">'pgcrypto'</span><span class="p">)</span>
<span class="n">create_table</span> <span class="ss">:devices</span><span class="p">,</span> <span class="ss">id: :uuid</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:kind</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/device.rb</span>
<span class="k">class</span> <span class="nc">Device</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="n">irb</span><span class="o">&gt;</span> <span class="n">device</span> <span class="o">=</span> <span class="no">Device</span><span class="p">.</span><span class="nf">create</span>
<span class="n">irb</span><span class="o">&gt;</span> <span class="n">device</span><span class="p">.</span><span class="nf">id</span>
<span class="o">=&gt;</span> <span class="s2">"814865cd-5a1d-4771-9306-4268f188fe9e"</span>
</code></pre>
</div>
<div class="note"><p>Предполагается, что используется <code>gen_random_uuid()</code> (из <code>uuid-pgcrypto</code>) при отсутствии опции <code>:default</code>, переданной в <code>create_table</code>.</p></div><p>Для использования генератора моделей Rails для таблицы, использующей UUID в качестве первичного ключа, передайте <code>--primary-key-type=uuid</code> в генератор моделей.</p><p>Например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">rails</span> <span class="n">generate</span> <span class="n">model</span> <span class="no">Device</span> <span class="o">--</span><span class="n">primary</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">type</span><span class="o">=</span><span class="n">uuid</span> <span class="n">kind</span><span class="ss">:string</span>
</code></pre>
</div>
<p>При создании модели с внешним ключом, ссылающимся на этот UUID, задайте <code>uuid</code> в качестве нативного типа поля, например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">rails</span> <span class="n">generate</span> <span class="n">model</span> <span class="no">Case</span> <span class="n">device_id</span><span class="ss">:uuid</span>
</code></pre>
</div>
<h3 id='generiruemye-stolbtsy' class='inside_page_header'><a href="#generiruemye-stolbtsy">3.</a> Генерируемые столбцы</h3><div class="note"><p>Генерируемые столбцы поддерживаются, начиная с 12.0 версии PostgreSQL.</p></div><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_users.rb</span>
<span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">virtual</span> <span class="ss">:name_upcased</span><span class="p">,</span> <span class="ss">type: :string</span><span class="p">,</span> <span class="ss">as: </span><span class="s1">'upper(name)'</span><span class="p">,</span> <span class="ss">stored: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="c1"># app/models/user.rb</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>

<span class="c1"># Usage</span>
<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'John'</span><span class="p">)</span>
<span class="no">User</span><span class="p">.</span><span class="nf">last</span><span class="p">.</span><span class="nf">name_upcased</span> <span class="c1"># =&gt; "JOHN"</span>
</code></pre>
</div>
<h3 id='otlozhennye-vneshnie-klyuchi' class='inside_page_header'><a href="#otlozhennye-vneshnie-klyuchi">4.</a> Отложенные внешние ключи</h3><ul><li><a href="https://www.postgresql.org/docs/current/sql-set-constraints.html">ограничения внешнего ключа таблицы</a>
</li></ul><p>По умолчанию ограничения таблицы в PostgreSQL проверяются немедленно после каждого выражения. Она намеренно не разрешает создавать записи, когда связанная запись еще не находится в связанной таблице. Впрочем, эту проверку целостности возможно запустить позднее, когда подтверждаются транзакции, добавив <code>DEFERRABLE</code> к определению внешнего ключа. Чтобы отложить все проверки по умолчанию, можно установить <code>DEFERRABLE INITIALLY DEFERRED</code>. Rails представляет эту особенность PostgreSQL, добавляя ключ <code>:deferrable</code> к опциям <code>foreign_key</code> в методах <code>add_reference</code> и <code>add_foreign_key</code>.</p><p>Примером этого является создание циклических зависимостей в транзакции, даже если у вас уже есть созданные внешние ключи:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">add_reference</span> <span class="ss">:person</span><span class="p">,</span> <span class="ss">:alias</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">deferrable: :deferred</span> <span class="p">}</span>
<span class="n">add_reference</span> <span class="ss">:alias</span><span class="p">,</span> <span class="ss">:person</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">deferrable: :deferred</span> <span class="p">}</span>
</code></pre>
</div>
<p>Если ссылка была создана с помощью опции <code>foreign_key: true</code>, следующая транзакция упала бы при запуске первого выражения <code>INSERT</code>. Хотя она не упадет, когда установлена опция <code>deferrable: :deferred</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">id: </span><span class="no">SecureRandom</span><span class="p">.</span><span class="nf">uuid</span><span class="p">,</span> <span class="ss">alias_id: </span><span class="no">SecureRandom</span><span class="p">.</span><span class="nf">uuid</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
  <span class="no">Alias</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">id: </span><span class="n">person</span><span class="p">.</span><span class="nf">alias_id</span><span class="p">,</span> <span class="ss">person_id: </span><span class="n">person</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"jaydee"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Опции <code>:deferrable</code> также можно установить <code>true</code> или <code>:immediate</code>, которые приводят к одному и тому же результату. Обе опции сохраняют поведение внешних ключей по умолчанию, но позволяют вручную отложить проверки с помощью <code>SET CONSTRAINTS ALL DEFERRED</code> внутри транзакции. Это вызовет, что внешние ключи будут проверены при подтверждении транзакции:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s2">"SET CONSTRAINTS ALL DEFERRED"</span><span class="p">)</span>
  <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">alias_id: </span><span class="no">SecureRandom</span><span class="p">.</span><span class="nf">uuid</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
  <span class="no">Alias</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">id: </span><span class="n">person</span><span class="p">.</span><span class="nf">alias_id</span><span class="p">,</span> <span class="ss">person_id: </span><span class="n">person</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"jaydee"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>
<p>По умолчанию <code>:deferrable</code> равен <code>false</code>, и ограничение всегда проверяется немедленно.</p><h3 id='polnotekstovyy-poisk' class='inside_page_header'><a href="#polnotekstovyy-poisk">5.</a> Полнотекстовый поиск</h3><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_documents.rb</span>
<span class="n">create_table</span> <span class="ss">:documents</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:title</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:body</span>
<span class="k">end</span>

<span class="n">add_index</span> <span class="ss">:documents</span><span class="p">,</span> <span class="s2">"to_tsvector('english', title || ' ' || body)"</span><span class="p">,</span> <span class="ss">using: :gin</span><span class="p">,</span> <span class="ss">name: </span><span class="s1">'documents_idx'</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/document.rb</span>
<span class="k">class</span> <span class="nc">Document</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Использование</span>
<span class="no">Document</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"Cats and Dogs"</span><span class="p">,</span> <span class="ss">body: </span><span class="s2">"are nice!"</span><span class="p">)</span>

<span class="c1">## Все документы совпадающие с 'cat &amp; dog'</span>
<span class="no">Document</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"to_tsvector('english', title || ' ' || body) @@ to_tsquery(?)"</span><span class="p">,</span>
                 <span class="s2">"cat &amp; dog"</span><span class="p">)</span>
</code></pre>
</div>
<p>Опционально можно хранить вектор как автоматически сгенерированный столбец (начиная с PostgreSQL 12.0):</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_documents.rb</span>
<span class="n">create_table</span> <span class="ss">:documents</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:title</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:body</span>

  <span class="n">t</span><span class="p">.</span><span class="nf">virtual</span> <span class="ss">:textsearchable_index_col</span><span class="p">,</span>
            <span class="ss">type: :tsvector</span><span class="p">,</span> <span class="ss">as: </span><span class="s2">"to_tsvector('english', title || ' ' || body)"</span><span class="p">,</span> <span class="ss">stored: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="n">add_index</span> <span class="ss">:documents</span><span class="p">,</span> <span class="ss">:textsearchable_index_col</span><span class="p">,</span> <span class="ss">using: :gin</span><span class="p">,</span> <span class="ss">name: </span><span class="s1">'documents_idx'</span>

<span class="c1"># Использование</span>
<span class="no">Document</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"Cats and Dogs"</span><span class="p">,</span> <span class="ss">body: </span><span class="s2">"are nice!"</span><span class="p">)</span>

<span class="c1">## все документы, соответствующие 'cat &amp; dog'</span>
<span class="no">Document</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"textsearchable_index_col @@ to_tsquery(?)"</span><span class="p">,</span> <span class="s2">"cat &amp; dog"</span><span class="p">)</span>
</code></pre>
</div>
<h3 id='predstavlenie-bazy-dannyh' class='inside_page_header'><a href="#predstavlenie-bazy-dannyh">6.</a> Представление базы данных</h3><ul><li><a href="https://postgrespro.ru/docs/postgrespro/current/sql-createview.html">view creation</a>
</li></ul><p>Представим, что нам нужно работать со старой базой данных, содержащей следующую таблицу:</p><div class="code_container">
  <pre><code class="highlight plaintext">rails_pg_guide=# \d "TBL_ART"
                                        Table "public.TBL_ART"
   Column   |            Type             |                         Modifiers
------------+-----------------------------+------------------------------------------------------------
 INT_ID     | integer                     | not null default nextval('"TBL_ART_INT_ID_seq"'::regclass)
 STR_TITLE  | character varying           |
 STR_STAT   | character varying           | default 'draft'::character varying
 DT_PUBL_AT | timestamp without time zone |
 BL_ARCH    | boolean                     | default false
Indexes:
    "TBL_ART_pkey" PRIMARY KEY, btree ("INT_ID")
</code></pre>
</div>
<p>Данная таблица не соответствует общепринятым Rails соглашениям.
Т.к. простые представление PostgreSQL обновляются по умолчанию, то можно обернуть их следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_articles_view.rb</span>
<span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
CREATE VIEW articles AS
  SELECT "INT_ID" AS id,
         "STR_TITLE" AS title,
         "STR_STAT" AS status,
         "DT_PUBL_AT" AS published_at,
         "BL_ARCH" AS archived
  FROM "TBL_ART"
  WHERE "BL_ARCH" = 'f'
</span><span class="no">  SQL</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/article.rb</span>
<span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="s2">"id"</span>
  <span class="k">def</span> <span class="nf">archive!</span>
    <span class="n">update_attribute</span> <span class="ss">:archived</span><span class="p">,</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">first</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">title: </span><span class="s2">"Winter is coming"</span><span class="p">,</span> <span class="ss">status: </span><span class="s2">"published"</span><span class="p">,</span> <span class="ss">published_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">year</span><span class="p">.</span><span class="nf">ago</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">second</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">title: </span><span class="s2">"Brace yourself"</span><span class="p">,</span> <span class="ss">status: </span><span class="s2">"draft"</span><span class="p">,</span> <span class="ss">published_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">month</span><span class="p">.</span><span class="nf">ago</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Article</span><span class="p">.</span><span class="nf">count</span>
<span class="p">=&gt;</span> <span class="mi">2</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">first</span><span class="p">.</span><span class="nf">archive!</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Article</span><span class="p">.</span><span class="nf">count</span>
<span class="p">=&gt;</span> <span class="mi">1</span>
</code></pre>
</div>
<div class="note"><p>Это приложение обслуживает только не архивированные <code>Articles</code>. Представление также допускает условия, при которых можно напрямую исключать архивные <code>Articles</code>.</p></div><h3 id='vygruzki-struktury' class='inside_page_header'><a href="#vygruzki-struktury">7.</a> Выгрузки структуры</h3><p>Если ваш <code>config.active_record.schema_format</code> это <code>:sql</code>, Rails вызовет <code>pg_dump</code> для генерации выгрузки структуры.</p><p>Можно использовать <code>ActiveRecord::Tasks::DatabaseTasks.structure_dump_flags</code> для конфигурации <code>pg_dump</code>. Например, чтобы исключить комментарии из выгрузки структуры, добавьте следующее в инициализатор:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Tasks</span><span class="o">::</span><span class="no">DatabaseTasks</span><span class="p">.</span><span class="nf">structure_dump_flags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'--no-comments'</span><span class="p">]</span>
</code></pre>
</div>


            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

   <!-- bottom rusrails -->
   <ins class="adsbygoogle"
        style="display:inline-block;width:580px;height:400px"
        data-ad-client="ca-pub-7764391801669990"
        data-ad-slot="7566253867"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
        </div>
        <div class="row-fluid">
          <div class="span12" id="footer">
            <p>
              <a target="blank" href="https://github.com/rusrails/rusrails"><img src="/assets/github-7cc23602a5ac2465f14c19492358a5a67dc24636761cc723e4d621cea0c09225.png" /></a>
              <a target="blank" href="http://twitter.com/rusrails"><img src="/assets/twitter-50e0e767c8793dec313a7dc5cfbcfe2067e3e89ea6ec64784eb7c6640f578758.png" /></a>
            </p>
            <p>
              <a href="https://creativecommons.org/licenses/by-sa/4.0/">Лицензия CC BY-SA 4.0</a>
              "Rails", "Ruby on Rails" и логотип Rails - торговые марки DHH
              <!-- Yandex.Metrika counter -->
<script>
  (function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter1006929 = new Ya.Metrika({id:1006929,
                    webvisor:true,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true});
        } catch(e) { }
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>

<noscript>
  <div>
    <img style="position:absolute; left:-9999px;" alt="" src="//mc.yandex.ru/watch/1006929" />
  </div>
</noscript>
<!-- /Yandex.Metrika counter -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64955373-1', 'auto');
  ga('send', 'pageview');

  var trackOutboundLink = function(url) {
    ga('send', 'event', 'outbound', 'click', url, {
      'transport': 'beacon',
      'hitCallback': function(){ }
    });
  }
</script>

            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="to_top" style="display: block">
      <div class="to_top_panel"></div>
    </div>
    <script src="/assets/application-8ee447905888b153d8458707061a14b1f15f69b6733e871a3ad91d80ae89e87b.js"></script>
  </body>
</html>
