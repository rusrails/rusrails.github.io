<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8">
<meta content="Ruby on Rails, Ruby, Rails, Rails 3, Rails 4, Rails 5, Rails 6, Rails 6.0, Rails 6.1, Rails 7.0, Rails 7.1 руководство, начинающим, самоучитель, manual, мануал, справочник, учебник, примеры, Руби, рельсы" name="keywords"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" name="description"/>
<meta content="product" property="twitter:card"/>
<meta content="@rusrails" property="twitter:site"/>
<meta content="Rusrails: Использование Rails для API-приложений" property="twitter:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="twitter:description"/>
<meta content="@rusrails" property="twitter:creator"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="twitter:image"/>
<meta content="website" property="og:type"/>
<meta content="Rusrails: Использование Rails для API-приложений" property="og:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="og:description"/>
<meta content="http://localhost:3000/api-app" property="og:url"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="og:image"/>
    <title>
      Rusrails: Использование Rails для API-приложений
    </title>
    <link rel="stylesheet" href="/assets/application-f9dfa6ce7fa871006d478e422639671663284ddaa3126cf81ddfe371ac3533c4.css" />
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="/"></a>
          <ul class="nav pull-right top-menu">
            <li>
              <a href="/">Главная</a>
            </li>
            <li class="dropdown">
              <a class="index-popover" href="#">
                Содержание
                <b class="caret"></b>
</a>              <div class="index-popover-content hide">
                  <ul><li><p><strong>С чего начать?</strong></p><ul><li><a href="/getting-started">Rails для начинающих</a>
</li></ul></li><li><p><strong>Модели</strong></p><ul><li><a href="/active-record-basics">Основы Active Record</a>
</li><li><a href="/active-record-migrations">Миграции Active Record</a>
</li><li><a href="/active-record-validations">Валидации Active Record</a>
</li><li><a href="/active-record-callbacks">Колбэки Active Record</a>
</li><li><a href="/active-record-associations">Связи (ассоциации) Active Record</a>
</li><li><a href="/active-record-querying">Интерфейс запросов Active Record</a>
</li><li><a href="/active-model-basics">Основы Active Model</a>
</li></ul></li><li><p><strong>Вью</strong></p><ul><li><a href="/action-view-overview">Обзор Action View</a>
</li><li><a href="/layouts-and-rendering">Макеты и рендеринг в Rails</a>
</li><li><a href="/action-view-helpers">Хелперы Action View</a>
</li><li><a href="/form-helpers">Хелперы форм в Action View</a>
</li></ul></li><li><p><strong>Контроллеры</strong></p><ul><li><a href="/action-controller-overview">Обзор Action Controller</a>
</li><li><a href="/routing">Роутинг в Rails</a>
</li></ul></li><li><p><strong>Другие компоненты</strong></p><ul><li><a href="/active-support-core-extensions">Расширения ядра Active Support</a>
</li><li><a href="/action-mailer-basics">Основы Action Mailer</a>
</li><li><a href="/action-mailbox-basics">Основы Action Mailbox</a>
</li><li><a href="/action-text-overview">Обзор Action Text</a>
</li><li><a href="/active_job_basics">Основы Active Job</a>
</li><li><a href="/active_storage_overview">Обзор Active Storage</a>
</li><li><a href="/action-cable-overview">Обзор Action Cable</a>
</li></ul></li><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/i18n">API интернационализации Rails (I18n)</a>
</li><li><a href="/testing">Тестирование приложений на Rails</a>
</li><li><a href="/security">Безопасность приложений на Rails</a>
</li><li><a href="/error-reporting">Отчет об ошибках в приложениях Rails</a>
</li></ul></li></ul><p>next_column</p><ul><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/debugging-rails-applications">Отладка приложений на Rails</a>
</li><li><a href="/configuring">Конфигурирование приложений на Rails</a>
</li><li><a href="/command-line">Командная строка Rails</a>
</li><li><a href="/asset-pipeline">Asset Pipeline</a>
</li><li><a href="/working-with-javascript-in-rails">Работа с JavaScript в Rails</a>
</li><li><a href="/initialization">Процесс инициализации в Rails</a>
</li><li><a href="/autoloading-and-reloading-constants">Автозагрузка и перезагрузка констант</a>
</li><li><a href="/classic-to-zeitwerk-howto">Как перейти с Classic на Zeitwerk</a>
</li><li><a href="/caching-with-rails">Кэширование с Rails: Обзор</a>
</li><li><a href="/active-support-instrumentation">Инструментарий Active Support</a>
</li><li><a href="/api-app">Использование Rails для API-приложений</a>
</li><li><a href="/active-record-postgresql">Active Record для PostgreSQL</a>
</li><li><a href="/active-record-multiple-databases">Несколько баз данных с Active Record</a>
</li><li><a href="/active-record-encryption">Шифрование Active Record</a>
</li></ul></li><li><p><strong>Расширяем Rails</strong></p><ul><li><a href="/plugins">Основы создания плагинов Rails</a>
</li><li><a href="/rails-on-rack">Rails on Rack</a>
</li><li><a href="/generators">Создание и настройка генераторов и шаблонов Rails</a>
</li><li><a href="/engines">Engine для начинающих</a>
</li><li><a href="/threading_and_code_execution">Треды и выполнение кода в Rails</a>
</li><li><a href="/rails-application-templates">Шаблоны приложения Rails</a>
</li></ul></li><li><p><strong>Вносим вклад в Ruby on Rails</strong></p><ul><li><a href="/contributing_to_ruby_on_rails">Вносим вклад в Ruby on Rails</a>
</li><li><a href="/api_documentation_guidelines">Рекомендации по документированию API</a>
</li><li><a href="/ruby_on_rails_guides_guidelines">Рекомендации для руководств по Ruby on Rails</a>
</li><li><a href="/development_dependencies_install">Установка зависимостей для разработки</a>
</li><li><a href="/maintenance-policy">Политика поддержки (версий)</a>
</li></ul></li><li><p><strong>Заметки о релизах</strong></p><ul><li><a href="/upgrading-ruby-on-rails">Апгрейд Ruby on Rails</a>
</li><li><a href="/7_1_release_notes">Версия 7.1 - Октябрь 2023</a>
</li><li><a href="/7_0_release_notes">Версия 7.0 - Декабрь 2021</a>
</li><li><a href="/6_1_release_notes">Версия 6.1 - Декабрь 2020</a>
</li><li><a href="/6_0_release_notes">Версия 6.0 - Август 2019</a>
</li></ul></li></ul>
              </div>
            </li>
            <li>
              <a href="/search">Поиск</a>
            </li>
            <li>
              <a target="blank" href="http://api.rusrails.ru">Ruby &amp; Rails API</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="content-wrapper">
      <div class="container-fluid">
        <div class="row-fluid">
          <div class="span3 pull-right">
            <div class="well social">
              <h4>Принимаем пожелания и пул-реквесты!</h4>
              <iframe allowtransparency="true" frameborder="0" height="30" src="http://ghbtns.com/github-btn.html?user=rusrails&repo=rusrails&type=watch&count=true&size=large" width="180"></iframe>
              <p></p>
              <a class="twitter-follow-button" data-lang="ru" href="https://twitter.com/rusrails"></a>
            </div>
              <div class="well menu">
                    <ul class="nav nav-list">
      <li>
        <h4>
          <a href="#chto-takoe-api-prilozhenie">1. Что такое API-приложение?</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#zachem-ispolzovat-rails-dlya-json-api">2. Зачем использовать Rails для JSON API?</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#bazovaya-konfiguratsiya">3. Базовая конфигурация</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#sozdanie-novogo-prilozheniya">3.1. Создание нового приложения</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#izmenenie-suschestvuyuschego-prilozheniya">3.2. Изменение существующего приложения</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#vybor-promezhutochnyh-programm">4. Выбор промежуточных программ</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#ispolzovanie-keshiruyuschey-promezhutochnoy-programmy">4.1. Использование кэширующей промежуточной программы</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#ispolzovanie-rack-sendfile">4.2. Использование Rack::Sendfile</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#ispolzovanie-actiondispatch-request">4.3. Использование ActionDispatch::Request</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#ispolzovanie-promezhutochnyh-programm-dlya-sessiy">4.4. Использование промежуточных программ для сессий</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#drugie-promezhutochnye-programmy">4.5. Другие промежуточные программы</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#udalenie-promezhutochnyh-programm">4.6. Удаление промежуточных программ</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#vybor-moduley-kontrollera">5. Выбор модулей контроллера</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#dobavlenie-drugih-moduley">5.1. Добавление других модулей</a>
</h5>      </li>
</ul>

              </div>
            <div class="well banner300 banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<!-- sidebar rusrails -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:600px"
     data-ad-client="ca-pub-7764391801669990"
     data-ad-slot="6089520660"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
          <div class="span9 content pull-left">
            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <!-- top rusrails -->
  <ins class="adsbygoogle"
       style="display:inline-block;width:980px;height:120px"
       data-ad-client="ca-pub-7764391801669990"
       data-ad-slot="4891989065"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
              <h2 id='ispolzovanie-rails-dlya-api-prilozheniy' class='inside_page_header'> Использование Rails для API-приложений</h2><p>В этом руководстве вы узнаете</p><ul><li>Что предоставляет Rails для API-приложений
</li><li>Как сконфигурировать Rails для работы без браузерных особенностей
</li><li>Как решить, какие промежуточные программы нужно включить
</li><li>Как решить, какие модули использовать в контроллере
</li></ul>
<hr>
<h3 id='chto-takoe-api-prilozhenie' class='inside_page_header'><a href="#chto-takoe-api-prilozhenie">1.</a> Что такое API-приложение?</h3><p>Обычно, когда говорят, что Rails используется как &quot;API&quot;, имеется в виду предоставление программно доступного API вместе с веб-приложением. Например, GitHub предоставляет <a href="https://developer.github.com">API</a>, который можно использовать в собственном клиенте.</p><p>С приходом клиентских фреймворков многие разработчики используют Rails для создания бэкенда, общего для их веб-приложений и других нативных приложений.</p><p>Например, Twitter использует свой <a href="https://developer.twitter.com/">публичный API</a> в своем веб-приложении, который создан как статичный сайт, потребляющий ресурсы JSON.</p><p>Вместо использования Rails для генерации HTML, взаимодействующего с сервером с помощью форм и ссылок, многие разработчики трактуют их веб-приложения как всего лишь клиент API, созданный из HTML с помощью JavaScript, обращающегося к JSON API.</p><p>Это руководство раскрывает создание приложения Rails, отдающего JSON-ресурсы клиентам API, включая клиентский фреймворк.</p><h3 id='zachem-ispolzovat-rails-dlya-json-api' class='inside_page_header'><a href="#zachem-ispolzovat-rails-dlya-json-api">2.</a> Зачем использовать Rails для JSON API?</h3><p>Первый вопрос, который многие задают, когда думают о создании JSON API с помощью Rails, это: &quot;Не будет ли использование Rails для отдачи некоторого JSON избыточным? Не должен ли я использовать что-то вроде Sinatra?&quot;.</p><p>Для очень простых API это может быть истиной. Однако, даже в самых навороченных HTML приложениях, большинство логики приложения находится вне уровня представления.</p><p>Причиной, по которой многие используют Rails, является то, что он предоставляет набор, позволяющий разработчикам взять и начать работать без осуществления множества тривиальных решений.</p><p>Давайте посмотрим на некоторые вещи, которые Rails предоставляет из коробки и которые применимы к API-приложениям.</p><p>На уровне промежуточных программ:</p><ul><li>Перезагрузка: приложения Rails поддерживают прозрачную перезагрузку. Это работает, даже если ваше приложение становится большим и рестарт сервера для каждого запроса становится неприемлемым.
</li><li>Режим разработки: приложения Rails идут с разумными значениями по умолчанию для разработки, что делает разработку приятной без ущерба производительности для production.
</li><li>Тестовый режим: то же самое, что и для режима разработки.
</li><li>Логирование: приложения Rails логируют каждый запрос с уровнем детализации, приемлемым для текущего режима. Логи Rails в development включают информацию о среде запроса, запросах в базу данных и основную информацию о производительности.
</li><li>Безопасность: Rails обнаруживает и мешает исполнению <a href="https://ru.wikipedia.org/wiki/IP-%D1%81%D0%BF%D1%83%D1%84%D0%B8%D0%BD%D0%B3">IP-спуфинга</a>, и безопасным способом обрабатывает криптографические сигнатуры в <a href="https://ru.wikipedia.org/wiki/%D0%90%D1%82%D0%B0%D0%BA%D0%B0_%D0%BF%D0%BE_%D0%B2%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%B8">атаках по времени</a>. Не знаете, что такое IP-спуфинг или атака по времени? Вот-вот!
</li><li>Парсинг параметров: Хотите устанавливать ваши параметры как JSON вместо URL-кодированной строки? Без проблем. Rails декодирует JSON и сделает его доступным в <code>params</code>. Хотите использовать вложенные URL-кодированные параметры? Это тоже работает.
</li><li>Условный GETs: Rails поддерживает условный <code>GET</code> (<code>ETag</code> и <code>Last-Modified</code>), обрабатывая заголовки запроса и возвращая правильный отклик и код статуса. Все, что нужно, это использовать проверку <a href="https://api.rubyonrails.org/classes/ActionController/ConditionalGet.html#method-i-stale-3F"><code>stale?</code></a> в вашем контроллере, и Rails позаботится обо всех деталях HTTP.
</li><li>Запросы HEAD: Rails прозрачно конвертирует запросы <code>HEAD</code> в <code>GET</code>, и возвращает только заголовки тем же образом. Это позволяет <code>HEAD</code> надежно работать во всех API Rails.
</li></ul><p>Очевидно, что хотя вы и можете это создать сами в терминах существующих промежуточных программ Rack, этот список демонстрирует стек промежуточных программ Rails по умолчанию, представляющий большую ценность, даже если вы &quot;просто генерируете JSON&quot;.</p><p>На уровне Action Pack:</p><ul><li>Ресурсный роутинг: Если вы создаете RESTful JSON API, вам захочется использовать роутер Rails. Чистое и общепринятое сопоставление от HTTP к контроллерам означает, что не нужно тратить время, думая, как смоделировать ваш API в терминах HTTP.
</li><li>Генерация URL: Обратной стороной роутинга является генерация URL. Хороший API, основанный на HTTP, включает URL (в качестве примера смотрите <a href="https://docs.github.com/en/rest/reference/gists">GitHub Gist API</a>).
</li><li>Отклики с заголовками и редиректами: <code>head :no_content</code> и <code>redirect_to user_url(current_user)</code> очень удобны. Конечно, заголовки отклика можно добавить руками, но зачем?
</li><li>Кэширование: Rails предоставляет кэширование страниц, экшнов и фрагментов. Кэширование фрагментов особенно полезно при создании вложенных объектов JSON.
</li><li>Базовая, дайджестная и токенная аутентификация: Rails поставляется с поддержкой из коробки трех типов аутентификации HTTP.
</li><li>Инструментарий: в Rails имеется инструментальный API, запускающий зарегистрированные обработчики для множества событий, таких как обработка экшна, отсылка файла или данных, перенаправление и запросы к базе данных. Полезная нагрузка о каждом событии приходит с соответствующими параметрами (для события обработки экшна полезная нагрузка включает контроллер, экшн, параметры, формат запроса, метод запроса и полный путь запроса).
</li><li>Генераторы: Часто удобно сгенерировать ресурс и получить модель, контроллер, заготовки для тестов и роутов, созданные одной командой, для дальнейшей доработки. То же самое для миграций и остального.
</li><li>Плагины: Многие сторонние библиотеки поставляются с поддержкой Rails, что уменьшает или устраняет стоимость настройки и внедрения библиотеки во фреймворк. Это включает вещи, такие как переопределение генераторов по умолчанию, добавление задач Rake и принятие выбора в Rails (такого как логгер и кэширующий бэкенд).
</li></ul><p>Конечно, процесс загрузки Rails также соединяет воедино все зарегистрированные компоненты. Например, процесс загрузки Rails это то, что использует файл <code>config/database.yml</code> при конфигурации Active Record.</p><p><strong>Краткая версия</strong>: можно не задумываться, какие части Rails все еще применимы, даже если вы уберете уровень представления, ответом будет - большая часть из них.</p><h3 id='bazovaya-konfiguratsiya' class='inside_page_header'><a href="#bazovaya-konfiguratsiya">3.</a> Базовая конфигурация</h3><p>Если вы создаете приложение Rails, которое будет в первую очередь сервером API, можно начать с более ограниченного подмножества Rails и добавлять особенности по необходимости.</p><h4 id='sozdanie-novogo-prilozheniya' class='inside_page_header'><a href="#sozdanie-novogo-prilozheniya">3.1.</a> Создание нового приложения</h4><p>Можно сгенерировать новое приложение api Rails:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">rails </span>new my_api <span class="nt">--api</span>
</code></pre>
</div>
<p>Это сделает три основных вещи:</p><ul><li>Сконфигурирует приложение, чтобы оно запускало более ограниченный набор промежуточных программ, чем обычно. В частности, оно не включит по умолчанию какие-либо промежуточные программы, полезные для браузерных приложений (такие как поддержка куки).
</li><li>Унаследует <code>ApplicationController</code> от <code>ActionController::API</code> вместо <code>ActionController::Base</code>. Как и в случае с промежуточными программами, это выкинет все модули Action Controller, предоставляющие функциональность, в основном используемую браузерными приложениями.
</li><li>Сконфигурирует генераторы, чтобы они пропускали генерацию вью, хелперов и ассетов при генерации нового ресурса.
</li></ul><h4 id='izmenenie-suschestvuyuschego-prilozheniya' class='inside_page_header'><a href="#izmenenie-suschestvuyuschego-prilozheniya">3.2.</a> Изменение существующего приложения</h4><p>Если хотите взять существующее приложение и сделать его API-приложением, следуйте этим шагам.</p><p>В <code>config/application.rb</code> добавьте следующую строчку в самый верх определения класса <code>Application</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">api_only</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
</div>
<p>В <code>config/environments/development.rb</code> установите <a href="/configuring#config-debug-exception-response-format"><code>config.debug_exception_response_format</code></a>, чтобы настроить формат, используемый в откликах, когда происходит ошибка в режиме development.</p><p>Чтобы отрендерить страницу HTML с отладочной информацией, используйте значение <code>:default</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">debug_exception_response_format</span> <span class="o">=</span> <span class="ss">:default</span>
</code></pre>
</div>
<p>Чтобы отрендерить отладочную информацию, сохранив формат отклика, используйте значение <code>:api</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">debug_exception_response_format</span> <span class="o">=</span> <span class="ss">:api</span>
</code></pre>
</div>
<p>По умолчанию <code>config.debug_exception_response_format</code> установлен <code>:api</code>, когда <code>config.api_only</code> установлен true.</p><p>Наконец, в <code>app/controllers/application_controller.rb</code> вместо:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</code></pre>
</div>
<p>сделайте:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">API</span>
<span class="k">end</span>
</code></pre>
</div>
<h3 id='vybor-promezhutochnyh-programm' class='inside_page_header'><a href="#vybor-promezhutochnyh-programm">4.</a> Выбор промежуточных программ</h3><p>API-приложение поставляется со следующими промежуточными программами по умолчанию:</p><ul><li><code>ActionDispatch::HostAuthorization</code>
</li><li><code>Rack::Sendfile</code>
</li><li><code>ActionDispatch::Static</code>
</li><li><code>ActionDispatch::Executor</code>
</li><li><code>ActionDispatch::ServerTiming</code>
</li><li><code>ActiveSupport::Cache::Strategy::LocalCache::Middleware</code>
</li><li><code>Rack::Runtime</code>
</li><li><code>ActionDispatch::RequestId</code>
</li><li><code>ActionDispatch::RemoteIp</code>
</li><li><code>Rails::Rack::Logger</code>
</li><li><code>ActionDispatch::ShowExceptions</code>
</li><li><code>ActionDispatch::DebugExceptions</code>
</li><li><code>ActionDispatch::ActionableExceptions</code>
</li><li><code>ActionDispatch::Reloader</code>
</li><li><code>ActionDispatch::Callbacks</code>
</li><li><code>ActiveRecord::Migration::CheckPending</code>
</li><li><code>Rack::Head</code>
</li><li><code>Rack::ConditionalGet</code>
</li><li><code>Rack::ETag</code>
</li></ul><p>Смотрите раздел по <a href="/rails-on-rack#internal-middleware-stack">внутренним промежуточным программам</a> руководства по Rack, чтобы узнать подробности о них.</p><p>Другие плагины, включая Active Record, могут добавлять дополнительные промежуточные программы. В основном, эти промежуточные программы безразличны к типу создаваемого приложения, и имеют смысл в API-приложении Rails.</p><p>Можно получить список всех промежуточных программ вашего приложения с помощью:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>middleware
</code></pre>
</div>
<h4 id='ispolzovanie-keshiruyuschey-promezhutochnoy-programmy' class='inside_page_header'><a href="#ispolzovanie-keshiruyuschey-promezhutochnoy-programmy">4.1.</a> Использование кэширующей промежуточной программы</h4><p>По умолчанию Rails добавит промежуточную программу, предоставляющую хранилище кэша, основанного на конфигурации вашего приложения (по умолчанию memcache). Это означает, что встроенный кэш HTTP будет полагаться на нее.</p><p>Например, используя метод <code>stale?</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">show</span>
  <span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>

  <span class="k">if</span> <span class="n">stale?</span><span class="p">(</span><span class="ss">last_modified: </span><span class="vi">@post</span><span class="p">.</span><span class="nf">updated_at</span><span class="p">)</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="vi">@post</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Вызов <code>stale?</code> сравнит заголовок <code>If-Modified-Since</code> в запросе с <code>@post.updated_at</code>. Если заголовок новее, чем время последнего модифицирования, этот экшн вернет отклик &quot;304 Not Modified&quot;. В противном случае, он отрендерит отклик и включит в него заголовок <code>Last-Modified</code>.</p><p>Обычно этот механизм используется отдельно для каждого клиента. Кэширующая промежуточная программа позволяет распределять этот кэширующий механизм между клиентами. Можно включить межклиентское кэширование в вызове <code>stale?</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">show</span>
  <span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>

  <span class="k">if</span> <span class="n">stale?</span><span class="p">(</span><span class="ss">last_modified: </span><span class="vi">@post</span><span class="p">.</span><span class="nf">updated_at</span><span class="p">,</span> <span class="ss">public: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="vi">@post</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Это означает, что кэширующая промежуточная программа сохранит значение <code>Last-Modified</code> для URL в кэше Rails, и добавит заголовок <code>If-Modified-Since</code> в любой последующий входящий запрос к этому URL.</p><p>Воспринимайте это как кэширование страниц в семантике HTTP.</p><h4 id='ispolzovanie-rack-sendfile' class='inside_page_header'><a href="#ispolzovanie-rack-sendfile">4.2.</a> Использование Rack::Sendfile</h4><p>При использовании метода <code>send_file</code> в контроллере Rails, он устанавливает заголовок <code>X-Sendfile</code>. <code>Rack::Sendfile</code> ответственен за фактическую отсылку файла.</p><p>Если ваш фронтенд сервер поддерживает ускоренную отсылку файла, <code>Rack::Sendfile</code> переложит работу по фактической отсылке файла на фронтенд сервер.</p><p>Можно настроить имя заголовка, которое использует ваш фронтенд сервер для этой цели, с помощью <a href="/configuring#config-action-dispatch-x-sendfile-header"><code>config.action_dispatch.x_sendfile_header</code></a> в соответствующем среде конфигурационном файле.</p><p>Подробнее узнать о том, как использовать <code>Rack::Sendfile</code> с популярными фронтендами можно в <a href="https://www.rubydoc.info/gems/rack/Rack/Sendfile">документации Rack::Sendfile</a>.</p><p>Вот несколько значений этого заголовка для некоторых популярных серверов, которые, как только эти серверы будут настроены, добавят поддержку для ускоренной отсылки файла:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Apache и lighttpd</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">x_sendfile_header</span> <span class="o">=</span> <span class="s2">"X-Sendfile"</span>

<span class="c1"># Nginx</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">x_sendfile_header</span> <span class="o">=</span> <span class="s2">"X-Accel-Redirect"</span>
</code></pre>
</div>
<p>Убедитесь, что сконфигурировали на своем сервере поддержку этих опций в соответствии с инструкциями в документации <code>Rack::Sendfile</code>.</p><h4 id='ispolzovanie-actiondispatch-request' class='inside_page_header'><a href="#ispolzovanie-actiondispatch-request">4.3.</a> Использование ActionDispatch::Request</h4><p><code>ActionDispatch::Request#params</code> примет параметры от клиента в формате JSON и сделает их доступными в контроллере внутри <code>params</code>.</p><p>Для его использования клиенту нужно сделать запрос с кодированными в JSON параметрами и указать <code>Content-Type</code> как <code>application/json</code>.</p><p>Вот пример на jQuery:</p><div class="code_container">
  <pre><code class="highlight js"><span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
  <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/people</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">dataType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">json</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">contentType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="na">person</span><span class="p">:</span> <span class="p">{</span> <span class="na">firstName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Yehuda</span><span class="dl">"</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Katz</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}),</span>
  <span class="na">success</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>
<p><code>ActionDispatch::Request</code> увидит <code>Content-Type</code> и вашими параметрами будут:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="p">{</span> <span class="ss">:person</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:firstName</span> <span class="o">=&gt;</span> <span class="s2">"Yehuda"</span><span class="p">,</span> <span class="ss">:lastName</span> <span class="o">=&gt;</span> <span class="s2">"Katz"</span> <span class="p">}</span> <span class="p">}</span>
</code></pre>
</div>
<h4 id='ispolzovanie-promezhutochnyh-programm-dlya-sessiy' class='inside_page_header'><a href="#ispolzovanie-promezhutochnyh-programm-dlya-sessiy">4.4.</a> Использование промежуточных программ для сессий</h4><p>Следующие промежуточные программы, используемые для управления сессией, исключены из приложений API, так как им обычно не нужны сессии. Если один из ваших клиентов API это браузер, возможно, вы захотите вернуть одну из:</p><ul><li><code>ActionDispatch::Session::CacheStore</code>
</li><li><code>ActionDispatch::Session::CookieStore</code>
</li><li><code>ActionDispatch::Session::MemCacheStore</code>
</li></ul><p>Трудность в их возврате в том, что по умолчанию при добавлении они передают <code>session_options</code> (включая ключ сессии), поэтому нельзя просто добавить инициализатор <code>session_store.rb</code>, добавить <code>use ActionDispatch::Session::CookieStore</code> и получить функционирующие сессии. (Проясним: сессии может и будут работать, но опции сессии будут игнорироваться - т.е. будет ключ сессии по умолчанию <code>_session_id</code>)</p><p>Вместо этого инициализатора нужно установить нужные опции где-то до создания стека промежуточных программ (наподобие <code>config/application.rb</code>) и передать их в предпочитаемую промежуточную программу, наподобие:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Это также сконфигурирует session_options для использования ниже</span>
<span class="n">config</span><span class="p">.</span><span class="nf">session_store</span> <span class="ss">:cookie_store</span><span class="p">,</span> <span class="ss">key: </span><span class="s1">'_interslice_session'</span>

<span class="c1"># Требуется для всех управлений сессиями (независимо от session_store)</span>
<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Cookies</span>

<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">use</span> <span class="n">config</span><span class="p">.</span><span class="nf">session_store</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="nf">session_options</span>
</code></pre>
</div>
<h4 id='drugie-promezhutochnye-programmy' class='inside_page_header'><a href="#drugie-promezhutochnye-programmy">4.5.</a> Другие промежуточные программы</h4><p>Rails поставляется с рядом других промежуточных программ, которые вы, возможно, захотите использовать в API-приложении, особенно если одним из клиентов вашего API является браузер:</p><ul><li><code>Rack::MethodOverride</code>
</li><li><code>ActionDispatch::Cookies</code>
</li><li><code>ActionDispatch::Flash</code>
</li></ul><p>Любые из этих промежуточных программ могут быть добавлены с помощью:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">MethodOverride</span>
</code></pre>
</div>
<h4 id='udalenie-promezhutochnyh-programm' class='inside_page_header'><a href="#udalenie-promezhutochnyh-programm">4.6.</a> Удаление промежуточных программ</h4><p>Если вы не хотите использовать промежуточную программу, которая включена по умолчанию в набор промежуточных программ для API, ее можно убрать с помощью:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">delete</span> <span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">Sendfile</span>
</code></pre>
</div>
<p>Учтите, что удаление этих промежуточных программ удалит поддержку для определенных особенностей в Action Controller.</p><h3 id='vybor-moduley-kontrollera' class='inside_page_header'><a href="#vybor-moduley-kontrollera">5.</a> Выбор модулей контроллера</h3><p>API-приложение (использующее <code>ActionController::API</code>) по умолчанию поставляется со следующими модулями:</p><ul><li><code>ActionController::UrlFor</code>: Делает доступными <code>url_for</code> и подобные хелперы.
</li><li><code>ActionController::Redirecting</code>: Поддержка для <code>redirect_to</code>.
</li><li><code>AbstractController::Rendering</code> и <code>ActionController::ApiRendering</code>: Базовая поддержка для рендеринга.
</li><li><code>ActionController::Renderers::All</code>: Поддержка для <code>render :json</code> и сотоварищей.
</li><li><code>ActionController::ConditionalGet</code>: Поддержка для <code>stale?</code>.
</li><li><code>ActionController::BasicImplicitRender</code>: Убеждается, что возвращен пустой отклик, если нет явного.
</li><li><code>ActionController::StrongParameters</code>: Поддержка для фильтрации параметров в сочетании с массовым назначением Active Model.
</li><li><code>ActionController::DataStreaming</code>: Поддержка для <code>send_file</code> и <code>send_data</code>.
</li><li><code>AbstractController::Callbacks</code>: Поддержка для <code>before_action</code> и подобных хелперов.
</li><li><code>ActionController::Rescue</code>: Поддержка для <code>rescue_from</code>.
</li><li><code>ActionController::Instrumentation</code>: Поддержка для инструментальных хуков, определенных Action Controller (подробности относительно этого смотрите в руководстве <a href="/active-support-instrumentation#action-controller">Инструментарий Active Support</a>).
</li><li><code>ActionController::ParamsWrapper</code>: Оборачивает хэш параметров во вложенный хэш, таким образом, к примеру, не нужно указывать корневые элементы при посылка запросов POST.
</li><li><code>ActionController::Head</code>: Поддержка возврата отклика без тела сообщения, только заголовки.
</li></ul><p>Другие плагины могут добавлять дополнительные модули. Список всех модулей, включенных в <code>ActionController::API</code> можно получить в консоли rails:</p><div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">ActionController</span><span class="o">::</span><span class="no">API</span><span class="p">.</span><span class="nf">ancestors</span> <span class="o">-</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Metal</span><span class="p">.</span><span class="nf">ancestors</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="no">ActionController</span><span class="o">::</span><span class="no">API</span><span class="p">,</span>
    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Railties</span><span class="o">::</span><span class="no">ControllerRuntime</span><span class="p">,</span>
    <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Routing</span><span class="o">::</span><span class="no">RouteSet</span><span class="o">::</span><span class="no">MountedHelpers</span><span class="p">,</span>
    <span class="no">ActionController</span><span class="o">::</span><span class="no">ParamsWrapper</span><span class="p">,</span>
    <span class="o">...</span> <span class="p">,</span>
    <span class="no">AbstractController</span><span class="o">::</span><span class="no">Rendering</span><span class="p">,</span>
    <span class="no">ActionView</span><span class="o">::</span><span class="no">ViewPaths</span><span class="p">]</span>
</code></pre>
</div>
<h4 id='dobavlenie-drugih-moduley' class='inside_page_header'><a href="#dobavlenie-drugih-moduley">5.1.</a> Добавление других модулей</h4><p>Все модули Action Controller знают о зависимых модулях, поэтому можно свободно включать любые модули в контроллеры, и будут включены и настроены все зависимости.</p><p>Некоторые распространенные модули, которые вы, возможно, захотите добавить:</p><ul><li><code>AbstractController::Translation</code>: Поддержка для методов локализации <code>l</code> и перевода <code>t</code>.
</li><li>Поддержка для базовой, дайджестной или токенной аутентификации HTTP:
<ul><li><code>ActionController::HttpAuthentication::Basic::ControllerMethods</code>
</li><li><code>ActionController::HttpAuthentication::Digest::ControllerMethods</code>
</li><li><code>ActionController::HttpAuthentication::Token::ControllerMethods</code>
</li></ul></li><li><code>ActionView::Layouts</code>: Поддержка для макетов при рендеринге.
</li><li><code>ActionController::MimeResponds</code>: Поддержка для <code>respond_to</code>.
</li><li><code>ActionController::Cookies</code>: Поддержка для <code>cookies</code>, что включает поддержку для подписанных и зашифрованных куки. Он требует промежуточную программу для куки.
</li><li><p><code>ActionController::Caching</code>: Поддержка кэширования вью для контроллера API. Отметьте, что нужно вручную указать хранилище кэша внутри контроллера подобно следующему:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">API</span>
  <span class="kp">include</span> <span class="o">::</span><span class="no">ActionController</span><span class="o">::</span><span class="no">Caching</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">cache_store</span> <span class="o">=</span> <span class="ss">:mem_cache_store</span>
<span class="k">end</span>
</code></pre>
</div>
</li></ul><p>  Rails <em>не</em> передает эту конфигурацию автоматически.</p><p>Лучшим местом для добавления модулей является <code>ApplicationController</code>, но вы также можете добавить модули в отдельные контроллеры.</p>

            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

   <!-- bottom rusrails -->
   <ins class="adsbygoogle"
        style="display:inline-block;width:580px;height:400px"
        data-ad-client="ca-pub-7764391801669990"
        data-ad-slot="7566253867"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
        </div>
        <div class="row-fluid">
          <div class="span12" id="footer">
            <p>
              <a target="blank" href="https://github.com/rusrails/rusrails"><img src="/assets/github-7cc23602a5ac2465f14c19492358a5a67dc24636761cc723e4d621cea0c09225.png" /></a>
              <a target="blank" href="http://twitter.com/rusrails"><img src="/assets/twitter-50e0e767c8793dec313a7dc5cfbcfe2067e3e89ea6ec64784eb7c6640f578758.png" /></a>
            </p>
            <p>
              <a href="https://creativecommons.org/licenses/by-sa/4.0/">Лицензия CC BY-SA 4.0</a>
              "Rails", "Ruby on Rails" и логотип Rails - торговые марки DHH
              <!-- Yandex.Metrika counter -->
<script>
  (function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter1006929 = new Ya.Metrika({id:1006929,
                    webvisor:true,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true});
        } catch(e) { }
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>

<noscript>
  <div>
    <img style="position:absolute; left:-9999px;" alt="" src="//mc.yandex.ru/watch/1006929" />
  </div>
</noscript>
<!-- /Yandex.Metrika counter -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64955373-1', 'auto');
  ga('send', 'pageview');

  var trackOutboundLink = function(url) {
    ga('send', 'event', 'outbound', 'click', url, {
      'transport': 'beacon',
      'hitCallback': function(){ }
    });
  }
</script>

            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="to_top" style="display: block">
      <div class="to_top_panel"></div>
    </div>
    <script src="/assets/application-8ee447905888b153d8458707061a14b1f15f69b6733e871a3ad91d80ae89e87b.js"></script>
  </body>
</html>
