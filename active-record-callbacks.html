<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8">
<meta content="Ruby on Rails, Ruby, Rails, Rails 3, Rails 4, Rails 5, Rails 6, Rails 6.0, Rails 6.1, Rails 7.0, Rails 7.1 руководство, начинающим, самоучитель, manual, мануал, справочник, учебник, примеры, Руби, рельсы" name="keywords"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" name="description"/>
<meta content="product" property="twitter:card"/>
<meta content="@rusrails" property="twitter:site"/>
<meta content="Rusrails: Колбэки Active Record" property="twitter:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="twitter:description"/>
<meta content="@rusrails" property="twitter:creator"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="twitter:image"/>
<meta content="website" property="og:type"/>
<meta content="Rusrails: Колбэки Active Record" property="og:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="og:description"/>
<meta content="http://localhost:3000/active-record-callbacks" property="og:url"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="og:image"/>
    <title>
      Rusrails: Колбэки Active Record
    </title>
    <link rel="stylesheet" href="/assets/application-f9dfa6ce7fa871006d478e422639671663284ddaa3126cf81ddfe371ac3533c4.css" />
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="/"></a>
          <ul class="nav pull-right top-menu">
            <li>
              <a href="/">Главная</a>
            </li>
            <li class="dropdown">
              <a class="index-popover" href="#">
                Содержание
                <b class="caret"></b>
</a>              <div class="index-popover-content hide">
                  <ul><li><p><strong>С чего начать?</strong></p><ul><li><a href="/getting-started">Rails для начинающих</a>
</li></ul></li><li><p><strong>Модели</strong></p><ul><li><a href="/active-record-basics">Основы Active Record</a>
</li><li><a href="/active-record-migrations">Миграции Active Record</a>
</li><li><a href="/active-record-validations">Валидации Active Record</a>
</li><li><a href="/active-record-callbacks">Колбэки Active Record</a>
</li><li><a href="/active-record-associations">Связи (ассоциации) Active Record</a>
</li><li><a href="/active-record-querying">Интерфейс запросов Active Record</a>
</li><li><a href="/active-model-basics">Основы Active Model</a>
</li></ul></li><li><p><strong>Вью</strong></p><ul><li><a href="/action-view-overview">Обзор Action View</a>
</li><li><a href="/layouts-and-rendering">Макеты и рендеринг в Rails</a>
</li><li><a href="/action-view-helpers">Хелперы Action View</a>
</li><li><a href="/form-helpers">Хелперы форм в Action View</a>
</li></ul></li><li><p><strong>Контроллеры</strong></p><ul><li><a href="/action-controller-overview">Обзор Action Controller</a>
</li><li><a href="/routing">Роутинг в Rails</a>
</li></ul></li><li><p><strong>Другие компоненты</strong></p><ul><li><a href="/active-support-core-extensions">Расширения ядра Active Support</a>
</li><li><a href="/action-mailer-basics">Основы Action Mailer</a>
</li><li><a href="/action-mailbox-basics">Основы Action Mailbox</a>
</li><li><a href="/action-text-overview">Обзор Action Text</a>
</li><li><a href="/active_job_basics">Основы Active Job</a>
</li><li><a href="/active_storage_overview">Обзор Active Storage</a>
</li><li><a href="/action-cable-overview">Обзор Action Cable</a>
</li></ul></li><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/i18n">API интернационализации Rails (I18n)</a>
</li><li><a href="/testing">Тестирование приложений на Rails</a>
</li><li><a href="/security">Безопасность приложений на Rails</a>
</li><li><a href="/error-reporting">Отчет об ошибках в приложениях Rails</a>
</li><li><a href="/debugging-rails-applications">Отладка приложений на Rails</a>
</li></ul></li></ul><p>next_column</p><ul><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/configuring">Конфигурирование приложений на Rails</a>
</li><li><a href="/command-line">Командная строка Rails</a>
</li><li><a href="/asset-pipeline">Asset Pipeline</a>
</li><li><a href="/working-with-javascript-in-rails">Работа с JavaScript в Rails</a>
</li><li><a href="/initialization">Процесс инициализации в Rails</a>
</li><li><a href="/autoloading-and-reloading-constants">Автозагрузка и перезагрузка констант</a>
</li><li><a href="/classic-to-zeitwerk-howto">Как перейти с Classic на Zeitwerk</a>
</li><li><a href="/caching-with-rails">Кэширование с Rails: Обзор</a>
</li><li><a href="/active-support-instrumentation">Инструментарий Active Support</a>
</li><li><a href="/api-app">Использование Rails для API-приложений</a>
</li><li><a href="/active-record-postgresql">Active Record для PostgreSQL</a>
</li><li><a href="/active-record-multiple-databases">Несколько баз данных с Active Record</a>
</li><li><a href="/active-record-encryption">Шифрование Active Record</a>
</li></ul></li><li><p><strong>Расширяем Rails</strong></p><ul><li><a href="/plugins">Основы создания плагинов Rails</a>
</li><li><a href="/rails-on-rack">Rails on Rack</a>
</li><li><a href="/generators">Создание и настройка генераторов и шаблонов Rails</a>
</li><li><a href="/engines">Engine для начинающих</a>
</li><li><a href="/threading_and_code_execution">Треды и выполнение кода в Rails</a>
</li><li><a href="/rails-application-templates">Шаблоны приложения Rails</a>
</li></ul></li><li><p><strong>Вносим вклад в Ruby on Rails</strong></p><ul><li><a href="/contributing_to_ruby_on_rails">Вносим вклад в Ruby on Rails</a>
</li><li><a href="/api_documentation_guidelines">Рекомендации по документированию API</a>
</li><li><a href="/ruby_on_rails_guides_guidelines">Рекомендации для руководств по Ruby on Rails</a>
</li><li><a href="/development_dependencies_install">Установка зависимостей для разработки</a>
</li><li><a href="/maintenance-policy">Политика поддержки (версий)</a>
</li></ul></li><li><p><strong>Заметки о релизах</strong></p><ul><li><a href="/upgrading-ruby-on-rails">Апгрейд Ruby on Rails</a>
</li><li><a href="/7_2_release_notes">Версия 7.2 - ?</a>
</li><li><a href="/7_1_release_notes">Версия 7.1 - Октябрь 2023</a>
</li><li><a href="/7_0_release_notes">Версия 7.0 - Декабрь 2021</a>
</li><li><a href="/6_1_release_notes">Версия 6.1 - Декабрь 2020</a>
</li><li><a href="/6_0_release_notes">Версия 6.0 - Август 2019</a>
</li></ul></li></ul>
              </div>
            </li>
            <li>
              <a href="/search">Поиск</a>
            </li>
            <li>
              <a target="blank" href="http://api.rusrails.ru">Ruby &amp; Rails API</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="content-wrapper">
      <div class="container-fluid">
        <div class="row-fluid">
          <div class="span3 pull-right">
            <div class="well social">
              <h4>Принимаем пожелания и пул-реквесты!</h4>
              <iframe allowtransparency="true" frameborder="0" height="30" src="http://ghbtns.com/github-btn.html?user=rusrails&repo=rusrails&type=watch&count=true&size=large" width="180"></iframe>
              <p></p>
              <a class="twitter-follow-button" data-lang="ru" href="https://twitter.com/rusrails"></a>
            </div>
              <div class="well menu">
                    <ul class="nav nav-list">
      <li>
        <h4>
          <a href="#zhiznennyy-tsikl-ob-ekta">1. Жизненный цикл объекта</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#registratsiya-kolbekov">2. Регистрация колбэков</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#registering-callbacks-to-fire-on-life-cycle-events">2.1. Регистрация колбэков, срабатывающих на событиях жизненного цикла</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#dostupnye-kolbeki">3. Доступные колбэки</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#sozdanie-ob-ekta">3.1. Создание объекта</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#validation-callbacks">3.1.1. Валидационные колбэки</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#save-callbacks">3.1.2. Колбэки сохранения</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#kolbeki-sozdaniya">3.1.3. колбэки создания</a>
</h6>      </li>
      <li>
        <h5>
          <a href="#obnovlenie-ob-ekta">3.2. Обновление объекта</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#kolbeki-obnovleniya">3.2.1. Колбэки обновления</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#kombinirovanie-kolbekov">3.2.2. Комбинирование колбэков</a>
</h6>      </li>
      <li>
        <h5>
          <a href="#unichtozhenie-ob-ekta">3.3. Уничтожение объекта</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#kolbeki-unichtozheniya">3.3.1. Колбэки уничтожения</a>
</h6>      </li>
      <li>
        <h5>
          <a href="#after_initialize-i-after_find">3.4. <code>after_initialize</code> и <code>after_find</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#after_touch">3.5. <code>after_touch</code></a>
</h5>      </li>
      <li>
        <h4>
          <a href="#zapusk-kolbekov">4. Запуск колбэков</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#uslovnye-kolbeki">5. Условные колбэки</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#ispolzovanie-if-i-unless-s-symbol">5.1. Использование <code>:if</code> и <code>:unless</code> с <code>Symbol</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#ispolzovanie-if-i-unless-s-proc">5.2. Использование <code>:if</code> и <code>:unless</code> с <code>Proc</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#multiple-callback-conditions">5.3. Составные условия колбэков</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#odnovremennoe-ispolzovanie-if-i-unless">5.4. Одновременное использование :if и :unless</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#propusk-kolbekov">6. Пропуск колбэков</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#podavlenie-kolbekov">7. Подавление колбэков</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#ostanovka-vypolneniya">8. Остановка выполнения</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#association-callbacks">9. Колбэки связей</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#kaskadnye-kolbeki-svyazey">10. Каскадные колбэки связей</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#transaction-callbacks">11. Транзакционные колбэки</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#after-commit-and-after-rollback">11.1. <code>after_commit</code> и <code>after_rollback</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#psevdonimy-dlya-after_commit">11.2. Псевдонимы для <code>after_commit</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#uporyadochivanie-tranzaktsionnyh-kolbekov">11.3. Упорядочивание транзакционных колбэков</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#callback-objects">12. Объекты колбэков</a>
</h4>      </li>
</ul>

              </div>
            <div class="well banner300 banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<!-- sidebar rusrails -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:600px"
     data-ad-client="ca-pub-7764391801669990"
     data-ad-slot="6089520660"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
          <div class="span9 content pull-left">
            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <!-- top rusrails -->
  <ins class="adsbygoogle"
       style="display:inline-block;width:980px;height:120px"
       data-ad-client="ca-pub-7764391801669990"
       data-ad-slot="4891989065"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
              <h2 id='kolbeki-active-record' class='inside_page_header'> Колбэки Active Record</h2><p>Это руководство научит вас вмешиваться в жизненный цикл ваших объектов Active Record.</p><p>После прочтения этого руководства вы узнаете:</p><ul><li>Когда определенные события случаются в течение жизни объекта Active Record.
</li><li>Как регистрировать, запускать и пропускать колбэки, реагирующие на события.
</li><li>Как создавать реляционные, ассоциативные, условные и транзакционные колбэки.
</li><li>Как создавать объекты, инкапсулирующие общее поведение для повторного использования ваших колбэков.
</li></ul><h3 id='zhiznennyy-tsikl-ob-ekta' class='inside_page_header'><a href="#zhiznennyy-tsikl-ob-ekta">1.</a> Жизненный цикл объекта</h3><p>В результате обычных операций приложения на Rails, объекты могут быть <a href="/active-record-basics#crud-reading-and-writing-data">созданы, обновлены и уничтожены</a>. Active Record дает возможность вмешаться в этот жизненный цикл объекта, таким образом, вы можете контролировать свое приложение и его данные.</p><p>Колбэки позволяют вам переключать логику до или после изменения состояния объекта. Это методы, которые вызываются в определенные моменты жизненного цикла объекта. С помощью колбэков можно писать код, который будет выполняться всякий раз, когда объект Active Record инициализируется, создается, сохраняется, обновляется, удаляется, проверяется на валидность или загружается из базы данных.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">BirthdayCake</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_create</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Congratulations, the callback has run!"</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">BirthdayCake</span><span class="p">.</span><span class="nf">create</span>
<span class="go">Congratulations, the callback has run!
</span></code></pre>
</div>
<p>Вы увидите, что есть множество событий жизненного цикла, и несколько вариантов вклиниться в них - или до, или после или даже вокруг них.</p><h3 id='registratsiya-kolbekov' class='inside_page_header'><a href="#registratsiya-kolbekov">2.</a> Регистрация колбэков</h3><p>Для того, чтобы использовать доступные колбэки, их необходимо реализовать и зарегистрировать. Реализация может быть выполнена множеством способов, например, с помощью обычных методов, блоков и proc, или путем определения пользовательских объектов колбэков с использованием классов или модулей. Давайте рассмотрим каждую из этих методик реализации.</p><p>Вы можете зарегистрировать колбэки с помощью <strong>специального макро-метода класса, который вызывает обычный метод</strong> для реализации.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>

  <span class="n">before_validation</span> <span class="ss">:ensure_username_has_value</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">ensure_username_has_value</span>
      <span class="k">if</span> <span class="n">username</span><span class="p">.</span><span class="nf">blank?</span>
        <span class="nb">self</span><span class="p">.</span><span class="nf">username</span> <span class="o">=</span> <span class="n">email</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p><strong>Макро-методы класса также могут получать блок</strong>. Их следует использовать, если код внутри блока такой короткий, что помещается в одну строчку.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>

  <span class="n">before_validation</span> <span class="k">do</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">username</span> <span class="o">=</span> <span class="n">email</span> <span class="k">if</span> <span class="n">username</span><span class="p">.</span><span class="nf">blank?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Альтернативно можно <strong>передать в колбэк proc</strong>, который будут выполнен.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>

  <span class="n">before_validation</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span> <span class="n">user</span><span class="p">.</span><span class="nf">username</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">email</span> <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">username</span><span class="p">.</span><span class="nf">blank?</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Наконец, можно определить <strong>собственный объект колбэка</strong>, как показано ниже. мы раскроем их <a href="#callback-objects">ниже подробнее</a>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>

  <span class="n">before_validation</span> <span class="no">AddUsername</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">AddUsername</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">before_validation</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">record</span><span class="p">.</span><span class="nf">username</span><span class="p">.</span><span class="nf">blank?</span>
      <span class="n">record</span><span class="p">.</span><span class="nf">username</span> <span class="o">=</span> <span class="n">record</span><span class="p">.</span><span class="nf">email</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='registering-callbacks-to-fire-on-life-cycle-events' class='inside_page_header'><a href="#registering-callbacks-to-fire-on-life-cycle-events">2.1.</a> Регистрация колбэков, срабатывающих на событиях жизненного цикла</h4><p>Колбэки также можно регистрировать для срабатывания только на определенных событиях жизненного цикла. Это можно сделать с помощью опции <code>:on</code>, которая позволяет полностью контролировать, когда и в каком контексте будут вызываться ваши колбэки.</p><div class="note"><p>Контекст - это категория или сценарий, в котором вы хотите применить определенные проверки.  При валидации модели ActiveRecord вы можете указать контекст для группировки проверок. Это позволяет вам иметь разные наборы валидаций, применяемые в разных ситуациях. В Rails существуют определенные контексты по умолчанию для проверок, такие как :create, :update и :save.</p></div><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>

  <span class="n">before_validation</span> <span class="ss">:ensure_username_has_value</span><span class="p">,</span> <span class="ss">on: :create</span>

  <span class="c1"># :on также принимает массив</span>
  <span class="n">after_validation</span> <span class="ss">:set_location</span><span class="p">,</span> <span class="ss">on: </span><span class="p">[</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:update</span> <span class="p">]</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">ensure_username_has_value</span>
      <span class="k">if</span> <span class="n">username</span><span class="p">.</span><span class="nf">blank?</span>
        <span class="nb">self</span><span class="p">.</span><span class="nf">username</span> <span class="o">=</span> <span class="n">email</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">set_location</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">location</span> <span class="o">=</span> <span class="no">LocationService</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="note"><p>Считается хорошей практикой объявлять методы колбэков как private. Если их оставить public, они могут быть вызваны извне модели и нарушить принципы инкапсуляции объекта.</p></div><div class="warning"><p>Не рекомендуется использовать методы, такие как <code>update</code>, <code>save</code> или любые другие, которые вызывают побочные эффекты для объекта внутри ваших колбэков. <br><br> Например, избегайте вызова <code>update(attribute: &quot;value&quot;)</code> внутри колбэка. Эта практика может привести к изменению состояния модели и потенциально вызвать непредвиденные проблемы во время коммита. <br><br> Вместо этого, для более безопасного подхода вы можете напрямую присваивать значения (например, <code>self.attribute = &quot;value&quot;</code>) в колбэках, таких как <code>before_create</code>, <code>before_update</code> или даже более ранних.</p></div><h3 id='dostupnye-kolbeki' class='inside_page_header'><a href="#dostupnye-kolbeki">3.</a> Доступные колбэки</h3><p>Вот список всех доступных колбэков Active Record, перечисленных <strong>в том порядке, в котором они вызываются</strong> в течение соответствующих операций:</p><h4 id='sozdanie-ob-ekta' class='inside_page_header'><a href="#sozdanie-ob-ekta">3.1.</a> Создание объекта</h4><ul><li><a href="https://api.rubyonrails.org/classes/ActiveModel/Validations/Callbacks/ClassMethods.html#method-i-before_validation"><code>before_validation</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveModel/Validations/Callbacks/ClassMethods.html#method-i-after_validation"><code>after_validation</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-before_save"><code>before_save</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-around_save"><code>around_save</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-before_create"><code>before_create</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-around_create"><code>around_create</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_create"><code>after_create</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_save"><code>after_save</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_commit"><code>after_commit</code></a> / <a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_rollback"><code>after_rollback</code></a>
</li></ul><p>Примеры <code>after_commit</code> / <code>after_rollback</code> можно найти <a href="#after-commit-and-after-rollback">здесь</a>.</p><p>Ниже приведены примеры использования этих колбэков. Мы сгруппировали их по связанным операциям, а затем покажем, как их можно использовать совместно.</p><h5 id='validation-callbacks' class='inside_page_header'><a href="#validation-callbacks">3.1.1.</a> Валидационные колбэки</h5><p>Валидационные колбэки вызываются всякий раз, когда запись проверяется на валидность напрямую через методы <a href="https://api.rubyonrails.org/classes/ActiveModel/Validations.html#method-i-valid-3F"><code>valid?</code></a> (или его псевдоним <a href="https://api.rubyonrails.org/classes/ActiveModel/Validations.html#method-i-validate"><code>validate</code></a>) или <a href="https://api.rubyonrails.org/classes/ActiveModel/Validations.html#method-i-invalid-3F"><code>invalid?</code></a>, или косвенно через методы <code>create</code>, <code>update</code> или <code>save</code>. Они выполняются до и после этапа валидации.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">before_validation</span> <span class="ss">:titleize_name</span>
  <span class="n">after_validation</span> <span class="ss">:log_errors</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">titleize_name</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="nb">name</span><span class="p">.</span><span class="nf">downcase</span><span class="p">.</span><span class="nf">titleize</span> <span class="k">if</span> <span class="nb">name</span><span class="p">.</span><span class="nf">present?</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Name titleized to </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">log_errors</span>
      <span class="k">if</span> <span class="n">errors</span><span class="p">.</span><span class="nf">any?</span>
        <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">"Validation failed: </span><span class="si">#{</span><span class="n">errors</span><span class="p">.</span><span class="nf">full_messages</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s2">""</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"john.doe@example.com"</span><span class="p">,</span> <span class="ss">password: </span><span class="s2">"abc123456"</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"john.doe@example.com"</span><span class="p">,</span> <span class="ss">created_at: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">""</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">valid?</span>
<span class="go">Name titleized to
Validation failed: Name can't be blank
</span><span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
</div>
<h5 id='save-callbacks' class='inside_page_header'><a href="#save-callbacks">3.1.2.</a> Колбэки сохранения</h5><p>Колбэки сохранения вызываются всякий раз, когда запись передается (т.е. &quot;сохраняется&quot;) в базу данных с помощью методов <code>create</code>, <code>update</code> или <code>save</code>. Они вызываются до, после и во время сохранения объекта.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:hash_password</span>
  <span class="n">around_save</span> <span class="ss">:log_saving</span>
  <span class="n">after_save</span> <span class="ss">:update_cache</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">hash_password</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">password_digest</span> <span class="o">=</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Password hashed for user with email: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">log_saving</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Saving user with email: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">yield</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User saved with email: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">update_cache</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">cache</span><span class="p">.</span><span class="nf">write</span><span class="p">([</span><span class="s2">"user_data"</span><span class="p">,</span> <span class="nb">self</span><span class="p">],</span> <span class="n">attributes</span><span class="p">)</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Update Cache"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Jane Doe"</span><span class="p">,</span> <span class="ss">password: </span><span class="s2">"password"</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"jane.doe@example.com"</span><span class="p">)</span>
<span class="err">
</span><span class="go">Password encrypted for user with email: jane.doe@example.com
Saving user with email: jane.doe@example.com
User saved with email: jane.doe@example.com
Update Cache
</span><span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"jane.doe@example.com"</span><span class="p">,</span> <span class="ss">created_at: </span><span class="s2">"2024-03-20 16:02:43.685500000 +0000"</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="s2">"2024-03-20 16:02:43.685500000 +0000"</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"Jane Doe"</span><span class="kt">&gt;</span>
</code></pre>
</div>
<h5 id='kolbeki-sozdaniya' class='inside_page_header'><a href="#kolbeki-sozdaniya">3.1.3.</a> колбэки создания</h5><p>колбэки создания вызываются всякий раз, когда запись <strong>впервые</strong> передается (т.е. &quot;сохраняется&quot;) в базу данных. Другими словами, они срабатывают при сохранении новой записи с помощью методов <code>create</code> или <code>save</code>. Они вызываются до, после и во время создания объекта.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_create</span> <span class="ss">:set_default_role</span>
  <span class="n">around_create</span> <span class="ss">:log_creation</span>
  <span class="n">after_create</span> <span class="ss">:send_welcome_email</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">set_default_role</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">role</span> <span class="o">=</span> <span class="s2">"user"</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User role set to default: user"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">log_creation</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Creating user with email: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">yield</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User created with email: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">send_welcome_email</span>
      <span class="no">UserMailer</span><span class="p">.</span><span class="nf">welcome_email</span><span class="p">(</span><span class="nb">self</span><span class="p">).</span><span class="nf">deliver_later</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User welcome email sent to: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"john.doe@example.com"</span><span class="p">)</span>
<span class="err">
</span><span class="go">User role set to default: user
Creating user with email: john.doe@example.com
User created with email: john.doe@example.com
User welcome email sent to: john.doe@example.com
</span><span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="mi">10</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"john.doe@example.com"</span><span class="p">,</span> <span class="ss">created_at: </span><span class="s2">"2024-03-20 16:19:52.405195000 +0000"</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="s2">"2024-03-20 16:19:52.405195000 +0000"</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"John Doe"</span><span class="kt">&gt;</span>
</code></pre>
</div>
<h4 id='obnovlenie-ob-ekta' class='inside_page_header'><a href="#obnovlenie-ob-ekta">3.2.</a> Обновление объекта</h4><p>Колбэки обновления вызываются всякий раз, когда <strong>существующая</strong> запись передается (т.е. &quot;сохраняется&quot;) в базу данных. Они вызываются до, после и во время обновления объекта.</p><ul><li><a href="https://api.rubyonrails.org/classes/ActiveModel/Validations/Callbacks/ClassMethods.html#method-i-before_validation"><code>before_validation</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveModel/Validations/Callbacks/ClassMethods.html#method-i-after_validation"><code>after_validation</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-before_save"><code>before_save</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-around_save"><code>around_save</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-before_update"><code>before_update</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-around_update"><code>around_update</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_update"><code>after_update</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_save"><code>after_save</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_commit"><code>after_commit</code></a> / <a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_rollback"><code>after_rollback</code></a>
</li></ul><div class="warning"><p>Колбэк <code>after_save</code> вызывается как при создании, так и при обновлении записей. Однако он всегда выполняется после более специфичных колбэков <code>after_create</code> и <code>after_update</code>, независимо от порядка вызова макросов. Аналогично, колбэки <code>before_save</code> и <code>around_save</code> следуют тому же правилу: <code>before_save</code> запускается перед созданием/обновлением, а <code>around_save</code> — вокруг операций создания/обновления.  Важно отметить, что колбэки сохранения всегда будут выполняться до/вокруг/после более специфических колбэков создания/обновления.</p></div><p>Мы уже рассмотрели колбэки <a href="#validation-callbacks">валидации</a> и <a href="#save-callbacks">сохранения</a>.  Примеры <code>after_commit</code> / <code>after_rollback</code> можно найти <a href="#after-commit-and-after-rollback">здесь</a>.</p><h5 id='kolbeki-obnovleniya' class='inside_page_header'><a href="#kolbeki-obnovleniya">3.2.1.</a> Колбэки обновления</h5><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_update</span> <span class="ss">:check_role_change</span>
  <span class="n">around_update</span> <span class="ss">:log_updating</span>
  <span class="n">after_update</span> <span class="ss">:send_update_email</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">check_role_change</span>
      <span class="k">if</span> <span class="n">role_changed?</span>
        <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User role changed to </span><span class="si">#{</span><span class="n">role</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">log_updating</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Updating user with email: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">yield</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User updated with email: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">send_update_email</span>
      <span class="no">UserMailer</span><span class="p">.</span><span class="nf">update_email</span><span class="p">(</span><span class="nb">self</span><span class="p">).</span><span class="nf">deliver_later</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Update email sent to: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"john.doe@example.com"</span><span class="p">,</span> <span class="ss">created_at: </span><span class="s2">"2024-03-20 16:19:52.405195000 +0000"</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="s2">"2024-03-20 16:19:52.405195000 +0000"</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">,</span> <span class="ss">role: </span><span class="s2">"user"</span> <span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">role: </span><span class="s2">"admin"</span><span class="p">)</span>
<span class="go">User role changed to admin
Updating user with email: john.doe@example.com
User updated with email: john.doe@example.com
Update email sent to: john.doe@example.com
</span></code></pre>
</div>
<h5 id='kombinirovanie-kolbekov' class='inside_page_header'><a href="#kombinirovanie-kolbekov">3.2.2.</a> Комбинирование колбэков</h5><p>Во многих случаях для достижения нужного поведения требуется комбинация колбэков. Например, вы можете захотеть отправить приветственное письмо после создания пользователя, но только если это новый пользователь, а не обновляемый. При обновлении информации о пользователе вы можете захотеть уведомить администратора, если были изменены важные данные. В этом случае вы можете использовать вместе колбэки <code>after_create</code> и <code>after_update</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_create</span> <span class="ss">:send_confirmation_email</span>
  <span class="n">after_update</span> <span class="ss">:notify_admin_if_critical_info_updated</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">send_confirmation_email</span>
      <span class="no">UserMailer</span><span class="p">.</span><span class="nf">confirmation_email</span><span class="p">(</span><span class="nb">self</span><span class="p">).</span><span class="nf">deliver_later</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Confirmation email sent to: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">notify_admin_if_critical_info_updated</span>
      <span class="k">if</span> <span class="n">saved_change_to_email?</span> <span class="o">||</span> <span class="n">saved_change_to_phone_number?</span>
        <span class="no">AdminMailer</span><span class="p">.</span><span class="nf">user_critical_info_updated</span><span class="p">(</span><span class="nb">self</span><span class="p">).</span><span class="nf">deliver_later</span>
        <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Notification sent to admin about critical info update for: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"john.doe@example.com"</span><span class="p">)</span>
<span class="go">Confirmation email sent to: john.doe@example.com
</span><span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"john.doe@example.com"</span><span class="p">,</span> <span class="o">...</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">email: </span><span class="s2">"john.doe.new@example.com"</span><span class="p">)</span>
<span class="go">Notification sent to admin about critical info update for: john.doe.new@example.com
</span><span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
</div>
<h4 id='unichtozhenie-ob-ekta' class='inside_page_header'><a href="#unichtozhenie-ob-ekta">3.3.</a> Уничтожение объекта</h4><p>Колбэки уничтожения вызываются всякий раз, когда запись уничтожается, но игнорируются при удалении записи. Они вызываются до, после и во время уничтожения объекта.</p><ul><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-before_destroy"><code>before_destroy</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-around_destroy"><code>around_destroy</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_destroy"><code>after_destroy</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_commit"><code>after_commit</code></a> / <a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_rollback"><code>after_rollback</code></a>
</li></ul><p>Примеры <code>after_commit</code> / <code>after_rollback</code> можно найти <a href="#after-commit-and-after-rollback">здесь</a>.</p><h5 id='kolbeki-unichtozheniya' class='inside_page_header'><a href="#kolbeki-unichtozheniya">3.3.1.</a> Колбэки уничтожения</h5><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_destroy</span> <span class="ss">:check_admin_count</span>
  <span class="n">around_destroy</span> <span class="ss">:log_destroy_operation</span>
  <span class="n">after_destroy</span> <span class="ss">:notify_users</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">check_admin_count</span>
      <span class="k">if</span> <span class="n">admin?</span> <span class="o">&amp;&amp;</span> <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">role: </span><span class="s2">"admin"</span><span class="p">).</span><span class="nf">count</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="kp">throw</span> <span class="ss">:abort</span>
      <span class="k">end</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Checked the admin count"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">log_destroy_operation</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"About to destroy user with ID </span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">yield</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User with ID </span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> destroyed successfully"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">notify_users</span>
      <span class="no">UserMailer</span><span class="p">.</span><span class="nf">deletion_email</span><span class="p">(</span><span class="nb">self</span><span class="p">).</span><span class="nf">deliver_later</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Notification sent to other users about user deletion"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"john.doe@example.com"</span><span class="p">,</span> <span class="ss">created_at: </span><span class="s2">"2024-03-20 16:19:52.405195000 +0000"</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="s2">"2024-03-20 16:19:52.405195000 +0000"</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">,</span> <span class="ss">role: </span><span class="s2">"admin"</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">destroy</span>
<span class="go">Checked the admin count
About to destroy user with ID 1
User with ID 1 destroyed successfully
Notification sent to other users about user deletion
</span></code></pre>
</div>
<h4 id='after_initialize-i-after_find' class='inside_page_header'><a href="#after_initialize-i-after_find">3.4.</a> <code>after_initialize</code> и <code>after_find</code></h4><p>Всякий раз, когда возникает объект Active Record или непосредственно при использовании <code>new</code>, или когда запись загружается из базы данных, будет вызван колбэк <a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_initialize"><code>after_initialize</code></a>. Он может быть полезен, чтобы избежать необходимости напрямую переопределять метод Active Record <code>initialize</code>.</p><p>При загрузке записи из базы данных, будет вызван колбэк <a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_find"><code>after_find</code></a>. <code>after_find</code> вызывается перед <code>after_initialize</code>, если они оба определены.</p><div class="note"><p>У колбэков <code>after_initialize</code> и <code>after_find</code> нет пары <code>before_*</code>.</p></div><p>Они могут быть зарегистрированы подобно другим колбэкам Active Record.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_initialize</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"You have initialized an object!"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">after_find</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"You have found an object!"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">User</span><span class="p">.</span><span class="nf">new</span>
<span class="go">You have initialized an object!
</span><span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="kp">nil</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">User</span><span class="p">.</span><span class="nf">first</span>
<span class="go">You have found an object!
You have initialized an object!
</span><span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="mi">1</span><span class="kt">&gt;</span>
</code></pre>
</div>
<h4 id='after_touch' class='inside_page_header'><a href="#after_touch">3.5.</a> <code>after_touch</code></h4><p>Колбэк <a href="https://api.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_touch"><code>after_touch</code></a> будет вызван, когда на объекте Active Record вызван <code>touch</code>. Подробнее о <code>touch</code> можно прочитать <a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-touch">здесь</a>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_touch</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"You have touched an object"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Kuldeep'</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"Kuldeep"</span><span class="p">,</span> <span class="ss">created_at: </span><span class="s2">"2013-11-25 12:17:49"</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="s2">"2013-11-25 12:17:49"</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">touch</span>
<span class="go">You have touched an object
</span><span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
</div>
<p>Он может быть использован совместно с <code>belongs_to</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:library</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
  <span class="n">after_touch</span> <span class="k">do</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"A Book was touched"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Library</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">after_touch</span> <span class="ss">:log_when_books_or_library_touched</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">log_when_books_or_library_touched</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Book/Library was touched"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">last</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Book</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">library_id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">created_at: </span><span class="s2">"2013-11-25 17:04:22"</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="s2">"2013-11-25 17:05:05"</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">touch</span> <span class="c1"># вызывает book.library.touch</span>
<span class="go">A Book was touched
Book/Library was touched
</span><span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
</div>
<h3 id='zapusk-kolbekov' class='inside_page_header'><a href="#zapusk-kolbekov">4.</a> Запуск колбэков</h3><p>Следующие методы запускают колбэки:</p><ul><li><code>create</code>
</li><li><code>create!</code>
</li><li><code>destroy</code>
</li><li><code>destroy!</code>
</li><li><code>destroy_all</code>
</li><li><code>destroy_by</code>
</li><li><code>save</code>
</li><li><code>save!</code>
</li><li><code>save(validate: false)</code>
</li><li><code>save!(validate: false)</code>
</li><li><code>toggle!</code>
</li><li><code>touch</code>
</li><li><code>update_attribute</code>
</li><li><code>update_attribute!</code>
</li><li><code>update</code>
</li><li><code>update!</code>
</li><li><code>valid?</code>
</li><li><code>validate</code>
</li></ul><p>Дополнительно, колбэк <code>after_find</code> запускается следующими поисковыми методами:</p><ul><li><code>all</code>
</li><li><code>first</code>
</li><li><code>find</code>
</li><li><code>find_by</code>
</li><li><code>find_by!</code>
</li><li><code>find_by_*</code>
</li><li><code>find_by_*!</code>
</li><li><code>find_by_sql</code>
</li><li><code>last</code>
</li><li><code>sole</code>
</li><li><code>take</code>
</li></ul><p>Колбэк <code>after_initialize</code> запускается всякий раз, когда инициализируется новый объект класса.</p><div class="note"><p>Методы <code>find_by_*</code> и <code>find_by_*!</code> это динамические методы поиска, генерируемые автоматически для каждого атрибута. Изучите подробнее их в <a href="/active-record-querying#dynamic-finders">разделе Динамический поиск</a></p></div><h3 id='uslovnye-kolbeki' class='inside_page_header'><a href="#uslovnye-kolbeki">5.</a> Условные колбэки</h3><p>Как и в <a href="/active-record-validations">валидациях</a>, возможно сделать вызов метода колбэка условным в зависимости от заданного предиката. Это осуществляется при использовании опций <code>:if</code> и <code>:unless</code>, которые могут принимать символ, <code>Proc</code> или массив.</p><p>Опцию <code>:if</code> следует использовать для определения, при каких условиях колбэк <em>должен</em> быть вызван. Если вы хотите определить условия, при которых колбэк <em>не должен</em> быть вызван, используйте опцию <code>:unless</code>.</p><h4 id='ispolzovanie-if-i-unless-s-symbol' class='inside_page_header'><a href="#ispolzovanie-if-i-unless-s-symbol">5.1.</a> Использование <code>:if</code> и <code>:unless</code> с <code>Symbol</code></h4><p>Опции <code>:if</code> и <code>:unless</code> можно связать с символом, соответствующим имени метода предиката, который будет вызван непосредственно перед вызовом колбэка.</p><p>При использовании опции <code>:if</code>, колбэк <strong>не будет</strong> выполнен, если метод предиката возвратит <strong>false</strong>; при использовании опции <code>:unless</code>, колбэк <strong>не будет</strong> выполнен, если метод предиката возвратит <strong>true</strong>. Это самый распространенный вариант.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:normalize_card_number</span><span class="p">,</span> <span class="ss">if: :paid_with_card?</span>
<span class="k">end</span>
</code></pre>
</div>
<p>При использовании такой формы регистрации, также возможно зарегистрировать несколько различных предикатов, которые будут вызваны, чтобы проверить, должен ли выполняться колбэк. Мы раскроем это <a href="#multiple-callback-conditions">ниже</a>.</p><h4 id='ispolzovanie-if-i-unless-s-proc' class='inside_page_header'><a href="#ispolzovanie-if-i-unless-s-proc">5.2.</a> Использование <code>:if</code> и <code>:unless</code> с <code>Proc</code></h4><p>Можно связать <code>:if</code> и <code>:unless</code> с объектом <code>Proc</code>. Этот вариант больше всего подходит при написании коротких методов, обычно однострочных.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:normalize_card_number</span><span class="p">,</span>
    <span class="ss">if: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">order</span><span class="p">)</span> <span class="p">{</span> <span class="n">order</span><span class="p">.</span><span class="nf">paid_with_card?</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Так как proc вычисляется в контексте объекта, также возможно написать так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:normalize_card_number</span><span class="p">,</span> <span class="ss">if: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="n">paid_with_card?</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='multiple-callback-conditions' class='inside_page_header'><a href="#multiple-callback-conditions">5.3.</a> Составные условия колбэков</h4><p>Опции <code>:if</code> и <code>:unless</code> также принимают массив из proc или имен методов в виде символов:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:filter_content</span><span class="p">,</span>
    <span class="ss">if: </span><span class="p">[</span><span class="ss">:subject_to_parental_control?</span><span class="p">,</span> <span class="ss">:untrusted_author?</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>
<p>В список условий также можно запросто включить proc:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:filter_content</span><span class="p">,</span>
    <span class="ss">if: </span><span class="p">[</span><span class="ss">:subject_to_parental_control?</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">untrusted_author?</span> <span class="p">}]</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='odnovremennoe-ispolzovanie-if-i-unless' class='inside_page_header'><a href="#odnovremennoe-ispolzovanie-if-i-unless">5.4.</a> Одновременное использование :if и :unless</h4><p>В колбэках можно смешивать <code>:if</code> и <code>:unless</code> в одном выражении:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:filter_content</span><span class="p">,</span>
    <span class="ss">if: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="n">forum</span><span class="p">.</span><span class="nf">parental_control?</span> <span class="p">},</span>
    <span class="ss">unless: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="n">author</span><span class="p">.</span><span class="nf">trusted?</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Колбэк запустится только когда все условия <code>:if</code> и не один из условий <code>:unless</code> будут истинны.</p><h3 id='propusk-kolbekov' class='inside_page_header'><a href="#propusk-kolbekov">6.</a> Пропуск колбэков</h3><p>Как и в <a href="/active-record-validations">валидациях</a>, возможно пропустить колбэки с помощью следующих методов:</p><ul><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-decrement-21"><code>decrement!</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/CounterCache/ClassMethods.html#method-i-decrement_counter"><code>decrement_counter</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-delete"><code>delete</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-delete_all"><code>delete_all</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-delete_by"><code>delete_by</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-increment-21"><code>increment!</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/CounterCache/ClassMethods.html#method-i-increment_counter"><code>increment_counter</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence/ClassMethods.html#method-i-insert"><code>insert</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence/ClassMethods.html#method-i-insert-21"><code>insert!</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence/ClassMethods.html#method-i-insert_all"><code>insert_all</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence/ClassMethods.html#method-i-insert_all-21"><code>insert_all!</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-touch_all"><code>touch_all</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-update_column"><code>update_column</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-update_columns"><code>update_columns</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-update_all"><code>update_all</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-update_counters"><code>update_counters</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence/ClassMethods.html#method-i-upsert"><code>upsert</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Persistence/ClassMethods.html#method-i-upsert_all"><code>upsert_all</code></a>
</li></ul><p>Давайте рассмотрим модель <code>User</code>, где колбэк <code>before_save</code> логирует любые изменения адреса электронной почты пользователя:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:log_email_change</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">log_email_change</span>
      <span class="k">if</span> <span class="n">email_changed?</span>
        <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Email changed from </span><span class="si">#{</span><span class="n">email_was</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Теперь предположим, что существует сценарий, в котором вы хотите обновить адрес электронной почты пользователя, не вызывая колбэк <code>before_save</code> для регистрации изменения email. Для этого вы можете использовать метод <code>update_columns</code>.</p><div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">update_columns</span><span class="p">(</span><span class="ss">email: </span><span class="s1">'new_email@example.com'</span><span class="p">)</span>
</code></pre>
</div>
<p>Вышесказанное обновит адрес электронной почты пользователя без вызова колбэка <code>before_save</code>.</p><div class="warning"><p>Эти методы следует использовать с осторожностью, поскольку в колбэках могут быть важные бизнес-правила и логика приложения, которые вы не хотите обходить. Их обход без понимания потенциальных последствий может привести к неверным данным.</p></div><h3 id='podavlenie-kolbekov' class='inside_page_header'><a href="#podavlenie-kolbekov">7.</a> Подавление колбэков</h3><p>В некоторых ситуациях вам может понадобиться временно отключить выполнение определенных колбэков в вашем Rails-приложении. Это полезно, когда вы хотите пропустить конкретные действия во время определенных операций, не отключая колбэки навсегда.</p><p>Rails предоставляет механизм подавления колбэков с помощью <a href="https://api.rubyonrails.org/classes/ActiveRecord/Suppressor.html">модуля <code>ActiveRecord::Suppressor</code></a>. Используя этот модуль, вы можете обернуть блок кода, в котором хотите подавить колбэки, гарантируя, что они не будут выполняться во время этой конкретной операции.</p><p>Рассмотрим сценарий, где у нас есть модель <code>User</code> с колбэком, который отправляет приветственное письмо новым пользователям после регистрации. Однако могут быть случаи, когда вы хотите создать пользователя без отправки приветственного письма, например, при заполнении базы данных тестовыми данными.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_create</span> <span class="ss">:send_welcome_email</span>

  <span class="k">def</span> <span class="nf">send_welcome_email</span>
    <span class="nb">puts</span> <span class="s2">"Welcome email sent to </span><span class="si">#{</span><span class="nb">self</span><span class="p">.</span><span class="nf">email</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>В этом примере колбэк <code>after_create</code> вызывает метод <code>send_welcome_email</code> каждый раз, когда создается новый пользователь.</p><p>Чтобы создать пользователя без отправки приветственного письма, мы можем использовать модуль <code>ActiveRecord::Suppressor</code> следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">User</span><span class="p">.</span><span class="nf">suppress</span> <span class="k">do</span>
  <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Jane"</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"jane@example.com"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>
<p>В этом коде блок <code>User.suppress</code> гарантирует, что колбэк <code>send_welcome_email</code> не будет выполнен во время создания пользователя &quot;Jane&quot;, позволяя создать пользователя без отправки приветственного письма.</p><div class="warning"><p>Использование механизма подавления колбэков ActiveRecord, хотя и может быть полезным для выборочного управления их выполнением, может привести к усложнению кода и неожиданному поведению. Подавление колбэков может затемнить логику работы вашего приложения, что со временем затруднит понимание и поддержку кодовой базы. Тщательно взвешивайте необходимость подавления колбэков, обеспечивая тщательную документацию и продуманное тестирование, чтобы снизить риски непреднамеренных побочных эффектов, проблем с производительностью и сбоев тестов.</p></div><h3 id='ostanovka-vypolneniya' class='inside_page_header'><a href="#ostanovka-vypolneniya">8.</a> Остановка выполнения</h3><p>При регистрации новых колбэков для ваших моделей они будут помещены в очередь на выполнение. Эта очередь будет включать все валидации модели, зарегистрированные колбэки и операцию с базой данных, которая должна быть выполнена.</p><p>Вся цепочка колбэков обернута в транзакцию. Если какой-либо колбэк вызывает исключение, цепочка выполнения прерывается, выполняется <strong>откат</strong>, а ошибка будет выброшена повторно.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_validation</span> <span class="k">do</span>
    <span class="k">raise</span> <span class="s2">"Price can't be negative"</span> <span class="k">if</span> <span class="n">total_price</span> <span class="o">&lt;</span> <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Product</span><span class="p">.</span><span class="nf">create</span> <span class="c1"># вызовет "Price can't be negative"</span>
</code></pre>
</div>
<p>Это неожиданно приводит к сбою кода, который не ожидает, что методы вроде <code>create</code> и <code>save</code> будут вызывать исключения.</p><div class="note"><p>Если во время цепочки колбэков возникает исключение, Rails повторно выбросит его, за исключением случаев, когда это исключение <code>ActiveRecord::Rollback</code> или <code>ActiveRecord::RecordInvalid</code>. Вместо этого, вы должны использовать <code>throw :abort</code> для преднамеренного прерывания цепочки. Если какой-либо колбэк использует кидает <code>:abort</code>, процесс будет прерван, а create вернет значение <code>create</code>.</p></div><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_validation</span> <span class="k">do</span>
    <span class="kp">throw</span> <span class="ss">:abort</span> <span class="k">if</span> <span class="n">total_price</span> <span class="o">&lt;</span> <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Product</span><span class="p">.</span><span class="nf">create</span> <span class="c1"># =&gt; false</span>
</code></pre>
</div>
<p>Однако при вызове метода <code>create!</code> будет выброшено исключение <code>ActiveRecord::RecordNotSaved</code>. Это исключение указывает на то, что запись не была сохранена из-за прерывания колбэком.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="c1"># =&gt; вызовет ActiveRecord::RecordNotSaved</span>
</code></pre>
</div>
<p>При <code>throw :abort</code> в любом колбэке уничтожения метод <code>destroy</code> вернет false:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_destroy</span> <span class="k">do</span>
    <span class="kp">throw</span> <span class="ss">:abort</span> <span class="k">if</span> <span class="n">still_active?</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">destroy</span> <span class="c1"># =&gt; false</span>
</code></pre>
</div>
<p>Однако, при вызове <code>destroy!</code> будет выброшено <code>ActiveRecord::RecordNotDestroyed</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">User</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">destroy!</span> <span class="c1"># =&gt; вызовет ActiveRecord::RecordNotDestroyed</span>
</code></pre>
</div>
<h3 id='association-callbacks' class='inside_page_header'><a href="#association-callbacks">9.</a> Колбэки связей</h3><p>Колбэки связей похожи на обычные колбэки, но они вызываются событиями в жизненном цикле связанной коллекции. Существует четыре доступных колбэка связей:</p><ul><li><code>before_add</code>
</li><li><code>after_add</code>
</li><li><code>before_remove</code>
</li><li><code>after_remove</code>
</li></ul><p>Вы можете определить колбэки связей, добавив опции к самой связи.</p><p>Представим ситуацию, когда автор может иметь множество книг. Однако, прежде чем добавлять книгу в коллекцию автора, вы хотите убедиться, что автор не достиг своего лимита книг. Этого можно добиться с помощью колбэка <code>before_add</code>, который проверит лимит.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">before_add: :check_limit</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">check_limit</span>
      <span class="k">if</span> <span class="n">books</span><span class="p">.</span><span class="nf">count</span> <span class="o">&gt;=</span> <span class="mi">5</span>
        <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:base</span><span class="p">,</span> <span class="s2">"Cannot add more than 5 books for this author"</span><span class="p">)</span>
        <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Если колбэк <code>before_add</code> бросает <code>:abort</code>, объект не добавляется в коллекцию.</p><p>Иногда вам может понадобиться выполнить несколько действий с связанным объектом. В этом случае вы можете объединить колбэки для одного события, передав их массивом. Кроме того, Rails автоматически передает колбэку объект, который добавляется или удаляется, для использования вами.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">before_add: </span><span class="p">[</span><span class="ss">:check_limit</span><span class="p">,</span> <span class="ss">:calculate_shipping_charges</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">check_limit</span>
    <span class="k">if</span> <span class="n">books</span><span class="p">.</span><span class="nf">count</span> <span class="o">&gt;=</span> <span class="mi">5</span>
      <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:base</span><span class="p">,</span> <span class="s2">"Cannot add more than 5 books for this author"</span><span class="p">)</span>
      <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">calculate_shipping_charges</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="n">weight_in_pounds</span> <span class="o">=</span> <span class="n">book</span><span class="p">.</span><span class="nf">weight_in_pounds</span> <span class="o">||</span> <span class="mi">1</span>
    <span class="n">shipping_charges</span> <span class="o">=</span> <span class="n">weight_in_pounds</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="n">shipping_charges</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Аналогично, если колбэк <code>before_remove</code> бросает <code>:abort</code>, объект не будет удален из коллекции.</p><div class="note"><p>Эти колбэки вызываются только тогда, когда связанные объекты добавляются или удаляются через коллекцию ассоциации.</p></div><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Вызывает колбэк `before_add`</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span> <span class="o">&lt;&lt;</span> <span class="n">book</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span> <span class="o">=</span> <span class="p">[</span><span class="n">book</span><span class="p">,</span> <span class="n">book2</span><span class="p">]</span>

<span class="c1"># Не вызывает колбэк `before_add`</span>
<span class="n">book</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">author_id: </span><span class="mi">1</span><span class="p">)</span>
</code></pre>
</div>
<h3 id='kaskadnye-kolbeki-svyazey' class='inside_page_header'><a href="#kaskadnye-kolbeki-svyazey">10.</a> Каскадные колбэки связей</h3><p>Колбэки могут быть вызваны при изменении связанных объектов. Они работают через связи моделей, при этом жизненные циклы событий могут ниспадать по связям и запускать колбэки.</p><p>Представим ситуацию, когда у пользователя есть много статей. Статьи пользователя должны быть удалены, если сам пользователь удаляется. Давайте добавим колбэк <code>after_destroy</code> к модели <code>User</code> через ее связь с моделью <code>Article</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_destroy</span> <span class="ss">:log_destroy_action</span>

  <span class="k">def</span> <span class="nf">log_destroy_action</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Article destroyed"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">first</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="mi">1</span><span class="kt">&gt;</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">create!</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Article</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">user_id: </span><span class="mi">1</span><span class="kt">&gt;</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">destroy</span>
<span class="go">Article destroyed
</span><span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="mi">1</span><span class="kt">&gt;</span>
</code></pre>
</div>
<div class="warning"><p>При использовании колбэка <code>before_destroy</code> его следует размещать перед связями с <code>dependent: :destroy</code> (или использовать опцию <code>prepend: true</code>), чтобы гарантировать их выполнение до того, как записи будут удалены с помощью <code>dependent: :destroy</code>.</p></div><h3 id='transaction-callbacks' class='inside_page_header'><a href="#transaction-callbacks">11.</a> Транзакционные колбэки</h3><h4 id='after-commit-and-after-rollback' class='inside_page_header'><a href="#after-commit-and-after-rollback">11.1.</a> <code>after_commit</code> и <code>after_rollback</code></h4><p>Два дополнительных колбэка вызываются по завершению транзакции базы данных: <a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_commit"><code>after_commit</code></a> и <a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_rollback"><code>after_rollback</code></a>. Эти колбэки очень похожи на колбэк <code>after_save</code>, за исключением того, что они не выполняются пока изменения в базе данных не будут подтверждены или обращены. Они наиболее полезны, когда вашим моделям Active Record необходимо взаимодействовать с внешними системами, не являющимися частью транзакции базы данных.</p><p>Рассмотрим модель <code>PictureFile</code>. которой необходимо удалить файл после того, как запись уничтожена.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PictureFile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_destroy</span> <span class="ss">:delete_picture_file_from_disk</span>

  <span class="k">def</span> <span class="nf">delete_picture_file_from_disk</span>
    <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
      <span class="no">File</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Если что-либо вызовет исключение после того, как был вызван колбэк <code>after_destroy</code>, и транзакция откатывается, тогда файл будет удален и модель останется в противоречивом состоянии. Например, предположим, что <code>picture_file_2</code> в следующем коде не валидна, и метод <code>save!</code> вызовет ошибку.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">PictureFile</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="n">picture_file_1</span><span class="p">.</span><span class="nf">destroy</span>
  <span class="n">picture_file_2</span><span class="p">.</span><span class="nf">save!</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Используя колбэк <code>after_commit</code>, можно учесть этот случай.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PictureFile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_commit</span> <span class="ss">:delete_picture_file_from_disk</span><span class="p">,</span> <span class="ss">on: :destroy</span>

  <span class="k">def</span> <span class="nf">delete_picture_file_from_disk</span>
    <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
      <span class="no">File</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="note"><p>Опция <code>:on</code> определяет, когда будет запущен колбэк. Если не предоставить опцию <code>:on</code>, колбэк будет запущен для каждого события жизненного цикла.  Подробнее об <code>:on</code> читайте <a href="#registering-callbacks-to-fire-on-life-cycle-events">тут</a>.</p></div><p>Когда транзакция завершается, колбэки <code>after_commit</code> или <code>after_rollback</code> вызываются для всех моделей, созданных, обновленных или уничтоженных внутри этой транзакции. Однако, если внутри одного из этих колбэков возникает исключение, оно будет передано дальше, и любые оставшиеся методы <code>after_commit</code> или <code>after_rollback</code> <em>не</em> будут выполнены.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">after_commit</span> <span class="p">{</span> <span class="k">raise</span> <span class="s2">"Intentional Error"</span> <span class="p">}</span>
  <span class="n">after_commit</span> <span class="p">{</span>
    <span class="c1"># Это не будет вызвано, потому что предыдущий after_commit вызывает исключение.</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"This will not be logged"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="warning"><p>Если код вашего колбэка вызывает исключение, вам нужно будет перехватить его и обработать внутри колбэка, чтобы дать другим колбэкам возможность выполниться.</p></div><p><code>after_commit</code> предоставляет совершенно другие гарантии, чем <code>after_save</code>, <code>after_update</code> и <code>after_destroy</code>. Например, если исключение возникает в <code>after_save</code>, транзакция будет отменена, и данные не сохранятся.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">after_save</span> <span class="k">do</span>
    <span class="c1"># Если это завершится с ошибкой, пользователь не будет сохранен.</span>
    <span class="no">EventLog</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">event: </span><span class="s2">"user_saved"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Однако, во время <code>after_commit</code> данные уже были сохранены в базе данных, поэтому любое исключение больше ничего не откатит.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">after_commit</span> <span class="k">do</span>
    <span class="c1"># Если это завершится с ошибкой, пользователь уже был сохранен.</span>
    <span class="no">EventLog</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">event: </span><span class="s2">"user_saved"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Код внутри колбэков <code>after_commit</code> или <code>after_rollback</code> не выполняется в отдельной транзакции.</p><p>В контексте одиночной транзакции, важно учитывать поведение колбэков <code>after_commit</code> и <code>after_rollback</code>, когда вы работаете с несколькими объектами, представляющими одну и ту же запись в базе данных. Эти колбэки вызываются только для первого объекта конкретной записи, которая изменяется внутри транзакции. Для других загруженных объектов, даже если они представляют ту же запись в базе данных, их соответствующие колбэки <code>after_commit</code> или <code>after_rollback</code> не будут вызваны.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_commit</span> <span class="ss">:log_user_saved_to_db</span><span class="p">,</span> <span class="ss">on: :update</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">log_user_saved_to_db</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User was saved to database"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">User</span><span class="p">.</span><span class="nf">transaction</span> <span class="p">{</span> <span class="n">user</span><span class="p">.</span><span class="nf">save</span><span class="p">;</span> <span class="n">user</span><span class="p">.</span><span class="nf">save</span> <span class="p">}</span>
<span class="c"># User was saved to database
</span></code></pre>
</div>
<div class="warning"><p>Это тонкое поведение особенно влияет на сценарии, где вы ожидаете независимого выполнения колбэков для каждого объекта, связанного с одной и той же записью в базе данных. Оно может повлиять на последовательность и предсказуемость вызова колбэков, что может привести к потенциальным несоответствиям в логике приложения после транзакции.</p></div><h4 id='psevdonimy-dlya-after_commit' class='inside_page_header'><a href="#psevdonimy-dlya-after_commit">11.2.</a> Псевдонимы для <code>after_commit</code></h4><p>Использование колбэка <code>after_commit</code> только при создании, обновлении или удалении данных является распространенной практикой. Иногда вы также можете захотеть использовать один колбэк для обоих <code>create</code> и <code>update</code>. Вот некоторые распространенные псевдонимы для этих операций:</p><ul><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_destroy_commit"><code>after_destroy_commit</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_create_commit"><code>after_create_commit</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_update_commit"><code>after_update_commit</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_save_commit"><code>after_save_commit</code></a>
</li></ul><p>Давайте разберем несколько примеров:</p><p>Вместо использования <code>after_commit</code> с опцией <code>on</code> для уничтожения, как показано ниже:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PictureFile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_commit</span> <span class="ss">:delete_picture_file_from_disk</span><span class="p">,</span> <span class="ss">on: :destroy</span>

  <span class="k">def</span> <span class="nf">delete_picture_file_from_disk</span>
    <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
      <span class="no">File</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Вместо этого можно использовать <code>after_destroy_commit</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PictureFile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_destroy_commit</span> <span class="ss">:delete_picture_file_from_disk</span>

  <span class="k">def</span> <span class="nf">delete_picture_file_from_disk</span>
    <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
      <span class="no">File</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>То же самое применимо к <code>after_create_commit</code> и <code>after_update_commit</code>.</p><p>Однако, если используются <code>after_create_commit</code> и <code>after_update_commit</code> с одним и тем же именем метода, сработает только колбэк, определенный последним, так как они оба являются псевдонимами к <code>after_commit</code>, который переопределяет ранее определенные колбэки с тем же именем метода.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_create_commit</span> <span class="ss">:log_user_saved_to_db</span>
  <span class="n">after_update_commit</span> <span class="ss">:log_user_saved_to_db</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">log_user_saved_to_db</span>
      <span class="c1"># Это будет вызвано один раз</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User was saved to database"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span> <span class="c1"># ничего не выводит</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">save</span> <span class="c1"># обновление user</span>
<span class="go">User was saved to database
</span></code></pre>
</div>
<p>В этом случае лучше использовать <code>after_save_commit</code>, который является псевдонимом для использования колбэка <code>after_commit</code> для создания и обновления записей:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_save_commit</span> <span class="ss">:log_user_saved_to_db</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">log_user_saved_to_db</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User was saved to database"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span> <span class="c1"># создание a User</span>
<span class="go">User was saved to database
</span><span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">save</span> <span class="c1"># обновление user</span>
<span class="go">User was saved to database
</span></code></pre>
</div>
<h4 id='uporyadochivanie-tranzaktsionnyh-kolbekov' class='inside_page_header'><a href="#uporyadochivanie-tranzaktsionnyh-kolbekov">11.3.</a> Упорядочивание транзакционных колбэков</h4><p>По умолчанию (начиная с Rails 7.1), транзакционные колбэки выполняются в том порядке, в котором они определены.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">after_commit</span> <span class="p">{</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"this gets called first"</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">after_commit</span> <span class="p">{</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"this gets called second"</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Впрочем, в предыдущих версиях Rails при определении нескольких транзакционных колбэков <code>after_</code> (<code>after_commit</code>, <code>after_rollback</code> и т.д.) порядок их выполнения был обратным.</p><p>Если по какой-то причине вы по-прежнему хотите, чтобы они выполнялись в обратном порядке, вы можете установить <a href="/configuring#config-active-record-run-after-transaction-callbacks-in-order-defined">следующую конфигурацию</a> в значение <code>false</code>. Тогда колбэки будут выполняться в обратном порядке.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">run_after_transaction_callbacks_in_order_defined</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
</div>
<div class="note"><p>Это также применяется ко всем вариациям <code>after_*_commit</code>, таким как <code>after_destroy_commit</code>.</p></div><h3 id='callback-objects' class='inside_page_header'><a href="#callback-objects">12.</a> Объекты колбэков</h3><p>Иногда методы колбэков, которые вы пишете, могут быть настолько полезными, что их можно будет переиспользовать в других моделях. Active Record позволяет создавать классы, которые инкапсулируют методы колбэков, чтобы их можно было переиспользовать.</p><p>Вот пример класса колбэка <code>after_commit</code> для очистки ненужных файлов из файловой системы. Это поведение может быть не уникальным для нашей модели <code>PictureFile</code>, и мы можем захотеть поделиться им, поэтому хорошей идеей будет инкапсулировать его в отдельный класс. Это значительно облегчит тестирование и изменение этого поведения.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">FileDestroyerCallback</span>
  <span class="k">def</span> <span class="nf">after_commit</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">filepath</span><span class="p">)</span>
      <span class="no">File</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">filepath</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>При объявлении внутри класса, как показано выше, методы колбэка будут получать объект модели в качестве параметра. Это будет работать для любой модели, которая использует класс следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PictureFile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_commit</span> <span class="no">FileDestroyerCallback</span><span class="p">.</span><span class="nf">new</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Имейте в виду, что нам нужно было создать новый объект <code>FileDestroyerCallback</code>, поскольку мы объявили наш колбэк как метод экземпляра. Это особенно полезно, если колбэки используют состояние созданного объекта. Однако во многих случаях более разумно объявлять колбэки как методы класса:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">FileDestroyerCallback</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">after_commit</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">filepath</span><span class="p">)</span>
      <span class="no">File</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">filepath</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>При объявлении метода колбэка таким образом, не потребуется создавать новый объект <code>FileDestroyerCallback</code> в нашей модели.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PictureFile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_commit</span> <span class="no">FileDestroyerCallback</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Внутри объектов колбэков вы можете объявлять столько колбэков, сколько вам нужно.</p>

            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

   <!-- bottom rusrails -->
   <ins class="adsbygoogle"
        style="display:inline-block;width:580px;height:400px"
        data-ad-client="ca-pub-7764391801669990"
        data-ad-slot="7566253867"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
        </div>
        <div class="row-fluid">
          <div class="span12" id="footer">
            <p>
              <a target="blank" href="https://github.com/rusrails/rusrails"><img src="/assets/github-7cc23602a5ac2465f14c19492358a5a67dc24636761cc723e4d621cea0c09225.png" /></a>
              <a target="blank" href="http://twitter.com/rusrails"><img src="/assets/twitter-50e0e767c8793dec313a7dc5cfbcfe2067e3e89ea6ec64784eb7c6640f578758.png" /></a>
            </p>
            <p>
              <a href="https://creativecommons.org/licenses/by-sa/4.0/">Лицензия CC BY-SA 4.0</a>
              "Rails", "Ruby on Rails" и логотип Rails - торговые марки DHH
              <!-- Yandex.Metrika counter -->
<script>
  (function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter1006929 = new Ya.Metrika({id:1006929,
                    webvisor:true,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true});
        } catch(e) { }
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>

<noscript>
  <div>
    <img style="position:absolute; left:-9999px;" alt="" src="//mc.yandex.ru/watch/1006929" />
  </div>
</noscript>
<!-- /Yandex.Metrika counter -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64955373-1', 'auto');
  ga('send', 'pageview');

  var trackOutboundLink = function(url) {
    ga('send', 'event', 'outbound', 'click', url, {
      'transport': 'beacon',
      'hitCallback': function(){ }
    });
  }
</script>

            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="to_top" style="display: block">
      <div class="to_top_panel"></div>
    </div>
    <script src="/assets/application-8ee447905888b153d8458707061a14b1f15f69b6733e871a3ad91d80ae89e87b.js"></script>
  </body>
</html>
