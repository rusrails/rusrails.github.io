<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8">
<meta content="Ruby on Rails, Ruby, Rails, Rails 3, Rails 4, Rails 5, Rails 6, Rails 6.0, Rails 6.1, Rails 7.0, Rails 7.1 руководство, начинающим, самоучитель, manual, мануал, справочник, учебник, примеры, Руби, рельсы" name="keywords"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" name="description"/>
<meta content="product" property="twitter:card"/>
<meta content="@rusrails" property="twitter:site"/>
<meta content="Rusrails: Основы Active Record" property="twitter:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="twitter:description"/>
<meta content="@rusrails" property="twitter:creator"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="twitter:image"/>
<meta content="website" property="og:type"/>
<meta content="Rusrails: Основы Active Record" property="og:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="og:description"/>
<meta content="http://localhost:3000/active-record-basics" property="og:url"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="og:image"/>
    <title>
      Rusrails: Основы Active Record
    </title>
    <link rel="stylesheet" href="/assets/application-f9dfa6ce7fa871006d478e422639671663284ddaa3126cf81ddfe371ac3533c4.css" />
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="/"></a>
          <ul class="nav pull-right top-menu">
            <li>
              <a href="/">Главная</a>
            </li>
            <li class="dropdown">
              <a class="index-popover" href="#">
                Содержание
                <b class="caret"></b>
</a>              <div class="index-popover-content hide">
                  <ul><li><p><strong>С чего начать?</strong></p><ul><li><a href="/getting-started">Rails для начинающих</a>
</li></ul></li><li><p><strong>Модели</strong></p><ul><li><a href="/active-record-basics">Основы Active Record</a>
</li><li><a href="/active-record-migrations">Миграции Active Record</a>
</li><li><a href="/active-record-validations">Валидации Active Record</a>
</li><li><a href="/active-record-callbacks">Колбэки Active Record</a>
</li><li><a href="/active-record-associations">Связи (ассоциации) Active Record</a>
</li><li><a href="/active-record-querying">Интерфейс запросов Active Record</a>
</li><li><a href="/active-model-basics">Основы Active Model</a>
</li></ul></li><li><p><strong>Вью</strong></p><ul><li><a href="/action-view-overview">Обзор Action View</a>
</li><li><a href="/layouts-and-rendering">Макеты и рендеринг в Rails</a>
</li><li><a href="/action-view-helpers">Хелперы Action View</a>
</li><li><a href="/form-helpers">Хелперы форм в Action View</a>
</li></ul></li><li><p><strong>Контроллеры</strong></p><ul><li><a href="/action-controller-overview">Обзор Action Controller</a>
</li><li><a href="/routing">Роутинг в Rails</a>
</li></ul></li><li><p><strong>Другие компоненты</strong></p><ul><li><a href="/active-support-core-extensions">Расширения ядра Active Support</a>
</li><li><a href="/action-mailer-basics">Основы Action Mailer</a>
</li><li><a href="/action-mailbox-basics">Основы Action Mailbox</a>
</li><li><a href="/action-text-overview">Обзор Action Text</a>
</li><li><a href="/active_job_basics">Основы Active Job</a>
</li><li><a href="/active_storage_overview">Обзор Active Storage</a>
</li><li><a href="/action-cable-overview">Обзор Action Cable</a>
</li></ul></li><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/i18n">API интернационализации Rails (I18n)</a>
</li><li><a href="/testing">Тестирование приложений на Rails</a>
</li><li><a href="/security">Безопасность приложений на Rails</a>
</li><li><a href="/error-reporting">Отчет об ошибках в приложениях Rails</a>
</li><li><a href="/debugging-rails-applications">Отладка приложений на Rails</a>
</li></ul></li></ul><p>next_column</p><ul><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/configuring">Конфигурирование приложений на Rails</a>
</li><li><a href="/command-line">Командная строка Rails</a>
</li><li><a href="/asset-pipeline">Asset Pipeline</a>
</li><li><a href="/working-with-javascript-in-rails">Работа с JavaScript в Rails</a>
</li><li><a href="/initialization">Процесс инициализации в Rails</a>
</li><li><a href="/autoloading-and-reloading-constants">Автозагрузка и перезагрузка констант</a>
</li><li><a href="/caching-with-rails">Кэширование с Rails: Обзор</a>
</li><li><a href="/active-support-instrumentation">Инструментарий Active Support</a>
</li><li><a href="/api-app">Использование Rails для API-приложений</a>
</li><li><a href="/active-record-postgresql">Active Record для PostgreSQL</a>
</li><li><a href="/active-record-multiple-databases">Несколько баз данных с Active Record</a>
</li><li><a href="/active-record-encryption">Шифрование Active Record</a>
</li></ul></li><li><p><strong>Расширяем Rails</strong></p><ul><li><a href="/plugins">Основы создания плагинов Rails</a>
</li><li><a href="/rails-on-rack">Rails on Rack</a>
</li><li><a href="/generators">Создание и настройка генераторов и шаблонов Rails</a>
</li><li><a href="/engines">Engine для начинающих</a>
</li><li><a href="/threading_and_code_execution">Треды и выполнение кода в Rails</a>
</li><li><a href="/rails-application-templates">Шаблоны приложения Rails</a>
</li></ul></li><li><p><strong>Вносим вклад в Ruby on Rails</strong></p><ul><li><a href="/contributing_to_ruby_on_rails">Вносим вклад в Ruby on Rails</a>
</li><li><a href="/api_documentation_guidelines">Рекомендации по документированию API</a>
</li><li><a href="/ruby_on_rails_guides_guidelines">Рекомендации для руководств по Ruby on Rails</a>
</li><li><a href="/development_dependencies_install">Установка зависимостей для разработки</a>
</li><li><a href="/maintenance-policy">Политика поддержки (версий)</a>
</li></ul></li><li><p><strong>Заметки о релизах</strong></p><ul><li><a href="/upgrading-ruby-on-rails">Апгрейд Ruby on Rails</a>
</li><li><a href="/7_2_release_notes">Версия 7.2 - ?</a>
</li><li><a href="/7_1_release_notes">Версия 7.1 - Октябрь 2023</a>
</li><li><a href="/7_0_release_notes">Версия 7.0 - Декабрь 2021</a>
</li><li><a href="/6_1_release_notes">Версия 6.1 - Декабрь 2020</a>
</li><li><a href="/6_0_release_notes">Версия 6.0 - Август 2019</a>
</li></ul></li></ul>
              </div>
            </li>
            <li>
              <a href="/search">Поиск</a>
            </li>
            <li>
              <a target="blank" href="http://api.rusrails.ru">Ruby &amp; Rails API</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="content-wrapper">
      <div class="container-fluid">
        <div class="row-fluid">
          <div class="span3 pull-right">
            <div class="well social">
              <h4>Принимаем пожелания и пул-реквесты!</h4>
              <iframe allowtransparency="true" frameborder="0" height="30" src="http://ghbtns.com/github-btn.html?user=rusrails&repo=rusrails&type=watch&count=true&size=large" width="180"></iframe>
              <p></p>
              <a class="twitter-follow-button" data-lang="ru" href="https://twitter.com/rusrails"></a>
            </div>
              <div class="well menu">
                    <ul class="nav nav-list">
      <li>
        <h4>
          <a href="#chto-takoe-active-record">1. Что такое Active Record?</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#pattern-active-record">1.1. Паттерн Active Record</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#object-relational-mapping">1.2. Object Relational Mapping</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#active-record-eto-freymvork-orm">1.3. Active Record это фреймворк ORM</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#soglasheniya-nad-konfiguratsiey-v-active-record">2. Соглашения над конфигурацией в Active Record</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#soglasheniya-po-imenovaniyu">2.1. Соглашения по именованию</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#soglasheniya-shemy">2.2. Соглашения схемы</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#sozdanie-modeley-active-record">3. Создание моделей Active Record</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#sozdanie-modeley-v-prostranstve-imen">3.1. Создание моделей в пространстве имен</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#overriding-the-naming-conventions">4. Переопределение соглашений об именовании</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#crud-reading-and-writing-data">5. CRUD: Чтение и запись данных</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#sozdanie">5.1. Создание</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#chtenie">5.2. Чтение</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#obnovlenie">5.3. Обновление</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#udalenie">5.4. Удаление</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#validatsii">6. Валидации</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#kolbeki">7. Колбэки</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#migrations">8. Миграции</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#svyazi">9. Связи</a>
</h4>      </li>
</ul>

              </div>
            <div class="well banner300 banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<!-- sidebar rusrails -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:600px"
     data-ad-client="ca-pub-7764391801669990"
     data-ad-slot="6089520660"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
          <div class="span9 content pull-left">
            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <!-- top rusrails -->
  <ins class="adsbygoogle"
       style="display:inline-block;width:980px;height:120px"
       data-ad-client="ca-pub-7764391801669990"
       data-ad-slot="4891989065"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
              <h2 id='osnovy-active-record' class='inside_page_header'> Основы Active Record</h2><p>Это руководство является введением в Active Record.</p><p>После прочтения этого руководства, вы узнаете:</p><ul><li>Как Active Record вписывается в парадигму Model-View-Controller (MVC).
</li><li>Что такое паттерны Object Relational Mapping и Active Record, и как они используются в Rails.
</li><li>Как использовать модели Active Record для управления информацией, хранящейся в реляционной базе данных.
</li><li>О соглашении по именованиям схемы Active Record.
</li><li>О концепциях миграций базы данных, валидаций, колбэков и связей.
</li></ul><h3 id='chto-takoe-active-record' class='inside_page_header'><a href="#chto-takoe-active-record">1.</a> Что такое Active Record?</h3><p>Active Record является частью M в <a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">MVC</a> - модели - это уровень системы, отвечающий за представление данных и бизнес-логики. Active Record помогает создавать и использовать Ruby-объекты, атрибуты которых требуют постоянного хранения в базе данных.</p><div class="note"><p>В чем разница между Active Record и Active Model? Моделирование данных возможно с помощью Ruby-объектов, которым <em>не обязательно</em> иметь поддержку базы данных. <a href="/active-model-basics">Active Model</a> обычно используется для этого в Rails, делая Active Record и Active Model частью M в MVC, также как и ваши собственные обычные Ruby-объекты.</p></div><p>Термин &quot;Active Record&quot; также относится к шаблону архитектуры программного обеспечения. Active Record в Rails является реализацией этого шаблона.  Это также описание того, что иногда называется системой <a href="https://en.wikipedia.org/wiki/Object-relational_mapping">Object Relational Mapping</a>. В следующих разделах объясняются эти термины.</p><h4 id='pattern-active-record' class='inside_page_header'><a href="#pattern-active-record">1.1.</a> Паттерн Active Record</h4><p><a href="https://www.martinfowler.com/eaaCatalog/activeRecord.html">Шаблон Active Record описал Martin Fowler</a> в книге <em>Patterns of Enterprise Application Architecture</em> как &quot;объект, который оборачивает строку в таблице базы данных, инкапсулирует доступ к базе данных и добавляет к этим данным доменную логику&quot;. Объекты Active Record содержат как данные, так и поведение. Классы Active Record тесно связаны со структурой записей лежащей в основе базы данных. Таким образом, пользователи могут легко читать из базы данных и записывать в нее, как вы увидите в приведенных ниже примерах.</p><h4 id='object-relational-mapping' class='inside_page_header'><a href="#object-relational-mapping">1.2.</a> Object Relational Mapping</h4><p>Object Relational Mapping, обычно называемое ORM, - это техника, которая связывает полноценные объекты языка программирования с таблицами в реляционной системе управления базами данных (RDBMS). В случае приложения Rails это объекты Ruby. С помощью ORM атрибуты объектов Ruby, а также связи между объектами, можно легко хранить и извлекать из базы данных без непосредственного написания SQL-запросов. В целом, ORM минимизируют объем кода доступа к базе данных, который вам приходится писать.</p><div class="note"><p>Чтобы полностью понять Active Record, будут полезны базовые знания реляционных систем управления базами данных (RDBMS) или языка структурированных запросов (SQL). Если хотите узнать больше, обратитесь <a href="https://www.khanacademy.org/computing/computer-programming/sql">к этому учебному пособию</a> (или <a href="https://www.devart.com/what-is-rdbms/">к этому</a>) или изучите их другими способами.</p></div><h4 id='active-record-eto-freymvork-orm' class='inside_page_header'><a href="#active-record-eto-freymvork-orm">1.3.</a> Active Record это фреймворк ORM</h4><p>Active Record позволяет нам делать следующее с помощью объектов Ruby:</p><ul><li>Представления моделей и их данных.
</li><li>Представления связей между моделями.
</li><li>Представления иерархий наследования с помощью связанных моделей.
</li><li>Валидации моделей до того, как они станут персистентными в базе данных.
</li><li>Выполнения операций с базой данных в объектно-ориентированном стиле.
</li></ul><h3 id='soglasheniya-nad-konfiguratsiey-v-active-record' class='inside_page_header'><a href="#soglasheniya-nad-konfiguratsiey-v-active-record">2.</a> Соглашения над конфигурацией в Active Record</h3><p>При написании приложения с использованием других языков программирования или фреймворков часто требуется писать много конфигурационного кода. В частности, это справедливо для фреймворков ORM. Однако, если следовать соглашениям, принятым Rails, при создании моделей Active Record вам потребуется писать очень мало или совсем не писать код конфигурации.</p><p>Rails использует принцип, согласно которому если вы конфигурируете свои приложения одинаковым образом в большинстве случаев, то этот способ должен быть установлен по умолчанию. Явная конфигурация должна требоваться только в тех случаях, когда вы не можете следовать соглашениям.</p><p>Чтобы воспользоваться преимуществами соглашения над конфигурацией в Active Record, необходимо соблюдать некоторые соглашения об именах и схемах. А в случае необходимости можно <a href="#overriding-the-naming-conventions">переопределить соглашения об именовании</a>.</p><h4 id='soglasheniya-po-imenovaniyu' class='inside_page_header'><a href="#soglasheniya-po-imenovaniyu">2.1.</a> Соглашения по именованию</h4><p>Active Record использует следующее соглашение об именах для сопоставления между моделями (представленными объектами Ruby) и таблицами базы данных:</p><p>Rails будет использовать множественное число классов ваших моделей, чтобы найти соответствующую таблицу базы данных. Например, класс с именем <code>Book</code> сопоставляется с таблицей базы данных <code>books</code>. Механизмы множественного числа Rails очень мощны и способны образовывать множественное число (и единственное число) как для правильных, так и для неправильных английских слов. В этом используется метод <a href="https://api.rubyonrails.org/classes/ActiveSupport/Inflector.html#method-i-pluralize">pluralize</a> из <a href="/active-support-core-extensions#pluralize">Active Support</a>.</p><p>Для имен классов, состоящих из двух или более слов, имя класса модели будет следовать соглашениям Ruby об использовании UpperCamelCase. Имя таблицы базы данных в этом случае будет иметь формат snake_case. Например:</p><ul><li><code>BookClub</code> - класс модели, единственное число, с заглавной первой буквы каждого слова.
</li><li><code>book_clubs</code> - соответствующая таблица базы данных, множественное число, с разделителями подчеркивания между словами.
</li></ul><p>Вот еще несколько примеров имен классов моделей и соответствующих имен таблиц:</p><table class='table table-striped'><tr>
<th>Модель / Класс</th>
<th>Таблица / Схема</th>
</tr>
<tr>
<td><code>Article</code></td>
<td><code>articles</code></td>
</tr>
<tr>
<td><code>LineItem</code></td>
<td><code>line_items</code></td>
</tr>
<tr>
<td><code>Product</code></td>
<td><code>products</code></td>
</tr>
<tr>
<td><code>Person</code></td>
<td><code>people</code></td>
</tr>
</table><h4 id='soglasheniya-shemy' class='inside_page_header'><a href="#soglasheniya-shemy">2.2.</a> Соглашения схемы</h4><p>Active Record также использует соглашения о именах столбцов в таблицах базы данных, зависящих от назначения этих столбцов.</p><ul><li><strong>Первичные ключи</strong> - По умолчанию Active Record использует числовой столбец с именем <code>id</code> как первичный ключ таблицы (<code>bigint</code> для PostgreSQL, MySQL и MariaDB, <code>integer</code> для SQLite). Этот столбец будет автоматически создан при использовании <a href="#migrations">миграций Active Record</a> для создания таблиц.
</li><li><strong>Внешние ключи</strong> - Эти поля должны именоваться по образцу <code>singularized_table_name_id</code> (т.е., <code>order_id</code>, <code>line_item_id</code>). Это поля, которые ищет Active Record при создании связей между вашими моделями.
</li></ul><p>Также имеются некоторые опциональные имена столбцов, добавляющие дополнительные особенности для экземпляров Active Record:</p><ul><li><code>created_at</code> - Автоматически будут установлены текущие дата и время при изначальном создании записи.
</li><li><code>updated_at</code> - Автоматически будут установлены текущие дата и время всякий раз, когда создается или обновляется запись.
</li><li><code>lock_version</code> - Добавляет <a href="https://api.rubyonrails.org/classes/ActiveRecord/Locking.html">оптимистическую блокировку</a> к модели.
</li><li><code>type</code> - Указывает, что модель использует <a href="https://api.rubyonrails.org/classes/ActiveRecord/Base.html#class-ActiveRecord::Base-label-Single+table+inheritance">Single Table Inheritance</a>.
</li><li><code>(association_name)_type</code> - Хранит тип для <a href="/active-record-associations#polymorphic-associations">полиморфных связей</a>.
</li><li><code>(table_name)_count</code> - Используется для кэширования количества принадлежащих по связи объектов. Например, если у класса <code>Article</code> несколько <code>Comment</code>, столбец <code>comments_count</code> в таблице <code>articles</code> закэширует количество существующих комментариев для каждой статьи.
</li></ul><div class="note"><p>Хотя эти имена столбцов опциональны, они зарезервированы Active Record. Избегайте зарезервированных ключевых слов при именовании столбцов таблицы. Например, <code>type</code> - это зарезервированное слово для определения таблицы, использующей наследование с единой таблицей (STI). Если вы не используете STI, используйте другое слово, аккуратно описывающее данные, которые вы моделируете.</p></div><h3 id='sozdanie-modeley-active-record' class='inside_page_header'><a href="#sozdanie-modeley-active-record">3.</a> Создание моделей Active Record</h3><p>При генерации Rails-приложения в <code>app/models/application_record.rb</code> будет создан абстрактный класс <code>ApplicationRecord</code>. Класс <code>ApplicationRecord</code> наследуется от <a href="https://api.rubyonrails.org/classes/ActiveRecord/Base.html"><code>ActiveRecord::Base</code></a> и именно он превращает обычный класс Ruby в модель Active Record.</p><p><code>ApplicationRecord</code> является базовым классом для всех моделей Active Record в вашем приложении. Чтобы создать новую модель, просто наследуйтесь от класса <code>ApplicationRecord</code>, и все готово:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Создастся модель <code>Book</code>, сопоставленная с таблицей <code>books</code> в базе данных, где каждый столбец таблицы сопоставляется с атрибутами класса <code>Book</code>. Экземпляр класса <code>Book</code> может представлять собой строку в таблице <code>books</code>. Таблица <code>books</code> со столбцами <code>id</code>, <code>title</code> и <code>author</code> может быть создана с помощью такого SQL-запроса:</p><div class="code_container">
  <pre><code class="highlight sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">books</span> <span class="p">(</span>
  <span class="n">id</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">auto_increment</span><span class="p">,</span>
  <span class="n">title</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
  <span class="n">author</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span>
</code></pre>
</div>
<p>Однако в Rails это обычно делается не так. Таблицы баз данных в Rails обычно создаются с помощью <a href="#migrations">миграций Active Record</a>, а не с помощью чистого SQL. Миграцию для таблицы <code>books</code>, описанной выше, можно создать следующим образом:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration CreateBooks title:string author:string
</code></pre>
</div>
<p>что приведет к этому:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Примечание:</span>
<span class="c1"># Столбец `id`, в качестве первичного ключа, по соглашению создается автоматически.</span>
<span class="c1"># Столбцы `created_at` и `updated_at` добавляются `t.timestamps`.</span>

<span class="c1"># db/migrate/20240220143807_create_books.rb</span>
<span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:title</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:author</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Эта миграция создает столбцы <code>id</code>, <code>title</code>, <code>author</code>, <code>created_at</code> и <code>updated_at</code>. Каждая строка этой таблицы может быть представлена экземпляром класса <code>Book</code> с теми же атрибутами: <code>id</code>, <code>title</code>, <code>author</code>, <code>created_at</code> и <code>updated_at</code>. Вы можете получить доступ к атрибутам книги следующим образом:</p><div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Book</span><span class="p">:</span><span class="mh">0x00007fbdf5e9a038</span> <span class="ss">id: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">title: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">author: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">created_at: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="kp">nil</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">title</span> <span class="o">=</span> <span class="s2">"The Hobbit"</span>
<span class="p">=&gt;</span> <span class="s2">"The Hobbit"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">title</span>
<span class="p">=&gt;</span> <span class="s2">"The Hobbit"</span>
</code></pre>
</div>
<div class="note"><p>Создание модели Active Record и соответствующей миграции можно выполнить с помощью команды <code>bin/rails generate model Book title:string author:string</code>. Эта команда создаст файлы <code>app/models/book.rb</code>, <code>db/migrate/20240220143807_create_books.rb</code> и несколько дополнительных файлов для тестирования.</p></div><h4 id='sozdanie-modeley-v-prostranstve-imen' class='inside_page_header'><a href="#sozdanie-modeley-v-prostranstve-imen">3.1.</a> Создание моделей в пространстве имен</h4><p>По умолчанию модели Active Record размещаются в директории <code>app/models</code>. Однако вы можете захотеть организовать свои модели, разместив похожие модели в отдельной папке и пространстве имен. Например, файлы <code>order.rb</code> и <code>order.rb</code> можно разместить в <code>app/models/books</code> с именами классов <code>Book::Order</code> и <code>Book::Review</code> соответственно. Active Record позволяет создавать модели в пространстве имен.</p><p>Если модуль <code>Book</code> еще не существует, команда <code>generate</code> создаст все следующим образом:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model Book::Order
<span class="go">      invoke  active_record
      create    db/migrate/20240306194227_create_book_orders.rb
      create    app/models/book/order.rb
      create    app/models/book.rb
      invoke    test_unit
      create      test/models/book/order_test.rb
      create      test/fixtures/book/orders.yml
</span></code></pre>
</div>
<p>Если модуль <code>Book</code> уже существует, вам будет предложено разрешить конфликт:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model Book::Order
<span class="go">      invoke  active_record
      create    db/migrate/20240305140356_create_book_orders.rb
      create    app/models/book/order.rb
    conflict    app/models/book.rb
  Overwrite /Users/bhumi/Code/rails_guides/app/models/book.rb? (enter "h" for help) [Ynaqdhm]
</span></code></pre>
</div>
<p>После успешного создания модели в пространстве имен классы <code>Book</code> и <code>Order</code> будут выглядеть следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/book.rb</span>
<span class="k">module</span> <span class="nn">Book</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">table_name_prefix</span>
    <span class="s2">"book_"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/models/book/order.rb</span>
<span class="k">class</span> <span class="nc">Book::Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Установка опции <a href="https://api.rubyonrails.org/classes/ActiveRecord/ModelSchema.html#method-c-table_name_prefix-3D">table_name_prefix</a> в <code>Book</code> позволит назвать таблицу базы данных для модели <code>Order</code> как <code>book_orders</code>, вместо просто <code>orders</code>.</p><p>Другая возможность - у вас уже есть модель <code>Book</code>, которую вы хотите оставить в <code>app/models</code>. В этом случае вы можете выбрать <code>n</code>, чтобы не перезаписывать <code>book.rb</code> во время команды <code>generate</code>.</p><p>Это позволит использовать таблицу с пространством имен для класса <code>Book::Order</code> даже без необходимости использования <code>table_name_prefix</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/book.rb</span>
<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># существующий код</span>
<span class="k">end</span>

<span class="no">Book</span><span class="o">::</span><span class="no">Order</span><span class="p">.</span><span class="nf">table_name</span>
<span class="c1"># =&gt; "book_orders"</span>
</code></pre>
</div>
<h3 id='overriding-the-naming-conventions' class='inside_page_header'><a href="#overriding-the-naming-conventions">4.</a> Переопределение соглашений об именовании</h3><p>Но что, если вы следуете другому соглашению по именованию или используете новое приложение Rails со старой базой данных? Не проблема, можно просто переопределить соглашения по умолчанию.</p><p>Так как <code>ApplicationRecord</code> наследуется от <code>ActiveRecord::Base</code>, модели вашего приложения будут иметь ряд полезных методов. Например, вы можете использовать метод <code>ActiveRecord::Base.table_name=</code> для настройки имени таблицы, которая должна использоваться:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">table_name</span> <span class="o">=</span> <span class="s2">"my_books"</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Если вы сделаете это, вам придется вручную определить имя класса, в котором размещены <a href="/testing#the-low-down-on-fixtures">фикстуры</a> (<code>my_books.yml</code>), используя метод <code>set_fixture_class</code> в вашем определении теста.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># test/models/book_test.rb</span>
<span class="k">class</span> <span class="nc">BookTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="n">set_fixture_class</span> <span class="ss">my_books: </span><span class="no">Book</span>
  <span class="n">fixtures</span> <span class="ss">:my_books</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Также возможно переопределить столбец, который должен быть использован как первичный ключ таблицы, с помощью метода <code>ActiveRecord::Base.primary_key=</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="s2">"book_id"</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="note"><p><strong>Active Record не рекомендует использовать столбцы с именем id, которые не являются первичным ключом.</strong> Использование столбца <code>id</code>, который не является одностолбцовым первичным ключом, усложняет доступ к значению этого столбца. Приложению придется использовать псевдоним атрибута <a href="https://api.rubyonrails.org/classes/ActiveRecord/ModelSchema.html#method-i-id_value"><code>id_value</code></a> для доступа к значению столбца <code>id</code>, который не является первичным ключом.</p></div><div class="note"><p>Если вы попытаетесь создать столбец с именем <code>id</code>, который не является первичным ключом, Rails выдаст ошибку во время миграции, например: <code>you can&#39;t redefine the primary key column &#39;id&#39; on &#39;my_books&#39;.</code> <code>To define a custom primary key, pass { id: false } to create_table.</code></p></div><h3 id='crud-reading-and-writing-data' class='inside_page_header'><a href="#crud-reading-and-writing-data">5.</a> CRUD: Чтение и запись данных</h3><p>CRUD это сокращение для четырех глаголов, используемых для описания операций с данными: <strong>C</strong>reate (создать), <strong>R</strong>ead (прочесть), <strong>U</strong>pdate (обновить) и <strong>D</strong>elete (удалить). Active Record автоматически создает методы, позволяющие читать и воздействовать на данные, хранимые в своих таблицах.</p><p>Active Record позволяет легко выполнять CRUD-операции с помощью этих высокоуровневых методов, которые абстрагируют детали доступа к базе данных. Обратите внимание, что все эти удобные методы приводят к выполнению SQL-запросов к базе данных.</p><p>В приведенных ниже примерах показано несколько методов CRUD, а также полученные SQL-запросы.</p><h4 id='sozdanie' class='inside_page_header'><a href="#sozdanie">5.1.</a> Создание</h4><p>Объекты Active Record могут быть созданы из хэша, блока или из вручную указанных после создания атрибутов. Метод <code>new</code> возвратит новый несохраненный объект, в то время как <code>create</code> сохранит объект в базе данных и возвратит его.</p><p>Например, для модели <code>Book</code> с атрибутами <code>title</code> и <code>author</code> вызов метода <code>create</code> создаст объект и сохранит новую запись в базе данных:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"The Lord of the Rings"</span><span class="p">,</span> <span class="ss">author: </span><span class="s2">"J.R.R. Tolkien"</span><span class="p">)</span>

<span class="c1"># Имейте в виду, что `id` присваивается автоматически, когда запись фиксируется в базе данных.</span>
<span class="n">book</span><span class="p">.</span><span class="nf">inspect</span>
<span class="c1"># =&gt; "#&lt;Book id: 106, title: \"The Lord of the Rings\", author: \"J.R.R. Tolkien\", created_at: \"2024-03-04 19:15:58.033967000 +0000\", updated_at: \"2024-03-04 19:15:58.033967000 +0000\"&gt;"</span>
</code></pre>
</div>
<p>В то время как метод <code>new</code> создаст экземпляр объекта <em>не</em> сохраняя его в базе данных:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
<span class="n">book</span><span class="p">.</span><span class="nf">title</span> <span class="o">=</span> <span class="s2">"The Hobbit"</span>
<span class="n">book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="s2">"J.R.R. Tolkien"</span>

<span class="c1"># Имейте в виду, что для этого объекта `id` не установлен.</span>
<span class="n">book</span><span class="p">.</span><span class="nf">inspect</span>
<span class="c1"># =&gt; "#&lt;Book id: nil, title: \"The Hobbit\", author: \"J.R.R. Tolkien\", created_at: nil, updated_at: nil&gt;"</span>

<span class="c1"># Вышеупомянутая book` еще не сохранена в базе данных.</span>

<span class="n">book</span><span class="p">.</span><span class="nf">save</span>
<span class="n">book</span><span class="p">.</span><span class="nf">id</span> <span class="c1"># =&gt; 107</span>

<span class="c1"># Теперь запись `book` зафиксирована в базе данных и имеет `id`.</span>
</code></pre>
</div>
<p>Наконец, если предоставлен блок и <code>create</code>, и <code>new</code> передадут новый объект в этот блок для инициализации, при этом только <code>create</code> сохраняет результирующий объект в базе данных:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">b</span><span class="o">|</span>
  <span class="n">b</span><span class="p">.</span><span class="nf">title</span> <span class="o">=</span> <span class="s2">"Metaprogramming Ruby 2"</span>
  <span class="n">b</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="s2">"Paolo Perrotta"</span>
<span class="k">end</span>

<span class="n">book</span><span class="p">.</span><span class="nf">save</span>
</code></pre>
</div>
<p>В результате выполнения обоих методов <code>book.save</code> и <code>Book.create</code> SQL-запрос будет выглядеть примерно так:</p><div class="code_container">
  <pre><code class="highlight sql"><span class="cm">/* Имейте в виду, что `created_at` и `updated_at` устанавливаются автоматически. */</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"books"</span> <span class="p">(</span><span class="nv">"title"</span><span class="p">,</span> <span class="nv">"author"</span><span class="p">,</span> <span class="nv">"created_at"</span><span class="p">,</span> <span class="nv">"updated_at"</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span> <span class="n">RETURNING</span> <span class="nv">"id"</span>  <span class="p">[[</span><span class="nv">"title"</span><span class="p">,</span> <span class="nv">"Metaprogramming Ruby 2"</span><span class="p">],</span> <span class="p">[</span><span class="nv">"author"</span><span class="p">,</span> <span class="nv">"Paolo Perrotta"</span><span class="p">],</span> <span class="p">[</span><span class="nv">"created_at"</span><span class="p">,</span> <span class="nv">"2024-02-22 20:01:18.469952"</span><span class="p">],</span> <span class="p">[</span><span class="nv">"updated_at"</span><span class="p">,</span> <span class="nv">"2024-02-22 20:01:18.469952"</span><span class="p">]]</span>
</code></pre>
</div>
<h4 id='chtenie' class='inside_page_header'><a href="#chtenie">5.2.</a> Чтение</h4><p>Active Record предоставляет богатый API для доступа к данным в базе данных. Вы можете выполнять запросы к отдельной записи или нескольким записям, фильтровать их по любому атрибуту, упорядочивать, группировать, выбирать определенные поля и делать все, что можно сделать с помощью SQL.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># возвратит коллекцию со всеми книгами.</span>
<span class="n">books</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">all</span>

<span class="c1"># Возвратит отдельную книгу.</span>
<span class="n">first_book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">first</span>
<span class="n">last_book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">last</span>
<span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">take</span>
</code></pre>
</div>
<p>Вышесказанное приводит к следующему SQL-запросу:</p><div class="code_container">
  <pre><code class="highlight sql"><span class="c1">-- Book.all</span>
<span class="k">SELECT</span> <span class="nv">"books"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"books"</span>

<span class="c1">-- Book.first</span>
<span class="k">SELECT</span> <span class="nv">"books"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"books"</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="nv">"books"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">ASC</span> <span class="k">LIMIT</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"LIMIT"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>

<span class="c1">-- Book.last</span>
<span class="k">SELECT</span> <span class="nv">"books"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"books"</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="nv">"books"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"LIMIT"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>

<span class="c1">-- Book.take</span>
<span class="k">SELECT</span> <span class="nv">"books"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"books"</span> <span class="k">LIMIT</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"LIMIT"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
</code></pre>
</div>
<p>Мы также можем находить конкретные книги с помощью <code>find_by</code> и <code>where</code>. В то время как <code>find_by</code> возвращает одну запись, <code>where</code> возвращает список записей:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Возвращает первую книгу с указанным названием или `nil`, если книга не найдена.</span>
<span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"Metaprogramming Ruby 2"</span><span class="p">)</span>

<span class="c1"># Альтернатива Book.find_by(id: 42). Выбросит исключение, если книга не найдена.</span>
<span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</code></pre>
</div>
<p>Вышесказанное приводит к следующему SQL-запросу:</p><div class="code_container">
  <pre><code class="highlight sql"><span class="k">SELECT</span> <span class="nv">"books"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"books"</span> <span class="k">WHERE</span> <span class="nv">"books"</span><span class="p">.</span><span class="nv">"author"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">LIMIT</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"author"</span><span class="p">,</span> <span class="nv">"J.R.R. Tolkien"</span><span class="p">],</span> <span class="p">[</span><span class="nv">"LIMIT"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>

<span class="k">SELECT</span> <span class="nv">"books"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"books"</span> <span class="k">WHERE</span> <span class="nv">"books"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">LIMIT</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">42</span><span class="p">],</span> <span class="p">[</span><span class="nv">"LIMIT"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Находит все книги данного автора, отсортированные по дате создания в обратном хронологическом порядке.</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">author: </span><span class="s2">"Douglas Adams"</span><span class="p">).</span><span class="nf">order</span><span class="p">(</span><span class="ss">created_at: :desc</span><span class="p">)</span>
</code></pre>
</div>
<p>приводит к следующему SQL-запросу:</p><div class="code_container">
  <pre><code class="highlight sql"><span class="k">SELECT</span> <span class="nv">"books"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"books"</span> <span class="k">WHERE</span> <span class="nv">"books"</span><span class="p">.</span><span class="nv">"author"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="nv">"books"</span><span class="p">.</span><span class="nv">"created_at"</span> <span class="k">DESC</span> <span class="p">[[</span><span class="nv">"author"</span><span class="p">,</span> <span class="nv">"Douglas Adams"</span><span class="p">]]</span>
</code></pre>
</div>
<p>Существует множество других методов Active Record для чтения и запроса записей. Подробнее о них вы можете узнать в руководстве <a href="/active-record-querying">по запросам Active Record</a>.</p><h4 id='obnovlenie' class='inside_page_header'><a href="#obnovlenie">5.3.</a> Обновление</h4><p>Как только объект Active Record будет получен, его атрибуты могут быть модифицированы, и он может быть сохранен в базу данных.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"The Lord of the Rings"</span><span class="p">)</span>
<span class="n">book</span><span class="p">.</span><span class="nf">title</span> <span class="o">=</span> <span class="s2">"The Lord of the Rings: The Fellowship of the Ring"</span>
<span class="n">book</span><span class="p">.</span><span class="nf">save</span>
</code></pre>
</div>
<p>Сокращенным вариантом для этого является использование хэша с атрибутами, связанными с желаемыми значениями, таким образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"The Lord of the Rings"</span><span class="p">)</span>
<span class="n">book</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"The Lord of the Rings: The Fellowship of the Ring"</span><span class="p">)</span>
</code></pre>
</div>
<p><code>update</code> приводит к следующему SQL-запросу:</p><div class="code_container">
  <pre><code class="highlight sql"><span class="cm">/* Имейте в виду, что `updated_at` обновляется автоматически. */</span>

 <span class="k">UPDATE</span> <span class="nv">"books"</span> <span class="k">SET</span> <span class="nv">"title"</span> <span class="o">=</span> <span class="o">?</span><span class="p">,</span> <span class="nv">"updated_at"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">WHERE</span> <span class="nv">"books"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"title"</span><span class="p">,</span> <span class="nv">"The Lord of the Rings: The Fellowship of the Ring"</span><span class="p">],</span> <span class="p">[</span><span class="nv">"updated_at"</span><span class="p">,</span> <span class="nv">"2024-02-22 20:51:13.487064"</span><span class="p">],</span> <span class="p">[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">104</span><span class="p">]]</span>
</code></pre>
</div>
<p>Это полезно, когда нужно обновить несколько атрибутов одновременно. Подобно <code>create</code>, использование <code>update</code> зафиксирует обновленные записи в базе данных.</p><p>Если необходимо обновить несколько записей за раз <strong>без колбэков и валидаций</strong>, можно обновить базу данных напрямую с помощью <code>update_all</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">update_all</span><span class="p">(</span><span class="ss">status: </span><span class="s2">"already own"</span><span class="p">)</span>
</code></pre>
</div>
<h4 id='udalenie' class='inside_page_header'><a href="#udalenie">5.4.</a> Удаление</h4><p>Более того, после получения, объект Active Record может быть уничтожен, что уберет его из базы данных.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"The Lord of the Rings"</span><span class="p">)</span>
<span class="n">book</span><span class="p">.</span><span class="nf">destroy</span>
</code></pre>
</div>
<p><code>destroy</code> приводит к следующему SQL-запросу:</p><div class="code_container">
  <pre><code class="highlight sql"><span class="k">DELETE</span> <span class="k">FROM</span> <span class="nv">"books"</span> <span class="k">WHERE</span> <span class="nv">"books"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">104</span><span class="p">]]</span>
</code></pre>
</div>
<p>Если необходимо удалить сразу несколько записей, можно использовать методы <code>destroy_by</code> или <code>destroy_all</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Найти и удалить все книги Douglas Adams.</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">destroy_by</span><span class="p">(</span><span class="ss">author: </span><span class="s2">"Douglas Adams"</span><span class="p">)</span>

<span class="c1"># Удалить все книги.</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">destroy_all</span>
</code></pre>
</div>
<h3 id='validatsii' class='inside_page_header'><a href="#validatsii">6.</a> Валидации</h3><p>Active Record позволяет проверять состояние модели до того, как она будет записана в базу данных. Имеются различные методы для различных типов валидаций. Например, можно проверить, чтобы значение атрибута не было пустым, было уникальным, отсутствовало в базе данных, соответствовало определенному формату и многое другое.</p><p>Методы <code>save</code>, <code>create</code> и <code>update</code> выполняют валидацию модели перед ее сохранением в базе данных. Если модель невалидна, эти методы возвращают <code>false</code>, и никаких операций с базой данных не выполняется. У всех этих методов есть более строгие аналоги с восклицательным знаком (то есть <code>save!</code>, <code>create!</code> и <code>update!</code>), которые при неудачной валидации вызывают исключение <code>ActiveRecord::RecordInvalid</code>. Быстрый пример для иллюстрации:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">save</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">save!</span>
<span class="go">ActiveRecord::RecordInvalid: Validation failed: Name can't be blank
</span></code></pre>
</div>
<p>Подробнее о валидациях можно прочитать в руководстве <a href="/active-record-validations">Валидации Active Record</a>.</p><h3 id='kolbeki' class='inside_page_header'><a href="#kolbeki">7.</a> Колбэки</h3><p>Колбэки Active Record разрешают присоединить код к определенным событиям в жизненном цикле ваших моделей. Это позволяет добавить поведение модели, выполнив код, когда эти события произойдут, например, когда вы создадите новую запись, обновите её, удалите её и так далее.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_create</span> <span class="ss">:log_new_user</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">log_new_user</span>
      <span class="nb">puts</span> <span class="s2">"A new user was registered"</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span>
<span class="go">A new user was registered
</span></code></pre>
</div>
<p>Подробнее о колбэках можно прочитать в руководстве <a href="/active-record-callbacks">Колбэки Active Record</a>.</p><h3 id='migrations' class='inside_page_header'><a href="#migrations">8.</a> Миграции</h3><p>Rails предоставляет удобный способ управления схемой базы данных с помощью миграций. Миграции пишутся на специальном языке предметной области и хранятся в файлах, которые выполняются для любой базы данных, поддерживаемой Active Record.</p><p>Вот миграция, которая создает новую таблицу под названием <code>publications</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreatePublications</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:publications</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:title</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="ss">:description</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:publication_type</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:publisher</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">boolean</span> <span class="ss">:single_issue</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Имейте в виду, что приведенный выше код не зависит от конкретной базы данных: он будет работать в MySQL, MariaDB, PostgreSQL, SQLite и других.</p><p>Rails отслеживает, какие миграции были внедрены в базу данных, и хранит их в соседней таблице той же самой базы данных под названием <code>schema_migrations</code>.</p><p>Для запуска миграции и создания таблицы выполните команду <code>bin/rails db:migrate</code>, а для отката и удаления таблицы - <code>bin/rails db:rollback</code>.</p><p>Подробнее о миграциях вы можете узнать в руководстве Active Record Migrations: Active Record Migrations guide: active_record_migrations.html.</p><p>Подробнее о миграциях можно прочитать в <a href="/active-record-migrations">руководстве по миграциям Active Record</a></p><h3 id='svyazi' class='inside_page_header'><a href="#svyazi">9.</a> Связи</h3><p>Связи Active Record позволяют вам определять взаимосвязи между моделями. Связи могут использоваться для описания отношений один-к-одному, один-ко-многим и многие-ко-многим. Например, отношение &quot;У автора много книг&quot; можно определить следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Теперь класс <code>Author</code> обладает методами для добавления и удаления книг у автора, а также многим другим.</p><p>Подробнее о связях можно прочитать в <a href="/active-record-associations">руководстве по связям Active Record</a>.</p>

            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

   <!-- bottom rusrails -->
   <ins class="adsbygoogle"
        style="display:inline-block;width:580px;height:400px"
        data-ad-client="ca-pub-7764391801669990"
        data-ad-slot="7566253867"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
        </div>
        <div class="row-fluid">
          <div class="span12" id="footer">
            <p>
              <a target="blank" href="https://github.com/rusrails/rusrails"><img src="/assets/github-7cc23602a5ac2465f14c19492358a5a67dc24636761cc723e4d621cea0c09225.png" /></a>
              <a target="blank" href="http://twitter.com/rusrails"><img src="/assets/twitter-50e0e767c8793dec313a7dc5cfbcfe2067e3e89ea6ec64784eb7c6640f578758.png" /></a>
            </p>
            <p>
              <a href="https://creativecommons.org/licenses/by-sa/4.0/">Лицензия CC BY-SA 4.0</a>
              "Rails", "Ruby on Rails" и логотип Rails - торговые марки DHH
              <!-- Yandex.Metrika counter -->
<script>
  (function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter1006929 = new Ya.Metrika({id:1006929,
                    webvisor:true,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true});
        } catch(e) { }
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>

<noscript>
  <div>
    <img style="position:absolute; left:-9999px;" alt="" src="//mc.yandex.ru/watch/1006929" />
  </div>
</noscript>
<!-- /Yandex.Metrika counter -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64955373-1', 'auto');
  ga('send', 'pageview');

  var trackOutboundLink = function(url) {
    ga('send', 'event', 'outbound', 'click', url, {
      'transport': 'beacon',
      'hitCallback': function(){ }
    });
  }
</script>

            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="to_top" style="display: block">
      <div class="to_top_panel"></div>
    </div>
    <script src="/assets/application-8ee447905888b153d8458707061a14b1f15f69b6733e871a3ad91d80ae89e87b.js"></script>
  </body>
</html>
