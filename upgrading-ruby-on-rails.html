<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8">
<meta content="Ruby on Rails, Ruby, Rails, Rails 3, Rails 4, Rails 5, Rails 6, Rails 6.0, Rails 6.1, Rails 7.0, Rails 7.1 руководство, начинающим, самоучитель, manual, мануал, справочник, учебник, примеры, Руби, рельсы" name="keywords"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" name="description"/>
<meta content="website" property="og:type"/>
<meta content="Rusrails: Апгрейд Ruby on Rails" property="og:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="og:description"/>
<meta content="http://localhost:3000/upgrading-ruby-on-rails" property="og:url"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="og:image"/>
    <title>
      Rusrails: Апгрейд Ruby on Rails
    </title>
    <link rel="stylesheet" href="/assets/application-f9dfa6ce7fa871006d478e422639671663284ddaa3126cf81ddfe371ac3533c4.css" />
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="/"></a>
          <ul class="nav pull-right top-menu">
            <li>
              <a href="/">Главная</a>
            </li>
            <li class="dropdown">
              <a class="index-popover" href="#">
                Содержание
                <b class="caret"></b>
</a>              <div class="index-popover-content hide">
                  <ul><li><p><strong>С чего начать?</strong></p><ul><li><a href="/getting-started">Rails для начинающих</a>
</li></ul></li><li><p><strong>Модели</strong></p><ul><li><a href="/active-record-basics">Основы Active Record</a>
</li><li><a href="/active-record-migrations">Миграции Active Record</a>
</li><li><a href="/active-record-validations">Валидации Active Record</a>
</li><li><a href="/active-record-callbacks">Колбэки Active Record</a>
</li><li><a href="/active-record-associations">Связи (ассоциации) Active Record</a>
</li><li><a href="/active-record-querying">Интерфейс запросов Active Record</a>
</li><li><a href="/active-model-basics">Основы Active Model</a>
</li></ul></li><li><p><strong>Вью</strong></p><ul><li><a href="/action-view-overview">Обзор Action View</a>
</li><li><a href="/layouts-and-rendering">Макеты и рендеринг в Rails</a>
</li><li><a href="/action-view-helpers">Хелперы Action View</a>
</li><li><a href="/form-helpers">Хелперы форм в Action View</a>
</li></ul></li><li><p><strong>Контроллеры</strong></p><ul><li><a href="/action-controller-overview">Обзор Action Controller</a>
</li><li><a href="/routing">Роутинг в Rails</a>
</li></ul></li><li><p><strong>Другие компоненты</strong></p><ul><li><a href="/active-support-core-extensions">Расширения ядра Active Support</a>
</li><li><a href="/action-mailer-basics">Основы Action Mailer</a>
</li><li><a href="/action-mailbox-basics">Основы Action Mailbox</a>
</li><li><a href="/action-text-overview">Обзор Action Text</a>
</li><li><a href="/active_job_basics">Основы Active Job</a>
</li><li><a href="/active_storage_overview">Обзор Active Storage</a>
</li><li><a href="/action-cable-overview">Обзор Action Cable</a>
</li></ul></li><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/i18n">API интернационализации Rails (I18n)</a>
</li><li><a href="/testing">Тестирование приложений на Rails</a>
</li><li><a href="/security">Безопасность приложений на Rails</a>
</li><li><a href="/error-reporting">Отчет об ошибках в приложениях Rails</a>
</li><li><a href="/debugging-rails-applications">Отладка приложений на Rails</a>
</li></ul></li></ul><p>next_column</p><ul><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/configuring">Конфигурирование приложений на Rails</a>
</li><li><a href="/command-line">Командная строка Rails</a>
</li><li><a href="/asset-pipeline">Asset Pipeline</a>
</li><li><a href="/working-with-javascript-in-rails">Работа с JavaScript в Rails</a>
</li><li><a href="/initialization">Процесс инициализации в Rails</a>
</li><li><a href="/autoloading-and-reloading-constants">Автозагрузка и перезагрузка констант</a>
</li><li><a href="/caching-with-rails">Кэширование с Rails: Обзор</a>
</li><li><a href="/active-support-instrumentation">Инструментарий Active Support</a>
</li><li><a href="/api-app">Использование Rails для API-приложений</a>
</li><li><a href="/active-record-postgresql">Active Record для PostgreSQL</a>
</li><li><a href="/active-record-multiple-databases">Несколько баз данных с Active Record</a>
</li><li><a href="/active-record-encryption">Шифрование Active Record</a>
</li></ul></li><li><p><strong>Расширяем Rails</strong></p><ul><li><a href="/plugins">Основы создания плагинов Rails</a>
</li><li><a href="/rails-on-rack">Rails on Rack</a>
</li><li><a href="/generators">Создание и настройка генераторов и шаблонов Rails</a>
</li><li><a href="/engines">Engine для начинающих</a>
</li><li><a href="/threading_and_code_execution">Треды и выполнение кода в Rails</a>
</li><li><a href="/rails-application-templates">Шаблоны приложения Rails</a>
</li></ul></li><li><p><strong>Вносим вклад в Ruby on Rails</strong></p><ul><li><a href="/contributing_to_ruby_on_rails">Вносим вклад в Ruby on Rails</a>
</li><li><a href="/api_documentation_guidelines">Рекомендации по документированию API</a>
</li><li><a href="/ruby_on_rails_guides_guidelines">Рекомендации для руководств по Ruby on Rails</a>
</li><li><a href="/development_dependencies_install">Установка зависимостей для разработки</a>
</li><li><a href="/maintenance-policy">Политика поддержки (версий)</a>
</li></ul></li><li><p><strong>Заметки о релизах</strong></p><ul><li><a href="/upgrading-ruby-on-rails">Апгрейд Ruby on Rails</a>
</li><li><a href="/7_2_release_notes">Версия 7.2 - ?</a>
</li><li><a href="/7_1_release_notes">Версия 7.1 - Октябрь 2023</a>
</li><li><a href="/7_0_release_notes">Версия 7.0 - Декабрь 2021</a>
</li><li><a href="/6_1_release_notes">Версия 6.1 - Декабрь 2020</a>
</li><li><a href="/6_0_release_notes">Версия 6.0 - Август 2019</a>
</li></ul></li></ul>
              </div>
            </li>
            <li>
              <a href="/search">Поиск</a>
            </li>
            <li>
              <a target="blank" href="http://api.rusrails.ru">Ruby &amp; Rails API</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="content-wrapper">
      <div class="container-fluid">
        <div class="row-fluid">
          <div class="span3 pull-right">
            <div class="well social">
              <h4>Принимаем пожелания и пул-реквесты!</h4>
              <iframe allowtransparency="true" frameborder="0" height="30" src="http://ghbtns.com/github-btn.html?user=rusrails&repo=rusrails&type=watch&count=true&size=large" width="180"></iframe>
            </div>
              <div class="well menu">
                    <ul class="nav nav-list">
      <li>
        <h4>
          <a href="#obschiy-sovet">1. Общий совет</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#testovoe-pokrytie">1.1. Тестовое покрытие</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#versii-ruby">1.2. Версии Ruby</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#protsess-apgreyda">1.3. Процесс апгрейда</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#perehod-mezhdu-versiyami">1.3.1. Переход между версиями</a>
</h6>      </li>
      <li>
        <h5>
          <a href="#the-update-task">1.4. Задача Update</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#nastroyka-umolchaniy-freymvorka">1.5. Настройка умолчаний фреймворка</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#upgrading-from-rails-7-1-to-rails-7-2">2. Апгрейд с Rails 7.1 на Rails 7.2</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#upgrading-from-rails-7-0-to-rails-7-1">3. Апгрейд с Rails 7.0 на Rails 7.1</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#puti-avtozagruzki-bolshe-ne-v-load_path">3.1. Пути автозагрузки больше не в $LOAD_PATH</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#config-autoload_lib-i-config-autoload_lib_once">3.2. config.autoload_lib и config.autoload_lib_once</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#activestorage-basecontroller-bolshe-ne-vklyuchaet-potokovyy-modul">3.3. <code>ActiveStorage::BaseController</code> больше не включает потоковый модуль</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#memcachestore-i-rediscachestore-teper-po-umolchaniyu-ispolzuyut-puly-soedineniy">3.4. <code>MemCacheStore</code> и <code>RedisCacheStore</code> теперь по умолчанию используют пулы соединений</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#sqlite3adapter-teper-konfiguriruetsya-chtoby-ispolzovatsya-v-rezhime-strogih-strok">3.5. <code>SQLite3Adapter</code> теперь конфигурируется, чтобы использоваться в режиме строгих строк</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#podderzhka-neskolkih-putey-predvaritelnogo-prosmotra-dlya-actionmailer-preview">3.6. Поддержка нескольких путей предварительного просмотра для <code>ActionMailer::Preview</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#config-i18n-raise_on_missing_translations-true-teper-vyzyvaet-oshibku-dlya-lyubogo-otsutstvuyuschego-perevoda">3.7. <code>config.i18n.raise_on_missing_translations = true</code> теперь вызывает ошибку для любого отсутствующего перевода.</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#bin-rails-test-teper-zapuskaet-zadachu-test-prepare">3.8. <code>bin/rails test</code> теперь запускает задачу <code>test:prepare</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#izmenen-sintaksis-importa-iz-rails-ujs">3.9. Изменен синтаксис импорта из <code>@rails/ujs</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#rails-logger-teper-vozvraschaet-ekzemplyar-activesupport-broadcastlogger">3.10. <code>Rails.logger</code> теперь возвращает экземпляр <code>ActiveSupport::BroadcastLogger</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#izmenilis-algoritmy-shifrovaniya-active-record">3.11. Изменились алгоритмы шифрования Active Record</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#novye-sposoby-obrabotki-isklyucheniy-v-testah-kontrollera-integratsionnyh-i-sistemnyh">3.12. Новые способы обработки исключений в тестах контроллера, интеграционных и системных</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#upgrading-from-rails-6-1-to-rails-7-0">4. Апгрейд с Rails 6.1 на Rails 7.0</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#izmenivsheesya-povedenie-actionview-helpers-urlhelper-button_to">4.1. Изменившееся поведение <code>ActionView::Helpers::UrlHelper#button_to</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#spring">4.2. Spring</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#sprockets-teper-optsionalnaya-zavisimost">4.3. Sprockets теперь опциональная зависимость</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#prilozheniya-dolzhny-zapuskatsya-v-rezhime-zeitwerk">4.4. Приложения должны запускаться в режиме <code>zeitwerk</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#metod-naznacheniya-config-autoloader-byl-udalen">4.5. Метод назначения <code>config.autoloader=</code> был удален</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#privatnyy-api-activesupport-dependencies-byl-udalen">4.6. Приватный API <code>ActiveSupport::Dependencies</code> был удален</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#avtomaticheskaya-zagruzka-vo-vremya-initsializatsii">4.7. Автоматическая загрузка во время инициализации</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#vozmozhnost-nastroit-config-autoload_once_paths">4.8. Возможность настроить <code>config.autoload_once_paths</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#actiondispatch-request-content_type-teper-vozvraschaet-zagolovok-content-type-kak-est">4.9. <code>ActionDispatch::Request#content_type</code> теперь возвращает заголовок Content-Type как есть.</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#izmenenie-klassa-daydzhesta-dlya-generatsii-klyuchey-trebuet-rotator-kuki">4.10. Изменение класса дайджеста для генерации ключей требует ротатор куки</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#klass-daydzhesta-dlya-activesupport-digest-izmenili-na-sha256">4.11. Класс дайджеста для ActiveSupport::Digest изменили на SHA256</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#novyy-format-serializatsii-activesupport-cache">4.12. Новый формат сериализации ActiveSupport::Cache</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#generatsiya-izobrazheniya-predvaritelnogo-prosmotra-video-v-active-storage">4.13. Генерация изображения предварительного просмотра видео в Active Storage</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#obrabotchik-varianta-po-umolchaniyu-active-storage-izmenilsya-na-vips">4.14. Обработчик варианта по умолчанию Active Storage изменился на <code>:vips</code></a>
</h5>      </li>
      <li>
        <h6>
          <a href="#zamenite-resize-na-resize_to_limit">4.14.1. Замените resize на resize_to_limit</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#ispolzuyte-massiv-pri-obrezke">4.14.2. Используйте массив при обрезке</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#peresmotrite-znacheniya-obrezki">4.14.3. Пересмотрите значения обрезки:</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#ispravte-fonovyy-tsvet-ispolzuemyy-dlya-resize_and_pad">4.14.4. Исправьте фоновый цвет, используемый для <code>resize_and_pad</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#uberite-lyubye-rotatsii-osnovannye-na-exif">4.14.5. Уберите любые ротации, основанные на EXIF</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#zamenite-monochrome-na-colourspace">4.14.6. Замените monochrome на colourspace</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#pereklyuchites-na-optsii-libvips-pri-szhatii-izobrazheniy">4.14.7. Переключитесь на опции libvips при сжатии изображений</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#deploy-na-production">4.14.8. Деплой на production</a>
</h6>      </li>
      <li>
        <h5>
          <a href="#versiya-rails-teper-vklyuchaetsya-v-damp-shemy-active-record">4.15. Версия Rails теперь включается в дамп схемы Active Record</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#upgrading-from-rails-6-0-to-rails-6-1">5. Апгрейд с Rails 6.0 на Rails 6.1</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#vozvraschaemoe-znachenie-rails-application-config_for-bolshe-ne-podderzhivaet-dostup-s-pomoschyu-strokovyh-klyuchey">5.1. Возвращаемое значение <code>Rails.application.config_for</code> больше не поддерживает доступ с помощью строковых ключей.</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#content-type-otklika-pri-ispolzovanii-respond_to-any">5.2. Content-Type отклика при использовании <code>respond_to#any</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#activesupport-callbacks-halted_callback_hook-teper-prinimaet-vtoroy-argument">5.3. <code>ActiveSupport::Callbacks#halted_callback_hook</code> теперь принимает второй аргумент</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#metod-klassa-helper-v-kontrollerah-ispolzuet-string-constantize">5.4. Метод класса <code>helper</code> в контроллерах использует <code>String#constantize</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#perenapravlenie-k-https-ot-http-teper-budet-ispolzovat-308">5.5. Перенаправление к HTTPS от HTTP теперь будет использовать  308</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#active-storage-teper-trebuet-image-processing">5.6. Active Storage теперь требует Image Processing</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#klass-activemodel-error">5.7. Класс <code>ActiveModel::Error</code></a>
</h5>      </li>
      <li>
        <h4>
          <a href="#upgrading-from-rails-5-2-to-rails-6-0">6. Апгрейд с Rails 5.2 на Rails 6.0</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#ispolzovanie-webpacker">6.1. Использование Webpacker</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#navyazyvanie-ssl">6.2. Навязывание SSL</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#dlya-uvelicheniya-bezopasnosti-metadannye-o-naznachenii-i-istechenii-teper-vstroeny-v-podpisannye-i-zashifrovannye-kuki">6.3. Для увеличения безопасности, метаданные о назначении и истечении теперь встроены в подписанные и зашифрованные куки</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#vse-pakety-npm-byli-peremescheny-v-prostranstvo-imen-rails">6.4. Все пакеты npm были перемещены в пространство имен <code>@rails</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#izmeneniya-action-cable-javascript-api">6.5. Изменения Action Cable JavaScript API</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#actiondispatch-response-content_type-teper-vozvraschaet-zagolovok-content-type-bez-izmeneniy">6.6. <code>ActionDispatch::Response#content_type</code> теперь возвращает заголовок Content-Type без изменений</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#novaya-nastroyka-config-hosts">6.7. Новая настройка <code>config.hosts</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#autoloading">6.8. Автозагрузка</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#publichnyy-api">6.8.1. Публичный API</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#struktura-proekta">6.8.2. Структура проекта</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#require_dependency">6.8.3. require_dependency</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#ogranichennye-imena-v-opredeleniyah-klassa-i-modulya">6.8.4. Ограниченные имена в определениях класса и модуля</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#kontserny">6.8.5. Концерны</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#app-v-putyah-avtomaticheskoy-zagruzki">6.8.6. <code>app</code> в путях автоматической загрузки</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#avtomaticheskaya-zagruzka-konstant-i-yavnye-prostranstva-imen">6.8.7. Автоматическая загрузка констант и явные пространства имен</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#odin-fayl-odna-konstanta-na-tom-zhe-urovne">6.8.8. Один файл, одна константа (на том же уровне)</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#spring-i-sreda-test">6.8.9. Spring и среда <code>test</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#bootsnap">6.8.10. Bootsnap</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#config-add_autoload_paths_to_load_path">6.8.11. <code>config.add_autoload_paths_to_load_path</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#tredobezopasnost">6.8.12. Тредобезопасность</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#shablony-poiska-v-config-autoload_paths">6.8.13. Шаблоны поиска в config.autoload_paths</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#neterpelivaya-zagruzka-i-avtomaticheskaya-zagruzka-soglasuyutsya">6.8.14. Нетерпеливая загрузка и автоматическая загрузка согласуются</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#kak-ispolzovat-klassicheskiy-avtozagruzchik-v-rails-6">6.8.15. Как использовать классический автозагрузчик в Rails 6</a>
</h6>      </li>
      <li>
        <h5>
          <a href="#izmenenie-povedeniya-prisvoeniya-active-storage">6.9. Изменение поведения присвоения Active Storage</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#polzovatelskie-prilozheniya-obrabotki-isklyucheniy">6.10. Пользовательские приложения обработки исключений</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#upgrading-from-rails-5-1-to-rails-5-2">7. Апгрейд с Rails 5.1 на Rails 5.2</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#bootsnap2">7.1. Bootsnap</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#istechenie-sroka-deystviya-v-podpisannyh-ili-zashifrovannyh-kuki-teper-vstroeno-v-znacheniya-kuki">7.2. Истечение срока действия в подписанных или зашифрованных куки теперь встроено в значения куки</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#upgrading-from-rails-5-0-to-rails-5-1">8. Апгрейд с Rails 5.0 на Rails 5.1</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#verhneurovnevyy-hashwithindifferentaccess-v-skorom-vremeni-ustareet">8.1. Верхнеуровневый <code>HashWithIndifferentAccess</code> в скором времени устареет.</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#application-secrets-teper-zagruzhaetsya-so-vsemi-klyuchami-v-kachestve-simvolov">8.2. <code>application.secrets</code> теперь загружается со всеми ключами в качестве символов</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#ubrana-ustarevshaya-podderzhka-text-i-nothing-v-render">8.3. Убрана устаревшая поддержка <code>:text</code> и <code>:nothing</code> в <code>render</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#ubrana-ustarevshaya-podderzhka-redirect_to-back">8.4. Убрана устаревшая поддержка <code>redirect_to :back</code></a>
</h5>      </li>
      <li>
        <h4>
          <a href="#upgrading-from-rails-4-2-to-rails-5-0">9. Апгрейд с Rails 4.2 на Rails 5.0</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#trebuetsya-ruby-2-2-2">9.1. Требуется Ruby 2.2.2+</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#modeli-active-record-teper-po-umolchaniyu-nasleduyutsya-ot-applicationrecord">9.2. Модели Active Record теперь по умолчанию наследуются от ApplicationRecord</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#preryvanie-tsepochek-kolbekov-s-pomoschyu-throw-abort">9.3. Прерывание цепочек колбэков с помощью <code>throw(:abort)</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#activejob-teper-po-umolchaniyu-nasleduetsya-ot-applicationjob">9.4. ActiveJob теперь по умолчанию наследуется от ApplicationJob</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#testirovanie-kontrollerov-rails">9.5. Тестирование контроллеров Rails</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#izvlechenie-nekotoryh-metodov-helpera-v-rails-controller-testing">9.5.1. Извлечение некоторых методов хелпера в <code>rails-controller-testing</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#novoe-povedenie-pri-zagruzke-faylov">9.5.2. Новое поведение при загрузке файлов</a>
</h6>      </li>
      <li>
        <h5>
          <a href="#avtozagruzka-otklyuchena-posle-zagruzki-v-srede-production">9.6. Автозагрузка отключена после загрузки в среде production</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#serializatsiya-v-xml">9.7. Сериализация в XML</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#ubrana-podderzhka-staroy-versii-adaptera-mysql">9.8. Убрана поддержка старой версии адаптера <code>mysql</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#ubrana-podderzhka-debugger">9.9. Убрана поддержка Debugger</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#ispolzovanie-bin-rails-dlya-zapuska-zadach-i-testov">9.10. Использование <code>bin/rails</code> для запуска задач и тестов</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#actioncontroller-parameters-bolshe-ne-nasleduetsya-ot-hashwithindifferentaccess">9.11. <code>ActionController::Parameters</code> больше не наследуется от <code>HashWithIndifferentAccess</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#teper-v-protect_from_forgery-po-umolchaniyu-prepend-false">9.12. Теперь в <code>protect_from_forgery</code> по умолчанию <code>prepend: false</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#obrabotchik-shablona-po-umolchaniyu-teper-raw">9.13. Обработчик шаблона по умолчанию теперь RAW</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#dobavleno-sovpadenie-s-podstanovkoy-dlya-zavisimostey-shablonov">9.14. Добавлено совпадение с подстановкой для зависимостей шаблонов</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#actionview-helpers-recordtaghelper-peremeschen-v-otdelnyy-gem-record_tag_helper">9.15. <code>ActionView::Helpers::RecordTagHelper</code> перемещен в отдельный гем (record_tag_helper)</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#ubrana-podderzhka-gema-protected_attributes">9.16. Убрана поддержка гема <code>protected_attributes</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#ubrana-podderzhka-gema-activerecord-deprecated_finders">9.17. Убрана поддержка гема <code>activerecord-deprecated_finders</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#poryadok-testov-activesupport-testcase-po-umolchaniyu-seychas-sluchaynyy">9.18. Порядок тестов <code>ActiveSupport::TestCase</code> по умолчанию сейчас случайный</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#actioncontroller-live-stal-concern">9.19. <code>ActionController::Live</code> стал <code>Concern</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#novye-znacheniya-po-umolchaniyu-freymvorka">9.20. Новые значения по умолчанию фреймворка</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#optsiya-active-record-dlya-belongs_to-trebuetsya-po-umolchaniyu">9.20.1. Опция Active Record для <code>belongs_to</code> - требуется по умолчанию</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#tokeny-csrf-dlya-formy">9.20.2. Токены CSRF для формы</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#zaschita-ot-poddelki-s-pomoschyu-proverki-domena">9.20.3. Защита от подделки с помощью проверки домена</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#razreshena-nastroyka-imeni-ocheredi-action-mailer">9.20.4. Разрешена настройка имени очереди Action Mailer</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#podderzhka-keshirovaniya-fragmentov-vo-vyu-action-mailer">9.20.5. Поддержка кэширования фрагментов во вью Action Mailer</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#nastroyka-vyvoda-db-structure-dump">9.20.6. Настройка вывода <code>db:structure:dump</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#nastroyka-optsiy-ssl-chtoby-vklyuchit-hsts-s-poddomenami">9.20.7. Настройка опций SSL, чтобы включить HSTS с поддоменами</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#sohranenie-vremennoy-zony-poluchatelya">9.20.8. Сохранение временной зоны получателя</a>
</h6>      </li>
      <li>
        <h5>
          <a href="#izmeneniya-s-serializatsiey-json-jsonb">9.21. Изменения с сериализацией JSON/JSONB</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#upgrading-from-rails-4-1-to-rails-4-2">10. Апгрейд с Rails 4.1 на Rails 4.2</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#web-console">10.1. Web Console</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#responders">10.2. Responders</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#obrabotka-oshibok-v-tranzaktsionnyh-kolbekah">10.3. Обработка ошибок в транзакционных колбэках</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#uporyadochivanie-testovyh-sluchaev">10.4. Упорядочивание тестовых случаев</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#serializovannye-atributy">10.5. Сериализованные атрибуты</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#uroven-loga-v-production">10.6. Уровень лога в Production</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#after_bundle-v-shablonah-rails">10.7. <code>after_bundle</code> в шаблонах Rails</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#sanitayzer-html-v-rails">10.8. Санитайзер HTML в Rails</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#testirovanie-dom-v-rails">10.9. Тестирование DOM в Rails</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#maskirovka-tokenov-autentifikatsii">10.10. Маскировка токенов аутентификации</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#action-mailer">10.11. Action Mailer</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#podderzhka-vneshnih-klyuchey">10.12. Поддержка внешних ключей</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#upgrading-from-rails-4-0-to-rails-4-1">11. Апгрейд с Rails 4.0 на Rails 4.1</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#zaschita-csrf-ot-vneshnih-tegov-lt-script-gt">11.1. Защита CSRF от внешних тегов <code>&lt;script&gt;</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#spring2">11.2. Spring</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#config-secrets-yml">11.3. <code>config/secrets.yml</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#izmeneniya-v-testovom-helpere">11.4. Изменения в тестовом хелпере</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#cookies-serializer">11.5. Сериализатор куки</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#izmenilas-struktura-flash">11.6. Изменилась структура Flash</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#changes-in-json-handling">11.7. Изменения в обработке JSON</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#ubran-multijson">11.7.1. Убран MultiJSON</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#sovmestimost-s-gemom-json">11.7.2. Совместимость с гемом JSON</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#novyy-koder-json">11.7.3. Новый кодер JSON</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#predstavlenie-v-json-ob-ektov-time">11.7.4. Представление в JSON объектов Time</a>
</h6>      </li>
      <li>
        <h5>
          <a href="#ispolzovanie-return-v-inlayn-blokah-kolbekov">11.8. Использование <code>return</code> в инлайн блоках колбэков</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#metody-opredelennye-v-fiksturah-active-record">11.9. Методы, определенные в фикстурах Active Record</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#obespechenie-dostupnyh-lokaley-i18n">11.10. Обеспечение доступных локалей I18n</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#mutiruyuschie-metody-mutatory-vyzyvaemye-na-relation">11.11. Мутирующие методы (мутаторы), вызываемые на Relation</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#changes-on-default-scopes">11.12. Изменения в скоупах по умолчанию</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#rendering-content-from-string">11.13. Рендеринг содержимого из строки</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#tipy-dannyh-json-i-hstore-v-postgresql">11.14. Типы данных JSON и hstore в PostgreSQL</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#yavnoe-ispolzovanie-bloka-dlya-activesupport-callbacks">11.15. Явное использование блока для <code>ActiveSupport::Callbacks</code></a>
</h5>      </li>
      <li>
        <h4>
          <a href="#upgrading-from-rails-3-2-to-rails-4-0">12. Апгрейд с Rails 3.2 на Rails 4.0</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#http-patch">12.1. HTTP PATCH</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#zametka-o-tipah-media">12.1.1. Заметка о типах медиа</a>
</h6>      </li>
      <li>
        <h5>
          <a href="#gemfile">12.2. Gemfile</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#vendor-plugins">12.3. vendor/plugins</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#active-record">12.4. Active Record</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#active-resource">12.5. Active Resource</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#active-model">12.6. Active Model</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#action-pack">12.7. Action Pack</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#active-support">12.8. Active Support</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#cache">12.8.1. Cache</a>
</h6>      </li>
      <li>
        <h5>
          <a href="#poryadok-zagruzki-helperov">12.9. Порядок загрузки хелперов</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#active-record-observer-i-action-controller-sweeper">12.10. Active Record Observer и Action Controller Sweeper</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#sprockets-rails">12.11. sprockets-rails</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#sass-rails">12.12. sass-rails</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#apgreyd-s-rails-3-1-na-rails-3-2">13. Апгрейд с Rails 3.1 на Rails 3.2</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#gemfile2">13.1. Gemfile</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#config-environments-development-rb">13.2. config/environments/development.rb</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#config-environments-test-rb">13.3. config/environments/test.rb</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#vendor-plugins2">13.4. vendor/plugins</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#active-record2">13.5. Active Record</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#apgreyd-s-rails-3-0-na-rails-3-1">14. Апгрейд с Rails 3.0 на Rails 3.1</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#gemfile3">14.1. Gemfile</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#config-application-rb">14.2. config/application.rb</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#config-environments-development-rb2">14.3. config/environments/development.rb</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#config-environments-production-rb">14.4. config/environments/production.rb</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#config-environments-test-rb2">14.5. config/environments/test.rb</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#config-initializers-wrap_parameters-rb">14.6. config/initializers/wrap_parameters.rb</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#config-initializers-session_store-rb">14.7. config/initializers/session_store.rb</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#ubrat-optsii-cache-i-concat-v-helperah-assetov-vo-vyu">14.8. Убрать опции :cache и :concat в хелперах ассетов во вью</a>
</h5>      </li>
</ul>

              </div>
            <div class="well banner300 banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<!-- sidebar rusrails -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:600px"
     data-ad-client="ca-pub-7764391801669990"
     data-ad-slot="6089520660"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
          <div class="span9 content pull-left">
            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <!-- top rusrails -->
  <ins class="adsbygoogle"
       style="display:inline-block;width:980px;height:120px"
       data-ad-client="ca-pub-7764391801669990"
       data-ad-slot="4891989065"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
              <h2 id='apgreyd-ruby-on-rails' class='inside_page_header'> Апгрейд Ruby on Rails</h2><p>В этом руководстве приведены шаги, которые необходимо выполнить, чтобы апгрейднуть приложение на новую версию Ruby on Rails. Эти шаги также доступны в отдельных руководствах по релизам.</p><h3 id='obschiy-sovet' class='inside_page_header'><a href="#obschiy-sovet">1.</a> Общий совет</h3><p>Перед попыткой апгрейда существующего приложения, следует убедиться, что есть хорошая причина для апгрейда. Нужно соблюсти баланс между несколькими факторами: необходимостью в новых особенностях, увеличением сложности в поиске поддержки для старого кода, доступностью вашего времени и навыков - это только некоторые из многих.</p><h4 id='testovoe-pokrytie' class='inside_page_header'><a href="#testovoe-pokrytie">1.1.</a> Тестовое покрытие</h4><p>Лучшим способом убедиться, что приложение продолжит работать после апгрейда, это иметь хорошее тестовое покрытие до начала апгрейда. Если у вас нет автоматических тестов, проверяющих большую часть вашего приложения, тогда нужно потратить время, проверяя все части, которые изменились. В случае обновления Rails это означает каждый отдельный кусок функциональности приложения. Пожалейте себя и убедитесь в хорошем тестовом покрытии <em>до</em> начала апгрейда.</p><h4 id='versii-ruby' class='inside_page_header'><a href="#versii-ruby">1.2.</a> Версии Ruby</h4><p>В основном Rails использует последние выпущенные версии Ruby:</p><ul><li>Rails 7.2 требует Ruby 3.1.0 или новее.
</li><li>Rails 7.0 и 7.1 требуют Ruby 2.7.0 или новее.
</li><li>Rails 6 требует Ruby 2.5.0 или новее.
</li><li>Rails 5 требует Ruby 2.2.2 или новее.
</li></ul><p>Хорошей идеей будет обновлять Ruby и Rails раздельно. Сначала обновитесь на последний Ruby, а потом обновляйте Rails.</p><h4 id='protsess-apgreyda' class='inside_page_header'><a href="#protsess-apgreyda">1.3.</a> Процесс апгрейда</h4><p>При изменении версий Rails лучше двигаться медленно, одна второстепенная версия за раз, чтобы результативно использовать предупреждения об устаревании. Версии Rails записываются в форме Major.Minor.Patch. В главной (Major) и второстепенной (Minor) версиях допустимо делать изменения в публичном API, и это может вызвать ошибки в вашем приложении. Версии Patch включают только исправления ошибок и не изменяют публичное API.</p><p>Процесс должен быть следующим:</p><ul><li>Пишете тесты и убеждаетесь, что они проходят.
</li><li>Переходите к последней версии патча, следующую после вашей текущей версии.
</li><li>Чините тесты и устаревшие особенности.
</li><li>Переходите к последней версии патча следующей второстепенной версии.
</li></ul><p>Повторяйте этот процесс, пока не достигнете целевой версии Rails.</p><h5 id='perehod-mezhdu-versiyami' class='inside_page_header'><a href="#perehod-mezhdu-versiyami">1.3.1.</a> Переход между версиями</h5><p>Чтобы перейти к версии:</p><ul><li>Измените номер версии Rails в <code>Gemfile</code> и запустите <code>bundle update</code>.
</li><li>Измените версии для пакетов Rails JavaScript в <code>package.json</code> и запустите <code>bin/rails javascript:install</code>, если вы на jsbundling-rails.
</li><li>Запустите <a href="#the-update-task">задачу Update</a>.
</li><li>Запустите свои тесты.
</li></ul><p>Полный список всех выпущенных версий Rails можно найти <a href="https://rubygems.org/gems/rails/versions">тут</a>.</p><h4 id='the-update-task' class='inside_page_header'><a href="#the-update-task">1.4.</a> Задача Update</h4><p>Rails предоставляет команду <code>rails app:update</code>. После обновления версии Rails в <code>Gemfile</code>, запустите эту команду. Она поможет вам с созданием новых файлов и изменением старых файлов в интерактивной сессии.</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>app:update
<span class="go">       exist  config
    conflict  config/application.rb
Overwrite /myapp/config/application.rb? (enter "h" for help) [Ynaqdh]
       force  config/application.rb
      create  config/initializers/new_framework_defaults_7_2.rb
</span><span class="c">...
</span></code></pre>
</div>
<p>Не забывайте просматривать разницу, чтобы увидеть какие-либо неожидаемые изменения.</p><h4 id='nastroyka-umolchaniy-freymvorka' class='inside_page_header'><a href="#nastroyka-umolchaniy-freymvorka">1.5.</a> Настройка умолчаний фреймворка</h4><p>Возможно, что новая версия Rails будет иметь другие настройки по умолчанию, чем в предыдущей версии. Однако, после следования шагам, описанным ниже, ваше приложение все еще будет запускаться с настройками по умолчанию из <em>предыдущей</em> версии Rails. Это так, потому что значения для <code>config.load_defaults</code> в <code>config/application.rb</code> не были пока изменены.</p><p>Чтобы позволить обновиться до новых значений по умолчанию один за другим, задача обновления создала файл <code>config/initializers/new_framework_defaults_X.Y.rb</code> (с желаемой версией Rails в имени файла). Следует включать новые конфигурационные значения по умолчанию, снимая комментарий с них в этом файле; это можно сделать постепенно на протяжение нескольких развертываний. Как только ваше приложение готово быть запущенным с новыми значениями по умолчанию, этот файл можно удалить и изменить значение <code>config.load_defaults</code>.</p><h3 id='upgrading-from-rails-7-1-to-rails-7-2' class='inside_page_header'><a href="#upgrading-from-rails-7-1-to-rails-7-2">2.</a> Апгрейд с Rails 7.1 на Rails 7.2</h3><p>Подробнее о внесенных изменениях в Rails 7.2 смотрите в <a href="/7_2_release_notes">заметках о релизе</a>.</p><h3 id='upgrading-from-rails-7-0-to-rails-7-1' class='inside_page_header'><a href="#upgrading-from-rails-7-0-to-rails-7-1">3.</a> Апгрейд с Rails 7.0 на Rails 7.1</h3><p>Подробнее о внесенных изменениях в Rails 7.1 смотрите в <a href="/7_1_release_notes">заметках о релизе</a>.</p><h4 id='puti-avtozagruzki-bolshe-ne-v-load_path' class='inside_page_header'><a href="#puti-avtozagruzki-bolshe-ne-v-load_path">3.1.</a> Пути автозагрузки больше не в $LOAD_PATH</h4><p>Начиная с Rails 7.1, директории, управляемые автозагрузчиками, больше не добавляются в <code>$LOAD_PATH</code>. Это означает, что их файлы больше невозможно загрузить вручную с помощью вызова <code>require</code>, что, впрочем, и не следовало делать.</p><p>Уменьшение размера <code>$LOAD_PATH</code> ускоряет вызовы <code>require</code> для приложений, не использующих <code>bootsnap</code>, и уменьшает размер кэша <code>bootsnap</code> для остальных.</p><p>Если все еще желаете иметь эти пути в <code>$LOAD_PATH</code>, можно включить:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">add_autoload_paths_to_load_path</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
</div>
<p>но мы не одобряем так делать, классы и модули в путях автозагрузки подразумеваются быть автозагруженными. Для этого нужно всего лишь на них сослаться.</p><p>Директория <code>lib</code> не затрагивается этим флажком, она всегда добавлена в <code>$LOAD_PATH</code>.</p><h4 id='config-autoload_lib-i-config-autoload_lib_once' class='inside_page_header'><a href="#config-autoload_lib-i-config-autoload_lib_once">3.2.</a> config.autoload_lib и config.autoload_lib_once</h4><p>Если в вашем приложении <code>lib</code> не находится в путях автозагрузки или однократной автозагрузки, можете опустить этот раздел. Это можно узнать, просмотрев вывод</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">#</span><span class="w"> </span>Печатает пути автозагрузки.
<span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>runner <span class="s1">'pp Rails.autoloaders.main.dirs'</span>
<span class="go">
</span><span class="gp">#</span><span class="w"> </span>Печатает пути однократной автозагрузки.
<span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>runner <span class="s1">'pp Rails.autoloaders.once.dirs'</span>
</code></pre>
</div>
<p>Если в вашем приложении <code>lib</code> в путях автозагрузки, обычно в <code>config/application.rb</code> есть конфигурация, которая выглядит наподобие</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Автоматически загружать lib, но не загружать нетерпеливо (возможно, что забыли).</span>
<span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">&lt;&lt;</span> <span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"lib"</span><span class="p">)</span>
</code></pre>
</div>
<p>или</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Автоматически, а также нетерпеливо загружать lib.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">&lt;&lt;</span> <span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"lib"</span><span class="p">)</span>
<span class="n">config</span><span class="p">.</span><span class="nf">eager_load_paths</span> <span class="o">&lt;&lt;</span> <span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"lib"</span><span class="p">)</span>
</code></pre>
</div>
<p>или</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># То же самое, потому что все пути нетерпеливой загрузки также становятся путями автозагрузки.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">eager_load_paths</span> <span class="o">&lt;&lt;</span> <span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"lib"</span><span class="p">)</span>
</code></pre>
</div>
<p>Это все еще работает, но рекомендуется заменить эти строчки более выразительным</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">autoload_lib</span><span class="p">(</span><span class="ss">ignore: </span><span class="sx">%w(assets tasks)</span><span class="p">)</span>
</code></pre>
</div>
<p>Пожалуйста, добавьте к списку <code>ignore</code> любые другие поддиректории <code>lib</code>, не содержащие файлы <code>.rb</code>, или которые не должны быть перезагружены или нетерпеливо загружены. Например, если в приложении есть <code>lib/templates</code>, <code>lib/generators</code> или <code>lib/middleware</code>, нужно добавить их имя относительно <code>lib</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">autoload_lib</span><span class="p">(</span><span class="ss">ignore: </span><span class="sx">%w(assets tasks templates generators middleware)</span><span class="p">)</span>
</code></pre>
</div>
<p>С помощью этой строчки код (не игнорируемый) в <code>lib</code> также будет нетерпеливо загружен, если <code>config.eager_load</code> <code>true</code> (по умолчанию в режиме <code>production</code>). Обычно это то, что необходимо, но если <code>lib</code> не добавлялся ранее в пути нетерпеливой загрузки, и вы все еще желаете, чтобы так и оставалось, выключите:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">main</span><span class="p">.</span><span class="nf">do_not_eager_load</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"lib"</span><span class="p">))</span>
</code></pre>
</div>
<p>Метод <code>config.autoload_lib_once</code> аналогичен тому, если бы в приложении <code>lib</code> был в <code>config.autoload_once_paths</code>.</p><h4 id='activestorage-basecontroller-bolshe-ne-vklyuchaet-potokovyy-modul' class='inside_page_header'><a href="#activestorage-basecontroller-bolshe-ne-vklyuchaet-potokovyy-modul">3.3.</a> <code>ActiveStorage::BaseController</code> больше не включает потоковый модуль</h4><p>Контроллеры приложения, наследуемые от <code>ActiveStorage::BaseController</code>, и использующие потоки для реализации пользовательской логики отдачи файлов, теперь должны явно включать модуль <code>ActiveStorage::Streaming</code>.</p><h4 id='memcachestore-i-rediscachestore-teper-po-umolchaniyu-ispolzuyut-puly-soedineniy' class='inside_page_header'><a href="#memcachestore-i-rediscachestore-teper-po-umolchaniyu-ispolzuyut-puly-soedineniy">3.4.</a> <code>MemCacheStore</code> и <code>RedisCacheStore</code> теперь по умолчанию используют пулы соединений</h4><p>Гем <code>connection_pool</code> был добавлен как зависимость гема <code>activesupport</code>, и <code>MemCacheStore</code> и <code>RedisCacheStore</code> теперь по умолчанию используют пулы соединений.</p><p>Если не желаете использовать пулы соединений, установите опции <code>:pool</code> <code>false</code> при конфигурировании хранилища кэша:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">cache_store</span> <span class="o">=</span> <span class="ss">:mem_cache_store</span><span class="p">,</span> <span class="s2">"cache.example.com"</span><span class="p">,</span> <span class="p">{</span> <span class="ss">pool: </span><span class="kp">false</span> <span class="p">}</span>
</code></pre>
</div>
<p>Подробности смотрите в руководстве <a href="/caching-with-rails#connection-pool-options">по кэшированию с Rails</a>.</p><h4 id='sqlite3adapter-teper-konfiguriruetsya-chtoby-ispolzovatsya-v-rezhime-strogih-strok' class='inside_page_header'><a href="#sqlite3adapter-teper-konfiguriruetsya-chtoby-ispolzovatsya-v-rezhime-strogih-strok">3.5.</a> <code>SQLite3Adapter</code> теперь конфигурируется, чтобы использоваться в режиме строгих строк</h4><p>Использование режима строгих строк отключает строковые литералы с двойными кавычками.</p><p>В SQLite есть несколько причуд, связанных со строковыми литералами с двойными кавычками. Сначала он пытается рассматривать строки с двойными кавычками в качестве имен переменных, но, если они не существуют, он рассматривает их в качестве строковых литералов. Из-за этого опечатки могут быть незамечены. Например, возможно создать индекс для несуществующего столбца. Подробности смотрите в <a href="https://www.sqlite.org/quirks.html#double_quoted_string_literals_are_accepted">документации SQLite</a>.</p><p>Если вы не хотите использовать <code>SQLite3Adapter</code> в строгом режиме, это поведение можно отключить:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">sqlite3_adapter_strict_strings_by_default</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
</div>
<h4 id='podderzhka-neskolkih-putey-predvaritelnogo-prosmotra-dlya-actionmailer-preview' class='inside_page_header'><a href="#podderzhka-neskolkih-putey-predvaritelnogo-prosmotra-dlya-actionmailer-preview">3.6.</a> Поддержка нескольких путей предварительного просмотра для <code>ActionMailer::Preview</code></h4><p>Опция <code>config.action_mailer.preview_path</code> устарела в пользу <code>config.action_mailer.preview_paths</code>. Добавление путей к этой конфигурационной опции вызовет, что эти пути будут использованы в поиске для предварительного просмотра писем.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">preview_paths</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/lib/mailer_previews"</span>
</code></pre>
</div>
<h4 id='config-i18n-raise_on_missing_translations-true-teper-vyzyvaet-oshibku-dlya-lyubogo-otsutstvuyuschego-perevoda' class='inside_page_header'><a href="#config-i18n-raise_on_missing_translations-true-teper-vyzyvaet-oshibku-dlya-lyubogo-otsutstvuyuschego-perevoda">3.7.</a> <code>config.i18n.raise_on_missing_translations = true</code> теперь вызывает ошибку для любого отсутствующего перевода.</h4><p>Раньше он вызывал ошибку только при вызове во вью или контроллере. Теперь он будет вызывать ошибку всякий раз, когда в <code>I18n.t</code> предоставлен нераспознанный ключ.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># с config.i18n.raise_on_missing_translations = true</span>

<span class="c1"># во вью или контроллере:</span>
<span class="n">t</span><span class="p">(</span><span class="s2">"missing.key"</span><span class="p">)</span> <span class="c1"># вызывает ошибку в 7.0, вызывает ошибку в 7.1</span>
<span class="no">I18n</span><span class="p">.</span><span class="nf">t</span><span class="p">(</span><span class="s2">"missing.key"</span><span class="p">)</span> <span class="c1"># не вызывает ошибку в 7.0, вызывает ошибку в 7.1</span>

<span class="c1"># где угодно:</span>
<span class="no">I18n</span><span class="p">.</span><span class="nf">t</span><span class="p">(</span><span class="s2">"missing.key"</span><span class="p">)</span> <span class="c1"># не вызывает ошибку в 7.0, вызывает ошибку в 7.1</span>
</code></pre>
</div>
<p>Если не желаете такое поведение, можно установить <code>config.i18n.raise_on_missing_translations = false</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># с config.i18n.raise_on_missing_translations = false</span>

<span class="c1"># во вью или контроллере:</span>
<span class="n">t</span><span class="p">(</span><span class="s2">"missing.key"</span><span class="p">)</span> <span class="c1"># не вызывает ошибку в 7.0, не вызывает ошибку в 7.1</span>
<span class="no">I18n</span><span class="p">.</span><span class="nf">t</span><span class="p">(</span><span class="s2">"missing.key"</span><span class="p">)</span> <span class="c1"># не вызывает ошибку в 7.0, не вызывает ошибку в 7.1</span>

<span class="c1"># где угодно:</span>
<span class="no">I18n</span><span class="p">.</span><span class="nf">t</span><span class="p">(</span><span class="s2">"missing.key"</span><span class="p">)</span> <span class="c1"># не вызывает ошибку в 7.0, не вызывает ошибку в 7.1</span>
</code></pre>
</div>
<p>Альтернативно можно настроить <code>I18n.exception_handler</code>. Подробности смотрите в <a href="/i18n#using-different-exception-handlers">руководстве i18n</a>.</p><p><code>AbstractController::Translation.raise_on_missing_translations</code> был убран. Это был приватный API, если вы полагались на него, следует мигрировать на <code>config.i18n.raise_on_missing_translations</code> или пользовательский обработчик исключения.</p><h4 id='bin-rails-test-teper-zapuskaet-zadachu-test-prepare' class='inside_page_header'><a href="#bin-rails-test-teper-zapuskaet-zadachu-test-prepare">3.8.</a> <code>bin/rails test</code> теперь запускает задачу <code>test:prepare</code></h4><p>При запуске тестов с помощью <code>bin/rails test</code> до запуска тестов будет запущена задача <code>rake test:prepare</code>. Если задача <code>test:prepare</code> была усовершенствована, эти усовершенствования будут запущены до тестов. <code>tailwindcss-rails</code>, <code>jsbundling-rails</code> и <code>cssbundling-rails</code> совершенствуют эту задачу, также как и другие сторонние гемы.</p><p>Подробности смотрите в руководстве <a href="/testing#running-tests-in-continuous-integration-ci">Тестирование приложений на Rails</a>.</p><p>Если запускаете тесты одного файла (<code>bin/rails test test/models/user_test.rb</code>), <code>test:prepare</code> не будет запущен перед этим.</p><h4 id='izmenen-sintaksis-importa-iz-rails-ujs' class='inside_page_header'><a href="#izmenen-sintaksis-importa-iz-rails-ujs">3.9.</a> Изменен синтаксис импорта из <code>@rails/ujs</code></h4><p>Начиная с Rails 7.1, изменился синтаксис для импорта модулей из <code>@rails/ujs</code>. Rails больше не поддерживает прямой импорт модуля из <code>@rails/ujs</code>.</p><p>Например, попытка импорта функции из библиотеки будет неудачной:</p><div class="code_container">
  <pre><code class="highlight javascript"><span class="k">import</span> <span class="p">{</span> <span class="nx">fileInputSelector</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rails/ujs</span><span class="dl">"</span>
<span class="c1">// ERROR: export 'fileInputSelector' (imported as 'fileInputSelector') was not found in '@rails/ujs' (possible exports: default)</span>
</code></pre>
</div>
<p>В Rails 7.1 пользователи сначала импортируют объект Rails непосредственно из <code>@rails/ujs</code>. Затем пользователи могут импортировать определенные модули из объекта Rails.</p><p>Пример импорта в Rails 7.1 показан ниже:</p><div class="code_container">
  <pre><code class="highlight javascript"><span class="k">import</span> <span class="nx">Rails</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rails/ujs</span><span class="dl">"</span>
<span class="c1">// Псевдоним метода</span>
<span class="kd">const</span> <span class="nx">fileInputSelector</span> <span class="o">=</span> <span class="nx">Rails</span><span class="p">.</span><span class="nx">fileInputSelector</span>
<span class="c1">// Альтернативно ссылаться на него из объекта Rails, в котором он использован</span>
<span class="nx">Rails</span><span class="p">.</span><span class="nx">fileInputSelector</span><span class="p">(...)</span>
</code></pre>
</div>
<h4 id='rails-logger-teper-vozvraschaet-ekzemplyar-activesupport-broadcastlogger' class='inside_page_header'><a href="#rails-logger-teper-vozvraschaet-ekzemplyar-activesupport-broadcastlogger">3.10.</a> <code>Rails.logger</code> теперь возвращает экземпляр <code>ActiveSupport::BroadcastLogger</code></h4><p>Класс <code>ActiveSupport::BroadcastLogger</code> это новый логгер, позволяющий простым образом транслировать логи в разные сливы (STDOUT, файл лога...).</p><p>API трансляции логов (с помощью метода <code>ActiveSupport::Logger.broadcast</code>) был убран, и был приватным раньше. Если ваше приложение или библиотека полагались на этот API, необходимо сделать следующие изменения:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"some_file.log"</span><span class="p">)</span>

<span class="c1"># До</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span><span class="n">logger</span><span class="p">))</span>

<span class="c1"># После</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">broadcast_to</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
</code></pre>
</div>
<p>Если ваше приложение конфигурирует пользовательский логгер, <code>Rails.logger</code> обернет или проксирует все методы к нему. На вашей стороне не требуются никаких изменений.</p><p>Если необходим доступ к вашему экземпляру пользовательского логгера, можно использовать метод <code>broadcasts</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">MyLogger</span><span class="p">.</span><span class="nf">new</span>

<span class="c1"># Где угодно в вашем приложении</span>
<span class="nb">puts</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">class</span> <span class="c1">#=&gt; BroadcastLogger</span>
<span class="nb">puts</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">broadcasts</span> <span class="c1">#=&gt; [MyLogger]</span>
</code></pre>
</div>
<h4 id='izmenilis-algoritmy-shifrovaniya-active-record' class='inside_page_header'><a href="#izmenilis-algoritmy-shifrovaniya-active-record">3.11.</a> Изменились алгоритмы шифрования Active Record</h4><p>Шифрование Active Record теперь использует SHA-256 в качестве алгоритма дайджеста хэша. Если у вас имеются данные, зашифрованные предыдущими версиями Rails, можно рассмотреть два сценария:</p><ul><li><p>Если у вас <code>config.active_support.key_generator_hash_digest_class</code> сконфигурирован как SHA-1 (по умолчанию до Rails 7.0), нужно также сконфигурировать SHA-1 для шифрования Active Record:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">hash_digest_class</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span>
</code></pre>
</div>
</li><li><p>Если у вас <code>config.active_support.key_generator_hash_digest_class</code> сконфигурирован как SHA-256 (новое умолчание в 7.0), вам необходимо сконфигурировать SHA-256 для шифрования Active Record:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">hash_digest_class</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA256</span>
</code></pre>
</div>
</li></ul><p>Смотрите руководство <a href="/configuring#config-active-record-encryption-hash-digest-class">Configuring Rails Applications</a> о подробностях по <code>config.active_record.encryption.hash_digest_class</code>.</p><p>В дополнение была представлена новая конфигурация <a href="/configuring#config-active-record-encryption-support-sha1-for-non-deterministic-encryption"><code>config.active_record.encryption.support_sha1_for_non_deterministic_encryption</code></a> чтобы починить <a href="https://github.com/rails/rails/issues/42922">баг</a>, вызывающий то, что некоторые атрибуты были зашифрованы с помощью SHA-1, даже если был настроен SHA-256 с помощью вышеупомянутой конфигурации <code>hash_digest_class</code>.</p><p>По умолчанию <code>config.active_record.encryption.support_sha1_for_non_deterministic_encryption</code> отключена в Rails 7.1. Если у вас есть данные, зашифрованные в версии Rails &lt; 7.1, которые, вы считаете, могут быть затронуты вышеупомянутым багом, эта конфигурация должна быть включена:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">support_sha1_for_non_deterministic_encryption</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
</div>
<p>Если вы работаете с зашифрованными данными, пожалуйста, внимательно прочитайте вышеизложенное.</p><h4 id='novye-sposoby-obrabotki-isklyucheniy-v-testah-kontrollera-integratsionnyh-i-sistemnyh' class='inside_page_header'><a href="#novye-sposoby-obrabotki-isklyucheniy-v-testah-kontrollera-integratsionnyh-i-sistemnyh">3.12.</a> Новые способы обработки исключений в тестах контроллера, интеграционных и системных</h4><p>Конфигурация <code>config.action_dispatch.show_exceptions</code> контролирует, как Action Pack обрабатывает исключения, вызванные во время отклика на запросы.</p><p>До Rails 7.1 установка <code>config.action_dispatch.show_exceptions = true</code> конфигурировала Action Pack ловить исключения и рендерить подходящие HTML страницы ошибки, наподобие рендера <code>public/404.html</code> со кодом статуса <code>404 Not found</code> вместо вызова исключения <code>ActiveRecord::RecordNotFound</code>. Установка <code>config.action_dispatch.show_exceptions = false</code> конфигурировала Action Pack не ловить исключение. До Rails 7.1 новые приложения генерировались со строчкой в <code>config/environments/test.rb</code>, устанавливающей <code>config.action_dispatch.show_exceptions = false</code>.</p><p>Rails 7.1 изменяет приемлемые значения с <code>true</code> и <code>false</code> на <code>:all</code>, <code>:rescuable</code> и <code>:none</code>.</p><ul><li><code>:all</code> - рендерить HTML страницы ошибки для всех исключений (эквивалентно <code>true</code>)
</li><li><code>:rescuable</code> - рендерить HTML страницы ошибки для исключений, объявленных в <a href="/configuring#config-action-dispatch-rescue-responses"><code>config.action_dispatch.rescue_responses</code></a>
</li><li><code>:none</code> (эквивалентно <code>false</code>) - не ловить любые исключения
</li></ul><p>Приложения, генерируемые Rails 7.1 или более поздними, устанавливают <code>config.action_dispatch.show_exceptions = :rescuable</code> в их <code>config/environments/test.rb</code>. При обновлении существующим приложениям можно изменить <code>config.action_dispatch.show_exceptions = :rescuable</code>, чтобы воспользоваться новым поведением, или заменить старые значения соответствующими новыми (<code>true</code> заменяется на <code>:all</code>, <code>false</code> заменяется на <code>:none</code>).</p><h3 id='upgrading-from-rails-6-1-to-rails-7-0' class='inside_page_header'><a href="#upgrading-from-rails-6-1-to-rails-7-0">4.</a> Апгрейд с Rails 6.1 на Rails 7.0</h3><p>Подробнее о внесенных изменениях в Rails 7.0 смотрите в <a href="/7_0_release_notes">заметках о релизе</a>.</p><h4 id='izmenivsheesya-povedenie-actionview-helpers-urlhelper-button_to' class='inside_page_header'><a href="#izmenivsheesya-povedenie-actionview-helpers-urlhelper-button_to">4.1.</a> Изменившееся поведение <code>ActionView::Helpers::UrlHelper#button_to</code></h4><p>Начиная с Rails 7.0 <code>button_to</code> рендерит тег <code>form</code> с методом HTTP <code>patch</code>, если использован сохраненный объект Active Record, чтобы создать URL кнопки. Чтобы оставить текущее поведение, рассмотрите явную передачу опции <code>method:</code>:</p><div class="code_container">
  <pre><code class="highlight diff"><span class="gd">-button_to("Do a POST", [:my_custom_post_action_on_workshop, Workshop.find(1)])
</span><span class="gi">+button_to("Do a POST", [:my_custom_post_action_on_workshop, Workshop.find(1)], method: :post)
</span></code></pre>
</div>
<p>или используйте хелпер для создания URL:</p><div class="code_container">
  <pre><code class="highlight diff"><span class="gd">-button_to("Do a POST", [:my_custom_post_action_on_workshop, Workshop.find(1)])
</span><span class="gi">+button_to("Do a POST", my_custom_post_action_on_workshop_workshop_path(Workshop.find(1)))
</span></code></pre>
</div>
<h4 id='spring' class='inside_page_header'><a href="#spring">4.2.</a> Spring</h4><p>Если ваше приложение использует Spring, он должен быть обновлен до, как минимум, версии 3.0.0. В противном случае вы получите</p><div class="code_container">
  <pre><code class="highlight plaintext">undefined method `mechanism=' for ActiveSupport::Dependencies:Module
</code></pre>
</div>
<p>А также убедитесь, что <a href="/configuring#config-cache-classes"><code>config.cache_classes</code></a> установлен <code>false</code> в <code>config/environments/test.rb</code>.</p><h4 id='sprockets-teper-optsionalnaya-zavisimost' class='inside_page_header'><a href="#sprockets-teper-optsionalnaya-zavisimost">4.3.</a> Sprockets теперь опциональная зависимость</h4><p>Гем <code>rails</code> больше не зависит от <code>sprockets-rails</code>. Если вашему приложению все еще нужно использовать Sprockets, убедитесь, что добавили <code>sprockets-rails</code> в свой Gemfile.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">gem</span> <span class="s2">"sprockets-rails"</span>
</code></pre>
</div>
<h4 id='prilozheniya-dolzhny-zapuskatsya-v-rezhime-zeitwerk' class='inside_page_header'><a href="#prilozheniya-dolzhny-zapuskatsya-v-rezhime-zeitwerk">4.4.</a> Приложения должны запускаться в режиме <code>zeitwerk</code></h4><p>Приложения, все еще запущенные в режиме <code>classic</code>, должны быть переключены в режим <code>zeitwerk</code>. Пожалуйста, обратитесь к руководству <a href="https://github.com/rusrails/rusrails/blob/7.0/source/classic_to_zeitwerk_howto.md">Как перейти с Classic на Zeitwerk</a>.</p><h4 id='metod-naznacheniya-config-autoloader-byl-udalen' class='inside_page_header'><a href="#metod-naznacheniya-config-autoloader-byl-udalen">4.5.</a> Метод назначения <code>config.autoloader=</code> был удален</h4><p>В Rails 7 больше нет конфигурационной настройки для установки режима автоматической загрузки, <code>config.autoloader=</code> был удален. Если вам нужно было назначить <code>:zeitwerk</code> по какой-то причине, просто уберите ее.</p><h4 id='privatnyy-api-activesupport-dependencies-byl-udalen' class='inside_page_header'><a href="#privatnyy-api-activesupport-dependencies-byl-udalen">4.6.</a> Приватный API <code>ActiveSupport::Dependencies</code> был удален</h4><p>Приватный API <code>ActiveSupport::Dependencies</code> был удален. Он включал методы, такие как <code>hook!</code>, <code>unhook!</code>, <code>depend_on</code>, <code>require_or_load</code>, <code>mechanism</code> и многие другие.</p><p>Немного основных моментов:</p><ul><li>Если вы использовали <code>ActiveSupport::Dependencies.constantize</code> или <code>ActiveSupport::Dependencies.safe_constantize</code>, просто измените их на <code>String#constantize</code> или <code>String#safe_constantize</code>.
</li></ul><div class="code_container">
  <pre><code class="highlight ruby">  <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Dependencies</span><span class="p">.</span><span class="nf">constantize</span><span class="p">(</span><span class="s2">"User"</span><span class="p">)</span> <span class="c1"># БОЛЬШЕ НЕВОЗМОЖНО</span>
  <span class="s2">"User"</span><span class="p">.</span><span class="nf">constantize</span> <span class="c1"># 👍</span>
</code></pre>
</div>
<ul><li><p>Любое использование <code>ActiveSupport::Dependencies.mechanism</code>, чтение или запись, должно быть заменено доступом к <code>config.cache_classes</code>, соответственно.</p></li><li><p>Если хотите отследить активность автоматического загрузчика, <code>ActiveSupport::Dependencies.verbose=</code> больше не доступен, просто передайте в <code>Rails.autoloaders.log!</code> в <code>config/application.rb</code>.</p></li></ul><p>Вспомогательные внутренние классы или модули тоже исчезли, такие как <code>ActiveSupport::Dependencies::Reference</code>, <code>ActiveSupport::Dependencies::Blamable</code> и прочие.</p><h4 id='avtomaticheskaya-zagruzka-vo-vremya-initsializatsii' class='inside_page_header'><a href="#avtomaticheskaya-zagruzka-vo-vremya-initsializatsii">4.7.</a> Автоматическая загрузка во время инициализации</h4><p>Приложения, которые автоматически загружают перезагружаемые константы во время инициализации вне блоков <code>to_prepare</code>, получали эти константы выгруженными, и получали это предупреждение, начиная с Rails 6.0:</p><div class="code_container">
  <pre><code class="highlight plaintext">DEPRECATION WARNING: Initialization autoloaded the constant ....

Being able to do this is deprecated. Autoloading during initialization is going
to be an error condition in future versions of Rails.

...
</code></pre>
</div>
<p>Если вы все еще получаете это предупреждение в логах, обратитесь к разделу об автоматической загрузки при запуске приложения в <a href="/autoloading-and-reloading-constants#autoloading-when-the-application-boots">руководстве по автозагрузке</a>. В противном случае вы получите <code>NameError</code> в Rails 7.</p><p>Константы, управляемые автозагрузчиком <code>once</code> могут быть автоматически загружены в течение инициализации, и их можно использовать нормально, блок <code>to_prepare</code> не нужен. Однако, для поддержки этого автозагрузчик <code>once</code> теперь настраивается раньше. Если в приложении имеются пользовательское словообразование, и автозагрузчик <code>once</code> должен быть в курсе о нем, необходимо перенести код из <code>config/initializers/inflections.rb</code> в тело определения класса приложения в <code>config/application.rb</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="c1"># ...</span>

    <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Inflector</span><span class="p">.</span><span class="nf">inflections</span><span class="p">(</span><span class="ss">:en</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">inflect</span><span class="o">|</span>
      <span class="n">inflect</span><span class="p">.</span><span class="nf">acronym</span> <span class="s2">"HTML"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='vozmozhnost-nastroit-config-autoload_once_paths' class='inside_page_header'><a href="#vozmozhnost-nastroit-config-autoload_once_paths">4.8.</a> Возможность настроить <code>config.autoload_once_paths</code></h4><p>Можно установить <a href="/configuring#config-autoload-once-paths"><code>config.autoload_once_paths</code></a> в классе приложения, определенном в <code>config/application.rb</code>, или в конфигурациях для сред в <code>config/environments/*</code>.</p><p>Схожим образом в engine можно настроить эту коллекцию в классе engine или в конфигурациях для сред.</p><p>После этого коллекция замораживается, и вы можете автоматически загружать из этих путей. В частности, оттуда можно загружать во время инициализации. Они управляются автоматическим загрузчиком <code>Rails.autoloaders.once</code>, который не перезагружает, а только автоматически/нетерпеливо загружает.</p><p>Если вы установили эту настройку после того, как конфигурации для сред были обработаны, и получили <code>FrozenError</code>, просто переместите этот код.</p><h4 id='actiondispatch-request-content_type-teper-vozvraschaet-zagolovok-content-type-kak-est' class='inside_page_header'><a href="#actiondispatch-request-content_type-teper-vozvraschaet-zagolovok-content-type-kak-est">4.9.</a> <code>ActionDispatch::Request#content_type</code> теперь возвращает заголовок Content-Type как есть.</h4><p>Раньше возвращаемое значение <code>ActionDispatch::Request#content_type</code> НЕ содержало часть charset. Это поведение изменилось, и возвращаемый заголовок Content-Type содержит часть charset как его часть.</p><p>Если вам нужен только тип MIME, используйте вместо этого <code>ActionDispatch::Request#media_type</code>.</p><p>До:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">request</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"CONTENT_TYPE"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">,</span> <span class="s2">"REQUEST_METHOD"</span> <span class="o">=&gt;</span> <span class="s2">"GET"</span><span class="p">)</span>
<span class="n">request</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv"</span>
</code></pre>
</div>
<p>После:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">request</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">,</span> <span class="s2">"REQUEST_METHOD"</span> <span class="o">=&gt;</span> <span class="s2">"GET"</span><span class="p">)</span>
<span class="n">request</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv; header=present; charset=utf-16"</span>
<span class="n">request</span><span class="p">.</span><span class="nf">media_type</span>   <span class="c1">#=&gt; "text/csv"</span>
</code></pre>
</div>
<h4 id='izmenenie-klassa-daydzhesta-dlya-generatsii-klyuchey-trebuet-rotator-kuki' class='inside_page_header'><a href="#izmenenie-klassa-daydzhesta-dlya-generatsii-klyuchey-trebuet-rotator-kuki">4.10.</a> Изменение класса дайджеста для генерации ключей требует ротатор куки</h4><p>Класс дайджеста по умолчанию для генерации ключей изменили с SHA1 на SHA256. Последствия этого в любых зашифрованных сообщениях, генерируемых Rails, включая зашифрованные куки.</p><p>Для возможности читать сообщения с помощью старого класса дайджеста необходимо зарегистрировать ротатор. Если этого не получится сделать, это приведет к тому, что сессии пользователей станут недействительными в течение обновления.</p><p>Вот пример ротатора для зашифрованных и подписанных куки.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/initializers/cookie_rotator.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">after_initialize</span> <span class="k">do</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">cookies_rotations</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">cookies</span><span class="o">|</span>
    <span class="n">authenticated_encrypted_cookie_salt</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">authenticated_encrypted_cookie_salt</span>
    <span class="n">signed_cookie_salt</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">signed_cookie_salt</span>

    <span class="n">secret_key_base</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secret_key_base</span>

    <span class="n">key_generator</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">KeyGenerator</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
      <span class="n">secret_key_base</span><span class="p">,</span> <span class="ss">iterations: </span><span class="mi">1000</span><span class="p">,</span> <span class="ss">hash_digest_class: </span><span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span>
    <span class="p">)</span>
    <span class="n">key_len</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">MessageEncryptor</span><span class="p">.</span><span class="nf">key_len</span>

    <span class="n">old_encrypted_secret</span> <span class="o">=</span> <span class="n">key_generator</span><span class="p">.</span><span class="nf">generate_key</span><span class="p">(</span><span class="n">authenticated_encrypted_cookie_salt</span><span class="p">,</span> <span class="n">key_len</span><span class="p">)</span>
    <span class="n">old_signed_secret</span> <span class="o">=</span> <span class="n">key_generator</span><span class="p">.</span><span class="nf">generate_key</span><span class="p">(</span><span class="n">signed_cookie_salt</span><span class="p">)</span>

    <span class="n">cookies</span><span class="p">.</span><span class="nf">rotate</span> <span class="ss">:encrypted</span><span class="p">,</span> <span class="n">old_encrypted_secret</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">rotate</span> <span class="ss">:signed</span><span class="p">,</span> <span class="n">old_signed_secret</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='klass-daydzhesta-dlya-activesupport-digest-izmenili-na-sha256' class='inside_page_header'><a href="#klass-daydzhesta-dlya-activesupport-digest-izmenili-na-sha256">4.11.</a> Класс дайджеста для ActiveSupport::Digest изменили на SHA256</h4><p>Класс дайджеста по умолчанию для ActiveSupport::Digest изменили с SHA1 на SHA256. Последствия этого в том, что такие вещи как Etag или ключи хэша, изменяться. Изменение этих ключей влияет на обращение к хэшу, будьте осторожны и следите за этим при обновлении на новый хэш.</p><h4 id='novyy-format-serializatsii-activesupport-cache' class='inside_page_header'><a href="#novyy-format-serializatsii-activesupport-cache">4.12.</a> Новый формат сериализации ActiveSupport::Cache</h4><p>Был представлен более быстрый и компактный формат сериализации.</p><p>Чтобы его включить, вы должны установить <code>config.active_support.cache_format_version = 7.0</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.1</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">cache_format_version</span> <span class="o">=</span> <span class="mf">7.0</span>
</code></pre>
</div>
<p>Или просто:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">7.0</span>
</code></pre>
</div>
<p>Однако, приложения Rails 6.1 не способны прочитать этот новый формат сериализации, поэтому, чтобы обеспечить бесшовный апгрейд, нужно сперва задеплоить ваш обновленный Rails 7.0 с <code>config.active_support.cache_format_version = 6.1</code>, и только после того, как все процессы Rails были обновлены, можно установить <code>config.active_support.cache_format_version = 7.0</code>.</p><p>Rails 7.0 может прочитать оба формата, поэтому не нужно инвалидировать кэш во время апгрейда.</p><h4 id='generatsiya-izobrazheniya-predvaritelnogo-prosmotra-video-v-active-storage' class='inside_page_header'><a href="#generatsiya-izobrazheniya-predvaritelnogo-prosmotra-video-v-active-storage">4.13.</a> Генерация изображения предварительного просмотра видео в Active Storage</h4><p>Генерация изображения предварительного просмотра видео теперь использует обнаружение смены сцен FFmpeg для генерации более значимых предварительны изображений. До этого использовался первый кадр видео, и это вызывало проблемы, если видео постепенно появлялось из черного экрана. Это изменение требует FFmpeg v3.4+.</p><h4 id='obrabotchik-varianta-po-umolchaniyu-active-storage-izmenilsya-na-vips' class='inside_page_header'><a href="#obrabotchik-varianta-po-umolchaniyu-active-storage-izmenilsya-na-vips">4.14.</a> Обработчик варианта по умолчанию Active Storage изменился на <code>:vips</code></h4><p>Для новых приложений трансформация изображения будет использовать libvips вместо ImageMagick. Это уменьшит время генерации вариантов, а также потребление CPU и памяти, улучшит время отклика в приложениях, полагающихся на Active Storage для раздачи своих изображений.</p><p>Опция <code>:mini_magick</code> не стала устаревшей, это нормально продолжать ее использование.</p><p>Чтобы мигрировать существующее приложение на libvips, установите:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">active_storage</span><span class="p">.</span><span class="nf">variant_processor</span> <span class="o">=</span> <span class="ss">:vips</span>
</code></pre>
</div>
<p>Затем вам нужно изменить существующий код преобразования на макрос <code>image_processing</code> и заменить опции ImageMagick на опции libvips.</p><h5 id='zamenite-resize-na-resize_to_limit' class='inside_page_header'><a href="#zamenite-resize-na-resize_to_limit">4.14.1.</a> Замените resize на resize_to_limit</h5><div class="code_container">
  <pre><code class="highlight diff"><span class="gd">- variant(resize: "100x")
</span><span class="gi">+ variant(resize_to_limit: [100, nil])
</span></code></pre>
</div>
<p>Если вы не сделаете это, при переключении на vips увидите эту ошибку: <code>no implicit conversion to float from string</code>.</p><h5 id='ispolzuyte-massiv-pri-obrezke' class='inside_page_header'><a href="#ispolzuyte-massiv-pri-obrezke">4.14.2.</a> Используйте массив при обрезке</h5><div class="code_container">
  <pre><code class="highlight diff"><span class="gd">- variant(crop: "1920x1080+0+0")
</span><span class="gi">+ variant(crop: [0, 0, 1920, 1080])
</span></code></pre>
</div>
<p>Если вы не сделаете это, при переключении на vips увидите эту ошибку: <code>unable to call crop: you supplied 2 arguments, but operation needs 5</code>.</p><h5 id='peresmotrite-znacheniya-obrezki' class='inside_page_header'><a href="#peresmotrite-znacheniya-obrezki">4.14.3.</a> Пересмотрите значения обрезки:</h5><p>Vips более строгий, чем ImageMagick, в отношение обрезки:</p><ul><li>Он не обрежет, если <code>x</code> и/или <code>y</code> имеют отрицательные значения. Например: <code>[-10, -10, 100, 100]</code>
</li><li>Он не обрежет, если (<code>x</code> или <code>y</code>) плюс размерность (<code>width</code>, <code>height</code>) больше, чем изображение. Например: изображение 125x125 и обрезка <code>[50, 50, 100, 100]</code>
</li></ul><p>Если вы не сделаете это, при переходе на vips увидите эту ошибку: <code>extract_area: bad extract area</code></p><h5 id='ispravte-fonovyy-tsvet-ispolzuemyy-dlya-resize_and_pad' class='inside_page_header'><a href="#ispravte-fonovyy-tsvet-ispolzuemyy-dlya-resize_and_pad">4.14.4.</a> Исправьте фоновый цвет, используемый для <code>resize_and_pad</code></h5><p>Vips использует черный в качестве фонового цвета <code>resize_and_pad</code> по умолчанию, вместо белого в ImageMagick. Исправьте это с помощью опции <code>background</code>:</p><div class="code_container">
  <pre><code class="highlight diff"><span class="gd">- variant(resize_and_pad: [300, 300])
</span><span class="gi">+ variant(resize_and_pad: [300, 300, background: [255]])
</span></code></pre>
</div>
<h5 id='uberite-lyubye-rotatsii-osnovannye-na-exif' class='inside_page_header'><a href="#uberite-lyubye-rotatsii-osnovannye-na-exif">4.14.5.</a> Уберите любые ротации, основанные на EXIF</h5><p>Vips будет осуществлять автоматическую ротацию с помощью значения EXIF при обработке вариантов. Если вы хранили значения ротации от загруженных пользователем изображений, чтобы применить ротацию в ImageMagick, это нужно перестать делать:</p><div class="code_container">
  <pre><code class="highlight diff"><span class="gd">- variant(format: :jpg, rotate: rotation_value)
</span><span class="gi">+ variant(format: :jpg)
</span></code></pre>
</div>
<h5 id='zamenite-monochrome-na-colourspace' class='inside_page_header'><a href="#zamenite-monochrome-na-colourspace">4.14.6.</a> Замените monochrome на colourspace</h5><p>Vips другую опцию для создания монохромных изображений:</p><div class="code_container">
  <pre><code class="highlight diff"><span class="gd">- variant(monochrome: true)
</span><span class="gi">+ variant(colourspace: "b-w")
</span></code></pre>
</div>
<h5 id='pereklyuchites-na-optsii-libvips-pri-szhatii-izobrazheniy' class='inside_page_header'><a href="#pereklyuchites-na-optsii-libvips-pri-szhatii-izobrazheniy">4.14.7.</a> Переключитесь на опции libvips при сжатии изображений</h5><p>JPEG</p><div class="code_container">
  <pre><code class="highlight diff"><span class="gd">- variant(strip: true, quality: 80, interlace: "JPEG", sampling_factor: "4:2:0", colorspace: "sRGB")
</span><span class="gi">+ variant(saver: { strip: true, quality: 80, interlace: true })
</span></code></pre>
</div>
<p>PNG</p><div class="code_container">
  <pre><code class="highlight diff"><span class="gd">- variant(strip: true, quality: 75)
</span><span class="gi">+ variant(saver: { strip: true, compression: 9 })
</span></code></pre>
</div>
<p>WEBP</p><div class="code_container">
  <pre><code class="highlight diff"><span class="gd">- variant(strip: true, quality: 75, define: { webp: { lossless: false, alpha_quality: 85, thread_level: 1 } })
</span><span class="gi">+ variant(saver: { strip: true, quality: 75, lossless: false, alpha_q: 85, reduction_effort: 6, smart_subsample: true })
</span></code></pre>
</div>
<p>GIF</p><div class="code_container">
  <pre><code class="highlight diff"><span class="gd">- variant(layers: "Optimize")
</span><span class="gi">+ variant(saver: { optimize_gif_frames: true, optimize_gif_transparency: true })
</span></code></pre>
</div>
<h5 id='deploy-na-production' class='inside_page_header'><a href="#deploy-na-production">4.14.8.</a> Деплой на production</h5><p>Active Storage кодирует в url изображения список трансформаций, которые нужно выполнить. Если ваше приложение кэширует эти url, ваши изображения сломаются после деплоя нового кода на production. Поэтому вам нужно вручную инвалидировать затронутые ключи кэширования.</p><p>Например, Если у вас есть что-то наподобие этого во вью:</p><div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="vi">@products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="n">cache</span> <span class="n">product</span> <span class="k">do</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">product</span><span class="p">.</span><span class="nf">cover_photo</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"200x"</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
</div>
<p>Можно инвалидировать кэш, либо обновив product, или изменив ключ кэширования:</p><div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="vi">@products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="n">cache</span> <span class="p">[</span><span class="s2">"v2"</span><span class="p">,</span> <span class="n">product</span><span class="p">]</span> <span class="k">do</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">product</span><span class="p">.</span><span class="nf">cover_photo</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="kp">nil</span><span class="p">])</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
</div>
<h4 id='versiya-rails-teper-vklyuchaetsya-v-damp-shemy-active-record' class='inside_page_header'><a href="#versiya-rails-teper-vklyuchaetsya-v-damp-shemy-active-record">4.15.</a> Версия Rails теперь включается в дамп схемы Active Record</h4><p>Rails 7.0 изменяет некоторые значения по умолчанию для некоторых типов столбца. Чтобы избежать, чтобы приложение, обновляемое с 6.1 на 7.0, загружало текущую схему, используя новые умолчания для 7.0, теперь Rails включает версию фреймворка в дампе схемы.</p><p>До первой загрузки схемы в Rails 7.0, убедитесь, что при запуске <code>rails app:update</code> версия схемы включена в дамп схемы.</p><p>Файл схемы будет выглядеть так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># This file is auto-generated from the current state of the database. Instead</span>
<span class="c1"># of editing this file, please use the migrations feature of Active Record to</span>
<span class="c1"># incrementally modify your database, and then regenerate this schema definition.</span>
<span class="c1">#</span>
<span class="c1"># This file is the source Rails uses to define your schema when running `bin/rails</span>
<span class="c1"># db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to</span>
<span class="c1"># be faster and is potentially less error prone than running all of your</span>
<span class="c1"># migrations from scratch. Old migrations may fail to apply correctly if those</span>
<span class="c1"># migrations use external dependencies or application code.</span>
<span class="c1">#</span>
<span class="c1"># It's strongly recommended that you check this file into your version control system.</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Schema</span><span class="p">[</span><span class="mf">6.1</span><span class="p">].</span><span class="nf">define</span><span class="p">(</span><span class="ss">version: </span><span class="mi">2022_01_28_123512</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="note"><p>При первом дампе схемы с Rails 7.0, вы увидите множество изменений в этот файл, включая некоторую информацию о столбцах. Убедитесь, что вы просмотрели содержимое файла новой схемы, и отправили его в свой репозиторий.</p></div><h3 id='upgrading-from-rails-6-0-to-rails-6-1' class='inside_page_header'><a href="#upgrading-from-rails-6-0-to-rails-6-1">5.</a> Апгрейд с Rails 6.0 на Rails 6.1</h3><p>Подробнее о внесенных изменениях в Rails 6.1 смотрите в <a href="/6_1_release_notes">заметках о релизе</a>.</p><h4 id='vozvraschaemoe-znachenie-rails-application-config_for-bolshe-ne-podderzhivaet-dostup-s-pomoschyu-strokovyh-klyuchey' class='inside_page_header'><a href="#vozvraschaemoe-znachenie-rails-application-config_for-bolshe-ne-podderzhivaet-dostup-s-pomoschyu-strokovyh-klyuchey">5.1.</a> Возвращаемое значение <code>Rails.application.config_for</code> больше не поддерживает доступ с помощью строковых ключей.</h4><p>Допустим, у нас есть такой конфигурационный файл:</p><div class="code_container">
  <pre><code class="highlight yaml"><span class="c1"># config/example.yml</span>
<span class="na">development</span><span class="pi">:</span>
  <span class="na">options</span><span class="pi">:</span>
    <span class="na">key</span><span class="pi">:</span> <span class="s">value</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config_for</span><span class="p">(</span><span class="ss">:example</span><span class="p">).</span><span class="nf">options</span>
</code></pre>
</div>
<p>Раньше это возвращало хэш, значения которого можно было получить с помощью строковых ключей. Это устарело в 6.0, а теперь вообще не работает.</p><p>Можно вызвать <code>with_indifferent_access</code> на возвращаемом значении <code>config_for</code>, если все еще хотите получать значения по строковым ключам, например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config_for</span><span class="p">(</span><span class="ss">:example</span><span class="p">).</span><span class="nf">with_indifferent_access</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">'options'</span><span class="p">,</span> <span class="s1">'key'</span><span class="p">)</span>
</code></pre>
</div>
<h4 id='content-type-otklika-pri-ispolzovanii-respond_to-any' class='inside_page_header'><a href="#content-type-otklika-pri-ispolzovanii-respond_to-any">5.2.</a> Content-Type отклика при использовании <code>respond_to#any</code></h4><p>Заголовок Content-Type, возвращаемый в отклике, может отличаться от возвращаемого в Rails 6.0, особенно если приложение использует <code>respond_to { |format| format.any }</code>.
Теперь Content-Type будет основан на предоставленном блоке, а не формате запроса.</p><p>Example:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">my_action</span>
  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
    <span class="nb">format</span><span class="p">.</span><span class="nf">any</span> <span class="p">{</span> <span class="n">render</span><span class="p">(</span><span class="ss">json: </span><span class="p">{</span> <span class="ss">foo: </span><span class="s1">'bar'</span> <span class="p">})</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="n">get</span><span class="p">(</span><span class="s1">'my_action.csv'</span><span class="p">)</span>
</code></pre>
</div>
<p>Прежним поведением был возврат <code>text/csv</code> в Content-Type отклика, что является неверным, так как рендерили отклик JSON. Текущее поведение правильно возвращает <code>application/json</code> в Content-Type отклика.</p><p>Если ваше приложение полагалось на прежнее некорректное поведение, следует указать, какие форматы принимает ваш экшн, т.е.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="nb">format</span><span class="p">.</span><span class="nf">any</span><span class="p">(</span><span class="ss">:xml</span><span class="p">,</span> <span class="ss">:json</span><span class="p">)</span> <span class="p">{</span> <span class="n">render</span> <span class="n">request</span><span class="p">.</span><span class="nf">format</span><span class="p">.</span><span class="nf">to_sym</span> <span class="o">=&gt;</span> <span class="vi">@people</span> <span class="p">}</span>
</code></pre>
</div>
<h4 id='activesupport-callbacks-halted_callback_hook-teper-prinimaet-vtoroy-argument' class='inside_page_header'><a href="#activesupport-callbacks-halted_callback_hook-teper-prinimaet-vtoroy-argument">5.3.</a> <code>ActiveSupport::Callbacks#halted_callback_hook</code> теперь принимает второй аргумент</h4><p>Active Support позволяет переопределить <code>halted_callback_hook</code> для вызова всякий раз, когда колбэк прерывает цепочку. Теперь этот метод принимает второй аргумент, являющийся именем прерываемого колбэка. Если у вас есть классы, переопределяющие этот метод, убедитесь, что он принимает два аргумента. Отметьте, что это значимое изменение без предшествующего цикла устаревания (по причинам быстродействия).</p><p>Пример:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before_create</span> <span class="p">{</span> <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="p">}</span>

  <span class="k">def</span> <span class="nf">halted_callback_hook</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">callback_name</span><span class="p">)</span> <span class="c1"># =&gt; Теперь этот метод принимает 2 аргумента вместо 1</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Book couldn't be </span><span class="si">#{</span><span class="n">callback_name</span><span class="si">}</span><span class="s2">d"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='metod-klassa-helper-v-kontrollerah-ispolzuet-string-constantize' class='inside_page_header'><a href="#metod-klassa-helper-v-kontrollerah-ispolzuet-string-constantize">5.4.</a> Метод класса <code>helper</code> в контроллерах использует <code>String#constantize</code></h4><p>Концептуально, до Rails 6.1</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">helper</span> <span class="s2">"foo/bar"</span>
</code></pre>
</div>
<p>приводил к</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">require_dependency</span> <span class="s2">"foo/bar_helper"</span>
<span class="n">module_name</span> <span class="o">=</span> <span class="s2">"foo/bar_helper"</span><span class="p">.</span><span class="nf">camelize</span>
<span class="n">module_name</span><span class="p">.</span><span class="nf">constantize</span>
</code></pre>
</div>
<p>Вместо этого, теперь он делает это:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">prefix</span> <span class="o">=</span> <span class="s2">"foo/bar"</span><span class="p">.</span><span class="nf">camelize</span>
<span class="s2">"</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">Helper"</span><span class="p">.</span><span class="nf">constantize</span>
</code></pre>
</div>
<p>Это изменение обратно совместимо с большинством приложений, в этом случае ничего делать не нужно.</p><p>Технически, однако, контроллеры могут настроить <code>helpers_path</code> на директорию в <code>$LOAD_PATH</code>, которая не в путях автозагрузки. Такой случай не поддерживается из коробки. Если модуль хелпера не загружается автоматически, приложение ответственно за его загрузку до вызова <code>helper</code>.</p><h4 id='perenapravlenie-k-https-ot-http-teper-budet-ispolzovat-308' class='inside_page_header'><a href="#perenapravlenie-k-https-ot-http-teper-budet-ispolzovat-308">5.5.</a> Перенаправление к HTTPS от HTTP теперь будет использовать  308</h4><p>Код статуса HTTP по умолчанию, используемый в <code>ActionDispatch::SSL</code> при перенаправлении не-GET/HEAD запросов от HTTP к HTTPS был изменен на <code>308</code>, как определено в <a href="https://tools.ietf.org/html/rfc7538">https://tools.ietf.org/html/rfc7538</a>.</p><h4 id='active-storage-teper-trebuet-image-processing' class='inside_page_header'><a href="#active-storage-teper-trebuet-image-processing">5.6.</a> Active Storage теперь требует Image Processing</h4><p>При обработке вариантов в Active Storage, теперь нужно иметь <a href="https://github.com/janko/image_processing">гем image_processing</a> вместо непосредственного использования <code>mini_magick</code>. Image Processing настроен использовать <code>mini_magick</code> по умолчанию, поэтому проще всего для апгрейда будет заменить гем <code>mini_magick</code> на гем <code>image_processing</code>, и убедиться, что убрали явное использование <code>combine_options</code>, так как это больше не нужно.</p><p>Для читаемости можно изменить необработанные вызовы <code>resize</code> на макросы <code>image_processing</code>. Например, вместо:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"100x100"</span><span class="p">)</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"100x100&gt;"</span><span class="p">)</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"100x100^"</span><span class="p">)</span>
</code></pre>
</div>
<p>можно, соответственно, сделать:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_fit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_fill: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
</code></pre>
</div>
<h4 id='klass-activemodel-error' class='inside_page_header'><a href="#klass-activemodel-error">5.7.</a> Класс <code>ActiveModel::Error</code></h4><p>Ошибки теперь экземпляры класса <code>ActiveModel::Error</code>, с измененным API. Некоторые из этих изменений могут вызывать ошибки, в зависимости от того, как вы взаимодействуете с ошибками, в то время как другие будут печатать предупреждения об устаревании, которые нужно починить для Rails 7.0.</p><p>Подробности об этом изменении и об изменениях в API можно найти <a href="https://github.com/rails/rails/pull/32313">в этом PR</a>.</p><h3 id='upgrading-from-rails-5-2-to-rails-6-0' class='inside_page_header'><a href="#upgrading-from-rails-5-2-to-rails-6-0">6.</a> Апгрейд с Rails 5.2 на Rails 6.0</h3><p>Подробнее о внесенных изменениях в Rails 6.0 смотрите в <a href="/6_0_release_notes">заметках о релизе</a>.</p><h4 id='ispolzovanie-webpacker' class='inside_page_header'><a href="#ispolzovanie-webpacker">6.1.</a> Использование Webpacker</h4><p><a href="https://github.com/rails/webpacker">Webpacker</a> это компилятор JavaScript по умолчанию для Rails 6. Но если вы обновляете приложение, он не активирован по умолчанию. Если хотите использовать Webpacker, включите его в Gemfile и установите:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">gem</span> <span class="s2">"webpacker"</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>webpacker:install
</code></pre>
</div>
<h4 id='navyazyvanie-ssl' class='inside_page_header'><a href="#navyazyvanie-ssl">6.2.</a> Навязывание SSL</h4><p>Метод <code>force_ssl</code> для контроллеров устарел и будет убран в Rails 6.1. Рекомендуется включить <a href="/configuring#config-force-ssl"><code>config.force_ssl</code></a> для обеспечения подключения HTTPS во всем приложении. Если необходимо освободить определенные конечные точки от перенаправления, можно использовать <a href="/configuring#config-ssl-options"><code>config.ssl_options</code></a> для конфигурирования этого поведения.</p><h4 id='dlya-uvelicheniya-bezopasnosti-metadannye-o-naznachenii-i-istechenii-teper-vstroeny-v-podpisannye-i-zashifrovannye-kuki' class='inside_page_header'><a href="#dlya-uvelicheniya-bezopasnosti-metadannye-o-naznachenii-i-istechenii-teper-vstroeny-v-podpisannye-i-zashifrovannye-kuki">6.3.</a> Для увеличения безопасности, метаданные о назначении и истечении теперь встроены в подписанные и зашифрованные куки</h4><p>Чтобы улучшить безопасность, Rails встраивает метаданные о назначении и истечении внутри зашифрованного или подписанного значения куки.</p><p>Затем Rails может помешать исполнению атак, пытающихся скопировать подписанное/зашифрованное значение куки и использовать его как значение другого куки.</p><p>Эти новые встроенные метаданные делает куки несовместимыми с версиями Rails старше чем 6.0.</p><p>Если необходимо, чтобы куки читались Rails 5.2 и старше, или вы все еще проверяете деплой 6.0 и хотите возможность отката, установите <code>Rails.application.config.action_dispatch.use_cookies_with_metadata</code> в <code>false</code>.</p><h4 id='vse-pakety-npm-byli-peremescheny-v-prostranstvo-imen-rails' class='inside_page_header'><a href="#vse-pakety-npm-byli-peremescheny-v-prostranstvo-imen-rails">6.4.</a> Все пакеты npm были перемещены в пространство имен <code>@rails</code></h4><p>Если вы раньше загружали любые из пакетов <code>actioncable</code>, <code>activestorage</code> или <code>rails-ujs</code> с помощью npm/yarn, вам нужно обновить имена этих зависимостей до их обновления до <code>6.0.0</code>:</p><div class="code_container">
  <pre><code class="highlight plaintext">actioncable   → @rails/actioncable
activestorage → @rails/activestorage
rails-ujs     → @rails/ujs
</code></pre>
</div>
<h4 id='izmeneniya-action-cable-javascript-api' class='inside_page_header'><a href="#izmeneniya-action-cable-javascript-api">6.5.</a> Изменения Action Cable JavaScript API</h4><p>Пакет Action Cable JavaScript был конвертирован из CoffeeScript в ES2015, и исходный код теперь опубликован в дистрибуции npm.</p><p>Этот релиз включает некоторые переломные изменения опциональных частей Action Cable JavaScript API:</p><ul><li><p>Настройки адаптера WebSocket и адаптера логгера были перемещены из свойств <code>ActionCable</code> в свойства <code>ActionCable.adapters</code>. Если вы настраивали эти адаптеры, необходимы следующие изменения:</p><div class="code_container">
  <pre><code class="highlight diff"><span class="gd">-    ActionCable.WebSocket = MyWebSocket
</span><span class="gi">+    ActionCable.adapters.WebSocket = MyWebSocket
</span></code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight diff"><span class="gd">-    ActionCable.logger = myLogger
</span><span class="gi">+    ActionCable.adapters.logger = myLogger
</span></code></pre>
</div>
</li><li><p>Методы <code>ActionCable.startDebugging()</code> и <code>ActionCable.stopDebugging()</code> были убраны и заменены свойством <code>ActionCable.logger.enabled</code>. Если вы использовали эти методы, необходимы следующие изменения:</p><div class="code_container">
  <pre><code class="highlight diff"><span class="gd">-    ActionCable.startDebugging()
</span><span class="gi">+    ActionCable.logger.enabled = true
</span></code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight diff"><span class="gd">-    ActionCable.stopDebugging()
</span><span class="gi">+    ActionCable.logger.enabled = false
</span></code></pre>
</div>
</li></ul><h4 id='actiondispatch-response-content_type-teper-vozvraschaet-zagolovok-content-type-bez-izmeneniy' class='inside_page_header'><a href="#actiondispatch-response-content_type-teper-vozvraschaet-zagolovok-content-type-bez-izmeneniy">6.6.</a> <code>ActionDispatch::Response#content_type</code> теперь возвращает заголовок Content-Type без изменений</h4><p>Ранее, возвращаемое значение <code>ActionDispatch::Response#content_type</code> НЕ содержало часть charset. Это поведение было изменено, чтобы также возвращать ранее опускаемую часть charset.</p><p>Если необходим только тип MIME, используйте вместо этого <code>ActionDispatch::Response#media_type</code>.</p><p>До:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">resp</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv; header=present"</span>
</code></pre>
</div>
<p>После:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">resp</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv; header=present; charset=utf-16"</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">media_type</span>   <span class="c1">#=&gt; "text/csv"</span>
</code></pre>
</div>
<h4 id='novaya-nastroyka-config-hosts' class='inside_page_header'><a href="#novaya-nastroyka-config-hosts">6.7.</a> Новая настройка <code>config.hosts</code></h4><p>В Rails теперь есть новая настройка <code>config.hosts</code> для целей безопасности. По умолчанию эта настройка <code>localhost</code> в development. Если вы используете другие домены в development, вам нужно их разрешить:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/environments/development.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">hosts</span> <span class="o">&lt;&lt;</span> <span class="s1">'dev.myapp.com'</span>
<span class="n">config</span><span class="p">.</span><span class="nf">hosts</span> <span class="o">&lt;&lt;</span> <span class="sr">/[a-z0-9-]+\.myapp\.com/</span> <span class="c1"># Опционально разрешен regexp</span>
</code></pre>
</div>
<p>Для других сред <code>config.hosts</code> пустой по умолчанию, что означает, что Rails не проверяет хост вообще. Опционально можно их добавить, если хотите проверять их в production.</p><h4 id='autoloading' class='inside_page_header'><a href="#autoloading">6.8.</a> Автозагрузка</h4><p>Конфигурация по умолчанию для Rails 6</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.0</span>
</code></pre>
</div>
<p>включает режим автозагрузки <code>zeitwerk</code> на CRuby. В этом режиме автозагрузка, перезагрузка и нетерпеливая загрузка управляются <a href="https://github.com/fxn/zeitwerk">Zeitwerk</a>.</p><p>Если вы используете умолчания из предыдущей версии Rails, можно включить zeitwerk так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">autoloader</span> <span class="o">=</span> <span class="ss">:zeitwerk</span>
</code></pre>
</div>
<h5 id='publichnyy-api' class='inside_page_header'><a href="#publichnyy-api">6.8.1.</a> Публичный API</h5><p>В целом, приложениям не нужно использовать API Zeitwerk напрямую. Rails настраивает его в соответствии с существующими контрактами: <code>config.autoload_paths</code>, <code>config.cache_classes</code> и т.д.</p><p>Хотя приложения должны придерживаться этого интерфейса, фактический объект загрузки Zeitwerk доступен как</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">main</span>
</code></pre>
</div>
<p>Это может быть удобным, к примеру, если необходимо предварительно загрузить наследование с единой таблицей (Single Table Inheritance, STI) или настроить пользовательский инфлектор.</p><h5 id='struktura-proekta' class='inside_page_header'><a href="#struktura-proekta">6.8.2.</a> Структура проекта</h5><p>Если в приложение автозагрузки были обновлены корректно, структура проекта должна быть, в основном, совместимой.</p><p>Однако, режим <code>classic</code> производит имена файлов из имен отсутствующих констант (<code>underscore</code>), в то время как режим <code>zeitwerk</code> производит имена констант из имен файлов (<code>camelize</code>). Эти хелперы не всегда противоположны друг другу, в частности для сокращений. Например, <code>&quot;FOO&quot;.underscore</code> это <code>&quot;foo&quot;</code>, но <code>&quot;foo&quot;.camelize</code> это <code>&quot;Foo&quot;</code>, а не <code>&quot;FOO&quot;</code>.</p><p>Совместимость можно проверить с помощью задачи <code>zeitwerk:check</code>:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>zeitwerk:check
<span class="go">Hold on, I am eager loading the application.
All is good!
</span></code></pre>
</div>
<h5 id='require_dependency' class='inside_page_header'><a href="#require_dependency">6.8.3.</a> require_dependency</h5><p>Все известные случаи применений <code>require_dependency</code> были устранены, следует найти и удалить их во всем проекте.</p><p>Если в вашем приложении есть Single Table Inheritance, посмотрите на <a href="/autoloading-and-reloading-constants#single-table-inheritance">раздел о наследовании с единой таблицей</a> руководства Автозагрузка и перезагрузка констант (режим Zeitwerk).</p><h5 id='ogranichennye-imena-v-opredeleniyah-klassa-i-modulya' class='inside_page_header'><a href="#ogranichennye-imena-v-opredeleniyah-klassa-i-modulya">6.8.4.</a> Ограниченные имена в определениях класса и модуля</h5><p>Теперь можно без проблем использовать пути констант в определениях класса и модуля:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Автозагрузка в теле этого класса теперь соответствует семантике Ruby.</span>
<span class="k">class</span> <span class="nc">Admin::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Особенность, о которой нужно знать, в том, что классический автозагрузчик мог иногда автоматически загружать <code>Foo::Wadus</code> в</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Foo::Bar</span>
  <span class="nc">Wadus</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Это не соответствует семантике Ruby, так как <code>Foo</code> не во вложенности, и это вообще не будет работать в режиме <code>zeitwerk</code>. Если вы найдете такие частные случаи, можете использовать ограниченное имя <code>Foo::Wadus</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Foo::Bar</span>
  <span class="nc">Foo::Wadus</span>
<span class="k">end</span>
</code></pre>
</div>
<p>или добавить <code>Foo</code> во вложенность:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Foo</span>
  <span class="k">class</span> <span class="nc">Bar</span>
    <span class="no">Wadus</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='kontserny' class='inside_page_header'><a href="#kontserny">6.8.5.</a> Концерны</h5><p>Можно автоматически загружать и нетерпеливо загружать их стандартной структуры, наподобие</p><div class="code_container">
  <pre><code class="highlight plaintext">app/models
app/models/concerns
</code></pre>
</div>
<p>В этом случае, <code>app/models/concerns</code> полагается корневой директорией (так как она принадлежит путям автозагрузки), и будет игнорироваться в качестве пространства имен. Поэтому, <code>app/models/concerns/foo.rb</code> должен определять <code>Foo</code>, а не <code>Concerns::Foo</code>.</p><p>Пространство имен <code>Concerns::</code> работало с классическим автозагрузчиком как побочный эффект реализации, но это никогда не было желаемым поведением. Приложение, использующее <code>Concerns::</code>, нуждается в переименовании этих классов и модулей, чтобы их можно было использовать в режиме <code>zeitwerk</code>.</p><h5 id='app-v-putyah-avtomaticheskoy-zagruzki' class='inside_page_header'><a href="#app-v-putyah-avtomaticheskoy-zagruzki">6.8.6.</a> <code>app</code> в путях автоматической загрузки</h5><p>В некоторых проектах когда мы хотели что-то вроде <code>app/api/base.rb</code> для определения <code>API::Base</code>, то добавляли <code>app</code> в пути автозагрузки, для того, чтобы это работало в режиме <code>classic</code>. С тех пор, как Rails автоматически добавляет все поддиректории <code>app</code> в пути автозагрузки, у нас теперь другая ситуация, в которой есть вложенные корневые директории, поэтому такая настройка больше не работает. Похожий принцип мы объяснили выше про <code>concerns</code>.</p><p>Если хотите сохранить эту структуру, необходимо удалить поддиректорию из путей автозагрузки в инициализаторе:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Dependencies</span><span class="p">.</span><span class="nf">autoload_paths</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/app/api"</span><span class="p">)</span>
</code></pre>
</div>
<h5 id='avtomaticheskaya-zagruzka-konstant-i-yavnye-prostranstva-imen' class='inside_page_header'><a href="#avtomaticheskaya-zagruzka-konstant-i-yavnye-prostranstva-imen">6.8.7.</a> Автоматическая загрузка констант и явные пространства имен</h5><p>Если пространство имен определено в файле, как <code>Hotel</code> тут:</p><div class="code_container">
  <pre><code class="highlight plaintext">app/models/hotel.rb         # Defines Hotel.
app/models/hotel/pricing.rb # Defines Hotel::Pricing.
</code></pre>
</div>
<p>константа <code>Hotel</code> должна быть установлена с помощью ключевых слов <code>class</code> или <code>module</code>. Например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Hotel</span>
<span class="k">end</span>
</code></pre>
</div>
<p>это хорошо.</p><p>Альтернативы, наподобие</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">Hotel</span> <span class="o">=</span> <span class="no">Class</span><span class="p">.</span><span class="nf">new</span>
</code></pre>
</div>
<p>или</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">Hotel</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span>
</code></pre>
</div>
<p>не будут работать, дочерние объекты, такие как <code>Hotel::Pricing</code>, не будут найдены.</p><p>Это ограничение применяется только к явным пространствам имен. Классы и модули, не определяющие пространство имен, могут быть определены с помощью этих идиом.</p><h5 id='odin-fayl-odna-konstanta-na-tom-zhe-urovne' class='inside_page_header'><a href="#odin-fayl-odna-konstanta-na-tom-zhe-urovne">6.8.8.</a> Один файл, одна константа (на том же уровне)</h5><p>В режиме <code>classic</code> технически было возможно определить несколько констант на том же уровне, и они все перезагружались. Например, для</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/foo.rb</span>

<span class="k">class</span> <span class="nc">Foo</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Bar</span>
<span class="k">end</span>
</code></pre>
</div>
<p>хотя <code>Bar</code> не мог быть автоматически загружен, автозагрузка <code>Foo</code> также помечала <code>Bar</code> как автоматически загруженный. Это не так в режиме <code>zeitwerk</code>, необходимо переместить <code>Bar</code> в собственный файл <code>bar.rb</code>. Один файл, одна константа.</p><p>Это только применимо к константам на том же уровне, как в вышеописанном примере. Внутренние классы и модули — это нормально. Например, рассмотрим</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/models/foo.rb</span>

<span class="k">class</span> <span class="nc">Foo</span>
  <span class="k">class</span> <span class="nc">InnerClass</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Если приложение перезагрузит <code>Foo</code>, оно также перезагрузит <code>Foo::InnerClass</code>.</p><h5 id='spring-i-sreda-test' class='inside_page_header'><a href="#spring-i-sreda-test">6.8.9.</a> Spring и среда <code>test</code></h5><p>Spring перезагружает код приложения, если что-то меняется. В среде <code>test</code> нужно включить перезагрузку, чтобы это работало:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/environments/test.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">cache_classes</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
</div>
<p>Иначе, вы получите такую ошибку:</p><div class="code_container">
  <pre><code class="highlight plaintext">reloading is disabled because config.cache_classes is true
</code></pre>
</div>
<h5 id='bootsnap' class='inside_page_header'><a href="#bootsnap">6.8.10.</a> Bootsnap</h5><p>Bootsnap должен быть как минимум версии 1.4.2.</p><p>Помимо этого, для Bootsnap необходимо отключить кэш iseq из-за ошибки в интерпретаторе, если запускается Ruby 2.5. Убедитесь, что зависимы от минимум Bootsnap 1.4.4 в таком случае.</p><h5 id='config-add_autoload_paths_to_load_path' class='inside_page_header'><a href="#config-add_autoload_paths_to_load_path">6.8.11.</a> <code>config.add_autoload_paths_to_load_path</code></h5><p>Новый конфигурационный пункт <a href="/configuring#config-add-autoload-paths-to-load-path"><code>config.add_autoload_paths_to_load_path</code></a> по умолчанию <code>true</code> для обратной совместимости, но позволяет уйти от добавления путей автозагрузки в <code>$LOAD_PATH</code>.</p><p>Это имеет смысл в большинстве приложений, так как никогда не следует требовать файл в <code>app/models</code>, к примеру, и Zeitwerk использует только абсолютные имена файлов.</p><p>Уходя от этого, вы оптимизируете поиск <code>$LOAD_PATH</code> (меньше директорий для проверки), и экономите работу Bootsnap и потребление памяти, поскольку ему не нужно строить индекс для этих директорий.</p><h5 id='tredobezopasnost' class='inside_page_header'><a href="#tredobezopasnost">6.8.12.</a> Тредобезопасность</h5><p>В классическом режиме автоматическая загрузка констант не является тредобезопасной, хотя в Rails есть локальные блокировки, например, чтобы сделать веб запросы тредобезопасными, когда включена автоматическая загрузка, так как это принято в среде development.</p><p>Автоматическая загрузка констант является тредобезопасной в режиме <code>zeitwerk</code>. Например, теперь можно автоматически загружать в многотредовых скриптах, запускаемых с помощью команды <code>runner</code>.</p><h5 id='shablony-poiska-v-config-autoload_paths' class='inside_page_header'><a href="#shablony-poiska-v-config-autoload_paths">6.8.13.</a> Шаблоны поиска в config.autoload_paths</h5><p>Остерегайтесь конфигураций, таких как</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">+=</span> <span class="no">Dir</span><span class="p">[</span><span class="s2">"</span><span class="si">#{</span><span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/lib/**/"</span><span class="p">]</span>
</code></pre>
</div>
<p>Каждый элемент <code>config.autoload_paths</code> должен представлять пространство имен верхнего уровня (<code>Object</code>) и они не могут быть последовательно вложенными (с исключением директорий <code>concerns</code>, описанных выше).</p><p>Чтобы это починить, просто уберите подстановки:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="si">#{</span><span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/lib"</span>
</code></pre>
</div>
<h5 id='neterpelivaya-zagruzka-i-avtomaticheskaya-zagruzka-soglasuyutsya' class='inside_page_header'><a href="#neterpelivaya-zagruzka-i-avtomaticheskaya-zagruzka-soglasuyutsya">6.8.14.</a> Нетерпеливая загрузка и автоматическая загрузка согласуются</h5><p>В режиме <code>classic</code>, если <code>app/models/foo.rb</code> определяет <code>Bar</code>, вы не сможете автоматически загрузить этот файл, но нетерпеливая загрузка будет работать, так как она загружает файлы вслепую. Это может быть источником ошибок, если вы сначала тестируете с помощью нетерпеливой загрузки, потом выполнение может сломаться при автоматической загрузке.</p><p>В режиме <code>zeitwerk</code> оба режима загрузки согласуются, они выдадут ошибки в тех же файлах.</p><h5 id='kak-ispolzovat-klassicheskiy-avtozagruzchik-v-rails-6' class='inside_page_header'><a href="#kak-ispolzovat-klassicheskiy-avtozagruzchik-v-rails-6">6.8.15.</a> Как использовать классический автозагрузчик в Rails 6</h5><p>Приложения могут загружать умолчания Rails 6 и все еще использовать классический автозагрузчик, настроив <code>config.autoloader</code> следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.0</span>
<span class="n">config</span><span class="p">.</span><span class="nf">autoloader</span> <span class="o">=</span> <span class="ss">:classic</span>
</code></pre>
</div>
<p>При использовании Classic Autoloader в приложении Rails 6 рекомендовано установить уровень concurrency на 1 в среде development, для веб-серверов и фоновых обработчиков, по причинам тредобезопасности.</p><h4 id='izmenenie-povedeniya-prisvoeniya-active-storage' class='inside_page_header'><a href="#izmenenie-povedeniya-prisvoeniya-active-storage">6.9.</a> Изменение поведения присвоения Active Storage</h4><p>С настройками по умолчанию для Rails 5.2, присвоение к коллекции вложений, объявленное с помощью <code>has_many_attached</code>, добавляет новые файлы:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many_attached</span> <span class="ss">:highlights</span>
<span class="k">end</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"funky.jpg"</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 1</span>

<span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_after_upload!</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"town.jpg"</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">highlights: </span><span class="p">[</span> <span class="n">blob</span> <span class="p">])</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 2</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "funky.jpg"</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">second</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "town.jpg"</span>
</code></pre>
</div>
<p>С настройками по умолчанию для Rails 6.0, присвоение к коллекции вложений заменяет существующие файлы вместо добавления к ним. Это соответствует поведению Active Record при присвоении к связанной коллекции:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"funky.jpg"</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 1</span>

<span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_after_upload!</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"town.jpg"</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">highlights: </span><span class="p">[</span> <span class="n">blob</span> <span class="p">])</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 1</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "town.jpg"</span>
</code></pre>
</div>
<p>Для добавления новых вложений вместо удаления существующих можно использовать <code>#attach</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_after_upload!</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"town.jpg"</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 2</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "funky.jpg"</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">second</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "town.jpg"</span>
</code></pre>
</div>
<p>Существующие приложения могут включить это новое поведение установив <a href="/configuring#config-active-storage-replace-on-assign-to-many"><code>config.active_storage.replace_on_assign_to_many</code></a> в <code>true</code>. Старое поведение будет устаревшим в Rails 7.0 и убрано в Rails 7.1.</p><h4 id='polzovatelskie-prilozheniya-obrabotki-isklyucheniy' class='inside_page_header'><a href="#polzovatelskie-prilozheniya-obrabotki-isklyucheniy">6.10.</a> Пользовательские приложения обработки исключений</h4><p>Неправильные заголовки запроса <code>Accept</code> или <code>Content-Type</code> теперь будут вызывать исключение. Приложение по умолчанию <a href="/configuring#config-exceptions-app"><code>config.exceptions_app</code></a> специфически обрабатывает эту ошибку и компенсирует ее. Пользовательским приложениям обработки исключений также необходимо обрабатывать эту ошибку, иначе такие запросы вызовут то, что Rails будет использовать резервное приложение обработки ошибок, возвращающее <code>500 Internal Server Error</code>.</p><h3 id='upgrading-from-rails-5-1-to-rails-5-2' class='inside_page_header'><a href="#upgrading-from-rails-5-1-to-rails-5-2">7.</a> Апгрейд с Rails 5.1 на Rails 5.2</h3><p>Подробнее о внесенных изменениях в Rails 5.2 смотрите в <a href="/5_2_release_notes">заметках о релизе</a>.</p><h4 id='bootsnap2' class='inside_page_header'><a href="#bootsnap2">7.1.</a> Bootsnap</h4><p>Rails 5.2 добавляет гем bootsnap во <a href="https://github.com/rails/rails/pull/29313">вновь сгенерированный Gemfile приложения</a>.
Команда <code>app:update</code> устанавливает его в <code>boot.rb</code>. Если необходимо использовать его, добавьте в Gemfile:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Reduces boot times through caching; required in config/boot.rb</span>
<span class="n">gem</span> <span class="s2">"bootsnap"</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span>
</code></pre>
</div>
<p>Иначе измените <code>boot.rb</code>, чтобы не использовать bootsnap.</p><h4 id='istechenie-sroka-deystviya-v-podpisannyh-ili-zashifrovannyh-kuki-teper-vstroeno-v-znacheniya-kuki' class='inside_page_header'><a href="#istechenie-sroka-deystviya-v-podpisannyh-ili-zashifrovannyh-kuki-teper-vstroeno-v-znacheniya-kuki">7.2.</a> Истечение срока действия в подписанных или зашифрованных куки теперь встроено в значения куки</h4><p>Чтобы повысить безопасность, Rails теперь встраивает информацию об истечении срока действия также в зашифрованное или подписанное значение куки.</p><p>Эта новая встроенная информация делает эти куки несовместимыми с версиями Rails до 5.2.</p><p>Если необходимо, чтобы куки читались в версии 5.1 и раньше, или если все еще проверяется деплой 5.2 и необходимо оставить возможность сделать откат, установите <code>Rails.application.config.action_dispatch.use_authenticated_cookie_encryption</code> в <code>false</code>.</p><h3 id='upgrading-from-rails-5-0-to-rails-5-1' class='inside_page_header'><a href="#upgrading-from-rails-5-0-to-rails-5-1">8.</a> Апгрейд с Rails 5.0 на Rails 5.1</h3><p>Подробнее о внесенных изменениях в Rails 5.1 смотрите в <a href="/5_1_release_notes">заметках о релизе</a>.</p><h4 id='verhneurovnevyy-hashwithindifferentaccess-v-skorom-vremeni-ustareet' class='inside_page_header'><a href="#verhneurovnevyy-hashwithindifferentaccess-v-skorom-vremeni-ustareet">8.1.</a> Верхнеуровневый <code>HashWithIndifferentAccess</code> в скором времени устареет.</h4><p>Если ваше приложение использует верхнеуровневый класс <code>HashWithIndifferentAccess</code>, то вам следует вместо него постепенно переходить на <code>ActiveSupport::HashWithIndifferentAccess</code>.</p><p>Это всего лишь постепенное устаревание, которое означает, что ваш код не будет прерываться в данный момент и не будет отображаться предостережение об устаревании, но эта константа в будущем будет удалена.</p><p>Кроме того, если имеются довольно старые документы YAML, содержащие выгрузки таких объектов, может понадобиться загрузить и выгрузить их снова, чтобы убедиться, что они ссылаются на нужную константу и что их загрузка не будет прерываться в будущем.</p><h4 id='application-secrets-teper-zagruzhaetsya-so-vsemi-klyuchami-v-kachestve-simvolov' class='inside_page_header'><a href="#application-secrets-teper-zagruzhaetsya-so-vsemi-klyuchami-v-kachestve-simvolov">8.2.</a> <code>application.secrets</code> теперь загружается со всеми ключами в качестве символов</h4><p>Если ваше приложение хранит вложенную конфигурацию в <code>config/secrets.yml</code>, все ключи теперь загружаются как символы, поэтому доступ с использованием строк должен быть изменен.</p><p>С:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">[</span><span class="ss">:smtp_settings</span><span class="p">][</span><span class="s2">"address"</span><span class="p">]</span>
</code></pre>
</div>
<p>На:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">[</span><span class="ss">:smtp_settings</span><span class="p">][</span><span class="ss">:address</span><span class="p">]</span>
</code></pre>
</div>
<h4 id='ubrana-ustarevshaya-podderzhka-text-i-nothing-v-render' class='inside_page_header'><a href="#ubrana-ustarevshaya-podderzhka-text-i-nothing-v-render">8.3.</a> Убрана устаревшая поддержка <code>:text</code> и <code>:nothing</code> в <code>render</code></h4><p>Если ваши контроллеры используют <code>render :text</code>, они перестанут работать. Новый способ рендерить вью с типом MIME <code>text/plain</code> — использовать <code>render :plain</code>.</p><p>Похожим образом, <code>render :nothing</code> также убран, и следует использовать метод <code>head</code> для отправки откликов, содержащих только заголовки. Например, <code>head :ok</code> посылает отклик 200 без тела.</p><h4 id='ubrana-ustarevshaya-podderzhka-redirect_to-back' class='inside_page_header'><a href="#ubrana-ustarevshaya-podderzhka-redirect_to-back">8.4.</a> Убрана устаревшая поддержка <code>redirect_to :back</code></h4><p>В Rails 5.0, <code>redirect_to :back</code> устарел. В Rails 5.1 он был убран полностью.</p><p>В качестве альтернативы используйте <code>redirect_back</code>. Важно отметить, что <code>redirect_back</code> также принимает опцию <code>fallback_location</code>, которая будет использована в случае отсутствия <code>HTTP_REFERER</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">redirect_back</span><span class="p">(</span><span class="ss">fallback_location: </span><span class="n">root_path</span><span class="p">)</span>
</code></pre>
</div>
<h3 id='upgrading-from-rails-4-2-to-rails-5-0' class='inside_page_header'><a href="#upgrading-from-rails-4-2-to-rails-5-0">9.</a> Апгрейд с Rails 4.2 на Rails 5.0</h3><p>Подробнее о внесенных изменениях в Rails 5.0 смотрите в <a href="/5_0_release_notes">заметках о релизе</a>.</p><h4 id='trebuetsya-ruby-2-2-2' class='inside_page_header'><a href="#trebuetsya-ruby-2-2-2">9.1.</a> Требуется Ruby 2.2.2+</h4><p>Начиная с Ruby on Rails 5.0, Ruby 2.2.2+ являются единственными поддерживаемыми версиями Ruby. Перед тем, как продолжить, убедитесь, что вы на Ruby версии 2.2.2 или выше.</p><h4 id='modeli-active-record-teper-po-umolchaniyu-nasleduyutsya-ot-applicationrecord' class='inside_page_header'><a href="#modeli-active-record-teper-po-umolchaniyu-nasleduyutsya-ot-applicationrecord">9.2.</a> Модели Active Record теперь по умолчанию наследуются от ApplicationRecord</h4><p>В Rails 4.2 модель Active Record наследуется от <code>ActiveRecord::Base</code>. В Rails 5.0 все модели наследуются от <code>ApplicationRecord</code>.</p><p><code>ApplicationRecord</code> - это новый суперкласс для всех моделей приложения, аналогично контроллерам, наследуемым от <code>ApplicationController</code> вместо <code>ActionController::Base</code>. Это дает приложению единое место для настройки специфичного для приложения поведения моделей.</p><p>При апгрейде с Rails 4.2 на Rails 5.0 необходимо создать файл <code>application_record.rb</code> в <code>app/models/</code> и добавить следующее содержимое:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Затем убедитесь, что все ваши модели наследуются от него.</p><h4 id='preryvanie-tsepochek-kolbekov-s-pomoschyu-throw-abort' class='inside_page_header'><a href="#preryvanie-tsepochek-kolbekov-s-pomoschyu-throw-abort">9.3.</a> Прерывание цепочек колбэков с помощью <code>throw(:abort)</code></h4><p>В Rails 4.2 в Active Record и Active Model, когда колбэк &#39;before&#39; возвращает <code>false</code>, вся цепочка цепочка колбэков прерывалась. Другими словами, последующие колбэки &#39;before&#39; не выполнялись, как и экшн, обернутый в колбэки.</p><p>В Rails 5.0, возврат <code>false</code> колбэком Active Record или Active Model не будет иметь этого побочного эффекта прерывания цепочки колбэков. Вместо этого, цепочки колбэков должны быть явно прерваны вызовом <code>throw(:abort)</code>.</p><p>При апгрейде с Rails 4.2 на Rails 5.0, возврат <code>false</code> в этих типах колбэков все еще будет прерывать цепочку колбэков, но вы получите предостережение об устаревании об этом грядущем изменении.</p><p>Когда вы будете готовы, можно переключиться на новое поведение и убрать предостережение об устаревании, добавив следующую конфигурацию в <code>config/application.rb</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">halt_callback_chains_on_return_false</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
</div>
<p>Отметим, что эта опция не влияет на колбэки Active Support, так как они никогда не прерывались в зависимости от возвращаемого значения.</p><p>За подробностями обратитесь к <a href="https://github.com/rails/rails/pull/17227">#17227</a>.</p><h4 id='activejob-teper-po-umolchaniyu-nasleduetsya-ot-applicationjob' class='inside_page_header'><a href="#activejob-teper-po-umolchaniyu-nasleduetsya-ot-applicationjob">9.4.</a> ActiveJob теперь по умолчанию наследуется от ApplicationJob</h4><p>В Rails 4.2 Active Job наследуется от <code>ActiveJob::Base</code>. В Rails 5.0 это поведение было изменено на наследование от <code>ApplicationJob</code>.</p><p>При апгрейде с Rails 4.2 на Rails 5.0 необходимо создать файл <code>application_job.rb</code> в <code>app/jobs/</code> со следующим содержимым:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationJob</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Затем убедитесь, что все классы заданий наследуются от него.</p><p>За подробностями обратитесь к <a href="https://github.com/rails/rails/pull/19034">#19034</a>.</p><h4 id='testirovanie-kontrollerov-rails' class='inside_page_header'><a href="#testirovanie-kontrollerov-rails">9.5.</a> Тестирование контроллеров Rails</h4><h5 id='izvlechenie-nekotoryh-metodov-helpera-v-rails-controller-testing' class='inside_page_header'><a href="#izvlechenie-nekotoryh-metodov-helpera-v-rails-controller-testing">9.5.1.</a> Извлечение некоторых методов хелпера в <code>rails-controller-testing</code></h5><p><code>assigns</code> и <code>assert_template</code> были извлечены в гем <code>rails-controller-testing</code>. Чтобы продолжить использование этих методов, добавьте <code>gem &quot;rails-controller-testing&quot;</code> в свой <code>Gemfile</code>.</p><p>Если вы используете RSpec для тестирования, обратитесь к документации гема по требуемой дополнительной конфигурации.</p><h5 id='novoe-povedenie-pri-zagruzke-faylov' class='inside_page_header'><a href="#novoe-povedenie-pri-zagruzke-faylov">9.5.2.</a> Новое поведение при загрузке файлов</h5><p>Если вы используете <code>ActionDispatch::Http::UploadedFile</code> в своих тестах для загрузки файлов, то вам нужно будет использовать вместо него аналогичный класс <code>Rack::Test::UploadedFile</code>.</p><p>За подробностями обратитесь к <a href="https://github.com/rails/rails/issues/26404">#26404</a>.</p><h4 id='avtozagruzka-otklyuchena-posle-zagruzki-v-srede-production' class='inside_page_header'><a href="#avtozagruzka-otklyuchena-posle-zagruzki-v-srede-production">9.6.</a> Автозагрузка отключена после загрузки в среде production</h4><p>Автозагрузка теперь отключена после загрузки в среде production по умолчанию.</p><p>Нетерпеливая загрузка приложения - это часть процесса загрузки, поэтому константы верхнего уровня все еще автоматически загружаются, их файлы не нужно требовать.</p><p>Более глубокие константы выполняются только во время выполнения, как содержимое обычных методов, и это нормально, так как содержащий их файл был нетерпеливо загружен при начальной загрузке.</p><p>Для абсолютного большинства приложений это изменение не требует каких-либо действий. Но, в очень редком случае, когда вашему приложению требуется автозагрузка в production, установите <code>Rails.application.config.enable_dependency_loading</code> в true.</p><h4 id='serializatsiya-v-xml' class='inside_page_header'><a href="#serializatsiya-v-xml">9.7.</a> Сериализация в XML</h4><p><code>ActiveModel::Serializers::Xml</code> был извлечен из Rails в гем <code>activemodel-serializers-xml</code>. Чтобы продолжить сериализацию в XML в вашем приложении, добавьте <code>gem &quot;activemodel-serializers-xml&quot;</code>в свой <code>Gemfile</code>.</p><h4 id='ubrana-podderzhka-staroy-versii-adaptera-mysql' class='inside_page_header'><a href="#ubrana-podderzhka-staroy-versii-adaptera-mysql">9.8.</a> Убрана поддержка старой версии адаптера <code>mysql</code></h4><p>В Rails 5 убрана поддержка старой версии адаптера БД <code>mysql</code>. Большинство пользователей могут использовать вместо него <code>mysql2</code>. Он будет сконвертирован в отдельный гем, если найдется кто-то для его поддержки.</p><h4 id='ubrana-podderzhka-debugger' class='inside_page_header'><a href="#ubrana-podderzhka-debugger">9.9.</a> Убрана поддержка Debugger</h4><p><code>debugger</code> не поддерживается Ruby 2.2, который требуется для Rails 5. Вместо него используйте <code>byebug</code>.</p><h4 id='ispolzovanie-bin-rails-dlya-zapuska-zadach-i-testov' class='inside_page_header'><a href="#ispolzovanie-bin-rails-dlya-zapuska-zadach-i-testov">9.10.</a> Использование <code>bin/rails</code> для запуска задач и тестов</h4><p>Rails 5 добавляет возможность запускать задачи и тесты с помощью <code>bin/rails</code> вместо rake. В основном эти изменения были внесены параллельно с rake, но некоторые были перенесены полностью.</p><p>Чтобы запустить тесты, просто напишите <code>bin/rails test</code>.</p><p><code>rake dev:cache</code> теперь <code>bin/rails dev:cache</code>.</p><p>Запустите <code>bin/rails</code> в директории вашего приложения, чтобы просмотреть список доступных команд.</p><h4 id='actioncontroller-parameters-bolshe-ne-nasleduetsya-ot-hashwithindifferentaccess' class='inside_page_header'><a href="#actioncontroller-parameters-bolshe-ne-nasleduetsya-ot-hashwithindifferentaccess">9.11.</a> <code>ActionController::Parameters</code> больше не наследуется от <code>HashWithIndifferentAccess</code></h4><p>Вызов <code>params</code> в вашем приложении теперь возвращает объект, а не хэш. Если ваши параметры уже дозволены, вам не нужно вносить каких-либо изменений. Если вы используете <code>map</code> и другие методы, зависящие от возможности читать хэш, не смотря на <code>permitted?</code>, нужно апгрейднуть ваше приложение, чтобы сначала сделать permit, а затем конвертировать в хэш.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">([</span><span class="ss">:proceed_to</span><span class="p">,</span> <span class="ss">:return_to</span><span class="p">]).</span><span class="nf">to_h</span>
</code></pre>
</div>
<h4 id='teper-v-protect_from_forgery-po-umolchaniyu-prepend-false' class='inside_page_header'><a href="#teper-v-protect_from_forgery-po-umolchaniyu-prepend-false">9.12.</a> Теперь в <code>protect_from_forgery</code> по умолчанию <code>prepend: false</code></h4><p><code>protect_from_forgery</code> по умолчанию <code>prepend: false</code>, что означает, что он буден вставлен в цепочку колбэков в том месте, в котором он вызывается в вашем приложении. Если вы хотите, чтобы <code>protect_from_forgery</code> всегда запускался первым, следует изменить приложение, чтобы использовался <code>protect_from_forgery prepend: true</code>.</p><h4 id='obrabotchik-shablona-po-umolchaniyu-teper-raw' class='inside_page_header'><a href="#obrabotchik-shablona-po-umolchaniyu-teper-raw">9.13.</a> Обработчик шаблона по умолчанию теперь RAW</h4><p>Файлы без обработчика шаблона в их расширении будут рендериться с помощью обработчика raw. Раньше Rails рендерил бы файлы с помощью обработчика шаблона ERB.</p><p>Если вы не хотите, чтобы ваш файл обрабатывался с помощью обработчика raw, следует добавить расширение к своему файлу, чтобы он анализировался подходящим обработчиком шаблона.</p><h4 id='dobavleno-sovpadenie-s-podstanovkoy-dlya-zavisimostey-shablonov' class='inside_page_header'><a href="#dobavleno-sovpadenie-s-podstanovkoy-dlya-zavisimostey-shablonov">9.14.</a> Добавлено совпадение с подстановкой для зависимостей шаблонов</h4><p>Теперь можно использовать совпадение с подстановкой для зависимостей ваших шаблонов. Например, если вы определяли ваши шаблоны так:</p><div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/subscribers_changed </span><span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/completed </span><span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/uncompleted </span><span class="cp">%&gt;</span>
</code></pre>
</div>
<p>Теперь можно вызвать зависимость единожды с помощью символа подстановки.</p><div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/* </span><span class="cp">%&gt;</span>
</code></pre>
</div>
<h4 id='actionview-helpers-recordtaghelper-peremeschen-v-otdelnyy-gem-record_tag_helper' class='inside_page_header'><a href="#actionview-helpers-recordtaghelper-peremeschen-v-otdelnyy-gem-record_tag_helper">9.15.</a> <code>ActionView::Helpers::RecordTagHelper</code> перемещен в отдельный гем (record_tag_helper)</h4><p><code>content_tag_for</code> и <code>div_for</code> были убраны в пользу использования <code>content_tag</code>. Чтобы продолжить использование старых методов, добавьте гем <code>record_tag_helper</code> в свой <code>Gemfile</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">gem</span> <span class="s2">"record_tag_helper"</span><span class="p">,</span> <span class="s2">"~&gt; 1.0"</span>
</code></pre>
</div>
<p>За подробностями обратитесь к <a href="https://github.com/rails/rails/issues/18411">#18411</a>.</p><h4 id='ubrana-podderzhka-gema-protected_attributes' class='inside_page_header'><a href="#ubrana-podderzhka-gema-protected_attributes">9.16.</a> Убрана поддержка гема <code>protected_attributes</code></h4><p>Гем <code>protected_attributes</code> больше не поддерживается в Rails 5.</p><h4 id='ubrana-podderzhka-gema-activerecord-deprecated_finders' class='inside_page_header'><a href="#ubrana-podderzhka-gema-activerecord-deprecated_finders">9.17.</a> Убрана поддержка гема <code>activerecord-deprecated_finders</code></h4><p>Гем <code>activerecord-deprecated_finders</code> больше не поддерживается в Rails 5.</p><h4 id='poryadok-testov-activesupport-testcase-po-umolchaniyu-seychas-sluchaynyy' class='inside_page_header'><a href="#poryadok-testov-activesupport-testcase-po-umolchaniyu-seychas-sluchaynyy">9.18.</a> Порядок тестов <code>ActiveSupport::TestCase</code> по умолчанию сейчас случайный</h4><p>Когда в вашем приложении запускаются тесты, порядок по умолчанию сейчас <code>:random</code> вместо <code>:sorted</code>. Используйте следующую конфигурационную опцию, чтобы установить <code>:sorted</code> обратно.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/environments/test.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">test_order</span> <span class="o">=</span> <span class="ss">:sorted</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='actioncontroller-live-stal-concern' class='inside_page_header'><a href="#actioncontroller-live-stal-concern">9.19.</a> <code>ActionController::Live</code> стал <code>Concern</code></h4><p>Если вы включали <code>ActionController::Live</code> в другой модуль, который включался в ваш контроллер, то вы также должны расширить модуль с помощью <code>ActiveSupport::Concern</code>. Альтернативно можно использовать хук <code>self.included</code>, чтобы включить <code>ActionController::Live</code> непосредственно в контроллер, как только включится <code>StreamingSupport</code>.</p><p>Это означает, что если в вашем приложении должен быть собственный модуль потоковой передачи, следующий код сломается в production:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Это обертка для потоковых контроллеров, выполняющих аутентификацию с помощью Warden/Devise.</span>
<span class="c1"># Смотрите https://github.com/plataformatec/devise/issues/2332</span>
<span class="c1"># Другим решением является аутентификация в роутере, как предложено в тщй проблеме</span>
<span class="k">class</span> <span class="nc">StreamingSupport</span>
  <span class="kp">include</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Live</span> <span class="c1"># это не будет работать в production для Rails 5</span>
  <span class="c1"># extend ActiveSupport::Concern # пока вы не раскомментируете эту строчку.</span>
  <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="k">super</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="k">rescue</span> <span class="no">ArgumentError</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="nf">message</span> <span class="o">==</span> <span class="s1">'uncaught throw :warden'</span>
      <span class="kp">throw</span> <span class="ss">:warden</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="n">e</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='novye-znacheniya-po-umolchaniyu-freymvorka' class='inside_page_header'><a href="#novye-znacheniya-po-umolchaniyu-freymvorka">9.20.</a> Новые значения по умолчанию фреймворка</h4><h5 id='optsiya-active-record-dlya-belongs_to-trebuetsya-po-umolchaniyu' class='inside_page_header'><a href="#optsiya-active-record-dlya-belongs_to-trebuetsya-po-umolchaniyu">9.20.1.</a> Опция Active Record для <code>belongs_to</code> - требуется по умолчанию</h5><p><code>belongs_to</code> по умолчанию теперь вызывает ошибку валидации, если связь не присутствует.</p><p>Это можно отключить для каждой связи с помощью <code>optional: true</code>.</p><p>Это значение по умолчанию можно автоматически сконфигурировать в новых приложениях. Если существующее приложение хочет добавить эту особенность, ее нужно включить в инициализаторе.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">belongs_to_required_by_default</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
</div>
<p>Эта конфигурация по умолчанию глобальна для всех моделей, но ее можно переопределить в модели. Это может помочь мигрировать все ваши модели на связи, требуемые по умолчанию.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># модель пока не готова к связям, требуемым по умолчанию</span>

  <span class="nb">self</span><span class="p">.</span><span class="nf">belongs_to_required_by_default</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="n">belongs_to</span><span class="p">(</span><span class="ss">:author</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># модель готова к связям, требуемым по умолчанию</span>

  <span class="nb">self</span><span class="p">.</span><span class="nf">belongs_to_required_by_default</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">belongs_to</span><span class="p">(</span><span class="ss">:pilot</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='tokeny-csrf-dlya-formy' class='inside_page_header'><a href="#tokeny-csrf-dlya-formy">9.20.2.</a> Токены CSRF для формы</h5><p>Rails 5 теперь поддерживает токены CSRF для формы, чтобы ослабить атаки с помощью внедрения кода с использованием форм, созданными JavaScript. Со включенной опцией формы вашего приложения будут иметь собственный токен CSRF, который специфичен для экшна и метода этой формы.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_controller</span><span class="p">.</span><span class="nf">per_form_csrf_tokens</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
</div>
<h5 id='zaschita-ot-poddelki-s-pomoschyu-proverki-domena' class='inside_page_header'><a href="#zaschita-ot-poddelki-s-pomoschyu-proverki-domena">9.20.3.</a> Защита от подделки с помощью проверки домена</h5><p>Можно настроить свое приложение для проверки, что заголовок HTTP <code>Origin</code> должен быть сверен с доменом сайта, в качестве дополнительной защиты от CSRF. Установите следующей настройке true:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_controller</span><span class="p">.</span><span class="nf">forgery_protection_origin_check</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
</div>
<h5 id='razreshena-nastroyka-imeni-ocheredi-action-mailer' class='inside_page_header'><a href="#razreshena-nastroyka-imeni-ocheredi-action-mailer">9.20.4.</a> Разрешена настройка имени очереди Action Mailer</h5><p>Имя очереди рассыльщика по умолчанию <code>mailers</code>. Эта конфигурационная опция позволяет глобально изменить имя очереди. Установите следующее в своих настройках:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">deliver_later_queue_name</span> <span class="o">=</span> <span class="ss">:new_queue_name</span>
</code></pre>
</div>
<h5 id='podderzhka-keshirovaniya-fragmentov-vo-vyu-action-mailer' class='inside_page_header'><a href="#podderzhka-keshirovaniya-fragmentov-vo-vyu-action-mailer">9.20.5.</a> Поддержка кэширования фрагментов во вью Action Mailer</h5><p>Установите <a href="/configuring#config-action-mailer-perform-caching"><code>config.action_mailer.perform_caching</code></a> в своих настройках, чтобы определить, должны ли вью Action Mailer поддерживать кэширование.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">perform_caching</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
</div>
<h5 id='nastroyka-vyvoda-db-structure-dump' class='inside_page_header'><a href="#nastroyka-vyvoda-db-structure-dump">9.20.6.</a> Настройка вывода <code>db:structure:dump</code></h5><p>Если используется <code>schema_search_path</code> или другие расширения PostgreSQL, можно контролировать, как выгружается схема. Установите <code>:all</code>, чтобы генерировать все выгрузки, или <code>:schema_search_path</code>, чтобы генерировать из пути поиска схемы.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">dump_schemas</span> <span class="o">=</span> <span class="ss">:all</span>
</code></pre>
</div>
<h5 id='nastroyka-optsiy-ssl-chtoby-vklyuchit-hsts-s-poddomenami' class='inside_page_header'><a href="#nastroyka-optsiy-ssl-chtoby-vklyuchit-hsts-s-poddomenami">9.20.7.</a> Настройка опций SSL, чтобы включить HSTS с поддоменами</h5><p>Установите следующее в своих настройках, чтобы включить HSTS при использовании поддоменов:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">ssl_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">hsts: </span><span class="p">{</span> <span class="ss">subdomains: </span><span class="kp">true</span> <span class="p">}</span> <span class="p">}</span>
</code></pre>
</div>
<h5 id='sohranenie-vremennoy-zony-poluchatelya' class='inside_page_header'><a href="#sohranenie-vremennoy-zony-poluchatelya">9.20.8.</a> Сохранение временной зоны получателя</h5><p>При использовании Ruby 2.4 можно сохранять временную зону получателя, когда вызывается <code>to_time</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">to_time_preserves_timezone</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
</div>
<h4 id='izmeneniya-s-serializatsiey-json-jsonb' class='inside_page_header'><a href="#izmeneniya-s-serializatsiey-json-jsonb">9.21.</a> Изменения с сериализацией JSON/JSONB</h4><p>В Rails 5.0 изменено то, как атрибуты JSON/JSONB сериализованы и десериализованы. Теперь, если задать тип столбца, равный <code>String</code>, Active Record больше не будет превращать эту строку в <code>Hash</code> и будет вместо этого только возвращать строку. Это не ограничивается кодом, взаимодействующим с моделями, а также влияет на настройки столбца <code>:default</code> в <code>db/schema.rb</code>. Рекомендуется не задавать столбцы, равные <code>String</code>, а вместо этого передавать <code>Hash</code>, который будет автоматически преобразован в строку JSON и обратно.</p><h3 id='upgrading-from-rails-4-1-to-rails-4-2' class='inside_page_header'><a href="#upgrading-from-rails-4-1-to-rails-4-2">10.</a> Апгрейд с Rails 4.1 на Rails 4.2</h3><h4 id='web-console' class='inside_page_header'><a href="#web-console">10.1.</a> Web Console</h4><p>Сначала добавьте <code>gem &quot;web-console&quot;, &quot;~&gt; 2.0&quot;</code> в группу <code>:development</code> своего <code>Gemfile</code> и запустите <code>bundle install</code> (он не включится при апгрейде Rails). Как только он будет установлен, можно просто оставлять обращение к хелперу консоли (т.е., <code>&lt;%= console %&gt;</code>) в любой вью, в которой вы ее хотите включить. Консоль также предоставляется на любой странице ошибок в среде development.</p><h4 id='responders' class='inside_page_header'><a href="#responders">10.2.</a> Responders</h4><p>Метод <code>respond_with</code> и метод класса <code>respond_to</code> были извлечены в гем <code>responders</code>. Для их использования просто добавьте <code>gem &quot;responders&quot;, &quot;~&gt; 2.0&quot;</code> в свой <code>Gemfile</code>. Вызовы <code>respond_with</code> и <code>respond_to</code> (на уровне класса) больше не будут работать без подключения гема <code>responders</code> к зависимостям:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/controllers/users_controller.rb</span>

<span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">respond_to</span> <span class="ss">:html</span><span class="p">,</span> <span class="ss">:json</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Метод экземпляра <code>respond_to</code> не затронут и не требует дополнительного гема:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/controllers/users_controller.rb</span>

<span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">html</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Подробнее смотрите <a href="https://github.com/rails/rails/pull/16526">#16526</a>.</p><h4 id='obrabotka-oshibok-v-tranzaktsionnyh-kolbekah' class='inside_page_header'><a href="#obrabotka-oshibok-v-tranzaktsionnyh-kolbekah">10.3.</a> Обработка ошибок в транзакционных колбэках</h4><p>В настоящий момент Active Record замалчивает ошибки, вызванные в колбэках <code>after_rollback</code> или <code>after_commit</code>, и только пишет их в логи. В следующей версии эти ошибки больше не будут замалчиваться. Вместо этого ошибки будут распространяться обычным образом, как в других колбэках Active Record.</p><p>При определении колбэка <code>after_rollback</code> или <code>after_commit</code> вы получите предупреждение об устаревании об этом предстоящем изменении. Когда будете готовы, можно будет переключиться на новое поведение и убрать предупреждение об устаревании с помощью следующей настройки в вашем <code>config/application.rb</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">raise_in_transactional_callbacks</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
</div>
<p>Подробнее смотрите в <a href="https://github.com/rails/rails/pull/14488">#14488</a> и <a href="https://github.com/rails/rails/pull/16537">#16537</a>.</p><h4 id='uporyadochivanie-testovyh-sluchaev' class='inside_page_header'><a href="#uporyadochivanie-testovyh-sluchaev">10.4.</a> Упорядочивание тестовых случаев</h4><p>В Rails 5.0 тестовые случаи будут по умолчанию выполняться в случайном порядке. В предвкушении этого изменения Rails 4.2 представил новую конфигурационную опцию <code>active_support.test_order</code> для явного указания упорядочивания тестов. Это позволит вам или заблокировать текущее поведение, установив этой опции <code>:sorted</code>, или переключиться на будущее поведение, установив этой опции <code>:random</code>.</p><p>Если не указать значение для этой опции, будет сформировано сообщение об устаревании. Чтобы этого избежать, добавьте следующую строчку в своей тестовой среде:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/environments/test.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">test_order</span> <span class="o">=</span> <span class="ss">:sorted</span> <span class="c1"># или `:random`, если хотите</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='serializovannye-atributy' class='inside_page_header'><a href="#serializovannye-atributy">10.5.</a> Сериализованные атрибуты</h4><p>При использовании произвольного кодировщика (например, <code>serialize :metadata, JSON</code>), назначение <code>nil</code> сериализованному атрибуту сохранит его в базу данных как <code>NULL</code>, вместо того, чтобы пропустить значение <code>nil</code> через кодировщик (например, <code>&quot;null&quot;</code> при использовании кодировщика <code>JSON</code>).</p><h4 id='uroven-loga-v-production' class='inside_page_header'><a href="#uroven-loga-v-production">10.6.</a> Уровень лога в Production</h4><p>В Rails 5 по умолчанию уровень лога для среды production будет изменен на <code>:debug</code> (с <code>:info</code>). Для сохранения текущего уровня по умолчанию, добавьте следующую строчку в свой <code>production.rb</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Установите `:info`, соответствующий текущему значению по умолчанию, или</span>
<span class="c1"># ecnfyjdbnt `:debug` для переключения в будущее значение по умолчанию.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">log_level</span> <span class="o">=</span> <span class="ss">:info</span>
</code></pre>
</div>
<h4 id='after_bundle-v-shablonah-rails' class='inside_page_header'><a href="#after_bundle-v-shablonah-rails">10.7.</a> <code>after_bundle</code> в шаблонах Rails</h4><p>Если у вас есть шаблон Rails, добавляющий все файлы в систему контроля версии, у него не получится добавить сгенерированные бинстабы, так как это выполняется до Bundler:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># template.rb</span>
<span class="n">generate</span><span class="p">(</span><span class="ss">:scaffold</span><span class="p">,</span> <span class="s2">"person name:string"</span><span class="p">)</span>
<span class="n">route</span> <span class="s2">"root to: 'people#index'"</span>
<span class="n">rake</span><span class="p">(</span><span class="s2">"db:migrate"</span><span class="p">)</span>

<span class="n">git</span> <span class="ss">:init</span>
<span class="n">git</span> <span class="ss">add: </span><span class="s2">"."</span>
<span class="n">git</span> <span class="ss">commit: </span><span class="sx">%Q{ -m 'Initial commit' }</span>
</code></pre>
</div>
<p>Теперь можно обернуть вызовы <code>git</code> в блок <code>after_bundle</code>. Он запустится после того, как будут сгенерированы бинстабы.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># template.rb</span>
<span class="n">generate</span><span class="p">(</span><span class="ss">:scaffold</span><span class="p">,</span> <span class="s2">"person name:string"</span><span class="p">)</span>
<span class="n">route</span> <span class="s2">"root to: 'people#index'"</span>
<span class="n">rake</span><span class="p">(</span><span class="s2">"db:migrate"</span><span class="p">)</span>

<span class="n">after_bundle</span> <span class="k">do</span>
  <span class="n">git</span> <span class="ss">:init</span>
  <span class="n">git</span> <span class="ss">add: </span><span class="s2">"."</span>
  <span class="n">git</span> <span class="ss">commit: </span><span class="sx">%Q{ -m 'Initial commit' }</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='sanitayzer-html-v-rails' class='inside_page_header'><a href="#sanitayzer-html-v-rails">10.8.</a> Санитайзер HTML в Rails</h4><p>Появился выбор для санации фрагментов HTML в вашем приложении. Старый подход сканирования html официально устарел в пользу <a href="https://github.com/rails/rails-html-sanitizer"><code>Rails HTML Sanitizer</code></a>.</p><p>Это означает, что методы <code>sanitize</code>, <code>sanitize_css</code>, <code>strip_tags</code> и <code>strip_links</code> теперь реализованы по-новому.</p><p>Новый санитайзер внутри использует <a href="https://github.com/flavorjones/loofah">Loofah</a>. Loofah, в свою очередь, использует Nokogiri, который является оберткой для парсеров, написанных на C и Java, таким образом, санирование должно стать быстрее, вне зависимости от того, на какой версии Ruby она запущена.</p><p>Новая версия обновляет <code>sanitize</code> таким образом, что он может принимать <code>Loofah::Scrubber</code> для мощной очистки. <a href="https://github.com/flavorjones/loofah#loofahscrubber">Несколько примеров скраберов тут</a>.</p><p>Также добавлены два новых скрабера: <code>PermitScrubber</code> и <code>TargetScrubber</code>. Подробнее читайте в <a href="https://github.com/rails/rails-html-sanitizer">readme гема</a>.</p><p>Документация для <code>PermitScrubber</code> и <code>TargetScrubber</code> объясняет, как можно получить полный контроль над тем, когда и как элементы должны быть отброшены.</p><p>Если вашему приложению необходима реализация старого санитайзера, включите <code>rails-deprecated_sanitizer</code> в свой <code>Gemfile</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">gem</span> <span class="s2">"rails-deprecated_sanitizer"</span>
</code></pre>
</div>
<h4 id='testirovanie-dom-v-rails' class='inside_page_header'><a href="#testirovanie-dom-v-rails">10.9.</a> Тестирование DOM в Rails</h4><p><a href="https://api.rubyonrails.org/v4.1/classes/ActionDispatch/Assertions/TagAssertions.html">Модуль <code>TagAssertions</code></a> (содержащий методы, такие как <code>assert_tag</code>), <a href="https://github.com/rails/rails/blob/6061472b8c310158a2a2e8e9a6b81a1aef6b60fe/actionpack/lib/action_dispatch/testing/assertions/dom.rb">устарел</a> в пользу методов <code>assert_select</code> из модуля <code>SelectorAssertions</code>, который был извлечен в <a href="https://github.com/rails/rails-dom-testing">гем rails-dom-testing</a>.</p><h4 id='maskirovka-tokenov-autentifikatsii' class='inside_page_header'><a href="#maskirovka-tokenov-autentifikatsii">10.10.</a> Маскировка токенов аутентификации</h4><p>В целях уменьшения атак SSL, <code>form_authenticity_token</code> теперь маскируется так, что он изменяется с каждым запросом. Таким образом, токены проверяются демаскируясь, а затем дешифруясь. Как последствие, любые стратегии проверки запросов из не-rails форм, которые полагались на статичный для сессии токен CSRF, должны принять это во внимание.</p><h4 id='action-mailer' class='inside_page_header'><a href="#action-mailer">10.11.</a> Action Mailer</h4><p>Раньше вызов метода рассыльщика на классе рассыльщика приводил к непосредственному выполнению соответствующего метода экземпляра. С представлением Active Job и <code>#deliver_later</code>, это больше не так. В Rails 4.2 вызов методов экземпляра откладывается, пока не будут вызваны методы <code>deliver_now</code> или <code>deliver_later</code>. Например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Notifier</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Called"</span>
    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="n">mail</span> <span class="o">=</span> <span class="no">Notifier</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="c1"># Notifier#notify в этом месте пока еще не вызван</span>
<span class="n">mail</span> <span class="o">=</span> <span class="n">mail</span><span class="p">.</span><span class="nf">deliver_now</span>      <span class="c1"># Напишет "Called"</span>
</code></pre>
</div>
<p>Это не должно привести к каким-либо значимым изменениям для большинства приложений. Однако, если необходимо синхронно выполнить некоторые не рассылающие методы, и раньше вы полагались на синхронное проксирующее поведение, следует объявить их как методы класса:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Notifier</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">broadcast_notifications</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
    <span class="n">users</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="no">Notifier</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='podderzhka-vneshnih-klyuchey' class='inside_page_header'><a href="#podderzhka-vneshnih-klyuchey">10.12.</a> Поддержка внешних ключей</h4><p>DSL миграций был расширен поддержкой определений внешнего ключа. Если вы использовали гем Foreigner, рассмотрите его удаление. Отметьте, что поддержка внешних ключей в Rails это подмножество Foreigner. Это означает, что не каждое определение Foreigner может быть полностью заменено его аналогом DSL миграций Rails.</p><p>Процедура миграции следующая:</p><ul><li>убрать <code>gem &quot;foreigner&quot;</code> из <code>Gemfile</code>.
</li><li>запустить <code>bundle install</code>.
</li><li>запустить <code>bin/rake db:schema:dump</code>.
</li><li>убедиться, что <code>db/schema.rb</code> содержит каждое определение внешнего ключа с необходимыми опциями.
</li></ul><h3 id='upgrading-from-rails-4-0-to-rails-4-1' class='inside_page_header'><a href="#upgrading-from-rails-4-0-to-rails-4-1">11.</a> Апгрейд с Rails 4.0 на Rails 4.1</h3><h4 id='zaschita-csrf-ot-vneshnih-tegov-lt-script-gt' class='inside_page_header'><a href="#zaschita-csrf-ot-vneshnih-tegov-lt-script-gt">11.1.</a> Защита CSRF от внешних тегов <code>&lt;script&gt;</code></h4><p>Или, &quot;а-а-а-а, почему мои тесты падают!!!?&quot;, или &quot;мой виджет <code>&lt;script&gt;</code> сломался!!&quot;</p><p>Защита от межсайтовой подделки запроса (CSRF) сейчас также покрывает GET-запросы с откликами JavaScript. Это запрещает сторонним сайтам ссылаться на ваши JavaScript с помощью тега <code>&lt;script&gt;</code> для извлечения чувствительных данных.</p><p>Это означает, что ваши функциональные и интеграционные тесты, использующие</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">get</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">format: :js</span>
</code></pre>
</div>
<p>теперь будут вызывать защиту CSRF. Переключитесь на</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">xhr</span> <span class="ss">:get</span><span class="p">,</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">format: :js</span>
</code></pre>
</div>
<p>чтобы явно тестировать <code>XmlHttpRequest</code>.</p><div class="note"><p>Ваши собственные теги <code>&lt;script&gt;</code> трактуются как межсайтовые и по умолчанию также блокируются. Если вы действительно хотите загружать JavaScript в тегах <code>&lt;script&gt;</code>, теперь нужно явно отключить защиту CSRF для этого экшна.</p></div><h4 id='spring2' class='inside_page_header'><a href="#spring2">11.2.</a> Spring</h4><p>Если хотите использовать Spring в качестве прелоадера своего приложения, вам необходимо:</p><ul><li>Добавить <code>gem &quot;spring&quot;, group: :development</code> в свой <code>Gemfile</code>.
</li><li>Установить spring с помощью <code>bundle install</code>.
</li><li>Сгенерировать бинстабы Spring с помощью <code>bundle exec spring binstub</code>.
</li></ul><div class="note"><p>Пользовательские задачи rake по умолчанию будут запущены в окружении <code>development</code>. Если хотите запускать их в других средах, проконсультируйтесь со <a href="https://github.com/rails/spring#rake">Spring README</a>.</p></div><h4 id='config-secrets-yml' class='inside_page_header'><a href="#config-secrets-yml">11.3.</a> <code>config/secrets.yml</code></h4><p>Если хотите использовать новое соглашение по хранению секретов приложения в <code>secrets.yml</code>, вам необходимо:</p><ul><li><p>Создать файл <code>secrets.yml</code> в директории <code>config</code> со следующим содержимым:</p><div class="code_container">
  <pre><code class="highlight yaml"><span class="na">development</span><span class="pi">:</span>
  <span class="na">secret_key_base</span><span class="pi">:</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="na">secret_key_base</span><span class="pi">:</span>

<span class="na">production</span><span class="pi">:</span>
  <span class="na">secret_key_base</span><span class="pi">:</span> <span class="s">&lt;%= ENV["SECRET_KEY_BASE"] %&gt;</span>
</code></pre>
</div>
</li><li><p>Использовать существующий <code>secret_key_base</code> из инициализатора <code>secret_token.rb</code>, чтобы установить переменную среды <code>SECRET_KEY_BASE</code> для всех пользователей, под которыми запускается приложение Rails в production. Альтернативно, можно просто скопировать существующий <code>secret_key_base</code> из инициализатора <code>secret_token.rb</code> в <code>secrets.yml</code> в разделе <code>production</code>, заменив <code>&lt;%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt;</code>.</p></li><li><p>Убрать инициализатор <code>secret_token.rb</code>.</p></li><li><p>Использовать <code>rake secret</code> для генерации ключей для раздела <code>development</code> и <code>test</code>.</p></li><li><p>Перезапустить сервер.</p></li></ul><h4 id='izmeneniya-v-testovom-helpere' class='inside_page_header'><a href="#izmeneniya-v-testovom-helpere">11.4.</a> Изменения в тестовом хелпере</h4><p>Если ваш тестовый хелпер содержит вызов <code>ActiveRecord::Migration.check_pending!</code>, его можно убрать. Проверка теперь выполняется автоматически при <code>require &quot;rails/test_help&quot;</code>, хотя наличие этой строчки в вашим хелпере ничему не навредит.</p><h4 id='cookies-serializer' class='inside_page_header'><a href="#cookies-serializer">11.5.</a> Сериализатор куки</h4><p>Приложения, созданные до Rails 4.1, используют <code>Marshal</code> для сериализации значений куки при хранении подписанных и зашифрованных куки. Если хотите использовать новый, основанный на <code>JSON</code>, формат, можно добавить файл инициализатора со следующим содержимым:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">cookies_serializer</span> <span class="o">=</span> <span class="ss">:hybrid</span>
</code></pre>
</div>
<p>Он прозрачно мигрирует ваши существующие куки, сериализованные <code>Marshal</code>, в новый формат, основанный на <code>JSON</code>.</p><p>При использовании сериализатора <code>:json</code> или <code>:hybrid</code>, следует иметь в виду, что не все объекты Ruby могут быть сериализованы в JSON. Например, объекты <code>Date</code> и <code>Time</code> будут сериализованы как строки, и у хэшей ключи будут преобразованы в строки.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CookiesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">set_cookie</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">encrypted</span><span class="p">[</span><span class="ss">:expiration_date</span><span class="p">]</span> <span class="o">=</span> <span class="no">Date</span><span class="p">.</span><span class="nf">tomorrow</span> <span class="c1"># =&gt; Thu, 20 Mar 2014</span>
    <span class="n">redirect_to</span> <span class="ss">action: </span><span class="s1">'read_cookie'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">read_cookie</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">encrypted</span><span class="p">[</span><span class="ss">:expiration_date</span><span class="p">]</span> <span class="c1"># =&gt; "2014-03-20"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Советуем хранить в куки только простые данные (строки и числа). Если необходимо хранить сложные объекты. необходимо производить эти преобразования вручную при чтении значений в последующих запросах.</p><p>При использовании хранения сессии в куки, все вышесказанное также применяется к хэшам <code>session</code> и <code>flash</code>.</p><h4 id='izmenilas-struktura-flash' class='inside_page_header'><a href="#izmenilas-struktura-flash">11.6.</a> Изменилась структура Flash</h4><p>Ключи сообщении Flash <a href="https://github.com/rails/rails/commit/a668beffd64106a1e1fedb71cc25eaaa11baf0c1">нормализуются в строки</a>. К ним по прежнему можно получить доступ с помощью символа или строки. Итерация по flash будет всегда возвращать строковые ключи:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">flash</span><span class="p">[</span><span class="s2">"string"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"a string"</span>
<span class="n">flash</span><span class="p">[</span><span class="ss">:symbol</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"a symbol"</span>

<span class="c1"># Rails &lt; 4.1</span>
<span class="n">flash</span><span class="p">.</span><span class="nf">keys</span> <span class="c1"># =&gt; ["string", :symbol]</span>

<span class="c1"># Rails &gt;= 4.1</span>
<span class="n">flash</span><span class="p">.</span><span class="nf">keys</span> <span class="c1"># =&gt; ["string", "symbol"]</span>
</code></pre>
</div>
<p>Убедитесь, что вы сравниваете ключи сообщений Flash со строками.</p><h4 id='changes-in-json-handling' class='inside_page_header'><a href="#changes-in-json-handling">11.7.</a> Изменения в обработке JSON</h4><p>Есть несколько основных изменений в обработке JSON в Rails 4.1.</p><h5 id='ubran-multijson' class='inside_page_header'><a href="#ubran-multijson">11.7.1.</a> Убран MultiJSON</h5><p>MultiJSON потерял <a href="https://github.com/rails/rails/pull/10576">смысл своего существования</a> и был убран из Rails.</p><p>Если ваше приложение сейчас непосредственно зависит от MultiJSON, у вас несколько вариантов:</p><ul><li><p>Добавьте &#39;multi_json&#39; в свой <code>Gemfile</code>. Отметьте, что это может что-нибудь сломать в будущем</p></li><li><p>Уйти от MultiJSON в пользу использования вместо него <code>obj.to_json</code> и <code>JSON.parse(str)</code></p></li></ul><div class="warning"><p>Нельзя просто заменить <code>MultiJson.dump</code> и <code>MultiJson.load</code> на <code>JSON.dump</code> и <code>JSON.load</code>. Эти API гема JSON означают сериализацию и десериализацию произвольных объектов Ruby, и, в основном, <a href="https://www.ruby-doc.org/stdlib-2.2.2/libdoc/json/rdoc/JSON.html#method-i-load">небезопасны</a>.</p></div><h5 id='sovmestimost-s-gemom-json' class='inside_page_header'><a href="#sovmestimost-s-gemom-json">11.7.2.</a> Совместимость с гемом JSON</h5><p>Исторически у Rails есть несколько проблем совместимости с гемом JSON. Использование <code>JSON.generate</code> и <code>JSON.dump</code> в приложении Rails могло вызвать неожиданные ошибки.</p><p>Rails 4.1 исправил эти проблемы, изолировав свой собственный кодер от гема JSON. API гема JSON будет функционировать, как обычно, но у него не будет доступа к особенностям, специфичным для Rails. Например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">FooBar</span>
  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="p">{</span> <span class="ss">foo: </span><span class="s1">'bar'</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">FooBar</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">to_json</span>
<span class="p">=&gt;</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">foo</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">bar</span><span class="se">\"</span><span class="s2">}"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">JSON</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="no">FooBar</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span> <span class="ss">quirks_mode: </span><span class="kp">true</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">#&lt;FooBar:0x007fa80a481610&gt;</span><span class="se">\"</span><span class="s2">"</span>
</code></pre>
</div>
<h5 id='novyy-koder-json' class='inside_page_header'><a href="#novyy-koder-json">11.7.3.</a> Новый кодер JSON</h5><p>Кодер JSON в Rails 4.1 был переписан, чтобы воспользоваться преимуществами гема JSON. Для большинства приложений это незаметное изменение. Однако, как часть переписывания, следующие особенности были убраны из кодера:</p><ul><li>Обнаружение кольцевых структур данных
</li><li>Поддержка хука <code>encode_json</code>
</li><li>Опция для кодирования объектов <code>BigDecimal</code> как числа, вместо строк
</li></ul><p>Если ваше приложение зависит от одной из этих особенностей, их можно вернуть, добавив гем <a href="https://github.com/rails/activesupport-json_encoder"><code>activesupport-json_encoder</code></a> в свой <code>Gemfile</code>.</p><h5 id='predstavlenie-v-json-ob-ektov-time' class='inside_page_header'><a href="#predstavlenie-v-json-ob-ektov-time">11.7.4.</a> Представление в JSON объектов Time</h5><p><code>#as_json</code> для объектов с компонентом времени (<code>Time</code>, <code>DateTime</code>, <code>ActiveSupport::TimeWithZone</code>) теперь возвращает по умолчанию с точностью до миллисекунд. Если необходимо сохранить старое поведение без миллисекунд, добавьте следующее в инициализатор:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">JSON</span><span class="o">::</span><span class="no">Encoding</span><span class="p">.</span><span class="nf">time_precision</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre>
</div>
<h4 id='ispolzovanie-return-v-inlayn-blokah-kolbekov' class='inside_page_header'><a href="#ispolzovanie-return-v-inlayn-blokah-kolbekov">11.8.</a> Использование <code>return</code> в инлайн блоках колбэков</h4><p>Раньше Rails разрешал инлайн блокам колбэков использовать <code>return</code> таким образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ReadOnlyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="k">return</span> <span class="kp">false</span> <span class="p">}</span> <span class="c1"># ПЛОХО</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Это поведение никогда явно не поддерживалось. В связи с изменением внутри <code>ActiveSupport::Callbacks</code>, оно более недопустимо в Rails 4.1. Использование выражения <code>return</code> в инлайн блоке колбэка вызовет <code>LocalJumpError</code> при выполнении колбэка.</p><p>Использование <code>return</code> в инлайн блоке колбэка может быть отрефакторено на вычисление возвращаемого значения:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ReadOnlyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="kp">false</span> <span class="p">}</span> <span class="c1"># ХОРОШО</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Как вариант, если предпочтителен <code>return</code>, рекомендуется явно вызывать метод:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ReadOnlyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="ss">:before_save_callback</span> <span class="c1"># ХОРОШО</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">before_save_callback</span>
      <span class="kp">false</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Это изменение применяется к большинству мест в Rails, где используются колбэки, включая колбэки Active Record и Active Model, а также фильтры в Action
 Controller (т.е. <code>before_action</code>).</p><p>Подробности смотрите в <a href="https://github.com/rails/rails/pull/13271">этом pull request</a>.</p><h4 id='metody-opredelennye-v-fiksturah-active-record' class='inside_page_header'><a href="#metody-opredelennye-v-fiksturah-active-record">11.9.</a> Методы, определенные в фикстурах Active Record</h4><p>Rails 4.1 вычисляет ERB каждой фикстуры в отдельном контексте, поэтому методы хелпера, определенные в фикстуре, не будут доступны в других фикстурах.</p><p>Методы хелпера, используемые в нескольких фикстурах, должны быть определены в модулях, подключаемых в новом <code>ActiveRecord::FixtureSet.context_class</code>, в <code>test_helper.rb</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">FixtureFileHelpers</span>
  <span class="k">def</span> <span class="nf">file_sha</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA256</span><span class="p">.</span><span class="nf">hexdigest</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'test/fixtures'</span><span class="p">,</span> <span class="n">path</span><span class="p">)))</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">FixtureSet</span><span class="p">.</span><span class="nf">context_class</span><span class="p">.</span><span class="nf">include</span> <span class="no">FixtureFileHelpers</span>
</code></pre>
</div>
<h4 id='obespechenie-dostupnyh-lokaley-i18n' class='inside_page_header'><a href="#obespechenie-dostupnyh-lokaley-i18n">11.10.</a> Обеспечение доступных локалей I18n</h4><p>Сейчас Rails 4.1 устанавливает по умолчанию для опции I18n <code>enforce_available_locales</code> <code>true</code>. Это означает, что он убедится, что все локали, переданные в него, должны быть объявлены в списке <code>available_locales</code>.</p><p>Чтобы это отключить (и позволить I18n принимать <em>любые</em> опции локали), добавьте следующую конфигурацию в приложение:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">i18n</span><span class="p">.</span><span class="nf">enforce_available_locales</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
</div>
<p>Отметьте, что эта опция была добавлена как мера безопасности, чтобы обеспечить, что пользовательская информация не может использоваться как информация о локали, если она не была ранее известна. Следовательно, рекомендуется на отключать эту опцию, если у вас нет весомых причин так делать.</p><h4 id='mutiruyuschie-metody-mutatory-vyzyvaemye-na-relation' class='inside_page_header'><a href="#mutiruyuschie-metody-mutatory-vyzyvaemye-na-relation">11.11.</a> Мутирующие методы (мутаторы), вызываемые на Relation</h4><p>У <code>Relation</code> больше нет мутирующих методов, таких как <code>#map!</code> и <code>#delete_if</code>. Преобразовывайте в массив, вызывая <code>#to_a</code>, перед использованием этих методов.</p><p>Это предназначено для предотвращения странных программных ошибок и непонятностей в коде, вызывающем мутирующие методы непосредственно на <code>Relation</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Вместо этого</span>
<span class="no">Author</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Hank Moody'</span><span class="p">).</span><span class="nf">compact!</span>

<span class="c1"># Теперь нужно делать так</span>
<span class="n">authors</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Hank Moody'</span><span class="p">).</span><span class="nf">to_a</span>
<span class="n">authors</span><span class="p">.</span><span class="nf">compact!</span>
</code></pre>
</div>
<h4 id='changes-on-default-scopes' class='inside_page_header'><a href="#changes-on-default-scopes">11.12.</a> Изменения в скоупах по умолчанию</h4><p>Скоупы по умолчанию больше не переопределяются присоединенными условиями.</p><p>В прежних версиях, при определении в модели <code>default_scope</code>, он переопределялся присоединенными условиями на то же поле. Теперь он объединяется, как и любой другой скоуп.</p><p>Раньше:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'pending'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'active'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'inactive'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">all</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">active</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'active'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">state: </span><span class="s1">'inactive'</span><span class="p">)</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'inactive'</span>
</code></pre>
</div>
<p>После:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'pending'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'active'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'inactive'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">all</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">active</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."state" = 'active'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">state: </span><span class="s1">'inactive'</span><span class="p">)</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."state" = 'inactive'</span>
</code></pre>
</div>
<p>Чтобы получить предыдущее поведение, необходимо явно убрать условие <code>default_scope</code> с помощью <code>unscoped</code>, <code>unscope</code>, <code>rewhere</code> или <code>except</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'pending'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">unscope</span><span class="p">(</span><span class="ss">where: :state</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">state: </span><span class="s1">'active'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">rewhere</span> <span class="ss">state: </span><span class="s1">'inactive'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">all</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">active</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'active'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">inactive</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'inactive'</span>
</code></pre>
</div>
<h4 id='rendering-content-from-string' class='inside_page_header'><a href="#rendering-content-from-string">11.13.</a> Рендеринг содержимого из строки</h4><p>Rails 4.1 предоставляет опции <code>:plain</code>, <code>:html</code> и <code>:body</code> для <code>render</code>. Эти опции теперь являются предпочтительным способом рендеринга основанного на строке содержимого, так как позволяет указать, какой тип содержимого вы хотите отослать в качестве отклика.</p><ul><li><code>render :plain</code> установит тип содержимого <code>text/plain</code>
</li><li><code>render :html</code> установит тип содержимого <code>text/html</code>
</li><li><code>render :body</code> <em>не</em> установит заголовок типа содержимого.
</li></ul><p>С точки зрения безопасности, если не ожидается какой-либо разметки в теле отклика, следует использовать <code>render :plain</code>, так как большинство браузеров будет экранировать небезопасное содержимое вашего отклика.</p><p>Использование <code>render :text</code> будет объявлено устаревшим в будущих версиях. Пожалуйста, начинайте использовать более точные опции <code>:plain</code>, <code>:html</code> и <code>:body</code>. Использование <code>render :text</code> может вызвать риски безопасности, так как содержимое посылается как <code>text/html</code>.</p><h4 id='tipy-dannyh-json-i-hstore-v-postgresql' class='inside_page_header'><a href="#tipy-dannyh-json-i-hstore-v-postgresql">11.14.</a> Типы данных JSON и hstore в PostgreSQL</h4><p>Rails 4.1 связывает столбцы <code>json</code> и <code>hstore</code> с Ruby <code>Hash</code> со строковыми ключами. В прежних версиях использовался <code>HashWithIndifferentAccess</code>. Это означает, что доступ по символу больше не поддерживается. Это также касается <code>store_accessors</code>, основанного на столбцах <code>json</code> или <code>hstore</code>. Убедитесь, что правильно используете строковые ключи.</p><h4 id='yavnoe-ispolzovanie-bloka-dlya-activesupport-callbacks' class='inside_page_header'><a href="#yavnoe-ispolzovanie-bloka-dlya-activesupport-callbacks">11.15.</a> Явное использование блока для <code>ActiveSupport::Callbacks</code></h4><p>Rails 4.1 теперь ожидает, что будет передан явный блок при вызове <code>ActiveSupport::Callbacks.set_callback</code>. Это изменение пришло из <code>ActiveSupport::Callbacks</code>, который был существенно переписан для релиза 4.1.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Раньше в Rails 4.0</span>
<span class="n">set_callback</span> <span class="ss">:save</span><span class="p">,</span> <span class="ss">:around</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span> <span class="n">stuff</span><span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span><span class="p">;</span> <span class="n">stuff</span> <span class="p">}</span>

<span class="c1"># Теперь в Rails 4.1</span>
<span class="n">set_callback</span> <span class="ss">:save</span><span class="p">,</span> <span class="ss">:around</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span> <span class="p">{</span> <span class="n">stuff</span><span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span><span class="p">;</span> <span class="n">stuff</span> <span class="p">}</span>
</code></pre>
</div>
<h3 id='upgrading-from-rails-3-2-to-rails-4-0' class='inside_page_header'><a href="#upgrading-from-rails-3-2-to-rails-4-0">12.</a> Апгрейд с Rails 3.2 на Rails 4.0</h3><p>Если версия Rails вашего приложения сейчас старше чем 3.2.x, следует сперва произвести апгрейд на Rails 3.2, перед попыткой обновиться до Rails 4.0.</p><p>Следующие изменения предназначены для апгрейда приложения на Rails 4.0.</p><h4 id='http-patch' class='inside_page_header'><a href="#http-patch">12.1.</a> HTTP PATCH</h4><p>Rails 4 теперь использует <code>PATCH</code> в качестве основного метода HTTP для обновлений, когда в <code>config/routes.rb</code> объявлен RESTful-ресурс. Экшн <code>update</code> все еще используется, и запросы <code>PUT</code> также будут направлены к экшну <code>update</code>. Поэтому, если вы используйте только стандартные RESTful-маршруты, не нужно делать никаких изменений:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:users</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="vi">@user</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="c1"># No change needed; PATCH will be preferred, and PUT will still work.</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Однако, необходимо сделать изменение, если вы используете <code>form_for</code> для обновления ресурса в сочетании с произвольным маршрутом с использованием метода <code>PUT</code> HTTP:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">put</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="ss">on: :member</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="p">[</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="vi">@user</span> <span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">update_name</span>
    <span class="c1"># Требуется изменение; form_for попытается использовать несуществующий маршрут PATCH.</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Если экшн не используется в публичном API, и можно без проблем изменить метод HTTP, можно обновить маршрут для использования <code>patch</code> вместо <code>put</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">patch</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="ss">on: :member</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Запросы <code>PUT</code> к <code>/users/:id</code> в Rails 4 направляются к <code>update</code>, как и раньше. Поэтому, если ваше API получит настоящие PUT-запросы, они будут работать. Роутер также направит запросы <code>PATCH</code> к <code>/users/:id</code> в экшн <code>update</code>.</p><p>Если экшн используется в публичном API, и вы не можете изменить используемый метод HTTP, можно обновить форму для использования метода <code>PUT</code>:</p><div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="p">[</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="vi">@user</span> <span class="p">],</span> <span class="ss">method: :put</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</code></pre>
</div>
<p>Подробнее о PATCH, и почему это изменение было сделано, смотрите <a href="https://weblog.rubyonrails.org/2012/2/26/edge-rails-patch-is-the-new-primary-http-method-for-updates/">эту публикацию</a> в блоге Rails.</p><h5 id='zametka-o-tipah-media' class='inside_page_header'><a href="#zametka-o-tipah-media">12.1.1.</a> Заметка о типах медиа</h5><p>Корректировка для метода <code>PATCH</code> <a href="http://www.rfc-editor.org/errata_search.php?rfc=5789">определяет, что с <code>PATCH</code> должен использоваться тип медиа &#39;diff&#39; </a>. Один из таких форматов <a href="https://tools.ietf.org/html/rfc6902">JSON Patch</a>. Хотя Rails не поддерживает JSON Patch, такую поддержку легко добавить:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># в вашем контроллере:</span>
<span class="k">def</span> <span class="nf">update</span>
  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
    <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="k">do</span>
      <span class="c1"># выполнить частичное обновление</span>
      <span class="vi">@article</span><span class="p">.</span><span class="nf">update</span> <span class="n">params</span><span class="p">[</span><span class="ss">:post</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="nb">format</span><span class="p">.</span><span class="nf">json_patch</span> <span class="k">do</span>
      <span class="c1"># выполнить сложное изменение</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/initializers/json_patch.rb</span>
<span class="no">Mime</span><span class="o">::</span><span class="no">Type</span><span class="p">.</span><span class="nf">register</span> <span class="s1">'application/json-patch+json'</span><span class="p">,</span> <span class="ss">:json_patch</span>
</code></pre>
</div>
<p>Так как JSON Patch только недавно был добавлен в RFC, пока еще нет множества замечательных библиотек Ruby. Один из имеющихся гемов <a href="https://github.com/tenderlove/hana">hana</a> от Aaron Patterson, но в нем еще нет полной поддержки нескольких последних изменений в спецификации.</p><h4 id='gemfile' class='inside_page_header'><a href="#gemfile">12.2.</a> Gemfile</h4><p>Rails 4.0 убрал группу <code>assets</code> из <code>Gemfile</code>. Вам нужно убрать эту строчку из <code>Gemfile</code> перед апгрейдом. Также следует обновить файл приложения (<code>config/application.rb</code>):</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Require the gems listed in Gemfile, including any gems</span>
<span class="c1"># you've limited to :test, :development, or :production.</span>
<span class="no">Bundler</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="o">*</span><span class="no">Rails</span><span class="p">.</span><span class="nf">groups</span><span class="p">)</span>
</code></pre>
</div>
<h4 id='vendor-plugins' class='inside_page_header'><a href="#vendor-plugins">12.3.</a> vendor/plugins</h4><p>Rails 4.0 больше не поддерживает загрузку плагинов из <code>vendor/plugins</code>. Следует переместить любые плагины, извлекая их в гемы и помещая их в <code>Gemfile</code>. Если решаете не делать гемы, можно переместить их, скажем, в <code>lib/my_plugin/*</code> и добавить соответствующий инициализатор в <code>config/initializers/my_plugin.rb</code>.</p><h4 id='active-record' class='inside_page_header'><a href="#active-record">12.4.</a> Active Record</h4><ul><li><p>Rails 4.0 убрал identity map из Active Record, из-за <a href="https://github.com/rails/rails/commit/302c912bf6bcd0fa200d964ec2dc4a44abe328a6">некоторых несоответствий со связями</a>. Если вы вручную включали это в своем приложении, нужно убрать соответствующую настройку, так как от нее больше не будет эффекта: <code>config.active_record.identity_map</code>.</p></li><li><p>Метод <code>delete</code> в связях коллекции может получать аргументы <code>Integer</code> или <code>String</code> в качестве id записей, кроме самих записей, так же, как делает метод <code>destroy</code>. Раньше он вызывал <code>ActiveRecord::AssociationTypeMismatch</code> для таких аргументов. Начиная с Rails 4.0, <code>delete</code> пытается автоматически найти записи, соответствующие переданным id, до их удаления.</p></li><li><p>В Rails 4.0, когда переименовывается столбец или таблица, относящиеся к ним индексы также переименовываются. Если у вас есть миграции, переименовывающие индексы – они больше не нужны.</p></li><li><p>Rails 4.0 изменил <code>serialized_attributes</code> и <code>attr_readonly</code> быть только методами класса. Не следует использовать методы экземпляра, так как они устарели. Следует заменить их на методы класса, т.е. <code>self.serialized_attributes</code> на <code>self.class.serialized_attributes</code>.</p></li><li><p>При использовании кодировщика по умолчанию, назначение <code>nil</code> сериализованному атрибуту сохранит его в базу данных как <code>NULL</code>, вместо пропуска значения <code>nil</code> через YAML (<code>&quot;--- \n...\n&quot;</code>).</p></li><li><p>Rails 4.0 убрал особенность <code>attr_accessible</code> и <code>attr_protected</code> в пользу. Для более гладкого (smooth) процесса апгрейда можно использовать <a href="https://github.com/rails/protected_attributes">гем Protected Attributes</a>.</p></li><li><p>Если вы не используете Protected Attributes, можно удалить опции, относящиеся к этому гему, такие как <code>whitelist_attributes</code> или <code>mass_assignment_sanitizer</code>.</p></li><li><p>Rails 4.0 требует, чтобы скоупы использовали вызываемый объект, такой как Proc или lambda:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="n">where</span><span class="p">(</span><span class="ss">active: </span><span class="kp">true</span><span class="p">)</span>

<span class="c1"># станет</span>
<span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
</code></pre>
</div>
</li><li><p>В Rails 4.0 устарели <code>ActiveRecord::Fixtures</code> в пользу <code>ActiveRecord::FixtureSet</code>.</p></li><li><p>В Rails 4.0 устарел <code>ActiveRecord::TestCase</code> в пользу <code>ActiveSupport::TestCase</code>.</p></li><li><p>В Rails 4.0 устарел API поиска, основанного на хэше. Это означает, что методы, которые раньше принимали &quot;finder options&quot;, больше так не делают. Например, <code>Book.find(:all, conditions: { name: &#39;1984&#39; })</code> устарел в пользу <code>Book.where(name: &#39;1984&#39;)</code></p></li><li><p>Все динамические методы, кроме <code>find_by_...</code> and <code>find_by_...!</code>, устарели. Вот как можно внести изменения:</p><ul><li><code>find_all_by_...</code>           становится <code>where(...)</code>.
</li><li><code>find_last_by_...</code>          становится <code>where(...).last</code>.
</li><li><code>scoped_by_...</code>             становится <code>where(...)</code>.
</li><li><code>find_or_initialize_by_...</code> становится <code>find_or_initialize_by(...)</code>.
</li><li><code>find_or_create_by_...</code>     становится <code>find_or_create_by(...)</code>.
</li></ul></li><li><p>Отметьте, что <code>where(...)</code> возвращает relation, а не массив, как старые методы поиска. Если вы ожидаете массив, используйте <code>where(...).to_a</code>.</p></li><li><p>Эти эквивалентные методы могут выполнять не идентичный SQL с предыдущей реализацией.</p></li><li><p>Чтобы включить старые методы поиска, можно использовать <a href="https://github.com/rails/activerecord-deprecated_finders">гем activerecord-deprecated_finders</a>.</p></li><li><p>Rails 4.0 изменил соединительную таблицу по умолчанию для связей <code>has_and_belongs_to_many</code>, удаляя общий префикс из имени второй таблицы. Любая существующая связь <code>has_and_belongs_to_many</code> между моделями с общим префиксом должна быть указана опция <code>join_table</code>. Например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CatalogCategory</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:catalog_products</span><span class="p">,</span> <span class="ss">join_table: </span><span class="s1">'catalog_categories_catalog_products'</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">CatalogProduct</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:catalog_categories</span><span class="p">,</span> <span class="ss">join_table: </span><span class="s1">'catalog_categories_catalog_products'</span>
<span class="k">end</span>
</code></pre>
</div>
</li><li><p>Отметьте, что префикс также принимает во внимание пространства имен, поэтому связи между <code>Catalog::Category</code> и <code>Catalog::Product</code> или <code>Catalog::Category</code> и <code>CatalogProduct</code> также необходимо обновить.</p></li></ul><h4 id='active-resource' class='inside_page_header'><a href="#active-resource">12.5.</a> Active Resource</h4><p>Rails 4.0 извлек Active Resource в отдельный гем. Если вам все еще нужна эта особенность, можете добавить <a href="https://github.com/rails/activeresource">гем Active Resource</a> в своем <code>Gemfile</code>.</p><h4 id='active-model' class='inside_page_header'><a href="#active-model">12.6.</a> Active Model</h4><ul><li><p>Rails 4.0 изменил то, как прикрепляются ошибки с помощью <code>ActiveModel::Validations::ConfirmationValidator</code>. Теперь, когда не проходят валидации подтверждения, ошибка будет прикреплена к <code>:#{attribute}_confirmation</code> вместо <code>attribute</code>.</p></li><li><p>Rails 4.0 изменил значение по умолчанию для <code>ActiveModel::Serializers::JSON.include_root_in_json</code> на <code>false</code>. Теперь сериализаторы Active Model и объекты Active Record имеют одинаковое значение по умолчанию. Это означает, что вы можете закомментировать или убрать следующую опцию в файле <code>config/initializers/wrap_parameters.rb</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Disable root element in JSON by default.</span>
<span class="c1"># ActiveSupport.on_load(:active_record) do</span>
<span class="c1">#   self.include_root_in_json = false</span>
<span class="c1"># end</span>
</code></pre>
</div>
</li></ul><h4 id='action-pack' class='inside_page_header'><a href="#action-pack">12.7.</a> Action Pack</h4><ul><li><p>Rails 4.0 представил <code>ActiveSupport::KeyGenerator</code>, и использует его, как основу для генерации и проверки подписанных куки (среди прочего). Существующие подписанные куки, сгенерированные с помощью Rails 3.x, будут прозрачно апгрейднуты, если вы оставите существующий <code>secret_token</code> и добавите новый <code>secret_key_base</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/initializers/secret_token.rb</span>
<span class="no">Myapp</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">secret_token</span> <span class="o">=</span> <span class="s1">'existing secret token'</span>
<span class="no">Myapp</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">secret_key_base</span> <span class="o">=</span> <span class="s1">'new secret key base'</span>
</code></pre>
</div>
<p>Отметьте, что вы должны обождать с установкой <code>secret_key_base</code>, пока 100% пользователей на перейдет на Rails 4.x, и вы точно не будете уверены, что не придется откатиться к Rails 3.x. Это так, потому что куки, подписанные на основе нового <code>secret_key_base</code> в Rails 4.x, обратно несовместимы с Rails 3.x. Можно спокойно оставить существующий <code>secret_token</code>, не устанавливать новый <code>secret_key_base</code> и игнорировать предупреждения, пока вы не будете полностью уверены, что апгрейд завершен.</p><p>Если вы полагаетесь на возможность внешних приложений или JavaScript читать подписанные куки сессии вашего приложения Rails (или подписанные куки в целом), вам не следует устанавливать <code>secret_key_base</code>, пока вы не избавитесь от этой проблемы.</p></li><li><p>Rails 4.0 шифрует содержимое основанной на куки сессии, если был установлен <code>secret_key_base</code>. Rails 3.x подписывал, но не шифровал содержимое основанной на куки сессии. Подписанные куки &quot;безопасны&quot;, так как проверяется, что они были сгенерированы приложением, и защищены от взлома. Однако, содержимое может быть просмотрено пользователем, и шифрование содержимого устраняет эту заботу без значительного снижения производительности.</p><p>Подробнее читайте в <a href="https://github.com/rails/rails/pull/9978">Pull Request #9978</a> о переходе на подписанные куки сессии.</p></li><li><p>Rails 4.0 убрал опцию <code>ActionController::Base.asset_path</code>. Используйте особенность конвейера ресурсов (assets pipeline).</p></li><li><p>В Rails 4.0 устарела опция <code>ActionController::Base.page_cache_extension</code>. Используйте вместо нее <code>ActionController::Base.default_static_extension</code>.</p></li><li><p>Rails 4.0 убрал кэширование страниц и экшнов из Action Pack. Необходимо добавить гем <code>actionpack-action_caching</code> для использования <code>caches_action</code> и <code>actionpack-page_caching</code> для использования <code>caches_page</code> в контроллерах.</p></li><li><p>Rails 4.0 убрал парсер параметров XML. Следует добавить гем <code>actionpack-xml_parser</code>, если вам требуется эта особенность.</p></li><li><p>Rails 4.0 изменил набор поиска <code>layout</code> по умолчанию с помощью символов или проков, возвращающих nil. Чтобы получить поведение &quot;без макета&quot;, возвращайте false вместо nil.</p></li><li><p>Rails 4.0 изменил клиент memcached по умолчанию с <code>memcache-client</code> на <code>dalli</code>. Чтобы произвести апгрейд, просто добавьте <code>gem &#39;dalli&#39;</code> в свой <code>Gemfile</code>.</p></li><li><p>В Rails 4.0 устарели методы <code>dom_id</code> и <code>dom_class</code> в контроллерах (они нужны только во вью). Вам следует включить модуль <code>ActionView::RecordIdentifier</code> в контроллерах, требующих эту особенность.</p></li><li><p>В Rails 4.0 устарела опция <code>:confirm</code> для хелпера <code>link_to</code>. Вместо нее следует полагаться на атрибут data (т.е. <code>data: { confirm: &#39;Are you sure?&#39; }</code>). Это устаревание также затрагивает хелперы, основанные на этом (такие как <code>link_to_if</code> или <code>link_to_unless</code>).</p></li><li><p>Rails 4.0 изменил работу <code>assert_generates</code>, <code>assert_recognizes</code> и <code>assert_routing</code>. Теперь все эти операторы контроля вызывают <code>Assertion</code> вместо <code>ActionController::RoutingError</code>.</p></li><li><p>Rails 4.0 вызывает <code>ArgumentError</code>, если определены коллизии в именах маршрутов. Это может быть вызвано как явно определенными именованными маршрутами, либо методом <code>resources</code>. Вот два примера, которые вызывают коллизию маршрутов с именем <code>example_path</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">get</span> <span class="s1">'one'</span> <span class="o">=&gt;</span> <span class="s1">'test#example'</span><span class="p">,</span> <span class="ss">as: :example</span>
<span class="n">get</span> <span class="s1">'two'</span> <span class="o">=&gt;</span> <span class="s1">'test#example'</span><span class="p">,</span> <span class="ss">as: :example</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:examples</span>
<span class="n">get</span> <span class="s1">'clashing/:id'</span> <span class="o">=&gt;</span> <span class="s1">'test#example'</span><span class="p">,</span> <span class="ss">as: :example</span>
</code></pre>
</div>
<p>В первом случае можно просто избежать использование одинакового имени для нескольких маршрутов. Во втором следует использовать опции <code>only</code> или <code>except</code>, представленные методом <code>resources</code>, чтобы ограничить создаваемые маршруты, о чем подробно описано в руководстве <a href="/routing#restricting-the-routes-created">Роутинг в Rails</a>.</p></li><li><p>Rails 4.0 также изменил способ отрисовки маршрутов с символами unicode. Теперь можно непосредственно отрисовывать символы unicode character. Если вы уже отрисовываете такие маршруты, их нужно изменить, например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">get</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Utils</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="s1">'こんにちは'</span><span class="p">),</span> <span class="ss">controller: </span><span class="s1">'welcome'</span><span class="p">,</span> <span class="ss">action: </span><span class="s1">'index'</span>
</code></pre>
</div>
<p>станет</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">get</span> <span class="s1">'こんにちは'</span><span class="p">,</span> <span class="ss">controller: </span><span class="s1">'welcome'</span><span class="p">,</span> <span class="ss">action: </span><span class="s1">'index'</span>
</code></pre>
</div>
</li><li><p>Rails 4.0 требует, чтобы маршруты, использующие <code>match</code> указывали метод запроса. Например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Rails 3.x</span>
<span class="n">match</span> <span class="s1">'/'</span> <span class="o">=&gt;</span> <span class="s1">'root#index'</span>

<span class="c1"># станет</span>
<span class="n">match</span> <span class="s1">'/'</span> <span class="o">=&gt;</span> <span class="s1">'root#index'</span><span class="p">,</span> <span class="ss">via: :get</span>

<span class="c1"># или</span>
<span class="n">get</span> <span class="s1">'/'</span> <span class="o">=&gt;</span> <span class="s1">'root#index'</span>
</code></pre>
</div>
</li><li><p>В Rails 4.0 убрана промежуточная программа <code>ActionDispatch::BestStandardsSupport</code>, <code>&lt;!DOCTYPE html&gt;</code> уже включает режим стандартов в соответствии с <a href="https://msdn.microsoft.com/en-us/library/jj676915(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/jj676915(v=vs.85).aspx</a>, а заголовок ChromeFrame был перемещен в <code>config.action_dispatch.default_headers</code>.</p><p>Помните, что вы также должны убрать все упоминания промежуточной программы из кода своего приложения, например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Вызовет исключение</span>
<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">insert_before</span><span class="p">(</span><span class="no">Rack</span><span class="o">::</span><span class="no">Lock</span><span class="p">,</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">BestStandardsSupport</span><span class="p">)</span>
</code></pre>
</div>
<p>Также найдите в своих настройках сред <code>config.action_dispatch.best_standards_support</code>, и уберите эту строчку, если она есть.</p></li><li><p>Rails 4.0 позволяет настраивать заголовки HTTP, установив <code>config.action_dispatch.default_headers</code>. Значения по умолчанию следующие:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">default_headers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'X-Frame-Options'</span> <span class="o">=&gt;</span> <span class="s1">'SAMEORIGIN'</span><span class="p">,</span>
  <span class="s1">'X-XSS-Protection'</span> <span class="o">=&gt;</span> <span class="s1">'1; mode=block'</span>
<span class="p">}</span>
</code></pre>
</div>
<p>Отметьте, что если ваше приложение зависит от загрузки определенных страниц в <code>&lt;frame&gt;</code> или <code>&lt;iframe&gt;</code>, тогда необходимо явно установить <code>X-Frame-Options</code> в <code>ALLOW-FROM ...</code> или <code>ALLOWALL</code>.</p></li><li><p>В Rails 4.0 при прекомпиляции ассетов не будут больше автоматически копироваться не-JS/CSS ассеты из <code>vendor/assets</code> и <code>lib/assets</code>. Разработчики приложений на Rails и engine-ов должны поместить эти ассеты в <code>app/assets</code> или настроить [<code>config.assets.precompile</code>][].</p></li><li><p>В Rails 4.0 вызывается <code>ActionController::UnknownFormat</code>, когда экшн не обрабатывает формат запроса. По умолчанию исключение обрабатывается, откликаясь с помощью 406 Not Acceptable, но теперь это можно переопределить. В Rails 3 всегда возвращался 406 Not Acceptable. Без возможности переопределения.</p></li><li><p>В Rails 4.0 вызывается характерное исключение <code>ActionDispatch::ParamsParser::ParseError</code>, когда <code>ParamsParser</code> не сможет распарсить параметры запроса. Вам нужно ловить это исключение, вместо низкоуровневого <code>MultiJson::DecodeError</code>, например.</p></li><li><p>В Rails 4.0 <code>SCRIPT_NAME</code> правильно вкладывается, когда engine монтируется в приложении, находящемся на префиксе URL. Больше не нужно устанавливать <code>default_url_options[:script_name]</code>, чтобы работать с переписанными префиксами URL.</p></li><li><p>В Rails 4.0 устарел <code>ActionController::Integration</code> в пользу <code>ActionDispatch::Integration</code>.</p></li><li><p>В Rails 4.0 устарел <code>ActionController::IntegrationTest</code> в пользу <code>ActionDispatch::IntegrationTest</code>.</p></li><li><p>В Rails 4.0 устарел <code>ActionController::PerformanceTest</code> в пользу <code>ActionDispatch::PerformanceTest</code>.</p></li><li><p>В Rails 4.0 устарел <code>ActionController::AbstractRequest</code> в пользу <code>ActionDispatch::Request</code>.</p></li><li><p>В Rails 4.0 устарел <code>ActionController::Request</code> в пользу <code>ActionDispatch::Request</code>.</p></li><li><p>В Rails 4.0 устарел <code>ActionController::AbstractResponse</code> в пользу <code>ActionDispatch::Response</code>.</p></li><li><p>В Rails 4.0 устарел <code>ActionController::Response</code> в пользу <code>ActionDispatch::Response</code>.</p></li><li><p>В Rails 4.0 устарел <code>ActionController::Routing</code> в пользу <code>ActionDispatch::Routing</code>.</p></li></ul><p>[<code>config.assets.precompile</code>]: /configuring#config-assets-precompile</p><h4 id='active-support' class='inside_page_header'><a href="#active-support">12.8.</a> Active Support</h4><p>Rails 4.0 убрал псевдоним <code>j</code> для <code>ERB::Util#json_escape</code>, так как <code>j</code> уже используется для <code>ActionView::Helpers::JavaScriptHelper#escape_javascript</code>.</p><h5 id='cache' class='inside_page_header'><a href="#cache">12.8.1.</a> Cache</h5><p>Метод кэширования изменился между Rails 3.x и 4.0. Вы должны <a href="/caching-with-rails#activesupport-cache-store">изменить пространство имен</a> и развертывать с холодным кэшем.</p><h4 id='poryadok-zagruzki-helperov' class='inside_page_header'><a href="#poryadok-zagruzki-helperov">12.9.</a> Порядок загрузки хелперов</h4><p>В Rails 4.0 изменился порядок, в котором загружались хелперы из более чем одной директории. Ранее они собирались, а затем сортировались по алфавиту. После апгрейда на Rails 4.0, хелперы будут сохранять порядок загружаемых директорий и будут сортироваться по алфавиту только в пределах каждой директории. Если вы явно не используете параметр <code>helpers_path</code>, Это изменение повлияет только на способ загрузки хелперов из engine-ов. Если вы полагаетесь на порядок загрузки, следует проверить, что после апгрейда доступны правильные методы. Если хотите изменить порядок, в котором загружаются engine, Можно использовать метод <code>config.railties_order=</code>.</p><h4 id='active-record-observer-i-action-controller-sweeper' class='inside_page_header'><a href="#active-record-observer-i-action-controller-sweeper">12.10.</a> Active Record Observer и Action Controller Sweeper</h4><p><code>ActiveRecord::Observer</code> и <code>ActionController::Caching::Sweeper</code> были извлечены в гем <code>rails-observers</code>. Следует добавить гем <code>rails-observers</code>, если вам нужны эти особенности.</p><h4 id='sprockets-rails' class='inside_page_header'><a href="#sprockets-rails">12.11.</a> sprockets-rails</h4><ul><li>  <code>assets:precompile:primary</code> и <code>assets:precompile:all</code> были убраны. Используйте вместо них <code>assets:precompile</code>.
</li><li><p>  Опция <code>config.assets.compress</code> должна быть изменена на [<code>config.assets.js_compressor</code>][], например, так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">js_compressor</span> <span class="o">=</span> <span class="ss">:uglifier</span>
</code></pre>
</div>
</li></ul><p>[<code>config.assets.js_compressor</code>]: /configuring#config-assets-js-compressor</p><h4 id='sass-rails' class='inside_page_header'><a href="#sass-rails">12.12.</a> sass-rails</h4><ul><li>  <code>asset_url</code> с двумя аргументами устарел. Например: <code>asset-url(&quot;rails.png&quot;, image)</code> стал <code>asset-url(&quot;rails.png&quot;)</code>
</li></ul><h3 id='apgreyd-s-rails-3-1-na-rails-3-2' class='inside_page_header'><a href="#apgreyd-s-rails-3-1-na-rails-3-2">13.</a> Апгрейд с Rails 3.1 на Rails 3.2</h3><p>Если версия Rails вашего приложения сейчас старше чем 3.1.x, следует сперва произвести апгрейд на Rails 3.1, перед попыткой обновиться до Rails 3.2.</p><p>Следующие изменения предназначены для апгрейда вашего приложения на последнюю версию 3.2.x Rails.</p><h4 id='gemfile2' class='inside_page_header'><a href="#gemfile2">13.1.</a> Gemfile</h4><p>Сделайте следующие изменения в своем <code>Gemfile</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">gem</span> <span class="s2">"rails"</span><span class="p">,</span> <span class="s2">"3.2.21"</span>

<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s2">"sass-rails"</span><span class="p">,</span>   <span class="s2">"~&gt; 3.2.6"</span>
  <span class="n">gem</span> <span class="s2">"coffee-rails"</span><span class="p">,</span> <span class="s2">"~&gt; 3.2.2"</span>
  <span class="n">gem</span> <span class="s2">"uglifier"</span><span class="p">,</span>     <span class="s2">"&gt;= 1.0.3"</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='config-environments-development-rb' class='inside_page_header'><a href="#config-environments-development-rb">13.2.</a> config/environments/development.rb</h4><p>Имеется ряд новых конфигурационных настроек, которые следует добавить в среде development:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Raise exception on mass assignment protection for Active Record models</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">mass_assignment_sanitizer</span> <span class="o">=</span> <span class="ss">:strict</span>

<span class="c1"># Log the query plan for queries taking more than this (works</span>
<span class="c1"># with SQLite, MySQL, and PostgreSQL)</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">auto_explain_threshold_in_seconds</span> <span class="o">=</span> <span class="mf">0.5</span>
</code></pre>
</div>
<h4 id='config-environments-test-rb' class='inside_page_header'><a href="#config-environments-test-rb">13.3.</a> config/environments/test.rb</h4><p>Также должна быть добавлена конфигурационная настройка <code>mass_assignment_sanitizer</code> в <code>config/environments/test.rb</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Raise exception on mass assignment protection for Active Record models</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">mass_assignment_sanitizer</span> <span class="o">=</span> <span class="ss">:strict</span>
</code></pre>
</div>
<h4 id='vendor-plugins2' class='inside_page_header'><a href="#vendor-plugins2">13.4.</a> vendor/plugins</h4><p>В Rails 3.2 устаревает <code>vendor/plugins</code>, а в Rails 4.0 будет убрана полностью. Хотя это и не требуется строго при апгрейде на Rails 3.2, можно начать перемещать любые плагины, извлекая их в гемы и помещая их в <code>Gemfile</code>. Если решаете не делать гемы, можно переместить их, скажем, в <code>lib/my_plugin/*</code> и добавить соответствующий инициализатор в <code>config/initializers/my_plugin.rb</code>.</p><h4 id='active-record2' class='inside_page_header'><a href="#active-record2">13.5.</a> Active Record</h4><p>Опция <code>:dependent =&gt; :restrict</code> была убрана из <code>belongs_to</code>. Если хотите предотвратить удаление объекта, если имеются какие-либо связанные объекты, можно установить <code>:dependent =&gt; :destroy</code> и возвращать <code>false</code> после проверки существования связи из любого колбэка на destroy связанного объекта.</p><h3 id='apgreyd-s-rails-3-0-na-rails-3-1' class='inside_page_header'><a href="#apgreyd-s-rails-3-0-na-rails-3-1">14.</a> Апгрейд с Rails 3.0 на Rails 3.1</h3><p>Если версия Rails вашего приложения сейчас старше чем 3.0.x, следует сперва произвести апгрейд на Rails 3.0, перед попыткой обновиться до Rails 3.1.</p><p>Следующие изменения предназначены для апгрейда вашего приложения на Rails 3.1.12, последнюю версию 3.1.x Rails.</p><h4 id='gemfile3' class='inside_page_header'><a href="#gemfile3">14.1.</a> Gemfile</h4><p>Сделайте следующие изменения в своем <code>Gemfile</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">gem</span> <span class="s2">"rails"</span><span class="p">,</span> <span class="s2">"3.1.12"</span>
<span class="n">gem</span> <span class="s2">"mysql2"</span>

<span class="c1"># Needed for the new asset pipeline</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s2">"sass-rails"</span><span class="p">,</span>   <span class="s2">"~&gt; 3.1.7"</span>
  <span class="n">gem</span> <span class="s2">"coffee-rails"</span><span class="p">,</span> <span class="s2">"~&gt; 3.1.1"</span>
  <span class="n">gem</span> <span class="s2">"uglifier"</span><span class="p">,</span>     <span class="s2">"&gt;= 1.0.3"</span>
<span class="k">end</span>

<span class="c1"># jQuery is the default JavaScript library in Rails 3.1</span>
<span class="n">gem</span> <span class="s2">"jquery-rails"</span>
</code></pre>
</div>
<h4 id='config-application-rb' class='inside_page_header'><a href="#config-application-rb">14.2.</a> config/application.rb</h4><p>Конвейер ресурсов (asset pipeline) требует следующих добавлений:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">version</span> <span class="o">=</span> <span class="s2">"1.0"</span>
</code></pre>
</div>
<p>Если ваше приложение использует маршрут &quot;/assets&quot; для ресурса, можно изменить префикс, используемый для ассетов, чтобы избежать конфликтов:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Defaults to '/assets'</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">prefix</span> <span class="o">=</span> <span class="s1">'/asset-files'</span>
</code></pre>
</div>
<h4 id='config-environments-development-rb2' class='inside_page_header'><a href="#config-environments-development-rb2">14.3.</a> config/environments/development.rb</h4><p>Уберите настройку для RJS <code>config.action_view.debug_rjs = true</code>.</p><p>Добавьте эти настройки, если вы включили конвейер ресурсов:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Do not compress assets</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compress</span> <span class="o">=</span> <span class="kp">false</span>

<span class="c1"># Expands the lines which load the assets</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">debug</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
</div>
<h4 id='config-environments-production-rb' class='inside_page_header'><a href="#config-environments-production-rb">14.4.</a> config/environments/production.rb</h4><p>Снова, большая часть изменений относится к конвейеру ресурсов. Подробнее о них можно прочитать в руководстве <a href="/asset-pipeline">Asset Pipeline</a>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Compress JavaScripts and CSS</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compress</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># Don't fallback to assets pipeline if a precompiled asset is missed</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compile</span> <span class="o">=</span> <span class="kp">false</span>

<span class="c1"># Generate digests for assets URLs</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">digest</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># Defaults to Rails.root.join("public/assets")</span>
<span class="c1"># config.assets.manifest = YOUR_PATH</span>

<span class="c1"># Precompile additional assets (application.js, application.css, and all non-JS/CSS are already added)</span>
<span class="c1"># config.assets.precompile += %w( admin.js admin.css )</span>

<span class="c1"># Force all access to the app over SSL, use Strict-Transport-Security, and use secure cookies.</span>
<span class="c1"># config.force_ssl = true</span>
</code></pre>
</div>
<h4 id='config-environments-test-rb2' class='inside_page_header'><a href="#config-environments-test-rb2">14.5.</a> config/environments/test.rb</h4><p>Можно увеличить производительность тестов, добавив следующее в среде test:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Configure static asset server for tests with Cache-Control for performance</span>
<span class="n">config</span><span class="p">.</span><span class="nf">public_file_server</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">config</span><span class="p">.</span><span class="nf">public_file_server</span><span class="p">.</span><span class="nf">headers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'Cache-Control'</span> <span class="o">=&gt;</span> <span class="s1">'public, max-age=3600'</span>
<span class="p">}</span>
</code></pre>
</div>
<h4 id='config-initializers-wrap_parameters-rb' class='inside_page_header'><a href="#config-initializers-wrap_parameters-rb">14.6.</a> config/initializers/wrap_parameters.rb</h4><p>Добавьте эти файлы со следующим содержимым, если хотите оборачивать параметры во вложенный хэш. Для новых приложений это включено по умолчанию.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Be sure to restart your server when you modify this file.</span>
<span class="c1"># This file contains settings for ActionController::ParamsWrapper which</span>
<span class="c1"># is enabled by default.</span>

<span class="c1"># Enable parameter wrapping for JSON. You can disable this by setting :format to an empty array.</span>
<span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">on_load</span><span class="p">(</span><span class="ss">:action_controller</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">wrap_parameters</span> <span class="ss">format: </span><span class="p">[</span><span class="ss">:json</span><span class="p">]</span>
<span class="k">end</span>

<span class="c1"># Disable root element in JSON by default.</span>
<span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">on_load</span><span class="p">(</span><span class="ss">:active_record</span><span class="p">)</span> <span class="k">do</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">include_root_in_json</span> <span class="o">=</span> <span class="kp">false</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='config-initializers-session_store-rb' class='inside_page_header'><a href="#config-initializers-session_store-rb">14.7.</a> config/initializers/session_store.rb</h4><p>Необходимо изменить ключ сессии на другой, или удалить все сессии:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># in config/initializers/session_store.rb</span>
<span class="no">AppName</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">session_store</span> <span class="ss">:cookie_store</span><span class="p">,</span> <span class="ss">key: </span><span class="s1">'SOMETHINGNEW'</span>
</code></pre>
</div>
<p>или</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span>bin/rake db:sessions:clear
</code></pre>
</div>
<h4 id='ubrat-optsii-cache-i-concat-v-helperah-assetov-vo-vyu' class='inside_page_header'><a href="#ubrat-optsii-cache-i-concat-v-helperah-assetov-vo-vyu">14.8.</a> Убрать опции :cache и :concat в хелперах ассетов во вью</h4><ul><li>Вместе с конвейером ресурсов опции :cache и :concat больше не используются, удалите эти опции из вью.
</li></ul>

            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

   <!-- bottom rusrails -->
   <ins class="adsbygoogle"
        style="display:inline-block;width:580px;height:400px"
        data-ad-client="ca-pub-7764391801669990"
        data-ad-slot="7566253867"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
        </div>
        <div class="row-fluid">
          <div class="span12" id="footer">
            <p>
              <a target="blank" href="https://github.com/rusrails/rusrails"><img src="/assets/github-7cc23602a5ac2465f14c19492358a5a67dc24636761cc723e4d621cea0c09225.png" /></a>
            </p>
            <p>
              <a href="https://creativecommons.org/licenses/by-sa/4.0/">Лицензия CC BY-SA 4.0</a>
              "Rails", "Ruby on Rails" и логотип Rails - торговые марки DHH
              <!-- Yandex.Metrika counter -->
<script>
  (function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter1006929 = new Ya.Metrika({id:1006929,
                    webvisor:true,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true});
        } catch(e) { }
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>

<noscript>
  <div>
    <img style="position:absolute; left:-9999px;" alt="" src="//mc.yandex.ru/watch/1006929" />
  </div>
</noscript>
<!-- /Yandex.Metrika counter -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64955373-1', 'auto');
  ga('send', 'pageview');

  var trackOutboundLink = function(url) {
    ga('send', 'event', 'outbound', 'click', url, {
      'transport': 'beacon',
      'hitCallback': function(){ }
    });
  }
</script>

            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="to_top" style="display: block">
      <div class="to_top_panel"></div>
    </div>
    <script src="/assets/application-48ac5c5be8858f5558a99606c2d341f9fee482f22db6deee5def03837c505584.js"></script>
  </body>
</html>
