<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8">
<meta content="Ruby on Rails, Ruby, Rails, Rails 3, Rails 4, Rails 5, Rails 6, Rails 6.0, Rails 6.1, Rails 7.0, Rails 7.1 руководство, начинающим, самоучитель, manual, мануал, справочник, учебник, примеры, Руби, рельсы" name="keywords"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" name="description"/>
<meta content="product" property="twitter:card"/>
<meta content="@rusrails" property="twitter:site"/>
<meta content="Rusrails: Основы Action Mailbox" property="twitter:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="twitter:description"/>
<meta content="@rusrails" property="twitter:creator"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="twitter:image"/>
<meta content="website" property="og:type"/>
<meta content="Rusrails: Основы Action Mailbox" property="og:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="og:description"/>
<meta content="http://localhost:3000/action-mailbox-basics" property="og:url"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="og:image"/>
    <title>
      Rusrails: Основы Action Mailbox
    </title>
    <link rel="stylesheet" media="screen" href="/assets/application-4f65588939909a694017a295c9ca934821f6a6358454c26c5360579d7ee0054d.css" />
    <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="Fst22acsRMX7HtPKoPwQj6jcNO5YwiW8bfj/Jnum+MaK89TbyDsPK7jrgRdBGFcTGeOrASdVQPJUZ+Qx7GEOww==" />
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="/"></a>
          <script async src="https://cse.google.com/cse.js?cx=4152266ab1c5e41d8"></script>
          <div class="gcse-search navbar-search pull-right"></div>
          <ul class="nav pull-right top-menu">
            <li>
              <a href="/">Главная</a>
            </li>
            <li class="dropdown">
              <a class="index-popover" href="#">
                Содержание
                <b class="caret"></b>
</a>              <div class="index-popover-content hide">
                  <ul><li><p><strong>С чего начать?</strong></p><ul><li><a href="/getting-started">Rails для начинающих</a>
</li></ul></li><li><p><strong>Модели</strong></p><ul><li><a href="/active-record-basics">Основы Active Record</a>
</li><li><a href="/active-record-migrations">Миграции Active Record</a>
</li><li><a href="/active-record-validations">Валидации Active Record</a>
</li><li><a href="/active-record-callbacks">Колбэки Active Record</a>
</li><li><a href="/active-record-associations">Связи (ассоциации) Active Record</a>
</li><li><a href="/active-record-querying">Интерфейс запросов Active Record</a>
</li><li><a href="/active-model-basics">Основы Active Model</a>
</li></ul></li><li><p><strong>Вью</strong></p><ul><li><a href="/action-view-overview">Обзор Action View</a>
</li><li><a href="/layouts-and-rendering">Макеты и рендеринг в Rails</a>
</li><li><a href="/action-view-helpers">Хелперы Action View</a>
</li><li><a href="/form-helpers">Хелперы форм в Action View</a>
</li></ul></li><li><p><strong>Контроллеры</strong></p><ul><li><a href="/action-controller-overview">Обзор Action Controller</a>
</li><li><a href="/routing">Роутинг в Rails</a>
</li></ul></li><li><p><strong>Другие компоненты</strong></p><ul><li><a href="/active-support-core-extensions">Расширения ядра Active Support</a>
</li><li><a href="/action-mailer-basics">Основы Action Mailer</a>
</li><li><a href="/action-mailbox-basics">Основы Action Mailbox</a>
</li><li><a href="/action-text-overview">Обзор Action Text</a>
</li><li><a href="/active_job_basics">Основы Active Job</a>
</li><li><a href="/active_storage_overview">Обзор Active Storage</a>
</li><li><a href="/action-cable-overview">Обзор Action Cable</a>
</li></ul></li><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/i18n">API интернационализации Rails (I18n)</a>
</li><li><a href="/testing">Тестирование приложений на Rails</a>
</li><li><a href="/security">Безопасность приложений на Rails</a>
</li><li><a href="/error-reporting">Отчет об ошибках в приложениях Rails</a>
</li></ul></li></ul><p>next_column</p><ul><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/debugging-rails-applications">Отладка приложений на Rails</a>
</li><li><a href="/configuring">Конфигурирование приложений на Rails</a>
</li><li><a href="/command-line">Командная строка Rails</a>
</li><li><a href="/asset-pipeline">Asset Pipeline</a>
</li><li><a href="/working-with-javascript-in-rails">Работа с JavaScript в Rails</a>
</li><li><a href="/initialization">Процесс инициализации в Rails</a>
</li><li><a href="/autoloading-and-reloading-constants">Автозагрузка и перезагрузка констант</a>
</li><li><a href="/classic-to-zeitwerk-howto">Как перейти с Classic на Zeitwerk</a>
</li><li><a href="/caching-with-rails">Кэширование с Rails: Обзор</a>
</li><li><a href="/active-support-instrumentation">Инструментарий Active Support</a>
</li><li><a href="/api-app">Использование Rails для API-приложений</a>
</li><li><a href="/active-record-postgresql">Active Record для PostgreSQL</a>
</li><li><a href="/active-record-multiple-databases">Несколько баз данных с Active Record</a>
</li><li><a href="/active-record-encryption">Шифрование Active Record</a>
</li></ul></li><li><p><strong>Расширяем Rails</strong></p><ul><li><a href="/plugins">Основы создания плагинов Rails</a>
</li><li><a href="/rails-on-rack">Rails on Rack</a>
</li><li><a href="/generators">Создание и настройка генераторов и шаблонов Rails</a>
</li><li><a href="/engines">Engine для начинающих</a>
</li><li><a href="/threading_and_code_execution">Треды и выполнение кода в Rails</a>
</li><li><a href="/rails-application-templates">Шаблоны приложения Rails</a>
</li></ul></li><li><p><strong>Вносим вклад в Ruby on Rails</strong></p><ul><li><a href="/contributing_to_ruby_on_rails">Вносим вклад в Ruby on Rails</a>
</li><li><a href="/api_documentation_guidelines">Рекомендации по документированию API</a>
</li><li><a href="/ruby_on_rails_guides_guidelines">Рекомендации для руководств по Ruby on Rails</a>
</li><li><a href="/development_dependencies_install">Установка зависимостей для разработки</a>
</li><li><a href="/maintenance-policy">Политика поддержки (версий)</a>
</li></ul></li><li><p><strong>Заметки о релизах</strong></p><ul><li><a href="/upgrading-ruby-on-rails">Апгрейд Ruby on Rails</a>
</li><li><a href="/7_1_release_notes">Версия 7.1 - ?</a>
</li><li><a href="/7_0_release_notes">Версия 7.0 - Декабрь 2021</a>
</li><li><a href="/6_1_release_notes">Версия 6.1 - Декабрь 2020</a>
</li><li><a href="/6_0_release_notes">Версия 6.0 - Август 2019</a>
</li></ul></li></ul>
              </div>
            </li>
            <li>
              <a target="blank" href="http://api.rusrails.ru">Ruby &amp; Rails API</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="content-wrapper">
      <div class="container-fluid">
        <div class="row-fluid">
          <div class="span3 pull-right">
            <div class="well social">
              <h4>Принимаем пожелания и пул-реквесты!</h4>
              <iframe allowtransparency="true" frameborder="0" height="30" src="http://ghbtns.com/github-btn.html?user=rusrails&repo=rusrails&type=watch&count=true&size=large" width="180"></iframe>
              <p></p>
              <a class="twitter-follow-button" data-lang="ru" href="https://twitter.com/rusrails"></a>
            </div>
              <div class="well menu">
                    <ul class="nav nav-list">
      <li>
        <h4>
          <a href="#chto-takoe-action-mailbox">1. Что такое Action Mailbox?</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#nastroyka">2. Настройка</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#konfiguratsiya">3. Конфигурация</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#exim">3.1. Exim</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#mailgun">3.2. Mailgun</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#mandrill">3.3. Mandrill</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#postfix">3.4. Postfix</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#postmark">3.5. Postmark</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#qmail">3.6. Qmail</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#sendgrid">3.7. SendGrid</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#primery">4. Примеры</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#unichtozhenie-inboundemails">5. Уничтожение InboundEmails</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#rabota-s-action-mailbox-pri-razrabotke">6. Работа с Action Mailbox при разработке</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#testirovanie-pochtovyh-yaschikov">7. Тестирование почтовых ящиков</a>
</h4>      </li>
</ul>

              </div>
            <div class="well banner300 banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<!-- sidebar rusrails -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:600px"
     data-ad-client="ca-pub-7764391801669990"
     data-ad-slot="6089520660"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
          <div class="span9 content pull-left">
            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <!-- top rusrails -->
  <ins class="adsbygoogle"
       style="display:inline-block;width:980px;height:120px"
       data-ad-client="ca-pub-7764391801669990"
       data-ad-slot="4891989065"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
              <h2 id='osnovy-action-mailbox' class='inside_page_header'> Основы Action Mailbox</h2><p>Это руководство предоставляет вам все, что нужно для того, чтобы начать получать письма в вашем приложении.</p><p>После его прочтения, вы узнаете:</p><ul><li>Как получать письма в приложении Rails.
</li><li>Как настраивать Action Mailbox.
</li><li>Как генерировать и маршрутизировать письма в ящик.
</li><li>Как тестировать входящие письма.
</li></ul>
<hr>
<h3 id='chto-takoe-action-mailbox' class='inside_page_header'><a href="#chto-takoe-action-mailbox">1.</a> Что такое Action Mailbox?</h3><p>Action Mailbox маршрутизирует входящие письма в подобные контроллеру ящики для обработки в Rails. Он поставляется с ингрессом для Mailgun, Mandrill, Postmark и SendGrid. Также можно обрабатывать входящие письма напрямую, с помощью встроенных ингрессов Exim, Postfix и Qmail.</p><p>Входящие письма преобразуются в записи <code>InboundEmail</code> с помощью Active Record и отслеживания жизненного цикла, оригинальные письма хранятся в облачном хранилище с помощью Active Storage, и данные обрабатываются с последующим их уничтожением по умолчанию.</p><p>Эти входящие письма асинхронно маршрутизируются с помощью Active Job на один или несколько выделенных ящиков, которые способны непосредственно взаимодействовать с остальной частью вашей доменной модели.</p><h3 id='nastroyka' class='inside_page_header'><a href="#nastroyka">2.</a> Настройка</h3><p>Установите миграции, необходимые для <code>InboundEmail</code>, и убедитесь, что Active Storage настроен:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>action_mailbox:install
<span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>db:migrate
</code></pre>
</div>
<h3 id='konfiguratsiya' class='inside_page_header'><a href="#konfiguratsiya">3.</a> Конфигурация</h3><h4 id='exim' class='inside_page_header'><a href="#exim">3.1.</a> Exim</h4><p>Сообщите Action Mailbox принимать письма от релея SMTP:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/environments/production.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailbox</span><span class="p">.</span><span class="nf">ingress</span> <span class="o">=</span> <span class="ss">:relay</span>
</code></pre>
</div>
<p>Сгенерируйте сложный пароль, который Action Mailbox может использовать для аутентификации запросов к ингрессу релея.</p><p>Используйте <code>bin/rails credentials:edit</code> чтобы добавить пароль в зашифрованные учетные данные вашего приложения под именем <code>action_mailbox.ingress_password</code>, по которому Action Mailbox автоматически найдет его:</p><div class="code_container">
  <pre><code class="highlight yaml"><span class="na">action_mailbox</span><span class="pi">:</span>
  <span class="na">ingress_password</span><span class="pi">:</span> <span class="s">...</span>
</code></pre>
</div>
<p>Альтернативно можно предоставить пароль в переменной среды <code>RAILS_INBOUND_EMAIL_PASSWORD</code>.</p><p>Настройте Exim передавать входящие письма в <code>bin/rails action_mailbox:ingress:exim</code>, предоставив <code>URL</code> ингресса релея и <code>INGRESS_PASSWORD</code>, созданный ранее. Если ваше приложение находится по адресу <code>https://example.com</code>, полная команда будет выглядеть так:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>action_mailbox:ingress:exim <span class="nv">URL</span><span class="o">=</span>https://example.com/rails/action_mailbox/relay/inbound_emails <span class="nv">INGRESS_PASSWORD</span><span class="o">=</span>...
</code></pre>
</div>
<h4 id='mailgun' class='inside_page_header'><a href="#mailgun">3.2.</a> Mailgun</h4><p>Передайте Action Mailbox ваш ключ Mailgun Signing (который можно найти в Settings -&gt; Security &amp; Users -&gt; API security в Mailgun), таким образом он сможет аутентифицировать запросы к ингрессу Mailgun.</p><p>Используйте <code>bin/rails credentials:edit</code>, чтобы добавить ключ Signing в зашифрованные учетные данные вашего приложения под именем <code>action_mailbox.mailgun_signing_key</code>, по которому Action Mailbox автоматически найдет его:</p><div class="code_container">
  <pre><code class="highlight yaml"><span class="na">action_mailbox</span><span class="pi">:</span>
  <span class="na">mailgun_signing_key</span><span class="pi">:</span> <span class="s">...</span>
</code></pre>
</div>
<p>Альтернативно можно предоставить ключ Signing в переменной среды <code>MAILGUN_INGRESS_SIGNING_KEY</code>.</p><p>Сообщите Action Mailbox принимать письма от Mailgun:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/environments/production.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailbox</span><span class="p">.</span><span class="nf">ingress</span> <span class="o">=</span> <span class="ss">:mailgun</span>
</code></pre>
</div>
<p><a href="https://documentation.mailgun.com/en/latest/user_manual.html#receiving-forwarding-and-storing-messages">Настройте Mailgun</a>
перенаправлять входящие письма в <code>/rails/action_mailbox/mailgun/inbound_emails/mime</code>. Если ваше приложение находится по адресу <code>https://example.com</code>, нужно указать полный URL <code>https://example.com/rails/action_mailbox/mailgun/inbound_emails/mime</code>.</p><h4 id='mandrill' class='inside_page_header'><a href="#mandrill">3.3.</a> Mandrill</h4><p>Передайте Action Mailbox ваш ключ Mandrill API, таким образом он сможет аутентифицировать запросы к ингрессу Mandrill.</p><p>Используйте <code>bin/rails credentials:edit</code> чтобы добавить ключ API в зашифрованные учетные данные вашего приложения под именем <code>action_mailbox.mandrill_api_key</code>, по которому Action Mailbox автоматически найдет его:</p><div class="code_container">
  <pre><code class="highlight yaml"><span class="na">action_mailbox</span><span class="pi">:</span>
  <span class="na">mandrill_api_key</span><span class="pi">:</span> <span class="s">...</span>
</code></pre>
</div>
<p>Альтернативно можно предоставить ключ API в переменной среды <code>MANDRILL_INGRESS_API_KEY</code>.</p><p>Сообщите Action Mailbox принимать письма от Mandrill:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/environments/production.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailbox</span><span class="p">.</span><span class="nf">ingress</span> <span class="o">=</span> <span class="ss">:mandrill</span>
</code></pre>
</div>
<p><a href="https://mandrill.zendesk.com/hc/en-us/articles/205583197-Inbound-Email-Processing-Overview">Настройте Mandrill</a> перенаправлять входящие письма в <code>/rails/action_mailbox/mandrill/inbound_emails</code>. Если ваше приложение находится по адресу <code>https://example.com</code>, нужно указать полный URL <code>https://example.com/rails/action_mailbox/mandrill/inbound_emails</code>.</p><h4 id='postfix' class='inside_page_header'><a href="#postfix">3.4.</a> Postfix</h4><p>Сообщите Action Mailbox принимать письма от релея SMTP:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/environments/production.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailbox</span><span class="p">.</span><span class="nf">ingress</span> <span class="o">=</span> <span class="ss">:relay</span>
</code></pre>
</div>
<p>Сгенерируйте сложный пароль, который Action Mailbox может использовать для аутентификации запросов к ингрессу релея.</p><p>Используйте <code>bin/rails credentials:edit</code> чтобы добавить пароль в зашифрованные учетные данные вашего приложения под именем <code>action_mailbox.ingress_password</code>, по которому Action Mailbox автоматически найдет его:</p><div class="code_container">
  <pre><code class="highlight yaml"><span class="na">action_mailbox</span><span class="pi">:</span>
  <span class="na">ingress_password</span><span class="pi">:</span> <span class="s">...</span>
</code></pre>
</div>
<p>Альтернативно можно предоставить пароль в переменной среды <code>RAILS_INBOUND_EMAIL_PASSWORD</code>.</p><p><a href="https://serverfault.com/questions/258469/how-to-configure-postfix-to-pipe-all-incoming-email-to-a-script">Настройте Postfix</a> передавать входящие письма в <code>bin/rails action_mailbox:ingress:postfix</code>, предоставив <code>URL</code> ингресса релея и <code>INGRESS_PASSWORD</code>, созданный ранее. Если ваше приложение находится по адресу <code>https://example.com</code>, полная команда будет выглядеть так:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>action_mailbox:ingress:postfix <span class="nv">URL</span><span class="o">=</span>https://example.com/rails/action_mailbox/relay/inbound_emails <span class="nv">INGRESS_PASSWORD</span><span class="o">=</span>...
</code></pre>
</div>
<h4 id='postmark' class='inside_page_header'><a href="#postmark">3.5.</a> Postmark</h4><p>Сообщите Action Mailbox принимать письма от Postmark:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/environments/production.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailbox</span><span class="p">.</span><span class="nf">ingress</span> <span class="o">=</span> <span class="ss">:postmark</span>
</code></pre>
</div>
<p>Сгенерируйте сложный пароль, который Action Mailbox может использовать для аутентификации запросов к ингрессу Postmark.</p><p>Используйте <code>bin/rails credentials:edit</code> чтобы добавить пароль в зашифрованные учетные данные вашего приложения под именем <code>action_mailbox.ingress_password</code>, по которому Action Mailbox автоматически найдет его:</p><div class="code_container">
  <pre><code class="highlight yaml"><span class="na">action_mailbox</span><span class="pi">:</span>
  <span class="na">ingress_password</span><span class="pi">:</span> <span class="s">...</span>
</code></pre>
</div>
<p>Альтернативно можно предоставить пароль в переменной среды <code>RAILS_INBOUND_EMAIL_PASSWORD</code>.</p><p><a href="https://postmarkapp.com/manual#configure-your-inbound-webhook-url">Настройте веб-хук входящих Postmark</a>, чтобы перенаправлять входящие письма в <code>/rails/action_mailbox/postmark/inbound_emails</code> с именем пользователя <code>actionmailbox</code> и созданным ранее паролем. Если ваше приложение находится по адресу <code>https://example.com</code>, нужно указать в настройках Postmark следующий полный URL:</p><div class="code_container">
  <pre><code class="highlight plaintext">https://actionmailbox:PASSWORD@example.com/rails/action_mailbox/postmark/inbound_emails
</code></pre>
</div>
<div class="note"><p>При настройке веб-хука входящих Postmark, убедитесь, что вы включили <strong>&quot;Include raw email content in JSON payload&quot;</strong>.
Action Mailbox нужно исходное содержимое email для работы.</p></div><h4 id='qmail' class='inside_page_header'><a href="#qmail">3.6.</a> Qmail</h4><p>Сообщите Action Mailbox принимать письма от релея SMTP:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/environments/production.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailbox</span><span class="p">.</span><span class="nf">ingress</span> <span class="o">=</span> <span class="ss">:relay</span>
</code></pre>
</div>
<p>Сгенерируйте сложный пароль, который Action Mailbox может использовать для аутентификации запросов к ингрессу релея.</p><p>Используйте <code>bin/rails credentials:edit</code> чтобы добавить пароль в зашифрованные учетные данные вашего приложения под именем <code>action_mailbox.ingress_password</code>, по которому Action Mailbox автоматически найдет его:</p><div class="code_container">
  <pre><code class="highlight yaml"><span class="na">action_mailbox</span><span class="pi">:</span>
  <span class="na">ingress_password</span><span class="pi">:</span> <span class="s">...</span>
</code></pre>
</div>
<p>Альтернативно можно предоставить пароль в переменной среды <code>RAILS_INBOUND_EMAIL_PASSWORD</code>.</p><p>Настройте Qmail передавать входящие письма в <code>bin/rails action_mailbox:ingress:qmail</code>, предоставив <code>URL</code> ингресса релея и <code>INGRESS_PASSWORD</code>, созданный ранее. Если ваше приложение находится по адресу <code>https://example.com</code>, полная команда будет выглядеть так:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>action_mailbox:ingress:qmail <span class="nv">URL</span><span class="o">=</span>https://example.com/rails/action_mailbox/relay/inbound_emails <span class="nv">INGRESS_PASSWORD</span><span class="o">=</span>...
</code></pre>
</div>
<h4 id='sendgrid' class='inside_page_header'><a href="#sendgrid">3.7.</a> SendGrid</h4><p>Сообщите Action Mailbox принимать письма от SendGrid:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># config/environments/production.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailbox</span><span class="p">.</span><span class="nf">ingress</span> <span class="o">=</span> <span class="ss">:sendgrid</span>
</code></pre>
</div>
<p>Сгенерируйте сложный пароль, который Action Mailbox может использовать для аутентификации запросов к ингрессу SendGrid.</p><p>Используйте <code>bin/rails credentials:edit</code> чтобы добавить пароль в зашифрованные учетные данные вашего приложения под именем <code>action_mailbox.ingress_password</code>, по которому Action Mailbox автоматически найдет его:</p><div class="code_container">
  <pre><code class="highlight yaml"><span class="na">action_mailbox</span><span class="pi">:</span>
  <span class="na">ingress_password</span><span class="pi">:</span> <span class="s">...</span>
</code></pre>
</div>
<p>Альтернативно можно предоставить пароль в переменной среды <code>RAILS_INBOUND_EMAIL_PASSWORD</code>.</p><p><a href="https://sendgrid.com/docs/for-developers/parsing-email/setting-up-the-inbound-parse-webhook/">Настройте SendGrid Inbound Parse</a> передавать входящие письма в <code>/rails/action_mailbox/sendgrid/inbound_emails</code> с именем пользователя <code>actionmailbox</code> и ранее созданным паролем. Если ваше приложение находится по адресу <code>https://example.com</code>, нужно настроить SendGrid следующим URL:</p><div class="code_container">
  <pre><code class="highlight plaintext">https://actionmailbox:PASSWORD@example.com/rails/action_mailbox/sendgrid/inbound_emails
</code></pre>
</div>
<div class="note"><p>При настройке веб хука SendGrid Inbound Parse, убедитесь, что включили флажок с надписью <strong>“Post the raw, full MIME message.”</strong> Action Mailbox для работы требует исходное сообщение MIME.</p></div><h3 id='primery' class='inside_page_header'><a href="#primery">4.</a> Примеры</h3><p>Настройте простой роутинг:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/mailboxes/application_mailbox.rb</span>
<span class="k">class</span> <span class="nc">ApplicationMailbox</span> <span class="o">&lt;</span> <span class="no">ActionMailbox</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">routing</span> <span class="sr">/^save@/i</span>     <span class="o">=&gt;</span> <span class="ss">:forwards</span>
  <span class="n">routing</span> <span class="sr">/@replies\./i</span> <span class="o">=&gt;</span> <span class="ss">:replies</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Затем настройте почтовый ящик:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">#</span><span class="w"> </span>Создайте новый почтовый ящик
<span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate mailbox forwards
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># app/mailboxes/forwards_mailbox.rb</span>
<span class="k">class</span> <span class="nc">ForwardsMailbox</span> <span class="o">&lt;</span> <span class="no">ApplicationMailbox</span>
  <span class="c1"># Колбэки, указывающие предусловия обработки</span>
  <span class="n">before_processing</span> <span class="ss">:require_projects</span>

  <span class="k">def</span> <span class="nf">process</span>
    <span class="c1"># Запишите перенаправление на единственный проект, или…</span>
    <span class="k">if</span> <span class="n">forwarder</span><span class="p">.</span><span class="nf">projects</span><span class="p">.</span><span class="nf">one?</span>
      <span class="n">record_forward</span>
    <span class="k">else</span>
      <span class="c1"># …вовлеките второй Action Mailer, чтобы спросить, в какой проект это нужно направить.</span>
      <span class="n">request_forwarding_project</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">require_projects</span>
      <span class="k">if</span> <span class="n">forwarder</span><span class="p">.</span><span class="nf">projects</span><span class="p">.</span><span class="nf">none?</span>
        <span class="c1"># Мспользуйте Action Mailers для возврата входящих писем отправителю – это прервет обработку</span>
        <span class="n">bounce_with</span> <span class="no">Forwards</span><span class="o">::</span><span class="no">BounceMailer</span><span class="p">.</span><span class="nf">no_projects</span><span class="p">(</span><span class="n">inbound_email</span><span class="p">,</span> <span class="ss">forwarder: </span><span class="n">forwarder</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">record_forward</span>
      <span class="n">forwarder</span><span class="p">.</span><span class="nf">forwards</span><span class="p">.</span><span class="nf">create</span> <span class="ss">subject: </span><span class="n">mail</span><span class="p">.</span><span class="nf">subject</span><span class="p">,</span> <span class="ss">content: </span><span class="n">mail</span><span class="p">.</span><span class="nf">content</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">request_forwarding_project</span>
      <span class="no">Forwards</span><span class="o">::</span><span class="no">RoutingMailer</span><span class="p">.</span><span class="nf">choose_project</span><span class="p">(</span><span class="n">inbound_email</span><span class="p">,</span> <span class="ss">forwarder: </span><span class="n">forwarder</span><span class="p">).</span><span class="nf">deliver_now</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">forwarder</span>
      <span class="vi">@forwarder</span> <span class="o">||=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">email_address: </span><span class="n">mail</span><span class="p">.</span><span class="nf">from</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<h3 id='unichtozhenie-inboundemails' class='inside_page_header'><a href="#unichtozhenie-inboundemails">5.</a> Уничтожение InboundEmails</h3><p>По умолчанию InboundEmail, которое было успешно обработано, будет уничтожено через 30 дней. Это удостоверяет, что вы не храните данные людей вынужденно, после того, как они могли закрыть свой аккаунт или удалить свое содержимое. Цель в том, что после обработки письма, вы должны извлечь все нужные данные и преобразовать их в модели домена и содержимое на вашей стороне в приложении. InboundEmail просто остается в системе на некоторое время для предоставления возможности отладки и криминалистики.</p><p>Фактическое уничтожение выполняется с помощью <code>IncinerationJob</code>, которая запланирована на запуск через <a href="/configuring#config-action-mailbox-incinerate-after"><code>config.action_mailbox.incinerate_after</code></a>. Это значение по умолчанию установлено <code>30.days</code>, но его можно изменить в настройках production.rb. (Отметьте, что это планируемое будущее уничтожение полагается на возможность вашей очереди задач хранить задачи на такой промежуток времени.)</p><h3 id='rabota-s-action-mailbox-pri-razrabotke' class='inside_page_header'><a href="#rabota-s-action-mailbox-pri-razrabotke">6.</a> Работа с Action Mailbox при разработке</h3><p>Полезно иметь возможность тестирования входящих писем при разработке без фактического отправления и получения реальных писем. Для этого есть вспомогательный контроллер, смонтированный на <code>/rails/conductor/action_mailbox/inbound_emails</code>, дающий перечень всех InboundEmail в системе, состояние их обработки, а также форму для создания нового InboundEmail.</p><h3 id='testirovanie-pochtovyh-yaschikov' class='inside_page_header'><a href="#testirovanie-pochtovyh-yaschikov">7.</a> Тестирование почтовых ящиков</h3><p>Пример:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ForwardsMailboxTest</span> <span class="o">&lt;</span> <span class="no">ActionMailbox</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"directly recording a client forward for a forwarder and forwardee corresponding to one project"</span> <span class="k">do</span>
    <span class="n">assert_difference</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">people</span><span class="p">(</span><span class="ss">:david</span><span class="p">).</span><span class="nf">buckets</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">recordings</span><span class="p">.</span><span class="nf">count</span> <span class="p">}</span> <span class="k">do</span>
      <span class="n">receive_inbound_email_from_mail</span> <span class="p">\</span>
        <span class="ss">to: </span><span class="s1">'save@example.com'</span><span class="p">,</span>
        <span class="ss">from: </span><span class="n">people</span><span class="p">(</span><span class="ss">:david</span><span class="p">).</span><span class="nf">email_address</span><span class="p">,</span>
        <span class="ss">subject: </span><span class="s2">"Fwd: Status update?"</span><span class="p">,</span>
        <span class="ss">body: </span><span class="o">&lt;&lt;~</span><span class="no">BODY</span><span class="sh">
          --- Begin forwarded message ---
          From: Frank Holland &lt;frank@microsoft.com&gt;

          What's the status?
</span><span class="no">        BODY</span>
    <span class="k">end</span>

    <span class="n">recording</span> <span class="o">=</span> <span class="n">people</span><span class="p">(</span><span class="ss">:david</span><span class="p">).</span><span class="nf">buckets</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">recordings</span><span class="p">.</span><span class="nf">last</span>
    <span class="n">assert_equal</span> <span class="n">people</span><span class="p">(</span><span class="ss">:david</span><span class="p">),</span> <span class="n">recording</span><span class="p">.</span><span class="nf">creator</span>
    <span class="n">assert_equal</span> <span class="s2">"Status update?"</span><span class="p">,</span> <span class="n">recording</span><span class="p">.</span><span class="nf">forward</span><span class="p">.</span><span class="nf">subject</span>
    <span class="n">assert_match</span> <span class="s2">"What's the status?"</span><span class="p">,</span> <span class="n">recording</span><span class="p">.</span><span class="nf">forward</span><span class="p">.</span><span class="nf">content</span><span class="p">.</span><span class="nf">to_s</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>За остальными тестовыми вспомогательными методами обратитесь к <a href="https://api.rubyonrails.org/classes/ActionMailbox/TestHelper.html">ActionMailbox::TestHelper API</a>.</p>

            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

   <!-- bottom rusrails -->
   <ins class="adsbygoogle"
        style="display:inline-block;width:580px;height:400px"
        data-ad-client="ca-pub-7764391801669990"
        data-ad-slot="7566253867"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
        </div>
        <div class="row-fluid">
          <div class="span12" id="footer">
            <p>
              <a target="blank" href="https://github.com/rusrails/rusrails"><img src="/assets/github-7cc23602a5ac2465f14c19492358a5a67dc24636761cc723e4d621cea0c09225.png" /></a>
              <a target="blank" href="http://twitter.com/rusrails"><img src="/assets/twitter-50e0e767c8793dec313a7dc5cfbcfe2067e3e89ea6ec64784eb7c6640f578758.png" /></a>
            </p>
            <p>
              <a href="https://creativecommons.org/licenses/by-sa/4.0/">Лицензия CC BY-SA 4.0</a>
              "Rails", "Ruby on Rails" и логотип Rails - торговые марки DHH
              <!-- Yandex.Metrika counter -->
<script>
  (function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter1006929 = new Ya.Metrika({id:1006929,
                    webvisor:true,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true});
        } catch(e) { }
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>

<noscript>
  <div>
    <img style="position:absolute; left:-9999px;" alt="" src="//mc.yandex.ru/watch/1006929" />
  </div>
</noscript>
<!-- /Yandex.Metrika counter -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64955373-1', 'auto');
  ga('send', 'pageview');

  var trackOutboundLink = function(url) {
    ga('send', 'event', 'outbound', 'click', url, {
      'transport': 'beacon',
      'hitCallback': function(){ }
    });
  }
</script>

            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="to_top" style="display: block">
      <div class="to_top_panel"></div>
    </div>
    <script src="/assets/application-8ee447905888b153d8458707061a14b1f15f69b6733e871a3ad91d80ae89e87b.js"></script>
  </body>
</html>
