<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8">
<meta content="Ruby on Rails, Ruby, Rails, Rails 3, Rails 4, Rails 5, Rails 6, Rails 6.0, Rails 6.1, Rails 7.0, Rails 7.1 руководство, начинающим, самоучитель, manual, мануал, справочник, учебник, примеры, Руби, рельсы" name="keywords"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" name="description"/>
<meta content="product" property="twitter:card"/>
<meta content="@rusrails" property="twitter:site"/>
<meta content="Rusrails: Связи (ассоциации) Active Record" property="twitter:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="twitter:description"/>
<meta content="@rusrails" property="twitter:creator"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="twitter:image"/>
<meta content="website" property="og:type"/>
<meta content="Rusrails: Связи (ассоциации) Active Record" property="og:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="og:description"/>
<meta content="http://localhost:3000/active-record-associations" property="og:url"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="og:image"/>
    <title>
      Rusrails: Связи (ассоциации) Active Record
    </title>
    <link rel="stylesheet" media="screen" href="/assets/application-4f65588939909a694017a295c9ca934821f6a6358454c26c5360579d7ee0054d.css" />
    <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="SCE5WkVndNDqQgJeP8Rm3GoGMFVIEO0bx9On+P+elDzeQAMTxNtVklncTrwNpU2b+ciwymiwaIaf/WMEhADGbA==" />
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="/"></a>
          <form class="navbar-search pull-right" action="/search" accept-charset="UTF-8" method="get">
            <input type="text" name="search" id="search" class="search-query" placeholder="Поиск.." />
</form>          <ul class="nav pull-right top-menu">
            <li>
              <a href="/">Главная</a>
            </li>
            <li class="dropdown">
              <a class="index-popover" href="#">
                Содержание
                <b class="caret"></b>
</a>              <div class="index-popover-content hide">
                  <ul><li><p><strong>С чего начать?</strong></p><ul><li><a href="/getting-started">Rails для начинающих</a>
</li></ul></li><li><p><strong>Модели</strong></p><ul><li><a href="/active-record-basics">Основы Active Record</a>
</li><li><a href="/active-record-migrations">Миграции Active Record</a>
</li><li><a href="/active-record-validations">Валидации Active Record</a>
</li><li><a href="/active-record-callbacks">Колбэки Active Record</a>
</li><li><a href="/active-record-associations">Связи (ассоциации) Active Record</a>
</li><li><a href="/active-record-querying">Интерфейс запросов Active Record</a>
</li><li><a href="/active-model-basics">Основы Active Model</a>
</li></ul></li><li><p><strong>Вью</strong></p><ul><li><a href="/action-view-overview">Обзор Action View</a>
</li><li><a href="/layouts-and-rendering">Макеты и рендеринг в Rails</a>
</li><li><a href="/action-view-helpers">Хелперы Action View</a>
</li><li><a href="/form-helpers">Хелперы форм в Action View</a>
</li></ul></li><li><p><strong>Контроллеры</strong></p><ul><li><a href="/action-controller-overview">Обзор Action Controller</a>
</li><li><a href="/routing">Роутинг в Rails</a>
</li></ul></li><li><p><strong>Другие компоненты</strong></p><ul><li><a href="/active-support-core-extensions">Расширения ядра Active Support</a>
</li><li><a href="/action-mailer-basics">Основы Action Mailer</a>
</li><li><a href="/action-mailbox-basics">Основы Action Mailbox</a>
</li><li><a href="/action-text-overview">Обзор Action Text</a>
</li><li><a href="/active_job_basics">Основы Active Job</a>
</li><li><a href="/active_storage_overview">Обзор Active Storage</a>
</li><li><a href="/action-cable-overview">Обзор Action Cable</a>
</li></ul></li><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/i18n">API интернационализации Rails (I18n)</a>
</li><li><a href="/testing">Тестирование приложений на Rails</a>
</li><li><a href="/security">Безопасность приложений на Rails</a>
</li><li><a href="/error-reporting">Отчет об ошибках в приложениях Rails</a>
</li></ul></li></ul><p>next_column</p><ul><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/debugging-rails-applications">Отладка приложений на Rails</a>
</li><li><a href="/configuring">Конфигурирование приложений на Rails</a>
</li><li><a href="/command-line">Командная строка Rails</a>
</li><li><a href="/asset-pipeline">Asset Pipeline</a>
</li><li><a href="/working-with-javascript-in-rails">Работа с JavaScript в Rails</a>
</li><li><a href="/initialization">Процесс инициализации в Rails</a>
</li><li><a href="/autoloading-and-reloading-constants">Автозагрузка и перезагрузка констант</a>
</li><li><a href="/classic-to-zeitwerk-howto">Как перейти с Classic на Zeitwerk</a>
</li><li><a href="/caching-with-rails">Кэширование с Rails: Обзор</a>
</li><li><a href="/active-support-instrumentation">Инструментарий Active Support</a>
</li><li><a href="/api-app">Использование Rails для API-приложений</a>
</li><li><a href="/active-record-postgresql">Active Record для PostgreSQL</a>
</li><li><a href="/active-record-multiple-databases">Несколько баз данных с Active Record</a>
</li><li><a href="/active-record-encryption">Шифрование Active Record</a>
</li></ul></li><li><p><strong>Расширяем Rails</strong></p><ul><li><a href="/plugins">Основы создания плагинов Rails</a>
</li><li><a href="/rails-on-rack">Rails on Rack</a>
</li><li><a href="/generators">Создание и настройка генераторов и шаблонов Rails</a>
</li><li><a href="/engines">Engine для начинающих</a>
</li><li><a href="/threading_and_code_execution">Треды и выполнение кода в Rails</a>
</li><li><a href="/rails-application-templates">Шаблоны приложения Rails</a>
</li></ul></li><li><p><strong>Вносим вклад в Ruby on Rails</strong></p><ul><li><a href="/contributing_to_ruby_on_rails">Вносим вклад в Ruby on Rails</a>
</li><li><a href="/api_documentation_guidelines">Рекомендации по документированию API</a>
</li><li><a href="/ruby_on_rails_guides_guidelines">Рекомендации для руководств по Ruby on Rails</a>
</li><li><a href="/development_dependencies_install">Установка зависимостей для разработки</a>
</li><li><a href="/maintenance-policy">Политика поддержки (версий)</a>
</li></ul></li><li><p><strong>Заметки о релизах</strong></p><ul><li><a href="/upgrading-ruby-on-rails">Апгрейд Ruby on Rails</a>
</li><li><a href="/7_1_release_notes">Версия 7.1 - ?</a>
</li><li><a href="/7_0_release_notes">Версия 7.0 - Декабрь 2021</a>
</li><li><a href="/6_1_release_notes">Версия 6.1 - Декабрь 2020</a>
</li><li><a href="/6_0_release_notes">Версия 6.0 - Август 2019</a>
</li></ul></li></ul>
              </div>
            </li>
            <li>
              <a target="blank" href="http://api.rusrails.ru">Ruby &amp; Rails API</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="content-wrapper">
      <div class="container-fluid">
        <div class="row-fluid">
          <div class="span3 pull-right">
            <div class="well social">
              <h4>Принимаем пожелания и пул-реквесты!</h4>
              <iframe allowtransparency="true" frameborder="0" height="30" src="http://ghbtns.com/github-btn.html?user=rusrails&repo=rusrails&type=watch&count=true&size=large" width="180"></iframe>
              <p></p>
              <a class="twitter-follow-button" data-lang="ru" href="https://twitter.com/rusrails"></a>
            </div>
              <div class="well menu">
                    <ul class="nav nav-list">
      <li>
        <h4>
          <a href="#zachem-nuzhny-svyazi">1. Зачем нужны связи?</a>
</h4>      </li>
      <li>
        <h4>
          <a href="#tipy-svyazey">2. Типы связей</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#svyaz-belongs_to">2.1. Связь <code>belongs_to</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#svyaz-has_one">2.2. Связь <code>has_one</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#svyaz-has_many">2.3. Связь <code>has_many</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#the-has-many-through-association">2.4.  Связь <code>has_many :through</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#the-has-one-through-association">2.5.  Связь <code>has_one :through</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#svyaz-has_and_belongs_to_many">2.6. Связь <code>has_and_belongs_to_many</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#vybor-mezhdu-belongs_to-i-has_one">2.7. Выбор между <code>belongs_to</code> и <code>has_one</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#vybor-mezhdu-has_many-through-i-has_and_belongs_to_many">2.8. Выбор между <code>has_many :through</code> и <code>has_and_belongs_to_many</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#polymorphic-associations">2.9.  Полиморфные связи</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#prisoedinenie-k-sebe">2.10. Присоединение к себе</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#poleznye-sovety-i-preduprezhdeniya">3. Полезные советы и предупреждения</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#upravlenie-keshirovaniem">3.1. Управление кэшированием</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#predotvraschenie-kolliziy-imen">3.2. Предотвращение коллизий имен</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#obnovlenie-shemy">3.3. Обновление схемы</a>
</h5>      </li>
      <li>
        <h6>
          <a href="#sozdanie-vneshnih-klyuchey-dlya-svyazey-belongs_to">3.3.1. Создание внешних ключей для связей <code>belongs_to</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#sozdanie-soedinitelnyh-tablits-dlya-svyazey-has_and_belongs_to_many">3.3.2. Создание соединительных таблиц для связей <code>has_and_belongs_to_many</code></a>
</h6>      </li>
      <li>
        <h5>
          <a href="#upravlenie-oblastyu-vidimosti-svyazey">3.4. Управление областью видимости связей</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#bi-directional-associations">3.5.  Двунаправленные связи</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#podrobnaya-informatsiya-po-svyazi-belongs_to">4. Подробная информация по связи <code>belongs_to</code></a>
</h4>      </li>
      <li>
        <h5>
          <a href="#metody-dobavlyaemye-belongs_to">4.1. Методы, добавляемые <code>belongs_to</code></a>
</h5>      </li>
      <li>
        <h6>
          <a href="#association">4.1.1. <code>association</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#association-associate">4.1.2. <code>association=(associate)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#build_association-attributes">4.1.3. <code>build_association(attributes = {})</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#create_association-attributes">4.1.4. <code>create_association(attributes = {})</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#create_association-attributes2">4.1.5. <code>create_association!(attributes = {})</code></a>
</h6>      </li>
      <li>
        <h7>
          <a href="#association_changed">4.1.5.1. <code>association_changed?</code></a>
</h7>      </li>
      <li>
        <h7>
          <a href="#association_previously_changed">4.1.5.2. <code>association_previously_changed?</code></a>
</h7>      </li>
      <li>
        <h5>
          <a href="#options-for-belongs-to">4.2.  Опции для <code>belongs_to</code></a>
</h5>      </li>
      <li>
        <h6>
          <a href="#autosave">4.2.1. <code>:autosave</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#class_name">4.2.2. <code>:class_name</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#counter_cache">4.2.3. <code>:counter_cache</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#dependent">4.2.4. <code>:dependent</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#foreign_key">4.2.5. <code>:foreign_key</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#primary_key">4.2.6. <code>:primary_key</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#inverse_of">4.2.7. <code>:inverse_of</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#polymorphic">4.2.8. <code>:polymorphic</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#touch">4.2.9. <code>:touch</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#validate">4.2.10. <code>:validate</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#optional">4.2.11. <code>:optional</code></a>
</h6>      </li>
      <li>
        <h5>
          <a href="#skoupy-dlya-belongs_to">4.3. Скоупы для <code>belongs_to</code></a>
</h5>      </li>
      <li>
        <h6>
          <a href="#where">4.3.1. <code>where</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#includes">4.3.2. <code>includes</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#readonly">4.3.3. <code>readonly</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#select">4.3.4. <code>select</code></a>
</h6>      </li>
      <li>
        <h5>
          <a href="#suschestvuyut-li-svyazannye-ob-ekty">4.4. Существуют ли связанные объекты?</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#kogda-sohranyayutsya-ob-ekty">4.5. Когда сохраняются объекты?</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#podrobnaya-informatsiya-po-svyazi-has_one">5. Подробная информация по связи <code>has_one</code></a>
</h4>      </li>
      <li>
        <h5>
          <a href="#metody-dobavlyaemye-has_one">5.1. Методы, добавляемые <code>has_one</code></a>
</h5>      </li>
      <li>
        <h6>
          <a href="#association2">5.1.1. <code>association</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#association-associate2">5.1.2. <code>association=(associate)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#build_association-attributes2">5.1.3. <code>build_association(attributes = {})</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#create_association-attributes3">5.1.4. <code>create_association(attributes = {})</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#create_association-attributes4">5.1.5. <code>create_association!(attributes = {})</code></a>
</h6>      </li>
      <li>
        <h5>
          <a href="#optsii-dlya-has_one">5.2. Опции для <code>has_one</code></a>
</h5>      </li>
      <li>
        <h6>
          <a href="#as">5.2.1. <code>:as</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#autosave2">5.2.2. <code>:autosave</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#class_name2">5.2.3. <code>:class_name</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#dependent2">5.2.4. <code>:dependent</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#foreign_key2">5.2.5. <code>:foreign_key</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#inverse_of2">5.2.6. <code>:inverse_of</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#primary_key2">5.2.7. <code>:primary_key</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#source">5.2.8. <code>:source</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#source_type">5.2.9. <code>:source_type</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#through">5.2.10. <code>:through</code></a>
</h6>      </li>
      <li>
        <h7>
          <a href="#touch2">5.2.10.1. <code>:touch</code></a>
</h7>      </li>
      <li>
        <h6>
          <a href="#validate2">5.2.11. <code>:validate</code></a>
</h6>      </li>
      <li>
        <h5>
          <a href="#skoupy-dlya-has_one">5.3. Скоупы для <code>has_one</code></a>
</h5>      </li>
      <li>
        <h6>
          <a href="#where2">5.3.1. <code>where</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#includes2">5.3.2. <code>includes</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#readonly2">5.3.3. <code>readonly</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#select2">5.3.4. <code>select</code></a>
</h6>      </li>
      <li>
        <h5>
          <a href="#suschestvuyut-li-svyazannye-ob-ekty2">5.4. Существуют ли связанные объекты?</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#kogda-sohranyayutsya-ob-ekty2">5.5. Когда сохраняются объекты?</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#has-many-association-reference">6.  Подробная информация по связи <code>has_many</code></a>
</h4>      </li>
      <li>
        <h5>
          <a href="#metody-dobavlyaemye-has_many">6.1. Методы, добавляемые <code>has_many</code></a>
</h5>      </li>
      <li>
        <h6>
          <a href="#collection">6.1.1. <code>collection</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-lt-lt-object">6.1.2. <code>collection&lt;&lt;(object, ...)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-delete-object">6.1.3. <code>collection.delete(object, ...)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-destroy-object">6.1.4. <code>collection.destroy(object, ...)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-objects">6.1.5. <code>collection=(objects)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection_singular_ids">6.1.6. <code>collection_singular_ids</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection_singular_ids-ids">6.1.7. <code>collection_singular_ids=(ids)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-clear">6.1.8. <code>collection.clear</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-empty">6.1.9. <code>collection.empty?</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-size">6.1.10. <code>collection.size</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-find">6.1.11. <code>collection.find(...)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-where">6.1.12. <code>collection.where(...)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-exists">6.1.13. <code>collection.exists?(...)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-build-attributes">6.1.14. <code>collection.build(attributes = {})</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-create-attributes">6.1.15. <code>collection.create(attributes = {})</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-create-attributes2">6.1.16. <code>collection.create!(attributes = {})</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-reload">6.1.17. <code>collection.reload</code></a>
</h6>      </li>
      <li>
        <h5>
          <a href="#optsii-dlya-has_many">6.2. Опции для <code>has_many</code></a>
</h5>      </li>
      <li>
        <h6>
          <a href="#as2">6.2.1. <code>:as</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#autosave3">6.2.2. <code>:autosave</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#class_name3">6.2.3. <code>:class_name</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#counter_cache2">6.2.4. <code>:counter_cache</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#dependent3">6.2.5. <code>:dependent</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#foreign_key3">6.2.6. <code>:foreign_key</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#inverse_of3">6.2.7. <code>:inverse_of</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#primary_key3">6.2.8. <code>:primary_key</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#source2">6.2.9. <code>:source</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#source_type2">6.2.10. <code>:source_type</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#through2">6.2.11. <code>:through</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#validate3">6.2.12. <code>:validate</code></a>
</h6>      </li>
      <li>
        <h5>
          <a href="#skoupy-dlya-has_many">6.3. Скоупы для <code>has_many</code></a>
</h5>      </li>
      <li>
        <h6>
          <a href="#where3">6.3.1. <code>where</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#extending">6.3.2. <code>extending</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#group">6.3.3. <code>group</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#includes3">6.3.4. <code>includes</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#limit">6.3.5. <code>limit</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#offset">6.3.6. <code>offset</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#order">6.3.7. <code>order</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#readonly3">6.3.8. <code>readonly</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#select3">6.3.9. <code>select</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#distinct">6.3.10. <code>distinct</code></a>
</h6>      </li>
      <li>
        <h5>
          <a href="#kogda-sohranyayutsya-ob-ekty3">6.4. Когда сохраняются объекты?</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#podrobnaya-informatsiya-po-svyazi-has_and_belongs_to_many">7. Подробная информация по связи <code>has_and_belongs_to_many</code></a>
</h4>      </li>
      <li>
        <h5>
          <a href="#metody-dobavlyaemye-has_and_belongs_to_many">7.1. Методы, добавляемые <code>has_and_belongs_to_many</code></a>
</h5>      </li>
      <li>
        <h6>
          <a href="#dopolnitelnye-metody-stolbtsov">7.1.1. Дополнительные методы столбцов</a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection2">7.1.2. <code>collection</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-lt-lt-object2">7.1.3. <code>collection&lt;&lt;(object, ...)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-delete-object2">7.1.4. <code>collection.delete(object, ...)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-destroy-object2">7.1.5. <code>collection.destroy(object, ...)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-objects2">7.1.6. <code>collection=(objects)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection_singular_ids2">7.1.7. <code>collection_singular_ids</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection_singular_ids-ids2">7.1.8. <code>collection_singular_ids=(ids)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-clear2">7.1.9. <code>collection.clear</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-empty2">7.1.10. <code>collection.empty?</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-size2">7.1.11. <code>collection.size</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-find2">7.1.12. <code>collection.find(...)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-where2">7.1.13. <code>collection.where(...)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-exists2">7.1.14. <code>collection.exists?(...)</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-build-attributes2">7.1.15. <code>collection.build(attributes = {})</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-create-attributes3">7.1.16. <code>collection.create(attributes = {})</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-create-attributes4">7.1.17. <code>collection.create!(attributes = {})</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#collection-reload2">7.1.18. <code>collection.reload</code></a>
</h6>      </li>
      <li>
        <h5>
          <a href="#optsii-dlya-has_and_belongs_to_many">7.2. Опции для <code>has_and_belongs_to_many</code></a>
</h5>      </li>
      <li>
        <h6>
          <a href="#association_foreign_key">7.2.1. <code>:association_foreign_key</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#autosave4">7.2.2. <code>:autosave</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#class_name4">7.2.3. <code>:class_name</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#foreign_key4">7.2.4. <code>:foreign_key</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#join_table">7.2.5. <code>:join_table</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#validate4">7.2.6. <code>:validate</code></a>
</h6>      </li>
      <li>
        <h5>
          <a href="#skoupy-dlya-has_and_belongs_to_many">7.3. Скоупы для <code>has_and_belongs_to_many</code></a>
</h5>      </li>
      <li>
        <h6>
          <a href="#where4">7.3.1. <code>where</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#extending2">7.3.2. <code>extending</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#group2">7.3.3. <code>group</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#includes4">7.3.4. <code>includes</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#limit2">7.3.5. <code>limit</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#offset2">7.3.6. <code>offset</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#order2">7.3.7. <code>order</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#readonly4">7.3.8. <code>readonly</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#select4">7.3.9. <code>select</code></a>
</h6>      </li>
      <li>
        <h6>
          <a href="#distinct2">7.3.10. <code>distinct</code></a>
</h6>      </li>
      <li>
        <h5>
          <a href="#kogda-sohranyayutsya-ob-ekty4">7.4. Когда сохраняются объекты?</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#association-callbacks-and-extensions">8.  Подробная информация по колбэкам и расширениям связи</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#kolbeki-svyazi">8.1. Колбэки связи</a>
</h5>      </li>
      <li>
        <h5>
          <a href="#rasshireniya-svyazi">8.2. Расширения связи</a>
</h5>      </li>
      <li>
        <h4>
          <a href="#nasledovanie-s-edinoy-tablitsey-sti">9. Наследование с единой таблицей (STI)</a>
</h4>      </li>
</ul>

              </div>
            <div class="well banner300 banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<!-- sidebar rusrails -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:600px"
     data-ad-client="ca-pub-7764391801669990"
     data-ad-slot="6089520660"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
          <div class="span9 content pull-left">
            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <!-- top rusrails -->
  <ins class="adsbygoogle"
       style="display:inline-block;width:980px;height:120px"
       data-ad-client="ca-pub-7764391801669990"
       data-ad-slot="4891989065"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
              <h2 id='svyazi-assotsiatsii-active-record' class='inside_page_header'> Связи (ассоциации) Active Record</h2><p>Это руководство раскрывает особенности связей Active Record.</p><p>После его прочтения, вы узнаете:</p><ul><li>Как объявлять связи между моделями Active Record.
</li><li>Как понимать различные типы связей Active Record.
</li><li>Как использовать методы, добавленные в ваши модели при создании связей.
</li></ul>
<hr>
<h3 id='zachem-nuzhny-svyazi' class='inside_page_header'><a href="#zachem-nuzhny-svyazi">1.</a> Зачем нужны связи?</h3><p>В Rails <em>связь</em> - это соединение между двумя моделями Active Record. Зачем нам нужны связи между моделями? Затем, что они позволяют сделать код для обычных операций проще и легче. Например, рассмотрим простое приложение на Rails, которое включает модель для авторов и модель для книг. Каждый автор может иметь много книг. Без связей объявление модели будет выглядеть так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Теперь, допустим, мы хотим добавить новую книгу для существующего автора. Нам нужно сделать так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">author_id: </span><span class="vi">@author</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
</code></pre>
</div>
<p>Или, допустим, удалим автора и убедимся, что все его книги также будут удалены:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">author_id: </span><span class="vi">@author</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
<span class="vi">@books</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
  <span class="n">book</span><span class="p">.</span><span class="nf">destroy</span>
<span class="k">end</span>
<span class="vi">@author</span><span class="p">.</span><span class="nf">destroy</span>
</code></pre>
</div>
<p>Со связями Active Record можно упростить эти и другие операции, декларативно сказав Rails, что имеется соединение между двумя моделями. Вот пересмотренный код для создания авторов и книг:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
</div>
<p>С этими изменениями создание новой книги для определенного автора проще:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
</code></pre>
</div>
<p>Удаление автора и всех его книг <em>намного</em> проще:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">destroy</span>
</code></pre>
</div>
<p>Чтобы узнать больше о различных типах связей, читайте следующий раздел руководства. Затем следуют некоторые полезные советы по работе со связями, а затем полное описание методов и опций для связей в Rails.</p><h3 id='tipy-svyazey' class='inside_page_header'><a href="#tipy-svyazey">2.</a> Типы связей</h3><p>Rails поддерживает шесть типов связей:</p><ul><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to"><code>belongs_to</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many :through</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one :through</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many"><code>has_and_belongs_to_many</code></a>
</li></ul><p>Связи реализуются с использованием макро-вызовов (macro-style calls), и, таким образом, вы можете декларативно добавлять возможности для своих моделей. Например, объявляя, что одна модель принадлежит (<code>belongs_to</code>) другой, вы указываете Rails сохранять информацию о <a href="https://ru.wikipedia.org/wiki/%D0%9F%D0%B5%D1%80%D0%B2%D0%B8%D1%87%D0%BD%D1%8B%D0%B9_%D0%BA%D0%BB%D1%8E%D1%87">первичном</a>-<a href="https://ru.wikipedia.org/wiki/%D0%92%D0%BD%D0%B5%D1%88%D0%BD%D0%B8%D0%B9_%D0%BA%D0%BB%D1%8E%D1%87">внешнем</a> ключах между экземплярами двух моделей, а также получаете несколько полезных методов, добавленных в модель.</p><p>После прочтения всего этого руководства, вы научитесь объявлять и использовать различные формы связей. Но сначала следует быстро ознакомиться с ситуациями, когда применим каждый тип связи.</p><h4 id='svyaz-belongs_to' class='inside_page_header'><a href="#svyaz-belongs_to">2.1.</a> Связь <code>belongs_to</code></h4><p>Связь <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to"><code>belongs_to</code></a> устанавливает соединение один-к-одному с другой моделью, когда один экземпляр объявляющей модели &quot;принадлежит&quot; одному экземпляру другой модели. Например, если в приложении есть авторы и книги, и одна книга может быть связана только с одним автором, нужно объявить модель book следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
</div>
<p><img src='/assets/association_basics/belongs_to-9920fb07a7a268b626652094ac514783eabad5106fd797f075a937834ff93a1a.png' title='' alt='Диаграмма для связи belongs_to' class='img-polaroid' /></p><div class="note"><p>Связи <code>belongs_to</code> <em>обязаны</em> использовать единственное число. Если использовать множественное число в вышеприведенном примере для связи <code>author</code> в модели <code>Book</code> и создать экземпляр с помощью <code>Book.create(authors: @author)</code>, будет сообщено &quot;uninitialized constant Book::Authors&quot;. Это так, потому что Rails автоматически получает имя класса из имени связи. Если в имени связи неправильно использовано число, то получаемый класс также будет неправильного числа.</p></div><p>Соответствующая миграция может выглядеть так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateOrders</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>При одиночном использовании, <code>belongs_to</code> создает однонаправленное соединение один-к-одному. Следовательно, в вышеприведенном примере каждая книга &quot;знает&quot; своего автора, но авторы не знают о своих книгах. Чтобы настроить <a href="#bi-directional-associations">двунаправленную связь</a> - используйте <code>belongs_to</code> в сочетании с <code>has_one</code> или <code>has_many</code> на другой модели.</p><p><code>belongs_to</code> не гарантирует ссылочной целостности, если <code>optional</code> установлен true, поэтому, в зависимости от использования, возможно, необходимо добавить ограничение внешнего ключа на столбце ссылки на уровне базы данных, подобным образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='svyaz-has_one' class='inside_page_header'><a href="#svyaz-has_one">2.2.</a> Связь <code>has_one</code></h4><p>Связь <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one</code></a> показывает, что у другой модели есть ссылка на эту модель. Та модель может быть извлечена с помощью этой связи.</p><p>Например, если каждый поставщик имеет только один аккаунт, можете объявить модель supplier подобно этому:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Главным отличием от <code>belongs_to</code> является то, что связующий столбец <code>supplier_id</code> расположен в другой таблице:</p><p><img src='/assets/association_basics/has_one-474d796d405556400b0023794819f307e6901fe7b825b11e11594a6847299cdd.png' title='' alt='Диаграмма для связи has_one' class='img-polaroid' /></p><p>Соответствующая миграция может выглядеть так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateSuppliers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>В зависимости от применения, возможно, потребуется создать индекс уникальности и/или ограничение внешнего ключа на указанный столбец таблицы accounts. В этом случае определение столбца может выглядеть так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">index: </span><span class="p">{</span> <span class="ss">unique: </span><span class="kp">true</span> <span class="p">},</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Эта связь может быть <a href="#bi-directional-associations">двунаправленной</a> при использовании в сочетании с <code>belongs_to</code> на другой модели.</p><h4 id='svyaz-has_many' class='inside_page_header'><a href="#svyaz-has_many">2.3.</a> Связь <code>has_many</code></h4><p>Связь <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many</code></a> указывает на соединение один-ко-многим с другой моделью. Эта связь часто бывает на &quot;другой стороне&quot; связи <code>belongs_to</code>. Эта связь указывает на то, что каждый экземпляр модели имеет ноль или более экземпляров другой модели. Например, в приложении, содержащем авторов и книги, модель author может быть объявлена следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="note"><p>Имя другой модели указывается во множественном числе при объявлении связи <code>has_many</code>.</p></div><p><img src='/assets/association_basics/has_many-b6fb815393a8b38888fb9ec8215a11c33913f10cff54837e2491b030cd96824e.png' title='' alt='Диаграмма для связи has_many' class='img-polaroid' /></p><p>Соответствующая миграция может выглядеть так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAuthors</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>В зависимости от применения, обычно неплохо было бы создать неуникальный индекс и опционально ограничение внешнего ключа на столбец автора для таблицы books:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='the-has-many-through-association' class='inside_page_header'><a href="#the-has-many-through-association">2.4.</a>  Связь <code>has_many :through</code></h4><p>Связь <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many :through</code></a> часто используется для настройки соединения многие-ко-многим с другой моделью. Эта связь указывает, что объявляющая модель может соответствовать нулю или более экземплярам другой модели <em>через</em> третью модель. Например, рассмотрим поликлинику, где пациентам (patients) дают направления (appointments) к врачам (physicians). Соответствующие объявления связей будут выглядеть следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Physician</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:appointments</span>
  <span class="n">has_many</span> <span class="ss">:patients</span><span class="p">,</span> <span class="ss">through: :appointments</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Appointment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:physician</span>
  <span class="n">belongs_to</span> <span class="ss">:patient</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Patient</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:appointments</span>
  <span class="n">has_many</span> <span class="ss">:physicians</span><span class="p">,</span> <span class="ss">through: :appointments</span>
<span class="k">end</span>
</code></pre>
</div>
<p><img src='/assets/association_basics/has_many_through-b8b306c6e3fec380ae60261a3db7ec58a7e50750539433c3993e528c111ec332.png' title='' alt='Диаграмма для связи has_many :through' class='img-polaroid' /></p><p>Соответствующая миграция может выглядеть так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAppointments</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:physicians</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:patients</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:appointments</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:physician</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:patient</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:appointment_date</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Коллекция соединительных моделей может управляться с помощью <a href="#has-many-association-reference">методов связи <code>has_many</code></a>. Например, если вы присвоите:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">physician</span><span class="p">.</span><span class="nf">patients</span> <span class="o">=</span> <span class="n">patients</span>
</code></pre>
</div>
<p>Тогда будут автоматически созданы новые соединительные модели для вновь связанных объектов. Если некоторые из ранее существующих сейчас отсутствуют, их соединительные строки автоматически удаляются.</p><div class="warning"><p>Автоматическое удаление соединительных моделей прямое, ни один из колбэков на уничтожение не включается.</p></div><p>Связь <code>has_many :through</code> также полезна для настройки &quot;ярлыков&quot; через вложенные связи <code>has_many</code>. Например, если документ имеет много секций, а секция имеет много параграфов, иногда хочется получить просто коллекцию всех параграфов в документе. Это можно настроить следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Document</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:sections</span>
  <span class="n">has_many</span> <span class="ss">:paragraphs</span><span class="p">,</span> <span class="ss">through: :sections</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Section</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:document</span>
  <span class="n">has_many</span> <span class="ss">:paragraphs</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Paragraph</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:section</span>
<span class="k">end</span>
</code></pre>
</div>
<p>С определенным <code>through: :sections</code> Rails теперь понимает:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@document</span><span class="p">.</span><span class="nf">paragraphs</span>
</code></pre>
</div>
<h4 id='the-has-one-through-association' class='inside_page_header'><a href="#the-has-one-through-association">2.5.</a>  Связь <code>has_one :through</code></h4><p>Связь <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one :through</code></a> настраивает соединение один-к-одному с другой моделью. Эта связь показывает, что объявляющая модель может быть связана с одним экземпляром другой модели <em>через</em> третью модель. Например, если каждый поставщик имеет один аккаунт, и каждый аккаунт связан с одной историей аккаунта, тогда модели могут выглядеть так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
  <span class="n">has_one</span> <span class="ss">:account_history</span><span class="p">,</span> <span class="ss">through: :account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">has_one</span> <span class="ss">:account_history</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">AccountHistory</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
</div>
<p><img src='/assets/association_basics/has_one_through-d9cad54a85e7e2e2e334541326ad33c37f2bf84e3e30b8aa80b6e029f889c82a.png' title='' alt='Диаграмма для связи has_one :through' class='img-polaroid' /></p><p>Соответствующая миграция может выглядеть так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAccountHistories</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:account_histories</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:account</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:credit_rating</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='svyaz-has_and_belongs_to_many' class='inside_page_header'><a href="#svyaz-has_and_belongs_to_many">2.6.</a> Связь <code>has_and_belongs_to_many</code></h4><p>Связь <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many"><code>has_and_belongs_to_many</code></a> создает прямое соединение многие-ко-многим с другой моделью, без промежуточной модели. Эта связь показывает, что каждый экземпляр объявляющей модели ссылается на ноль или более записей другой модели. Например, если ваше приложение включает сборки (assemblies) и детали (parts), где каждый узел имеет много деталей, и каждая деталь встречается во многих сборках, модели можно объявить таким образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
</div>
<p><img src='/assets/association_basics/habtm-873c780b161cfd6dee3dbeaa367f8885a0282557beba80dcb865da4636a620d5.png' title='' alt='Диаграмма для связи has_and_belongs_to_many' class='img-polaroid' /></p><p>Соответствующая миграция может выглядеть так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesAndParts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:assemblies</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:parts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:part_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:assembly</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:part</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='vybor-mezhdu-belongs_to-i-has_one' class='inside_page_header'><a href="#vybor-mezhdu-belongs_to-i-has_one">2.7.</a> Выбор между <code>belongs_to</code> и <code>has_one</code></h4><p>Если хотите настроить отношение один-к-одному между двумя моделями, необходимо добавить <code>belongs_to</code> к одной и <code>has_one</code> к другой. Как узнать что к какой?</p><p>Различие в том, где помещен внешний ключ (он должен быть в таблице для класса, объявляющего связь <code>belongs_to</code>), но вы также должны думать о реальном значении данных. Отношение <code>has_one</code> говорит, что что-то принадлежит вам - то есть что что-то указывает на вас. Например, больше смысла в том, что поставщик владеет аккаунтом, чем в том, что аккаунт владеет поставщиком. Это означает, что правильные отношения подобны этому:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Соответствующая миграция может выглядеть так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateSuppliers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span>  <span class="ss">:supplier_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">:supplier_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="note"><p>Использование <code>t.bigint :supplier_id</code> указывает имя внешнего ключа очевидно и явно. В современных версиях Rails можно абстрагироваться от деталей реализации используя <code>t.references :supplier</code>.</p></div><h4 id='vybor-mezhdu-has_many-through-i-has_and_belongs_to_many' class='inside_page_header'><a href="#vybor-mezhdu-has_many-through-i-has_and_belongs_to_many">2.8.</a> Выбор между <code>has_many :through</code> и <code>has_and_belongs_to_many</code></h4><p>Rails предлагает два разных способа объявления отношения многие-ко-многим между моделями. Первый способ - использовать <code>has_and_belongs_to_many</code>, который позволяет создать связь напрямую:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Второй способ объявить отношение многие-ко-многим - использование <code>has_many :through</code>. Это осуществляет связь не напрямую, а через соединяющую модель:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:manifests</span>
  <span class="n">has_many</span> <span class="ss">:parts</span><span class="p">,</span> <span class="ss">through: :manifests</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Manifest</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:assembly</span>
  <span class="n">belongs_to</span> <span class="ss">:part</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:manifests</span>
  <span class="n">has_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">through: :manifests</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Простейший признак того, что нужно настраивать отношение <code>has_many :through</code> - если необходимо работать с моделью отношений как с независимым объектом. Если вам не нужно ничего делать с моделью отношений, проще настроить связь <code>has_and_belongs_to_many</code> (хотя нужно не забыть создать соединяющую таблицу в базе данных).</p><p>Вы должны использовать <code>has_many :through</code>, если нужны валидации, колбэки или дополнительные атрибуты для соединительной модели.</p><h4 id='polymorphic-associations' class='inside_page_header'><a href="#polymorphic-associations">2.9.</a>  Полиморфные связи</h4><p><em>Полиморфные связи</em> - это немного более &quot;навороченный&quot; вид связей. С полиморфными связями модель может принадлежать более чем одной модели, на одиночной связи. Например, имеется модель изображения, которая принадлежит или модели работника, или модели продукта. Вот как это объявляется:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Picture</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:imageable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="ss">as: :imageable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="ss">as: :imageable</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Можно считать полиморфное объявление <code>belongs_to</code> как настройку интерфейса, которую может использовать любая другая модель. Из экземпляра модели <code>Employee</code> можно получить коллекцию изображений: <code>@employee.pictures</code>.</p><p>Подобным образом можно получить <code>@product.pictures</code>.</p><p>Если имеется экземпляр модели <code>Picture</code>, можно получить его родителя посредством <code>@picture.imageable</code>. Чтобы это работало, необходимо объявить столбец внешнего ключа и столбец типа в модели, объявляющей полиморфный интерфейс:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreatePictures</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:pictures</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span>  <span class="ss">:imageable_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:imageable_type</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="p">[</span><span class="ss">:imageable_type</span><span class="p">,</span> <span class="ss">:imageable_id</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Эта миграция может быть упрощена при использовании формы <code>t.references</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreatePictures</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:pictures</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:imageable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p><img src='/assets/association_basics/polymorphic-a4deb1783f2e5373c0465329e9d3576a7f5f55afd69093f16b3cf6f1629d1cb0.png' title='' alt='Диаграмма для полиморфной связи' class='img-polaroid' /></p><h4 id='prisoedinenie-k-sebe' class='inside_page_header'><a href="#prisoedinenie-k-sebe">2.10.</a> Присоединение к себе</h4><p>При разработке модели данных иногда находится модель, которая может иметь отношение сама к себе. Например, мы хотим хранить всех работников в одной модели базы данных, но нам нужно отслеживать отношения начальник-подчиненный. Эта ситуация может быть смоделирована с помощью связей, присоединяемых к себе:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:subordinates</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Employee"</span><span class="p">,</span>
                          <span class="ss">foreign_key: </span><span class="s2">"manager_id"</span>

  <span class="n">belongs_to</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Employee"</span><span class="p">,</span> <span class="ss">optional: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
</div>
<p>С такой настройкой, вы можете получить <code>@employee.subordinates</code> и <code>@employee.manager</code>.</p><p>В миграциях/схеме следует добавить столбец ссылки модели на саму себя.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateEmployees</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:employees</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">to_table: :employees</span> <span class="p">}</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<h3 id='poleznye-sovety-i-preduprezhdeniya' class='inside_page_header'><a href="#poleznye-sovety-i-preduprezhdeniya">3.</a> Полезные советы и предупреждения</h3><p>Вот некоторые вещи, которые необходимо знать для эффективного использования связей Active Record в вашем приложении на Rails:</p><ul><li>Управление кэшированием
</li><li>Предотвращение коллизий имен
</li><li>Обновление схемы
</li><li>Управление областью видимости связей
</li><li>Двусторонние связи
</li></ul><h4 id='upravlenie-keshirovaniem' class='inside_page_header'><a href="#upravlenie-keshirovaniem">3.1.</a> Управление кэшированием</h4><p>Все методы связи построены вокруг кэширования, которое хранит результаты последних запросов доступными для будущих операций. Кэш является общим для разных методов. Например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># получаем книги из базы данных</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span>

<span class="c1"># используем кэшированную копию книг</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>

<span class="c1"># используем кэшированную копию книг</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">empty?</span>
</code></pre>
</div>
<p>Но что если вы хотите перезагрузить кэш, так как данные могли быть изменены другой частью приложения? Всего лишь вызовите <code>reload</code> на связи:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># получаем книги из базы данных</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span>

<span class="c1"># используем кэшированную копию книг</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>

<span class="c1"># отказываемся от кэшированной копии книг и снова обращаемся к базе данных</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">empty?</span>
</code></pre>
</div>
<h4 id='predotvraschenie-kolliziy-imen' class='inside_page_header'><a href="#predotvraschenie-kolliziy-imen">3.2.</a> Предотвращение коллизий имен</h4><p>Вы не свободны в выборе любого имени для своих связей. Поскольку создание связи добавляет метод с таким именем в модель, будет плохой идеей дать связи имя, уже используемое как метод экземпляра <code>ActiveRecord::Base</code>. Метод связи тогда переопределит базовый метод, и что-нибудь перестанет работать. Например, <code>attributes</code> или <code>connection</code> плохие имена для связей.</p><h4 id='obnovlenie-shemy' class='inside_page_header'><a href="#obnovlenie-shemy">3.3.</a> Обновление схемы</h4><p>Связи очень полезные, но не волшебные. Вы ответственны за содержание вашей схемы базы данных в соответствии со связями. На практике это означает две вещи, в зависимости от того, какой тип связей создаете. Для связей <code>belongs_to</code> нужно создать внешние ключи, а для связей <code>has_and_belongs_to_many</code> нужно создать подходящую соединительную таблицу.</p><h5 id='sozdanie-vneshnih-klyuchey-dlya-svyazey-belongs_to' class='inside_page_header'><a href="#sozdanie-vneshnih-klyuchey-dlya-svyazey-belongs_to">3.3.1.</a> Создание внешних ключей для связей <code>belongs_to</code></h5><p>Когда объявляете связь <code>belongs_to</code>, нужно создать внешние ключи, при необходимости. Например, рассмотрим эту модель:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Это объявление нуждается в поддержке соответствующим столбцом внешнего ключа в таблице books. Для совершенно новой таблицы миграция может выглядеть примерно так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span>   <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>     <span class="ss">:book_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:author</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>В то время как для существующей таблицы, это может выглядеть следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddAuthorToBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_reference</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">:author</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Если необходимо <a href="/active-record-migrations#foreign-keys">принудительно использовать ссылочную целостность на уровне базы данных</a>, добавьте опцию <code>foreign_key: true</code> в вышеприведенное объявление &#39;reference&#39; столбца.</p><h5 id='sozdanie-soedinitelnyh-tablits-dlya-svyazey-has_and_belongs_to_many' class='inside_page_header'><a href="#sozdanie-soedinitelnyh-tablits-dlya-svyazey-has_and_belongs_to_many">3.3.2.</a> Создание соединительных таблиц для связей <code>has_and_belongs_to_many</code></h5><p>Если вы создали связь <code>has_and_belongs_to_many</code>, необходимо обязательно создать соединительную таблицу. Если имя соединительной таблицы явно не указано с использованием опции <code>:join_table</code>, Active Record создает имя, используя алфавитный порядок имен классов. Поэтому соединение между моделями author и book по умолчанию даст значение имени таблицы &quot;authors_books&quot;, так как &quot;a&quot; идет перед &quot;b&quot; в алфавитном порядке.</p><div class="warning"><p>Приоритет между именами модели рассчитывается с использованием оператора <code>&lt;=&gt;</code> для <code>String</code>. Это означает, что если строки имеют разную длину и в своей короткой части они равны, тогда более длинная строка рассматривается как с более высоким лексическим приоритетом, по сравнению с короткой. Например, кто-то ожидает, что таблицы &quot;paper_boxes&quot; и &quot;papers&quot; создадут соединительную таблицу &quot;papers_paper_boxes&quot; поскольку имя &quot;paper_boxes&quot; длиннее, но фактически будет сгенерирована таблица с именем &quot;paper_boxes_papers&quot; (поскольку знак подчеркивания &quot;_&quot; лексикографически <em>меньше</em>, чем &quot;s&quot; в обычной кодировке).</p></div><p>Какое бы ни было имя, вы должны вручную сгенерировать соединительную таблицу в соответствующей миграции. Например, рассмотрим эти связи:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Теперь нужно написать миграцию для создания таблицы <code>assemblies_parts</code>. Эта таблица должна быть создана без первичного ключа:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesPartsJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="ss">:assembly_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="ss">:part_id</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">:assembly_id</span>
    <span class="n">add_index</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">:part_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Мы передаем <code>id: false</code> в <code>create_table</code>, так как эта таблица не представляет модель. Это необходимо, чтобы связь работала правильно. Если вы видите странное поведение в связи <code>has_and_belongs_to_many</code>, например, искаженные ID моделей, или исключения в связи с конфликтом ID, скорее всего вы забыли убрать первичный ключ.</p><p>Также можно использовать метод <code>create_join_table</code></p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesPartsJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_join_table</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">:parts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:assembly_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:part_id</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='upravlenie-oblastyu-vidimosti-svyazey' class='inside_page_header'><a href="#upravlenie-oblastyu-vidimosti-svyazey">3.4.</a> Управление областью видимости связей</h4><p>По умолчанию связи ищут объекты только в пределах области видимости текущего модуля. Это важно, когда вы объявляете модели Active Record внутри модуля. Например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Это будет работать, так как оба класса <code>Supplier</code> и <code>Account</code> определены в пределах одной области видимости. Но нижеследующее не будет работать, потому что <code>Supplier</code> и <code>Account</code> определены в разных областях видимости:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Billing</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Для связи модели с моделью в другом пространстве имен, необходимо указать полное имя класса в объявлении связи:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span>
        <span class="ss">class_name: </span><span class="s2">"MyApplication::Billing::Account"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Billing</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span>
        <span class="ss">class_name: </span><span class="s2">"MyApplication::Business::Supplier"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='bi-directional-associations' class='inside_page_header'><a href="#bi-directional-associations">3.5.</a>  Двунаправленные связи</h4><p>Для связей нормально работать в двух направлениях, затребовав объявление в двух различных моделях:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Active Record попытается автоматически определить, что эти две модели образуют двунаправленную связь, основываясь на имени связи. Эта информация позволяет Active Record:</p><ul><li><p>Предотвращать необходимость запросов для уже загруженных данных</p><div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">all?</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
<span class="gp">irb&gt;</span><span class="w">   </span><span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">equal?</span><span class="p">(</span><span class="n">author</span><span class="p">)</span> <span class="c1"># Тут не выполняются дополнительные запросы</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="k">end</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
</div>
</li><li><p>Предотвращать несогласованные данные (как только есть только одна загруженная копия объекта <code>Author</code>)</p><div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"Changed Name"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
</div>
</li><li><p>Автоматически сохраняет связи в большинстве случаев</p><div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">save!</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
</div>
</li><li><p>Проверяет <a href="/active-record-validations#presence">наличие</a> и <a href="/active-record-validations#absence">отсутствие</a> связей в большинстве случаев</p><div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"Author must exist"</span><span class="p">]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
</div>
</li></ul><p>Active Record поддерживает автоматическое определение для большинства связей со стандартными именами. Однако, Active Record не будет автоматически определять двунаправленные связи, содержащие опции <code>:through</code> или <code>:foreign_key</code>. Пользовательские скоупы на противоположных связях также предотвращают автоматическое определение, как и пользовательские скоупы на самой связи, за исключением когда <a href="/configuring#config-active-record-automatic-scope-inversing"><code>config.active_record.automatic_scope_inversing</code></a> установлена true (по умолчанию для новых приложений).</p><p>Например, рассмотрим следующие объявления моделей:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:writer</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'Author'</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s1">'author_id'</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Из-за опции <code>:foreign_key</code>, Active Record больше не будет автоматически распознавать двунаправленную связь. Это может вызвать, что ваше приложение:</p><ul><li><p>Выполняет необходимые запросы для тех же данных (в этом примере вызывая N+1 запрос)</p><div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">any?</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
<span class="gp">irb&gt;</span><span class="w">   </span><span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">equal?</span><span class="p">(</span><span class="n">author</span><span class="p">)</span> <span class="c1"># Это выполняет запрос для каждой книги</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="k">end</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
</div>
</li><li><p>Ссылается на несколько копий модели с несогласованными данными</p><div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"Changed Name"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">name</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
</div>
</li><li><p>Не в состоянии автоматически сохранять связи</p><div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">save!</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
</div>
</li><li><p>Не в состоянии проверять наличие или отсутствие</p><div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"Author must exist"</span><span class="p">]</span>
</code></pre>
</div>
</li></ul><p>Active Record представляет опцию <code>:inverse_of</code>, таким образом можно явно объявить двунаправленные связи:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: </span><span class="s1">'writer'</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:writer</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'Author'</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s1">'author_id'</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Включив опцию <code>:inverse_of</code> в объявлении связи <code>has_many</code>, Active Record будет распознавать двунаправленную связь и будет вести себя как в изначальных примерах выше:</p><h3 id='podrobnaya-informatsiya-po-svyazi-belongs_to' class='inside_page_header'><a href="#podrobnaya-informatsiya-po-svyazi-belongs_to">4.</a> Подробная информация по связи <code>belongs_to</code></h3><p>В терминах базы данных связь <code>belongs_to</code> сообщает, что таблица этой модели содержит столбец, представляющий ссылку на другую таблицу. Она может быть использована для настройки отношений один-к-одному или один-ко-многим, в зависимости от настроек. Если таблица другого класса содержит ссылку в отношении один-к-одному, вместо этого  следует использовать <code>has_one</code>.</p><h4 id='metody-dobavlyaemye-belongs_to' class='inside_page_header'><a href="#metody-dobavlyaemye-belongs_to">4.1.</a> Методы, добавляемые <code>belongs_to</code></h4><p>Когда объявляете связь <code>belongs_to</code>, объявляющий класс автоматически получает 8 методов, относящихся к связи:</p><ul><li><code>association</code>
</li><li><code>association=(associate)</code>
</li><li><code>build_association(attributes = {})</code>
</li><li><code>create_association(attributes = {})</code>
</li><li><code>create_association!(attributes = {})</code>
</li><li><code>reload_association</code>
</li><li><code>reset_association</code>
</li><li><code>association_changed?</code>
</li><li><code>association_previously_changed?</code>
</li></ul><p>Во всех четырех методах <code>association</code> заменяется символом, переданным как первый аргумент в <code>belongs_to</code>. Например, имеем объявление:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Каждый экземпляр модели <code>Book</code> будет иметь эти методы:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">author</span>
<span class="n">author</span><span class="o">=</span>
<span class="n">build_author</span>
<span class="n">create_author</span>
<span class="n">create_author!</span>
<span class="n">reload_author</span>
<span class="n">reset_author</span>
<span class="n">author_changed?</span>
<span class="n">author_previously_changed?</span>
</code></pre>
</div>
<div class="note"><p>Когда устанавливаете новую связь <code>has_one</code> или <code>belongs_to</code>, следует использовать префикс <code>build_</code> для построения связи, в отличие от метода <code>association.build</code>, используемый для связей <code>has_many</code> или <code>has_and_belongs_to_many</code>. Чтобы создать связь, используйте префикс <code>create_</code>.</p></div><h5 id='association' class='inside_page_header'><a href="#association">4.1.1.</a> <code>association</code></h5><p>Метод <code>association</code> возвращает связанный объект, если он есть. Если объекта нет, возвращает <code>nil</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">author</span>
</code></pre>
</div>
<p>Если связанный объект уже был получен из базы данных для этого объекта, возвращается кэшированная версия. Чтобы переопределить это поведение (и заставить прочитать из базы данных), вызовите <code>#reload_association</code> на родительском объекте.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">reload_author</span>
</code></pre>
</div>
<p>Чтобы выгрузить кэшированную версию связанного объекта при следующем доступе, если таковая имеется, и прочитать ее из базы данных, вызовите <code>#reset_association</code> на родительском объекте.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">reset_author</span>
</code></pre>
</div>
<h5 id='association-associate' class='inside_page_header'><a href="#association-associate">4.1.2.</a> <code>association=(associate)</code></h5><p>Метод <code>association=</code> привязывает связанный объект к этому объекту. Фактически это означает извлечение первичного ключа из связанного объекта и присвоение его значения внешнему ключу.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="vi">@author</span>
</code></pre>
</div>
<h5 id='build_association-attributes' class='inside_page_header'><a href="#build_association-attributes">4.1.3.</a> <code>build_association(attributes = {})</code></h5><p>Метод <code>build_association</code> возвращает новый объект связанного типа. Этот объект будет экземпляром с переданными атрибутами, будет установлена связь с внешним ключом этого объекта, но связанный объект пока <em>не</em> будет сохранен.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">build_author</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span>
                             <span class="ss">author_name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
</code></pre>
</div>
<h5 id='create_association-attributes' class='inside_page_header'><a href="#create_association-attributes">4.1.4.</a> <code>create_association(attributes = {})</code></h5><p>Метод <code>create_association</code> возвращает новый объект связанного типа. Этот объект будет экземпляром с переданными атрибутами, будет установлена связь с внешним ключом этого объекта, и, если он пройдет валидации, определенные в связанной модели, связанный объект <em>будет</em> сохранен.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">create_author</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span>
                              <span class="ss">author_name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
</code></pre>
</div>
<h5 id='create_association-attributes2' class='inside_page_header'><a href="#create_association-attributes2">4.1.5.</a> <code>create_association!(attributes = {})</code></h5><p>Работает так же, как и вышеприведенный <code>create_association</code>, но вызывает <code>ActiveRecord::RecordInvalid</code>, если запись невалидна.</p><h6 id='association_changed' class='inside_page_header'><a href="#association_changed">4.1.5.1.</a> <code>association_changed?</code></h6><p>Метод <code>association_changed?</code> возвращает true, если был назначен новый связанный объект, и внешний ключ будет обновлен при следующем сохранении.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="c1"># =&gt; #&lt;Author author_number: 123, author_name: "John Doe"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; false</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">second</span> <span class="c1"># =&gt; #&lt;Author author_number: 456, author_name: "Jane Smith"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; true</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">save!</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; false</span>
</code></pre>
</div>
<h6 id='association_previously_changed' class='inside_page_header'><a href="#association_previously_changed">4.1.5.2.</a> <code>association_previously_changed?</code></h6><p>Метод <code>association_previously_changed?</code> возвращает true, если предыдущее сохранение обновило связь, ссылающуюся на новый связанный объект.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="c1"># =&gt; #&lt;Author author_number: 123, author_name: "John Doe"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_previously_changed?</span> <span class="c1"># =&gt; false</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">second</span> <span class="c1"># =&gt; #&lt;Author author_number: 456, author_name: "Jane Smith"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">save!</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_previously_changed?</span> <span class="c1"># =&gt; true</span>
</code></pre>
</div>
<h4 id='options-for-belongs-to' class='inside_page_header'><a href="#options-for-belongs-to">4.2.</a>  Опции для <code>belongs_to</code></h4><p>Хотя Rails использует разумные значения по умолчанию, работающие во многих ситуациях, бывают случаи, когда хочется изменить поведение связи <code>belongs_to</code>. Такая настройка легко выполнима с помощью передачи опций и блоков со скоупом при создании связи. Например, эта связь использует две такие опции:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: :books_updated_at</span><span class="p">,</span>
    <span class="ss">counter_cache: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Связь <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to"><code>belongs_to</code></a> поддерживает эти опции:</p><ul><li><code>:autosave</code>
</li><li><code>:class_name</code>
</li><li><code>:counter_cache</code>
</li><li><code>:dependent</code>
</li><li><code>:foreign_key</code>
</li><li><code>:primary_key</code>
</li><li><code>:inverse_of</code>
</li><li><code>:polymorphic</code>
</li><li><code>:touch</code>
</li><li><code>:validate</code>
</li><li><code>:optional</code>
</li></ul><h5 id='autosave' class='inside_page_header'><a href="#autosave">4.2.1.</a> <code>:autosave</code></h5><p>Если установить опцию <code>:autosave</code> в <code>true</code>, Rails сохранит любые загруженные связанные члены и уничтожит члены, помеченные для уничтожения, всякий раз, когда сохраняется родительский объект. Но установить <code>:autosave</code> в <code>false</code> - не то же самое, что не устанавливать опцию <code>:autosave</code>. Если опция <code>:autosave</code> отсутствует, то новые связанные объекты будут сохранены, но обновленные связанные объекты сохранены не будут.</p><h5 id='class_name' class='inside_page_header'><a href="#class_name">4.2.2.</a> <code>:class_name</code></h5><p>Если имя другой модели не может быть получено из имени связи, можете использовать опцию <code>:class_name</code> для предоставления имени модели. Например, если книга принадлежит автору, но фактическое имя модели, содержащей авторов, <code>Patron</code>, можете установить это следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Patron"</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='counter_cache' class='inside_page_header'><a href="#counter_cache">4.2.3.</a> <code>:counter_cache</code></h5><p>Опция <code>:counter_cache</code> может быть использована, чтобы сделать поиск количества принадлежащих объектов более эффективным. Рассмотрим эти модели:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
</div>
<p>С этими объявлениями запрос значения <code>@author.books.size</code> требует обращения к базе данных для выполнения запроса <code>COUNT(*)</code>. Чтобы этого избежать, можете добавить кэш счетчика в <em>принадлежащую</em> модель:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">counter_cache: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
</div>
<p>С этим объявлением, Rails будет хранить в кэше актуальное значение и затем возвращать это значение в отклик на метод <code>size</code>.</p><p>Хотя опция <code>:counter_cache</code> определяется в модели, включающей определение <code>belongs_to</code>, фактический столбец должен быть добавлен в <em>связанную</em> (<code>has_many</code>) модель. В вышеописанном случае, необходимо добавить столбец, названный <code>books_count</code> в модель <code>Author</code>.</p><p>Имя столбца по умолчанию можно переопределить, указав произвольное имя столбца в объявлении <code>counter_cache</code> вместо <code>true</code>. Например, для использования <code>count_of_books</code> вместо <code>books_count</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">counter_cache: :count_of_books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="note"><p>Опцию <code>:counter_cache</code> необходимо указывать только на стороне <code>belongs_to</code> связи.</p></div><p>Столбцы кэша счетчика добавляются в список атрибутов модели только для чтения посредством <code>attr_readonly</code>.</p><p>Если по какой-то причине вы изменяете значение первичного ключа модели, но не обновляете внешние ключи посчитанных моделей, то кэш счетчика может иметь устаревшие данные. Другими словами, любые &quot;осиротевшие&quot; модели все еще будут считать в отношении счетчика. Чтобы починить кэш счетчика, используйте <a href="https://api.rubyonrails.org/classes/ActiveRecord/CounterCache/ClassMethods.html#method-i-reset_counters"><code>reset_counters</code></a>.</p><h5 id='dependent' class='inside_page_header'><a href="#dependent">4.2.4.</a> <code>:dependent</code></h5><p>Если установить опцию <code>:dependent</code> в:</p><ul><li><code>:destroy</code>, когда объект уничтожается, <code>destroy</code> вызывается на его связанных объектах.
</li><li><code>:delete</code>, когда объект уничтожается, все его связанные объекты удаляются прямо из базы данных без вызова метода <code>destroy</code>.
</li><li><code>:destroy_async</code>: когда объект уничтожается, задание <code>ActiveRecord::DestroyAssociationAsyncJob</code> ставится в очередь, которое вызовет destroy на его связанных объектах. Чтобы это работало, должен быть настроен Active Job.
</li></ul><div class="warning"><p>Не следует определять эту опцию в связи <code>belongs_to</code>, которая соединена со связью <code>has_many</code> в другом классе. Это приведет к &quot;битым&quot; связям в записях вашей базы данных.</p></div><h5 id='foreign_key' class='inside_page_header'><a href="#foreign_key">4.2.5.</a> <code>:foreign_key</code></h5><p>По соглашению Rails предполагает, что столбец, используемый для хранения внешнего ключа в этой модели, имеет имя модели с добавленным суффиксом <code>_id</code>. Опция <code>:foreign_key</code> позволяет установить имя внешнего ключа явно:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Patron"</span><span class="p">,</span>
                      <span class="ss">foreign_key: </span><span class="s2">"patron_id"</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="info"><p>В любом случае, Rails не создаст столбцы внешнего ключа за вас. Вам необходимо явно определить их в своих миграциях.</p></div><h5 id='primary_key' class='inside_page_header'><a href="#primary_key">4.2.6.</a> <code>:primary_key</code></h5><p>По соглашению Rails предполагает, что для первичного ключа используется столбец <code>id</code> в таблице. Опция <code>:primary_key</code> позволяет указать иной столбец.</p><p>Например, имеется таблица <code>users</code> с <code>guid</code> в качестве первичного ключа. Если мы хотим отдельную таблицу <code>todos</code>, содержащую внешний ключ <code>user_id</code> из столбца <code>guid</code>, для этого можно использовать <code>primary_key</code> следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="s1">'guid'</span> <span class="c1"># primary key is guid and not id</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Todo</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">primary_key: </span><span class="s1">'guid'</span>
<span class="k">end</span>
</code></pre>
</div>
<p>При выполнении <code>@user.todos.create</code>, у записи <code>@todo</code> будет значение <code>user_id</code> таким же, как значение <code>guid</code> у <code>@user</code>.</p><h5 id='inverse_of' class='inside_page_header'><a href="#inverse_of">4.2.7.</a> <code>:inverse_of</code></h5><p>Опция <code>:inverse_of</code> определяет имя связи <code>has_many</code> или <code>has_one</code>, являющейся противоположностью для этой связи. Подробности смотрите в разделе <a href="#bi-directional-associations">Двунаправленная связь</a>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: :author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">inverse_of: :books</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='polymorphic' class='inside_page_header'><a href="#polymorphic">4.2.8.</a> <code>:polymorphic</code></h5><p>Передача <code>true</code> для опции <code>:polymorphic</code> показывает, что это полиморфная связь. Полиморфные связи подробно рассматривались <a href="#polymorphic-associations">ранее</a>.</p><h5 id='touch' class='inside_page_header'><a href="#touch">4.2.9.</a> <code>:touch</code></h5><p>Если установите опцию <code>:touch</code> в <code>true</code>, то временные метки <code>updated_at</code> или <code>updated_on</code> на связанном объекте будут установлены в текущее время всякий раз, когда этот объект будет сохранен или уничтожен:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
</div>
<p>В этом случае, сохранение или уничтожение книги обновит временную метку на связанном авторе. Также можно определить конкретный атрибут временной метки для обновления:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: :books_updated_at</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='validate' class='inside_page_header'><a href="#validate">4.2.10.</a> <code>:validate</code></h5><p>Если установите опцию <code>:validate</code> в <code>true</code>, тогда связанные объекты будут проходить валидацию всякий раз, когда вы сохраняете этот объект. По умолчанию она равна <code>false</code>: связанные объекты не проходят валидацию, когда этот объект сохраняется.</p><h5 id='optional' class='inside_page_header'><a href="#optional">4.2.11.</a> <code>:optional</code></h5><p>Если установить <code>:optional</code> в <code>true</code>, тогда наличие связанных объектов не будет валидироваться. По умолчанию установлено в <code>false</code>.</p><h4 id='skoupy-dlya-belongs_to' class='inside_page_header'><a href="#skoupy-dlya-belongs_to">4.3.</a> Скоупы для <code>belongs_to</code></h4><p>Иногда хочется настроить запрос, используемый <code>belongs_to</code>. Такая настройка может быть достигнута с помощью блока скоупа. Например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Внутри блока скоупа можно использовать любые стандартные <a href="/active-record-querying">методы запросов</a>. Далее обсудим следующие из них:</p><ul><li><code>where</code>
</li><li><code>includes</code>
</li><li><code>readonly</code>
</li><li><code>select</code>
</li></ul><h5 id='where' class='inside_page_header'><a href="#where">4.3.1.</a> <code>where</code></h5><p>Метод <code>where</code> позволяет определить условия, которым должен отвечать связанный объект.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='includes' class='inside_page_header'><a href="#includes">4.3.2.</a> <code>includes</code></h5><p>Метод <code>includes</code> можно использовать для определения связей второго порядка, которые должны быть лениво загружены при использовании этой связи. Например, рассмотрим эти модели:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Если вы часто получаете авторов непосредственно из глав (<code>@chapter.book.author</code>), то можно улучшить эффективность кода, включив авторов в связь между книгой и ее главами:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:author</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="note"><p>Нет необходимости в использовании <code>includes</code> для ближайших связей - то есть, если есть <code>Book belongs_to :author</code>, то author автоматически лениво загружается при необходимости.</p></div><h5 id='readonly' class='inside_page_header'><a href="#readonly">4.3.3.</a> <code>readonly</code></h5><p>При использовании <code>readonly</code>, связанный объект будет только для чтения при получении через связь.</p><h5 id='select' class='inside_page_header'><a href="#select">4.3.4.</a> <code>select</code></h5><p>Метод <code>select</code> позволяет переопределить SQL выражение <code>SELECT</code>, используемое для получения данных о связанном объекте. По умолчанию Rails получает все столбцы.</p><div class="info"><p>При использовании метода <code>select</code> на связи <code>belongs_to</code>, следует также установить опцию <code>:foreign_key</code> для гарантии правильных результатов.</p></div><h4 id='suschestvuyut-li-svyazannye-ob-ekty' class='inside_page_header'><a href="#suschestvuyut-li-svyazannye-ob-ekty">4.4.</a> Существуют ли связанные объекты?</h4><p>Можно увидеть, существует ли какой-либо связанный объект, при использовании метода <code>association.nil?</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">if</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="vi">@msg</span> <span class="o">=</span> <span class="s2">"No author found for this book"</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='kogda-sohranyayutsya-ob-ekty' class='inside_page_header'><a href="#kogda-sohranyayutsya-ob-ekty">4.5.</a> Когда сохраняются объекты?</h4><p>Присвоение связи <code>belongs_to</code> не приводит к автоматическому сохранению ни самого объекта, ни связанного объекта.</p><h3 id='podrobnaya-informatsiya-po-svyazi-has_one' class='inside_page_header'><a href="#podrobnaya-informatsiya-po-svyazi-has_one">5.</a> Подробная информация по связи <code>has_one</code></h3><p>Связь <code>has_one</code> создает соответствие один-к-одному с другой моделью. В терминах базы данных эта связь сообщает, что другой класс содержит внешний ключ. Если этот класс содержит внешний ключ, следует использовать <code>belongs_to</code>.</p><h4 id='metody-dobavlyaemye-has_one' class='inside_page_header'><a href="#metody-dobavlyaemye-has_one">5.1.</a> Методы, добавляемые <code>has_one</code></h4><p>Когда объявляете связь <code>has_one</code>, объявляющий класс автоматически получает 6 методов, относящихся к связи:</p><ul><li><code>association</code>
</li><li><code>association=(associate)</code>
</li><li><code>build_association(attributes = {})</code>
</li><li><code>create_association(attributes = {})</code>
</li><li><code>create_association!(attributes = {})</code>
</li><li><code>reload_association</code>
</li><li><code>reset_assocation</code>
</li></ul><p>Во всех этих методах <code>association</code> заменяется на символ, переданный как первый аргумент в <code>has_one</code>. Например, имеем объявление:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Каждый экземпляр модели <code>Supplier</code> будет иметь эти методы:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">account</span>
<span class="n">account</span><span class="o">=</span>
<span class="n">build_account</span>
<span class="n">create_account</span>
<span class="n">create_account!</span>
<span class="n">reload_account</span>
<span class="n">reset_account</span>
</code></pre>
</div>
<div class="note"><p>При установлении новой связи <code>has_one</code> или <code>belongs_to</code>, следует использовать префикс <code>build_</code> для построения связи, в отличие от метода <code>association.build</code>, используемого для связей <code>has_many</code> или <code>has_and_belongs_to_many</code>. Чтобы создать связь, используйте префикс <code>create_</code>.</p></div><h5 id='association2' class='inside_page_header'><a href="#association2">5.1.1.</a> <code>association</code></h5><p>Метод <code>association</code> возвращает связанный объект, если таковой имеется. Если связанный объект не найден, возвращает <code>nil</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span>
</code></pre>
</div>
<p>Если связанный объект уже был получен из базы данных для этого объекта, возвращается кэшированная версия. Чтобы переопределить это поведение (и заставить прочитать из базы данных), вызовите <code>#reload_association</code> на родительском объекте.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">reload_account</span>
</code></pre>
</div>
<p>Чтобы выгрузить кэшированную версию связанного объекта при следующем доступе, если таковая имеется, и прочитать ее из базы данных, вызовите <code>#reset_association</code> на родительском объекте.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">reset_author</span>
</code></pre>
</div>
<h5 id='association-associate2' class='inside_page_header'><a href="#association-associate2">5.1.2.</a> <code>association=(associate)</code></h5><p>Метод <code>association=</code> привязывает связанный объект к этому объекту. Фактически это означает извлечение первичного ключа этого объекта и присвоение его значения внешнему ключу связанного объекта.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span> <span class="o">=</span> <span class="vi">@account</span>
</code></pre>
</div>
<h5 id='build_association-attributes2' class='inside_page_header'><a href="#build_association-attributes2">5.1.3.</a> <code>build_association(attributes = {})</code></h5><p>Метод <code>build_association</code> возвращает новый объект связанного типа. Этот объект будет экземпляром с переданными атрибутами, и будет установлена связь через внешний ключ, но связанный объект пока <em>не</em> будет сохранен.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">build_account</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">"Net 30"</span><span class="p">)</span>
</code></pre>
</div>
<h5 id='create_association-attributes3' class='inside_page_header'><a href="#create_association-attributes3">5.1.4.</a> <code>create_association(attributes = {})</code></h5><p>Метод <code>create_association</code> возвращает новый объект связанного типа. Этот объект будет экземпляром с переданными атрибутами, будет установлена связь через внешний ключ, и, если он пройдет валидации, определенные в связанной модели, связанный объект <em>будет</em> сохранен</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">create_account</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">"Net 30"</span><span class="p">)</span>
</code></pre>
</div>
<h5 id='create_association-attributes4' class='inside_page_header'><a href="#create_association-attributes4">5.1.5.</a> <code>create_association!(attributes = {})</code></h5><p>Работает так же, как и вышеприведенный <code>create_association</code>, но вызывает <code>ActiveRecord::RecordInvalid</code>, если запись невалидна.</p><h4 id='optsii-dlya-has_one' class='inside_page_header'><a href="#optsii-dlya-has_one">5.2.</a> Опции для <code>has_one</code></h4><p>Хотя Rails использует разумные значения по умолчанию, работающие во многих ситуациях, бывают случаи, когда хочется изменить поведение связи <code>has_one</code>. Такая настройка легко выполнима с помощью передачи опции при создании связи. Например, эта связь использует две такие опции:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Billing"</span><span class="p">,</span> <span class="ss">dependent: :nullify</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Связь <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one</code></a> поддерживает эти опции:</p><ul><li><code>:as</code>
</li><li><code>:autosave</code>
</li><li><code>:class_name</code>
</li><li><code>:dependent</code>
</li><li><code>:foreign_key</code>
</li><li><code>:inverse_of</code>
</li><li><code>:primary_key</code>
</li><li><code>:source</code>
</li><li><code>:source_type</code>
</li><li><code>:through</code>
</li><li><code>:touch</code>
</li><li><code>:validate</code>
</li></ul><h5 id='as' class='inside_page_header'><a href="#as">5.2.1.</a> <code>:as</code></h5><p>Установка опции <code>:as</code> показывает, что это полиморфная связь. Полиморфные связи подробно рассматривались <a href="#polymorphic-associations">ранее</a>.</p><h5 id='autosave2' class='inside_page_header'><a href="#autosave2">5.2.2.</a> <code>:autosave</code></h5><p>Если установить опцию <code>:autosave</code> в <code>true</code>, Rails сохранит любые загруженные связанные члены и уничтожит члены, помеченные для уничтожения, всякий раз, когда сохраняется родительский объект. Но установить <code>:autosave</code> в <code>false</code> - не то же самое, что не устанавливать опцию <code>:autosave</code>. Если опция <code>:autosave</code> отсутствует, то новые связанные объекты будут сохранены, но обновленные связанные объекты сохранены не будут.</p><h5 id='class_name2' class='inside_page_header'><a href="#class_name2">5.2.3.</a> <code>:class_name</code></h5><p>Если имя другой модели не может быть образовано из имени связи, можете использовать опцию <code>:class_name</code> для предоставления имени модели. Например, если поставщик имеет аккаунт, но фактическое имя модели, содержащей аккаунты, это <code>Billing</code>, можете установить это следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Billing"</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='dependent2' class='inside_page_header'><a href="#dependent2">5.2.4.</a> <code>:dependent</code></h5><p>Управляет тем, что произойдет со связанным объектом, когда его владелец будет уничтожен:</p><ul><li><code>:destroy</code> приведет к тому, что связанный объект также будет уничтожен
</li><li><code>:delete</code> приведет к тому, что связанный объект будет удален из базы данных напрямую (таким образом не будут выполнены колбэки)
</li><li><code>:destroy_async</code>: когда объект уничтожается, задание <code>ActiveRecord::DestroyAssociationAsyncJob</code> ставится в очередь, которое вызовет destroy на его связанных объектах. Чтобы это работало, должен быть настроен Active Job.
</li><li><code>:nullify</code> приведет к тому, что внешний ключ будет установлен <code>NULL</code>. Столбцы полиморфного типа на полиморфных связях также обнуляются. Колбэки не выполняются.
</li><li><code>:restrict_with_exception</code> приведет к вызову исключения <code>ActiveRecord::DeleteRestrictionError</code>, если есть связанный объект
</li><li><code>:restrict_with_error</code> приведет к ошибке, добавляемой к владельцу, если есть связанный объект
</li></ul><p>Нельзя устанавливать или оставлять опцию <code>:nullify</code> для связей, имеющих ограничение <code>NOT NULL</code>. Если не установить <code>dependent</code> для уничтожения таких связей, вы не сможете изменить связанный объект, так как внешнему ключу изначально связанного объекта будет назначено недопустимое значение <code>NULL</code>.</p><h5 id='foreign_key2' class='inside_page_header'><a href="#foreign_key2">5.2.5.</a> <code>:foreign_key</code></h5><p>По соглашению Rails предполагает, что столбец, используемый для хранения внешнего ключа в этой модели, имеет имя модели с добавленным суффиксом <code>_id</code>. Опция <code>:foreign_key</code> позволяет установить имя внешнего ключа явно:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"supp_id"</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="info"><p>В любом случае, Rails не создаст столбцы внешнего ключа за вас. Вам необходимо явно определить их в своих миграциях.</p></div><h5 id='inverse_of2' class='inside_page_header'><a href="#inverse_of2">5.2.6.</a> <code>:inverse_of</code></h5><p>Опция <code>:inverse_of</code> определяет имя связи <code>belongs_to</code>, являющейся обратной для этой связи. Подробности смотрите в разделе <a href="#bi-directional-associations">Двунаправленная связь</a>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">inverse_of: :supplier</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">inverse_of: :account</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='primary_key2' class='inside_page_header'><a href="#primary_key2">5.2.7.</a> <code>:primary_key</code></h5><p>По соглашению, Rails предполагает, что столбец, используемый для хранения первичного ключа, это <code>id</code>. Вы можете переопределить это и явно определить первичный ключ с помощью опции <code>:primary_key</code>.</p><h5 id='source' class='inside_page_header'><a href="#source">5.2.8.</a> <code>:source</code></h5><p>Опция <code>:source</code> определяет имя источника связи для связи <code>has_one :through</code>.</p><h5 id='source_type' class='inside_page_header'><a href="#source_type">5.2.9.</a> <code>:source_type</code></h5><p>Опция <code>:source_type</code> определяет тип источника связи для связи <code>has_one :through</code>, который действует при полиморфной связи.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:book</span>
  <span class="n">has_one</span> <span class="ss">:hardback</span><span class="p">,</span> <span class="ss">through: :book</span><span class="p">,</span> <span class="ss">source: :format</span><span class="p">,</span> <span class="ss">source_type: </span><span class="s2">"Hardback"</span>
  <span class="n">has_one</span> <span class="ss">:dust_jacket</span><span class="p">,</span> <span class="ss">through: :hardback</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:format</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Paperback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>

<span class="k">class</span> <span class="nc">Hardback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:dust_jacket</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">DustJacket</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
</code></pre>
</div>
<h5 id='through' class='inside_page_header'><a href="#through">5.2.10.</a> <code>:through</code></h5><p>Опция <code>:through</code> определяет соединительную модель, через которую выполняется запрос. Связи <code>has_one :through</code> подробно рассматривались <a href="#the-has-one-through-association">ранее</a>.</p><h6 id='touch2' class='inside_page_header'><a href="#touch2">5.2.10.1.</a> <code>:touch</code></h6><p>Если опция <code>:touch</code> установлена <code>true</code>, тогда временные метки <code>updated_at</code> или <code>updated_on</code> у связанного объекта будут установлены в текущее время всякий раз, когда этот объект будет сохранен или уничтожен:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
<span class="k">end</span>
</code></pre>
</div>
<p>В этом случае, сохранение или удаление поставщика обновит временную метку у связанного счета. Также можно указать конкретный атрибут временной метки для обновления:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">touch: :suppliers_updated_at</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='validate2' class='inside_page_header'><a href="#validate2">5.2.11.</a> <code>:validate</code></h5><p>Если установите опцию <code>:validate</code> в <code>true</code>, тогда новые связанные объекты будут проходить валидацию всякий раз, когда вы сохраняете этот объект. По умолчанию она равна <code>false</code>: новые связанные объекты не проходят валидацию, когда этот объект сохраняется.</p><h4 id='skoupy-dlya-has_one' class='inside_page_header'><a href="#skoupy-dlya-has_one">5.3.</a> Скоупы для <code>has_one</code></h4><p>Иногда хочется настроить запрос, используемый <code>has_one</code>. Такая настройка может быть достигнута с помощью блока скоупа. Например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Внутри блока скоупа можно использовать любые стандартные <a href="/active-record-querying">методы запросов</a>. Далее обсудим следующие из них:</p><ul><li><code>where</code>
</li><li><code>includes</code>
</li><li><code>readonly</code>
</li><li><code>select</code>
</li></ul><h5 id='where2' class='inside_page_header'><a href="#where2">5.3.1.</a> <code>where</code></h5><p>Метод <code>where</code> позволяет определить условия, которым должен отвечать связанный объект.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"confirmed = 1"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='includes2' class='inside_page_header'><a href="#includes2">5.3.2.</a> <code>includes</code></h5><p>Метод <code>includes</code> позволяет определить связи второго порядка, которые должны быть лениво загружены при использовании этой связи. Например, рассмотрим эти модели:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">belongs_to</span> <span class="ss">:representative</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Representative</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:accounts</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Если вы часто получаете representatives непосредственно из suppliers (<code>@supplier.account.representative</code>), то можно улучшить эффективность кода, включив representatives в связь между suppliers и accounts:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:representative</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">belongs_to</span> <span class="ss">:representative</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Representative</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:accounts</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='readonly2' class='inside_page_header'><a href="#readonly2">5.3.3.</a> <code>readonly</code></h5><p>При использовании <code>readonly</code>, связанный объект будет только для чтения при получении через связь.</p><h5 id='select2' class='inside_page_header'><a href="#select2">5.3.4.</a> <code>select</code></h5><p>Метод <code>select</code> позволяет переопределить SQL выражение <code>SELECT</code>, используемое для получения данных о связанном объекте. По умолчанию Rails получает все столбцы.</p><h4 id='suschestvuyut-li-svyazannye-ob-ekty2' class='inside_page_header'><a href="#suschestvuyut-li-svyazannye-ob-ekty2">5.4.</a> Существуют ли связанные объекты?</h4><p>Можно увидеть, существует ли какой-либо связанный объект, при использовании метода <code>association.nil?</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">if</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="vi">@msg</span> <span class="o">=</span> <span class="s2">"No account found for this supplier"</span>
<span class="k">end</span>
</code></pre>
</div>
<h4 id='kogda-sohranyayutsya-ob-ekty2' class='inside_page_header'><a href="#kogda-sohranyayutsya-ob-ekty2">5.5.</a> Когда сохраняются объекты?</h4><p>Когда вы назначаете объект связью <code>has_one</code>, этот объект автоматически сохраняется (для того, чтобы обновить его внешний ключ). Кроме того, любой заменяемый объект также автоматически сохраняется, поскольку его внешний ключ также изменяется.</p><p>Если одно из этих сохранений проваливается из-за ошибок валидации, тогда выражение назначения возвращает <code>false</code>, и само назначение отменяется.</p><p>Если родительский объект (который объявляет связь <code>has_one</code>) является несохраненным (то есть <code>new_record?</code> возвращает <code>true</code>), тогда дочерние объекты не сохраняются. Они сохранятся автоматически, когда сохранится родительский объект.</p><p>Если вы хотите назначить объект связью <code>has_one</code> без сохранения объекта, используйте метод <code>build_association</code>.</p><h3 id='has-many-association-reference' class='inside_page_header'><a href="#has-many-association-reference">6.</a>  Подробная информация по связи <code>has_many</code></h3><p>Связь <code>has_many</code> создает отношение один-ко-многим с другой моделью. В терминах базы данных эта связь говорит, что другой класс будет иметь внешний ключ, относящийся к экземплярам этого класса.</p><h4 id='metody-dobavlyaemye-has_many' class='inside_page_header'><a href="#metody-dobavlyaemye-has_many">6.1.</a> Методы, добавляемые <code>has_many</code></h4><p>Когда объявляете связь <code>has_many</code>, объявляющий класс автоматически получает 17 методов, относящихся к связи:</p><ul><li><code>collection</code>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;(object, ...)</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete(object, ...)</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy(object, ...)</code></a>
</li><li><code>collection=(objects)</code>
</li><li><code>collection_singular_ids</code>
</li><li><code>collection_singular_ids=(ids)</code>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find(...)</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where(...)</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?(...)</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build(attributes = {})</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create(attributes = {})</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create-21"><code>collection.create!(attributes = {})</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a>
</li></ul><p>Во всех этих методах <code>collection</code> заменяется символом, переданным как первый аргумент в <code>has_many</code>, и <code>collection_singular</code> заменяется версией в единственном числе этого символа. Например, имеем объявление:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Каждый экземпляр модели <code>Author</code> будет иметь эти методы:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">books</span>
<span class="n">books</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="o">=</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
<span class="n">book_ids</span>
<span class="n">book_ids</span><span class="o">=</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">clear</span>
<span class="n">books</span><span class="p">.</span><span class="nf">empty?</span>
<span class="n">books</span><span class="p">.</span><span class="nf">size</span>
<span class="n">books</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">books</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">books</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
</div>
<h5 id='collection' class='inside_page_header'><a href="#collection">6.1.1.</a> <code>collection</code></h5><p>Метод <code>collection</code> возвращает Relation всех связанных объектов. Если нет связанных объектов, он возвращает пустой Relation.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span>
</code></pre>
</div>
<h5 id='collection-lt-lt-object' class='inside_page_header'><a href="#collection-lt-lt-object">6.1.2.</a> <code>collection&lt;&lt;(object, ...)</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;</code></a> добавляет один или более объектов в коллекцию, устанавливая их внешние ключи равными первичному ключу вызывающей модели.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span> <span class="o">&lt;&lt;</span> <span class="vi">@book1</span>
</code></pre>
</div>
<h5 id='collection-delete-object' class='inside_page_header'><a href="#collection-delete-object">6.1.3.</a> <code>collection.delete(object, ...)</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete</code></a> убирает один или более объектов из коллекции, установив их внешние ключи в <code>NULL</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="vi">@book1</span><span class="p">)</span>
</code></pre>
</div>
<div class="warning"><p>Объекты будут в дополнение уничтожены, если связаны с <code>dependent: :destroy</code>, и удалены, если они связаны с <code>dependent: :delete_all</code>.</p></div><h5 id='collection-destroy-object' class='inside_page_header'><a href="#collection-destroy-object">6.1.4.</a> <code>collection.destroy(object, ...)</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy</code></a> убирает один или более объектов из коллекции, выполняя <code>destroy</code> для каждого объекта.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="vi">@book1</span><span class="p">)</span>
</code></pre>
</div>
<div class="warning"><p>Объекты будут <em>всегда</em> удаляться из базы данных, игнорируя опцию <code>:dependent</code>.</p></div><h5 id='collection-objects' class='inside_page_header'><a href="#collection-objects">6.1.5.</a> <code>collection=(objects)</code></h5><p>Метод <code>collection=</code> делает коллекцию содержащей только представленные объекты, добавляя и удаляя по мере необходимости. Изменения будут персистентными в базе данных.</p><h5 id='collection_singular_ids' class='inside_page_header'><a href="#collection_singular_ids">6.1.6.</a> <code>collection_singular_ids</code></h5><p>Метод <code>collection_singular_ids</code> возвращает массив id объектов в коллекции.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@book_ids</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">book_ids</span>
</code></pre>
</div>
<h5 id='collection_singular_ids-ids' class='inside_page_header'><a href="#collection_singular_ids-ids">6.1.7.</a> <code>collection_singular_ids=(ids)</code></h5><p>Метод <code>collection_singular_ids=</code> делает коллекцию содержащей только объекты, идентифицированные представленными значениями первичного ключа, добавляя и удаляя по мере необходимости. Изменения будут персистентными в базе данных.</p><h5 id='collection-clear' class='inside_page_header'><a href="#collection-clear">6.1.8.</a> <code>collection.clear</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a> убирает каждый объект из коллекции в соответствии со стратегией, определенной опцией <code>dependent</code>. Если опция не указана, он следует стратегии по умолчанию. Стратегия по умолчанию для <code>has_many :through</code> это <code>delete_all</code>, а для связей <code>has_many</code> — установить их внешние ключи в <code>NULL</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">clear</span>
</code></pre>
</div>
<div class="warning"><p>Объекты будут удалены, если они связаны с помощью <code>dependent: :destroy</code> или <code>dependent: :destroy_async</code>, как и с помощью <code>dependent: :delete_all</code>.</p></div><h5 id='collection-empty' class='inside_page_header'><a href="#collection-empty">6.1.9.</a> <code>collection.empty?</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a> возвращает <code>true</code>, если коллекция не содержит каких-либо связанных объектов.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="o">&lt;</span><span class="sx">% if </span><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">empty?</span> <span class="sx">%&gt;
  No Books Found
&lt;% end %&gt;</span>
</code></pre>
</div>
<h5 id='collection-size' class='inside_page_header'><a href="#collection-size">6.1.10.</a> <code>collection.size</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a> возвращает количество объектов в коллекции.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@book_count</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>
</code></pre>
</div>
<h5 id='collection-find' class='inside_page_header'><a href="#collection-find">6.1.11.</a> <code>collection.find(...)</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find</code></a> ищет объекты в таблице коллекции.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@available_book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
</div>
<h5 id='collection-where' class='inside_page_header'><a href="#collection-where">6.1.12.</a> <code>collection.where(...)</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where</code></a> ищет объекты в коллекции, основываясь на переданных условиях, но объекты загружаются лениво, что означает, что база данных запрашивается только когда происходит доступ к объекту(-там).</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@available_books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">available: </span><span class="kp">true</span><span class="p">)</span> <span class="c1"># Пока нет запроса</span>
<span class="vi">@available_book</span> <span class="o">=</span> <span class="vi">@available_books</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Теперь база данных будет запрошена</span>
</code></pre>
</div>
<h5 id='collection-exists' class='inside_page_header'><a href="#collection-exists">6.1.13.</a> <code>collection.exists?(...)</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?</code></a> проверяет, существует ли в таблице коллекции объект, отвечающий представленным условиям.</p><h5 id='collection-build-attributes' class='inside_page_header'><a href="#collection-build-attributes">6.1.14.</a> <code>collection.build(attributes = {})</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build</code></a> возвращает один или массив объектов связанного типа. Объект(ы) будут экземплярами с переданными атрибутами, будет создана ссылка через их внешние ключи, но связанные объекты <em>не</em> будут пока сохранены.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span>
                            <span class="ss">book_number: </span><span class="s2">"A12345"</span><span class="p">)</span>

<span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">build</span><span class="p">([</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12346"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12347"</span> <span class="p">}])</span>
</code></pre>
</div>
<h5 id='collection-create-attributes' class='inside_page_header'><a href="#collection-create-attributes">6.1.15.</a> <code>collection.create(attributes = {})</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create</code></a> возвращает один или массив новых объектов связанного типа. Объект(ы) будут экземплярами с переданными атрибутами, будет создана ссылка через его внешний ключ, и, если он пройдет валидации, определенные в связанной модели, связанный объект <em>будет</em> сохранен</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span>
                             <span class="ss">book_number: </span><span class="s2">"A12345"</span><span class="p">)</span>

<span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">([</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12346"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12347"</span> <span class="p">}])</span>
</code></pre>
</div>
<h5 id='collection-create-attributes2' class='inside_page_header'><a href="#collection-create-attributes2">6.1.16.</a> <code>collection.create!(attributes = {})</code></h5><p>Работает так же, как вышеприведенный <code>collection.create</code>, но вызывает <code>ActiveRecord::RecordInvalid</code>, если запись невалидна.</p><h5 id='collection-reload' class='inside_page_header'><a href="#collection-reload">6.1.17.</a> <code>collection.reload</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a> возвращает Relation всех связанных объектов, принудительно читая базу данных. Если нет связанных объектов, он возвращает пустой Relation.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
</div>
<h4 id='optsii-dlya-has_many' class='inside_page_header'><a href="#optsii-dlya-has_many">6.2.</a> Опции для <code>has_many</code></h4><p>Хотя Rails использует разумные значения по умолчанию, работающие во многих ситуациях, бывают случаи, когда хочется изменить поведение связи <code>has_many</code>. Такая настройка легко выполнима с помощью передачи опций при создании связи. Например, эта связь использует две такие опции:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">dependent: :delete_all</span><span class="p">,</span> <span class="ss">validate: </span><span class="kp">false</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Связь <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many</code></a> поддерживает эти опции:</p><ul><li><code>:as</code>
</li><li><code>:autosave</code>
</li><li><code>:class_name</code>
</li><li><code>:counter_cache</code>
</li><li><code>:dependent</code>
</li><li><code>:foreign_key</code>
</li><li><code>:inverse_of</code>
</li><li><code>:primary_key</code>
</li><li><code>:source</code>
</li><li><code>:source_type</code>
</li><li><code>:through</code>
</li><li><code>:validate</code>
</li></ul><h5 id='as2' class='inside_page_header'><a href="#as2">6.2.1.</a> <code>:as</code></h5><p>Установка опции <code>:as</code> показывает, что это полиморфная связь. Полиморфные связи подробно рассматривались <a href="#polymorphic-associations">ранее</a>.</p><h5 id='autosave3' class='inside_page_header'><a href="#autosave3">6.2.2.</a> <code>:autosave</code></h5><p>Если установить опцию <code>:autosave</code> в <code>true</code>, Rails сохранит любые загруженные связанные члены и уничтожит члены, помеченные для уничтожения, всякий раз, когда сохраняется родительский объект. Но установить <code>:autosave</code> в <code>false</code> - не то же самое, что не устанавливать опцию <code>:autosave</code>. Если опция <code>:autosave</code> отсутствует, то новые связанные объекты будут сохранены, но обновленные связанные объекты сохранены не будут.</p><h5 id='class_name3' class='inside_page_header'><a href="#class_name3">6.2.3.</a> <code>:class_name</code></h5><p>Если имя другой модели не может быть произведено из имени связи, можете использовать опцию <code>:class_name</code> для предоставления имени модели. Например, если автор имеет много книг, но фактическое имя модели, содержащей книги, это <code>Transaction</code>, можете установить это следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Transaction"</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='counter_cache2' class='inside_page_header'><a href="#counter_cache2">6.2.4.</a> <code>:counter_cache</code></h5><p>Эта опция используется для настройки произвольно названного <code>:counter_cache</code>. Эту опцию нужно использовать, только если вы изменили имя вашего <code>:counter_cache</code> у <a href="#options-for-belongs-to">связи belongs_to</a>.</p><h5 id='dependent3' class='inside_page_header'><a href="#dependent3">6.2.5.</a> <code>:dependent</code></h5><p>Управляет тем, что произойдет со связанными объектами, когда его владелец будет уничтожен:</p><ul><li><code>:destroy</code> приведет к тому, что связанные объекты также будут уничтожены
</li><li><code>:delete_all</code> приведет к тому, что связанные объекты будут удалены из базы данных напрямую (таким образом не будут выполнены колбэки)
</li><li><code>:destroy_async</code>: когда объект уничтожается, задание <code>ActiveRecord::DestroyAssociationAsyncJob</code> ставится в очередь, которое вызовет destroy на его связанных объектах. Чтобы это работало, должен быть настроен Active Job.
</li><li><code>:nullify</code> приведет к тому, что внешние ключи будет установлен <code>NULL</code>. Столбцы полиморфного типа на полиморфных связях также обнуляются. Колбэки не выполняются.
</li><li><code>:restrict_with_exception</code> приведет к вызову исключения <code>ActiveRecord::DeleteRestrictionError</code>, если есть какой-нибудь связанный объект
</li><li><code>:restrict_with_error</code> приведет к ошибке, добавляемой к владельцу, если есть какой-нибудь связанный объект
</li></ul><p>Опции <code>:destroy</code> и <code>:delete_all</code> также влияют на семантику методов <code>collection.delete</code> и <code>collection=</code>, вынуждая их удалять связанные объекты при удалении из коллекции.</p><h5 id='foreign_key3' class='inside_page_header'><a href="#foreign_key3">6.2.6.</a> <code>:foreign_key</code></h5><p>По соглашению Rails предполагает, что столбец, используемый для хранения внешнего ключа в этой модели, имеет имя модели с добавленным суффиксом <code>_id</code>. Опция <code>:foreign_key</code> позволяет установить имя внешнего ключа явно:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"cust_id"</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="info"><p>В любом случае, Rails не создаст столбцы внешнего ключа за вас. Вам необходимо явно определить их в своих миграциях.</p></div><h5 id='inverse_of3' class='inside_page_header'><a href="#inverse_of3">6.2.7.</a> <code>:inverse_of</code></h5><p>Опция <code>:inverse_of</code> определяет имя связи <code>belongs_to</code>, являющейся обратной для этой связи. Подробности смотрите в разделе <a href="#bi-directional-associations">Двунаправленная связь</a>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: :author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">inverse_of: :books</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='primary_key3' class='inside_page_header'><a href="#primary_key3">6.2.8.</a> <code>:primary_key</code></h5><p>По соглашению, Rails предполагает, что столбец, используемый для хранения первичного ключа, это <code>id</code>. Вы можете переопределить это и явно определить первичный ключ с помощью опции <code>:primary_key</code>.</p><p>Допустим, в таблице <code>users</code> есть <code>id</code> в качестве primary_key, но также имеется столбец <code>guid</code>. Имеется требование, что таблица <code>todos</code> должна содержать значение столбца <code>guid</code>, а не значение <code>id</code>. Это достигается следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:todos</span><span class="p">,</span> <span class="ss">primary_key: :guid</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Теперь, если выполнить <code>@todo = @user.todos.create</code>, то в запись <code>@todo</code> значение <code>user_id</code> будет таким же, как значение <code>guid</code> в <code>@user</code>.</p><h5 id='source2' class='inside_page_header'><a href="#source2">6.2.9.</a> <code>:source</code></h5><p>Опция <code>:source</code> определяет имя источника связи для связи <code>has_many :through</code>. Эту опцию нужно использовать, только если имя источника связи не может быть автоматически выведено из имени связи.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">has_many</span> <span class="ss">:paperbacks</span><span class="p">,</span> <span class="ss">through: :books</span><span class="p">,</span> <span class="ss">source: :format</span><span class="p">,</span> <span class="ss">source_type: </span><span class="s2">"Paperback"</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:format</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Hardback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
<span class="k">class</span> <span class="nc">Paperback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
</code></pre>
</div>
<h5 id='source_type2' class='inside_page_header'><a href="#source_type2">6.2.10.</a> <code>:source_type</code></h5><p>Опция <code>:source_type</code> определяет тип источника связи для связи <code>has_many :through</code>, который действует при полиморфной связи.</p><h5 id='through2' class='inside_page_header'><a href="#through2">6.2.11.</a> <code>:through</code></h5><p>Опция <code>:through</code> определяет соединительную модель, через которую выполняется запрос. Связи <code>has_many :through</code> предоставляют способ осуществления отношений многие-ко-многим, как обсуждалось <a href="#the-has-many-through-association">ранее в этом руководстве</a>.</p><h5 id='validate3' class='inside_page_header'><a href="#validate3">6.2.12.</a> <code>:validate</code></h5><p>Если установите опцию <code>:validate</code> в <code>false</code>, тогда новые связанные объекты не будут проходить валидацию всякий раз, когда вы сохраняете этот объект. По умолчанию она равна <code>true</code>: новые связанные объекты проходят валидацию, когда этот объект сохраняется.</p><h4 id='skoupy-dlya-has_many' class='inside_page_header'><a href="#skoupy-dlya-has_many">6.3.</a> Скоупы для <code>has_many</code></h4><p>Иногда хочется настроить запрос, используемый <code>has_many</code>. Такая настройка может быть достигнута с помощью блока скоупа. Например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">processed: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Внутри блока скоупа можно использовать любые стандартные <a href="/active-record-querying">методы запросов</a>. Далее обсудим следующие из них:</p><ul><li><code>where</code>
</li><li><code>extending</code>
</li><li><code>group</code>
</li><li><code>includes</code>
</li><li><code>limit</code>
</li><li><code>offset</code>
</li><li><code>order</code>
</li><li><code>readonly</code>
</li><li><code>select</code>
</li><li><code>distinct</code>
</li></ul><h5 id='where3' class='inside_page_header'><a href="#where3">6.3.1.</a> <code>where</code></h5><p>Метод <code>where</code> позволяет определить условия, которым должен отвечать связанный объект.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:confirmed_books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"confirmed = 1"</span> <span class="p">},</span>
    <span class="ss">class_name: </span><span class="s2">"Book"</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Также можно задать условия хэшем:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:confirmed_books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">confirmed: </span><span class="kp">true</span> <span class="p">},</span>
    <span class="ss">class_name: </span><span class="s2">"Book"</span>
<span class="k">end</span>
</code></pre>
</div>
<p>При использовании опции <code>where</code> хэшем, при создание записи через эту связь будет автоматически применен скоуп с использованием хэша. В этом случае при использовании <code>@author.confirmed_books.create</code> или <code>@author.confirmed_books.build</code> будут созданы книги, в которых столбец confirmed будет иметь значение <code>true</code>.</p><h5 id='extending' class='inside_page_header'><a href="#extending">6.3.2.</a> <code>extending</code></h5><p>Метод <code>extending</code> определяет именованный модуль для расширения прокси связи. Расширения связей подробно обсуждаются <a href="#association-callbacks-and-extensions">позже в этом руководстве</a>.</p><h5 id='group' class='inside_page_header'><a href="#group">6.3.3.</a> <code>group</code></h5><p>Метод <code>group</code> предоставляет имя атрибута, по которому группируется результирующий набор, используя выражение <code>GROUP BY</code> в поисковом SQL.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">group</span> <span class="s1">'books.id'</span> <span class="p">},</span>
                      <span class="ss">through: :books</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='includes3' class='inside_page_header'><a href="#includes3">6.3.4.</a> <code>includes</code></h5><p>Можете использовать метод <code>includes</code> для определения связей второго порядка, которые должны быть нетерпеливо загружены, когда эта связь используется. Например, рассмотрим эти модели:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Если вы часто получаете главы прямо из авторов (<code>@author.books.chapters</code>), тогда можете сделать свой код более эффективным, включив главы в связь от авторов к книгам:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:chapters</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='limit' class='inside_page_header'><a href="#limit">6.3.5.</a> <code>limit</code></h5><p>Метод <code>limit</code> позволяет ограничить общее количество объектов, которые будут выбраны через связь.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:recent_books</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'published_at desc'</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="p">},</span>
    <span class="ss">class_name: </span><span class="s2">"Book"</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='offset' class='inside_page_header'><a href="#offset">6.3.6.</a> <code>offset</code></h5><p>Метод <code>offset</code> позволяет определить начальное смещение для выбора объектов через связь. Например, <code>-&gt; { offset(11) }</code> пропустит первые 11 записей.</p><h5 id='order' class='inside_page_header'><a href="#order">6.3.7.</a> <code>order</code></h5><p>Метод <code>order</code> предписывает порядок, в котором связанные объекты будут получены (в синтаксисе SQL, используемом в условии <code>ORDER BY</code>).</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span> <span class="s2">"date_confirmed DESC"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='readonly3' class='inside_page_header'><a href="#readonly3">6.3.8.</a> <code>readonly</code></h5><p>При использовании метода <code>readonly</code>, связанные объекты будут доступны только для чтения, когда получены посредством связи.</p><h5 id='select3' class='inside_page_header'><a href="#select3">6.3.9.</a> <code>select</code></h5><p>Метод <code>select</code> позволяет переопределить SQL условие <code>SELECT</code>, которое используется для получения данных о связанном объекте. По умолчанию Rails получает все столбцы.</p><div class="warning"><p>Если укажете свой собственный <code>select</code>, не забудьте включить столбцы первичного ключа и внешнего ключа в связанной модели. Если так не сделать, Rails выдаст ошибку.</p></div><h5 id='distinct' class='inside_page_header'><a href="#distinct">6.3.10.</a> <code>distinct</code></h5><p>Используйте метод <code>distinct</code>, чтобы убирать дубликаты из коллекции. Это полезно в сочетании с опцией <code>:through</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:readings</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">through: :readings</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'John'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Article</span> <span class="ss">id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"a1"</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Article</span> <span class="ss">id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"a1"</span><span class="kt">&gt;</span><span class="p">]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Reading</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">12</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">5</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">13</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">5</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre>
</div>
<p>В вышеописанной задаче два reading, и <code>person.articles</code> выявляет их оба, даже если эти записи указывают на одну и ту же статью.</p><p>Давайте установим <code>distinct</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Person</span>
  <span class="n">has_many</span> <span class="ss">:readings</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">distinct</span> <span class="p">},</span> <span class="ss">through: :readings</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Honda'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Article</span> <span class="ss">id: </span><span class="mi">7</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"a1"</span><span class="kt">&gt;</span><span class="p">]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Reading</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">16</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">7</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">7</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">17</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">7</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">7</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre>
</div>
<p>В вышеописанной задаче все еще два reading. Однако <code>person.articles</code> показывает только одну статью, поскольку коллекция загружает только уникальные записи.</p><p>Если вы хотите быть уверенными, что после вставки все записи персистентной связи различны (и, таким образом, убедиться, что при просмотре связи никогда не будет дублирующихся записей), следует добавить уникальный индекс для самой таблицы. Например, если таблица называется <code>readings</code>, и вы хотите убедиться, что все публикации могут быть добавлены к персоне один раз, следует добавить в миграцию:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">add_index</span> <span class="ss">:readings</span><span class="p">,</span> <span class="p">[</span><span class="ss">:person_id</span><span class="p">,</span> <span class="ss">:article_id</span><span class="p">],</span> <span class="ss">unique: </span><span class="kp">true</span>
</code></pre>
</div>
<p>Как только у вас появится этот индекс уникальности, попытка добавить статью к персоне дважды вызовет ошибку <code>ActiveRecord::RecordNotUnique</code>:</p><div class="code_container">
  <pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Honda'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="go">ActiveRecord::RecordNotUnique
</span></code></pre>
</div>
<p>Отметьте, что проверка уникальности при использовании чего-то, наподобие <code>include?</code>, подвержено состояниям гонки. Не пытайтесь использовать <code>include?</code> для соблюдения уникальности в связи. Используя вышеприведенный пример со статьёй, нижеследующий код вызовет гонку, поскольку несколько пользователей могут использовать его одновременно:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span> <span class="k">unless</span> <span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
</code></pre>
</div>
<h4 id='kogda-sohranyayutsya-ob-ekty3' class='inside_page_header'><a href="#kogda-sohranyayutsya-ob-ekty3">6.4.</a> Когда сохраняются объекты?</h4><p>Когда вы назначаете объект связью <code>has_many</code>, этот объект автоматически сохраняется (для того, чтобы обновить его внешний ключ). Если назначаете несколько объектов в одном выражении, они все будут сохранены.</p><p>Если одно из этих сохранений проваливается из-за ошибок валидации, тогда выражение назначения возвращает <code>false</code>, и само назначение отменяется.</p><p>Если родительский объект (который объявляет связь <code>has_many</code>) является несохраненным (то есть <code>new_record?</code> возвращает <code>true</code>), тогда дочерние объекты не сохраняются при добавлении. Все несохраненные члены связи сохранятся автоматически, когда сохранится родительский объект.</p><p>Если вы хотите назначить объект связью <code>has_many</code> без сохранения объекта, используйте метод <code>collection.build</code>.</p><h3 id='podrobnaya-informatsiya-po-svyazi-has_and_belongs_to_many' class='inside_page_header'><a href="#podrobnaya-informatsiya-po-svyazi-has_and_belongs_to_many">7.</a> Подробная информация по связи <code>has_and_belongs_to_many</code></h3><p>Связь <code>has_and_belongs_to_many</code> создает отношение многие-ко-многим с другой моделью. В терминах базы данных это связывает два класса через промежуточную соединительную таблицу, которая включает внешние ключи, относящиеся к каждому классу.</p><h4 id='metody-dobavlyaemye-has_and_belongs_to_many' class='inside_page_header'><a href="#metody-dobavlyaemye-has_and_belongs_to_many">7.1.</a> Методы, добавляемые <code>has_and_belongs_to_many</code></h4><p>Когда объявляете связь <code>has_and_belongs_to_many</code>, объявляющий класс автоматически получает несколько методов, относящихся к связи:</p><ul><li><code>collection</code>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;(object, ...)</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete(object, ...)</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy(object, ...)</code></a>
</li><li><code>collection=(objects)</code>
</li><li><code>collection_singular_ids</code>
</li><li><code>collection_singular_ids=(ids)</code>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find(...)</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where(...)</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?(...)</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build(attributes = {})</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create(attributes = {})</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create-21"><code>collection.create!(attributes = {})</code></a>
</li><li><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a>
</li></ul><p>Во всех этих методах <code>collection</code> заменяется символом, переданным как первый аргумент в <code>has_and_belongs_to_many</code>, а <code>collection_singular</code> заменяется версией в единственном числе этого символа. Например, имеем объявление:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Каждый экземпляр модели <code>Part</code> будет иметь следующие методы:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">assemblies</span>
<span class="n">assemblies</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="o">=</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
<span class="n">assembly_ids</span>
<span class="n">assembly_ids</span><span class="o">=</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">clear</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">empty?</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">size</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
</div>
<h5 id='dopolnitelnye-metody-stolbtsov' class='inside_page_header'><a href="#dopolnitelnye-metody-stolbtsov">7.1.1.</a> Дополнительные методы столбцов</h5><p>Если соединительная таблица для связи <code>has_and_belongs_to_many</code> имеет дополнительные столбцы, кроме двух внешних ключей, эти столбцы будут добавлены как атрибуты к записям, получаемым посредством связи. Записи, возвращаемые с дополнительными атрибутами, будут всегда только для чтения, поскольку Rails не может сохранить значения этих атрибутов.</p><div class="warning"><p>Использование дополнительных атрибутов в соединительной таблице в связи has_and_belongs_to_many устарело. Если требуется этот тип сложного поведения таблицы, соединяющей две модели в отношениях многие-ко-многим, следует использовать связь <code>has_many :through</code> вместо <code>has_and_belongs_to_many</code>.</p></div><h5 id='collection2' class='inside_page_header'><a href="#collection2">7.1.2.</a> <code>collection</code></h5><p>Метод <code>collection</code> возвращает Relation всех связанных объектов. Если нет связанных объектов, он возвращает пустой Relation.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span>
</code></pre>
</div>
<h5 id='collection-lt-lt-object2' class='inside_page_header'><a href="#collection-lt-lt-object2">7.1.3.</a> <code>collection&lt;&lt;(object, ...)</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;</code></a> добавляет один или более объектов в коллекцию, создавая записи в соединительной таблице.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span> <span class="o">&lt;&lt;</span> <span class="vi">@assembly1</span>
</code></pre>
</div>
<div class="note"><p>Этот метод - просто псевдоним к <code>collection.concat</code> и <code>collection.push</code>.</p></div><h5 id='collection-delete-object2' class='inside_page_header'><a href="#collection-delete-object2">7.1.4.</a> <code>collection.delete(object, ...)</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete</code></a> убирает один или более объектов из коллекции, удаляя записи в соединительной таблице. Это не уничтожает объекты.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="vi">@assembly1</span><span class="p">)</span>
</code></pre>
</div>
<h5 id='collection-destroy-object2' class='inside_page_header'><a href="#collection-destroy-object2">7.1.5.</a> <code>collection.destroy(object, ...)</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy</code></a> убирает один или более объектов из коллекции, удаляя записи в соединительной таблице. Это не уничтожает объекты.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="vi">@assembly1</span><span class="p">)</span>
</code></pre>
</div>
<h5 id='collection-objects2' class='inside_page_header'><a href="#collection-objects2">7.1.6.</a> <code>collection=(objects)</code></h5><p>Метод <code>collection=</code> делает коллекцию содержащей только представленные объекты, добавляя и удаляя по мере необходимости. Изменения будут персистентными в базе данных.</p><h5 id='collection_singular_ids2' class='inside_page_header'><a href="#collection_singular_ids2">7.1.7.</a> <code>collection_singular_ids</code></h5><p>Метод <code>collection_singular_ids</code> возвращает массив id объектов в коллекции.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@assembly_ids</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assembly_ids</span>
</code></pre>
</div>
<h5 id='collection_singular_ids-ids2' class='inside_page_header'><a href="#collection_singular_ids-ids2">7.1.8.</a> <code>collection_singular_ids=(ids)</code></h5><p>Метод <code>collection_singular_ids=</code> делает коллекцию содержащей только объекты, идентифицированные представленными значениями первичного ключа, добавляя и удаляя по мере необходимости. Изменения будут персистентными в базе данных.</p><h5 id='collection-clear2' class='inside_page_header'><a href="#collection-clear2">7.1.9.</a> <code>collection.clear</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a> убирает каждый объект из коллекции, удаляя строки из соединительной таблицы. Это не уничтожает связанные объекты.</p><h5 id='collection-empty2' class='inside_page_header'><a href="#collection-empty2">7.1.10.</a> <code>collection.empty?</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a> возвращает <code>true</code>, если коллекция не содержит каких-либо связанных объектов.</p><div class="code_container">
  <pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">empty?</span> <span class="cp">%&gt;</span>
  This part is not used in any assemblies
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
</div>
<h5 id='collection-size2' class='inside_page_header'><a href="#collection-size2">7.1.11.</a> <code>collection.size</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a> возвращает количество объектов в коллекции.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@assembly_count</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">size</span>
</code></pre>
</div>
<h5 id='collection-find2' class='inside_page_header'><a href="#collection-find2">7.1.12.</a> <code>collection.find(...)</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find</code></a> ищет объекты в таблице коллекции.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
</div>
<h5 id='collection-where2' class='inside_page_header'><a href="#collection-where2">7.1.13.</a> <code>collection.where(...)</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where</code></a> ищет объекты в коллекции, основываясь на переданных условиях, но объекты загружаются лениво, что означает, что база данных запрашивается только когда происходит доступ к объекту(-там).</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@new_assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"created_at &gt; ?"</span><span class="p">,</span> <span class="mi">2</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
</code></pre>
</div>
<h5 id='collection-exists2' class='inside_page_header'><a href="#collection-exists2">7.1.14.</a> <code>collection.exists?(...)</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?</code></a> проверяет, существует ли в таблице коллекции объект, отвечающий представленным условиям.</p><h5 id='collection-build-attributes2' class='inside_page_header'><a href="#collection-build-attributes2">7.1.15.</a> <code>collection.build(attributes = {})</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build</code></a> возвращает один или более объектов связанного типа. Эти объекты будут экземплярами с переданными атрибутами, и будет создана связь через соединительную таблицу, но связанный объект пока <em>не</em> будет сохранен.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">build</span><span class="p">({</span><span class="ss">assembly_name: </span><span class="s2">"Transmission housing"</span><span class="p">})</span>
</code></pre>
</div>
<h5 id='collection-create-attributes3' class='inside_page_header'><a href="#collection-create-attributes3">7.1.16.</a> <code>collection.create(attributes = {})</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create</code></a> возвращает один или более объектов связанного типа. Эти объекты будут экземплярами с переданными атрибутами, будет создана связь через соединительную таблицу, и, если он пройдет валидации, определенные в связанной модели, связанный объект <em>будет</em> сохранен.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">create</span><span class="p">({</span><span class="ss">assembly_name: </span><span class="s2">"Transmission housing"</span><span class="p">})</span>
</code></pre>
</div>
<h5 id='collection-create-attributes4' class='inside_page_header'><a href="#collection-create-attributes4">7.1.17.</a> <code>collection.create!(attributes = {})</code></h5><p>Работает так же, как вышеприведенный <code>collection.create</code>, но вызывает <code>ActiveRecord::RecordInvalid</code>, если запись невалидна.</p><h5 id='collection-reload2' class='inside_page_header'><a href="#collection-reload2">7.1.18.</a> <code>collection.reload</code></h5><p>Метод <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a> возвращает Relation всех связанных объектов, принудительно читая базу данных. Если нет связанных объектов, он возвращает пустой Relation.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="vi">@assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
</div>
<h4 id='optsii-dlya-has_and_belongs_to_many' class='inside_page_header'><a href="#optsii-dlya-has_and_belongs_to_many">7.2.</a> Опции для <code>has_and_belongs_to_many</code></h4><p>Хотя Rails использует разумные значения по умолчанию, работающие во многих ситуациях, бывают случаи, когда хочется изменить поведение связи <code>has_and_belongs_to_many</code>. Такая настройка легко выполнима с помощью передачи опции при создании связи. Например, эта связь использует две такие опции:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">readonly</span> <span class="p">},</span>
                                       <span class="ss">autosave: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Связь <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many"><code>has_and_belongs_to_many</code></a> поддерживает эти опции:</p><ul><li><code>:association_foreign_key</code>
</li><li><code>:autosave</code>
</li><li><code>:class_name</code>
</li><li><code>:foreign_key</code>
</li><li><code>:join_table</code>
</li><li><code>:validate</code>
</li></ul><h5 id='association_foreign_key' class='inside_page_header'><a href="#association_foreign_key">7.2.1.</a> <code>:association_foreign_key</code></h5><p>По соглашению Rails предполагает, что столбец в соединительной таблице, используемый для хранения внешнего ключа, указываемого на другую модель, является именем этой модели с добавленным суффиксом <code>_id</code>. Опция <code>:association_foreign_key</code> позволяет установить имя внешнего ключа явно:</p><div class="info"><p>Опции <code>:foreign_key</code> и <code>:association_foreign_key</code> полезны при настройке присоединения к себе многие-ко-многим. Например:</p></div><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:friends</span><span class="p">,</span>
      <span class="ss">class_name: </span><span class="s2">"User"</span><span class="p">,</span>
      <span class="ss">foreign_key: </span><span class="s2">"this_user_id"</span><span class="p">,</span>
      <span class="ss">association_foreign_key: </span><span class="s2">"other_user_id"</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='autosave4' class='inside_page_header'><a href="#autosave4">7.2.2.</a> <code>:autosave</code></h5><p>Если установить опцию <code>:autosave</code> в <code>true</code>, Rails сохранит любые загруженные связанные члены и уничтожит члены, помеченные для уничтожения, всякий раз, когда сохраняется родительский объект. Но установить <code>:autosave</code> в <code>false</code> - не то же самое, что не устанавливать опцию <code>:autosave</code>. Если опция <code>:autosave</code> отсутствует, то новые связанные объекты будут сохранены, но обновленные связанные объекты сохранены не будут.</p><h5 id='class_name4' class='inside_page_header'><a href="#class_name4">7.2.3.</a> <code>:class_name</code></h5><p>Если имя другой модели не может быть произведено из имени связи, можете использовать опцию <code>:class_name</code> для предоставления имени модели. Например, если часть имеет много сборок, но фактическое имя модели, содержащей сборки - это <code>Gadget</code>, можете установить это следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Gadget"</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='foreign_key4' class='inside_page_header'><a href="#foreign_key4">7.2.4.</a> <code>:foreign_key</code></h5><p>По соглашению Rails предполагает, что столбец в соединительной таблице, используемый для хранения внешнего ключа, указываемого на эту модель, имеет имя модели с добавленным суффиксом <code>_id</code>. Опция <code>:foreign_key</code> позволяет установить имя внешнего ключа явно:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:friends</span><span class="p">,</span>
      <span class="ss">class_name: </span><span class="s2">"User"</span><span class="p">,</span>
      <span class="ss">foreign_key: </span><span class="s2">"this_user_id"</span><span class="p">,</span>
      <span class="ss">association_foreign_key: </span><span class="s2">"other_user_id"</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='join_table' class='inside_page_header'><a href="#join_table">7.2.5.</a> <code>:join_table</code></h5><p>Если имя соединительной таблицы по умолчанию, основанное на алфавитном порядке, - это не то, что вам нужно, используйте опцию <code>:join_table</code>, чтобы переопределить его.</p><h5 id='validate4' class='inside_page_header'><a href="#validate4">7.2.6.</a> <code>:validate</code></h5><p>Если установите опцию <code>:validate</code> в <code>false</code>, тогда новые связанные объекты не будут проходить валидацию всякий раз, когда вы сохраняете этот объект. По умолчанию она равна <code>true</code>: новые связанные объекты проходят валидацию, когда этот объект сохраняется.</p><h4 id='skoupy-dlya-has_and_belongs_to_many' class='inside_page_header'><a href="#skoupy-dlya-has_and_belongs_to_many">7.3.</a> Скоупы для <code>has_and_belongs_to_many</code></h4><p>Иногда хочется настроить запрос, используемый <code>has_many</code>. Такая настройка может быть достигнута с помощью блока скоупа. Например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Внутри блока скоупа можно использовать любые стандартные <a href="/active-record-querying">методы запросов</a>. Далее обсудим следующие из них:</p><ul><li><code>where</code>
</li><li><code>extending</code>
</li><li><code>group</code>
</li><li><code>includes</code>
</li><li><code>limit</code>
</li><li><code>offset</code>
</li><li><code>order</code>
</li><li><code>readonly</code>
</li><li><code>select</code>
</li><li><code>distinct</code>
</li></ul><h5 id='where4' class='inside_page_header'><a href="#where4">7.3.1.</a> <code>where</code></h5><p>Метод <code>where</code> позволяет определить условия, которым должен отвечать связанный объект.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"factory = 'Seattle'"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Также можно задать условия хэшем:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">factory: </span><span class="s1">'Seattle'</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<p>При использовании опции <code>where</code> хэшем, при создание записи через эту связь будет автоматически применен скоуп с использованием хэша. В этом случае при использовании <code>@parts.assemblies.create</code> или <code>@parts.assemblies.build</code> будут созданы сборки, в которых столбец <code>factory</code> будет иметь значение <code>Seattle</code>.</p><h5 id='extending2' class='inside_page_header'><a href="#extending2">7.3.2.</a> <code>extending</code></h5><p>Метод <code>extending</code> определяет именованный модуль для расширения прокси связи. Расширения связей подробно обсуждаются <a href="#association-callbacks-and-extensions">позже в этом руководстве</a>.</p><h5 id='group2' class='inside_page_header'><a href="#group2">7.3.3.</a> <code>group</code></h5><p>Метод <code>group</code> предоставляет имя атрибута, по которому группируется результирующий набор, используя выражение <code>GROUP BY</code> в поисковом запросе SQL.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">group</span> <span class="s2">"factory"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='includes4' class='inside_page_header'><a href="#includes4">7.3.4.</a> <code>includes</code></h5><p>Можете использовать метод <code>includes</code> для определения связей второго порядка, которые должны быть нетерпеливо загружены, когда эта связь используется.</p><h5 id='limit2' class='inside_page_header'><a href="#limit2">7.3.5.</a> <code>limit</code></h5><p>Метод <code>limit</code> позволяет ограничить общее количество объектов, которые будут выбраны через связь.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Customer</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s2">"created_at DESC"</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='offset2' class='inside_page_header'><a href="#offset2">7.3.6.</a> <code>offset</code></h5><p>Метод <code>offset</code> позволяет определить начальное смещение для выбора объектов через связь. Например, <code>-&gt; { offset(11) }</code> пропустит первые 11 записей.</p><h5 id='order2' class='inside_page_header'><a href="#order2">7.3.7.</a> <code>order</code></h5><p>Метод <code>order</code> предписывает порядок, в котором связанные объекты будут получены (в синтаксисе SQL, используемом в условии <code>ORDER BY</code>).</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Customer</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span> <span class="s2">"assembly_name ASC"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<h5 id='readonly4' class='inside_page_header'><a href="#readonly4">7.3.8.</a> <code>readonly</code></h5><p>При использовании метода <code>:readonly</code>, связанные объекты будут доступны только для чтения, когда получены посредством связи.</p><h5 id='select4' class='inside_page_header'><a href="#select4">7.3.9.</a> <code>select</code></h5><p>Метод <code>select</code> позволяет переопределить SQL условие <code>SELECT</code>, которое используется для получения данных о связанном объекте. По умолчанию Rails получает все столбцы.</p><h5 id='distinct2' class='inside_page_header'><a href="#distinct2">7.3.10.</a> <code>distinct</code></h5><p>Используйте метод <code>distinct</code>, чтобы убирать дубликаты из коллекции.</p><h4 id='kogda-sohranyayutsya-ob-ekty4' class='inside_page_header'><a href="#kogda-sohranyayutsya-ob-ekty4">7.4.</a> Когда сохраняются объекты?</h4><p>Когда вы назначаете объект связью <code>has_and_belongs_to_many</code>, этот объект автоматически сохраняется (в порядке обновления соединительной таблицы). Если назначаете несколько объектов в одном выражении, они все будут сохранены.</p><p>Если одно из этих сохранений проваливается из-за ошибок валидации, тогда выражение назначения возвращает <code>false</code>, a само назначение отменяется.</p><p>Если родительский объект (который объявляет связь <code>has_and_belongs_to_many</code>) является несохраненным (то есть <code>new_record?</code> возвращает <code>true</code>), тогда дочерние объекты не сохраняются при добавлении. Все несохраненные члены связи сохранятся автоматически, когда сохранится родительский объект.</p><p>Если вы хотите назначить объект связью <code>has_and_belongs_to_many</code> без сохранения объекта, используйте метод <code>collection.build</code>.</p><h3 id='association-callbacks-and-extensions' class='inside_page_header'><a href="#association-callbacks-and-extensions">8.</a>  Подробная информация по колбэкам и расширениям связи</h3><h4 id='kolbeki-svyazi' class='inside_page_header'><a href="#kolbeki-svyazi">8.1.</a> Колбэки связи</h4><p>Обычно колбэки прицепляются к жизненному циклу объектов Active Record, позволяя вам работать с этими объектами в различных точках. Например, можете использовать колбэк <code>:before_save</code>, чтобы вызвать что-то перед тем, как объект будет сохранен.</p><p>Колбэки связи похожи на обычные колбэки, но они включаются событиями в жизненном цикле коллекции. Доступны четыре колбэка связи:</p><ul><li><code>before_add</code>
</li><li><code>after_add</code>
</li><li><code>before_remove</code>
</li><li><code>after_remove</code>
</li></ul><p>Колбэки связи объявляются с помощью добавления опций в объявление связи. Например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">before_add: :check_credit_limit</span>

  <span class="k">def</span> <span class="nf">check_credit_limit</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Rails передает добавляемый или удаляемый объект в колбэк.</p><p>Можете помещать колбэки в очередь на отдельное событие, передав их как массив:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span>
    <span class="ss">before_add: </span><span class="p">[</span><span class="ss">:check_credit_limit</span><span class="p">,</span> <span class="ss">:calculate_shipping_charges</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">check_credit_limit</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">calculate_shipping_charges</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Если колбэк <code>before_add</code> вызывает <code>:abort</code>, объект не будет добавлен в коллекцию. Подобным образом, если колбэк <code>before_remove</code> вызывает <code>:abort</code>, объект не убирается из коллекции:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># книга не будет добавлена, если достигнут лимит</span>
<span class="k">def</span> <span class="nf">check_credit_limit</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
  <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="k">if</span> <span class="n">limit_reached?</span>
<span class="k">end</span>
</code></pre>
</div>
<div class="note"><p>Эти колбэки вызываются только когда связанные объекты добавляются или убираются через коллекцию связи:</p></div><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># Вызывает колбэк `before_add`</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span> <span class="o">&lt;&lt;</span> <span class="n">book</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span> <span class="o">=</span> <span class="p">[</span><span class="n">book</span><span class="p">,</span> <span class="n">book2</span><span class="p">]</span>

<span class="c1"># Не вызывает колбэк `before_add`</span>
<span class="n">book</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">author_id: </span><span class="mi">1</span><span class="p">)</span>
</code></pre>
</div>
<h4 id='rasshireniya-svyazi' class='inside_page_header'><a href="#rasshireniya-svyazi">8.2.</a> Расширения связи</h4><p>Вы не ограничены функциональностью, которую Rails автоматически встраивает в выданные по связи объекты. Можно расширить эти объекты с помощью анонимных модулей, добавив новые методы поиска, методы создания и иные методы. Например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">find_by_book_prefix</span><span class="p">(</span><span class="n">book_number</span><span class="p">)</span>
      <span class="n">find_by</span><span class="p">(</span><span class="ss">category_id: </span><span class="n">book_number</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Если имеется расширение, которое должно быть общим для нескольких связей, можно использовать именованный модуль расширения. Например:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">FindRecentExtension</span>
  <span class="k">def</span> <span class="nf">find_recent</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"created_at &gt; ?"</span><span class="p">,</span> <span class="mi">5</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:deliveries</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Расширения могут ссылаться на внутренние методы выданных по связи объектов, используя следующие три атрибута акцессора <code>proxy_association</code>:</p><ul><li><code>proxy_association.owner</code> возвращает объект, в котором объявлена связь.
</li><li><code>proxy_association.reflection</code> возвращает объект reflection, описывающий связь.
</li><li><code>proxy_association.target</code> возвращает связанный объект для <code>belongs_to</code> или <code>has_one</code>, или коллекцию связанных объектов для <code>has_many</code> или <code>has_and_belongs_to_many</code>.
</li></ul><h3 id='nasledovanie-s-edinoy-tablitsey-sti' class='inside_page_header'><a href="#nasledovanie-s-edinoy-tablitsey-sti">9.</a> Наследование с единой таблицей (STI)</h3><p>Иногда можно делиться полями и поведением между различными моделями. Скажем, у нас есть модели Car, Motorcycle и Bicycle. Мы хотим совместно использовать поля <code>color</code> и <code>price</code> и некоторые методы всеми из них, но иметь некоторое специфичное поведение для каждого, а также различные контроллеры.</p><p>Сначала нужно сгенерировать базовую модель Vehicle:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model vehicle <span class="nb">type</span>:string color:string price:decimal<span class="o">{</span>10.2<span class="o">}</span>
</code></pre>
</div>
<p>Вы заметили, что мы добавили поле &quot;type&quot;? Так как все модели будут сохранены в одну таблицу базы данных, Rails сохранит в этот столбец имя модели, которая сохраняется. В нашем примере это может быть &quot;Car&quot;, &quot;Motorcycle&quot; или &quot;Bicycle.&quot; STI не работает без поля &quot;type&quot; в таблице.</p><p>Затем мы сгенерируем модель Car, унаследованную от Vehicle. Для этого можно использовать опцию <code>--parent=PARENT</code>, которая сгенерирует модель, унаследованную от указанного родителя и без эквивалентной миграции (так как таблица уже существует).</p><p>Например, чтобы сгенерировать модель Car:</p><div class="code_container">
  <pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model car <span class="nt">--parent</span><span class="o">=</span>Vehicle
</code></pre>
</div>
<p>Сгенерированная модель будет выглядеть так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">Vehicle</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Это означает, что все поведение, такое как связи, публичные методы и так далее, добавленное в Vehicle, доступно также для Car.</p><p>Создание автомобиля сохранит его в таблице <code>vehicles</code> со значением &quot;Car&quot; в поле <code>type</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">Car</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">color: </span><span class="s1">'Red'</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">10000</span><span class="p">)</span>
</code></pre>
</div>
<p>сгенерирует следующий SQL:</p><div class="code_container">
  <pre><code class="highlight sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"vehicles"</span> <span class="p">(</span><span class="nv">"type"</span><span class="p">,</span> <span class="nv">"color"</span><span class="p">,</span> <span class="nv">"price"</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Car'</span><span class="p">,</span> <span class="s1">'Red'</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
</code></pre>
</div>
<p>Запрос записей автомобилей будет искать только среди транспортных средств, которые являются автомобилями:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">Car</span><span class="p">.</span><span class="nf">all</span>
</code></pre>
</div>
<p>запустит подобный запрос:</p><div class="code_container">
  <pre><code class="highlight sql"><span class="k">SELECT</span> <span class="nv">"vehicles"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"vehicles"</span> <span class="k">WHERE</span> <span class="nv">"vehicles"</span><span class="p">.</span><span class="nv">"type"</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'Car'</span><span class="p">)</span>
</code></pre>
</div>


            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

   <!-- bottom rusrails -->
   <ins class="adsbygoogle"
        style="display:inline-block;width:580px;height:400px"
        data-ad-client="ca-pub-7764391801669990"
        data-ad-slot="7566253867"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
        </div>
        <div class="row-fluid">
          <div class="span12" id="footer">
            <p>
              <a target="blank" href="https://github.com/rusrails/rusrails"><img src="/assets/github-7cc23602a5ac2465f14c19492358a5a67dc24636761cc723e4d621cea0c09225.png" /></a>
              <a target="blank" href="http://twitter.com/rusrails"><img src="/assets/twitter-50e0e767c8793dec313a7dc5cfbcfe2067e3e89ea6ec64784eb7c6640f578758.png" /></a>
            </p>
            <p>
              <a href="https://creativecommons.org/licenses/by-sa/4.0/">Лицензия CC BY-SA 4.0</a>
              "Rails", "Ruby on Rails" и логотип Rails - торговые марки DHH
              <!-- Yandex.Metrika counter -->
<script>
  (function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter1006929 = new Ya.Metrika({id:1006929,
                    webvisor:true,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true});
        } catch(e) { }
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>

<noscript>
  <div>
    <img style="position:absolute; left:-9999px;" alt="" src="//mc.yandex.ru/watch/1006929" />
  </div>
</noscript>
<!-- /Yandex.Metrika counter -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64955373-1', 'auto');
  ga('send', 'pageview');

  var trackOutboundLink = function(url) {
    ga('send', 'event', 'outbound', 'click', url, {
      'transport': 'beacon',
      'hitCallback': function(){ }
    });
  }
</script>

            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="to_top" style="display: block">
      <div class="to_top_panel"></div>
    </div>
    <script src="/assets/application-8ee447905888b153d8458707061a14b1f15f69b6733e871a3ad91d80ae89e87b.js"></script>
  </body>
</html>
