<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8">
<meta content="Ruby on Rails, Ruby, Rails, Rails 3, Rails 4, Rails 5, Rails 6, Rails 6.0, Rails 6.1, Rails 7.0, Rails 7.1 руководство, начинающим, самоучитель, manual, мануал, справочник, учебник, примеры, Руби, рельсы" name="keywords"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" name="description"/>
<meta content="product" property="twitter:card"/>
<meta content="@rusrails" property="twitter:site"/>
<meta content="Rusrails: Процесс инициализации в Rails" property="twitter:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="twitter:description"/>
<meta content="@rusrails" property="twitter:creator"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="twitter:image"/>
<meta content="website" property="og:type"/>
<meta content="Rusrails: Процесс инициализации в Rails" property="og:title"/>
<meta content="Ruby on Rails руководства, учебники, статьи на русском языке" property="og:description"/>
<meta content="http://localhost:3000/initialization" property="og:url"/>
<meta content="http://rusrails.ru/assets/rusrails.png" property="og:image"/>
    <title>
      Rusrails: Процесс инициализации в Rails
    </title>
    <link rel="stylesheet" media="screen" href="/assets/application-4f65588939909a694017a295c9ca934821f6a6358454c26c5360579d7ee0054d.css" />
    <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="bjR1+tQCe3zBitCcBSaAMq1FjaJCeGq3gfM39kd78/bsUkgErJZNgj3dI8JrpAYlSYBvgOlmkERi0ly2I2xguw==" />
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="/"></a>
          <form class="navbar-search pull-right" action="/search" accept-charset="UTF-8" method="get">
            <input type="text" name="search" id="search" class="search-query" placeholder="Поиск.." />
</form>          <ul class="nav pull-right top-menu">
            <li>
              <a href="/">Главная</a>
            </li>
            <li class="dropdown">
              <a class="index-popover" href="#">
                Содержание
                <b class="caret"></b>
</a>              <div class="index-popover-content hide">
                  <ul><li><p><strong>С чего начать?</strong></p><ul><li><a href="/getting-started">Rails для начинающих</a>
</li></ul></li><li><p><strong>Модели</strong></p><ul><li><a href="/active-record-basics">Основы Active Record</a>
</li><li><a href="/active-record-migrations">Миграции Active Record</a>
</li><li><a href="/active-record-validations">Валидации Active Record</a>
</li><li><a href="/active-record-callbacks">Колбэки Active Record</a>
</li><li><a href="/active-record-associations">Связи (ассоциации) Active Record</a>
</li><li><a href="/active-record-querying">Интерфейс запросов Active Record</a>
</li><li><a href="/active-model-basics">Основы Active Model</a>
</li></ul></li><li><p><strong>Вью</strong></p><ul><li><a href="/action-view-overview">Обзор Action View</a>
</li><li><a href="/layouts-and-rendering">Макеты и рендеринг в Rails</a>
</li><li><a href="/action-view-helpers">Хелперы Action View</a>
</li><li><a href="/form-helpers">Хелперы форм в Action View</a>
</li></ul></li><li><p><strong>Контроллеры</strong></p><ul><li><a href="/action-controller-overview">Обзор Action Controller</a>
</li><li><a href="/routing">Роутинг в Rails</a>
</li></ul></li><li><p><strong>Другие компоненты</strong></p><ul><li><a href="/active-support-core-extensions">Расширения ядра Active Support</a>
</li><li><a href="/action-mailer-basics">Основы Action Mailer</a>
</li><li><a href="/action-mailbox-basics">Основы Action Mailbox</a>
</li><li><a href="/action-text-overview">Обзор Action Text</a>
</li><li><a href="/active_job_basics">Основы Active Job</a>
</li><li><a href="/active_storage_overview">Обзор Active Storage</a>
</li><li><a href="/action-cable-overview">Обзор Action Cable</a>
</li></ul></li><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/i18n">API интернационализации Rails (I18n)</a>
</li><li><a href="/testing">Тестирование приложений на Rails</a>
</li><li><a href="/security">Безопасность приложений на Rails</a>
</li><li><a href="/error-reporting">Отчет об ошибках в приложениях Rails</a>
</li></ul></li></ul><p>next_column</p><ul><li><p><strong>Копаем глубже</strong></p><ul><li><a href="/debugging-rails-applications">Отладка приложений на Rails</a>
</li><li><a href="/configuring">Конфигурирование приложений на Rails</a>
</li><li><a href="/command-line">Командная строка Rails</a>
</li><li><a href="/asset-pipeline">Asset Pipeline</a>
</li><li><a href="/working-with-javascript-in-rails">Работа с JavaScript в Rails</a>
</li><li><a href="/initialization">Процесс инициализации в Rails</a>
</li><li><a href="/autoloading-and-reloading-constants">Автозагрузка и перезагрузка констант</a>
</li><li><a href="/classic-to-zeitwerk-howto">Как перейти с Classic на Zeitwerk</a>
</li><li><a href="/caching-with-rails">Кэширование с Rails: Обзор</a>
</li><li><a href="/active-support-instrumentation">Инструментарий Active Support</a>
</li><li><a href="/api-app">Использование Rails для API-приложений</a>
</li><li><a href="/active-record-postgresql">Active Record для PostgreSQL</a>
</li><li><a href="/active-record-multiple-databases">Несколько баз данных с Active Record</a>
</li><li><a href="/active-record-encryption">Шифрование Active Record</a>
</li></ul></li><li><p><strong>Расширяем Rails</strong></p><ul><li><a href="/plugins">Основы создания плагинов Rails</a>
</li><li><a href="/rails-on-rack">Rails on Rack</a>
</li><li><a href="/generators">Создание и настройка генераторов и шаблонов Rails</a>
</li><li><a href="/engines">Engine для начинающих</a>
</li><li><a href="/threading_and_code_execution">Треды и выполнение кода в Rails</a>
</li><li><a href="/rails-application-templates">Шаблоны приложения Rails</a>
</li></ul></li><li><p><strong>Вносим вклад в Ruby on Rails</strong></p><ul><li><a href="/contributing_to_ruby_on_rails">Вносим вклад в Ruby on Rails</a>
</li><li><a href="/api_documentation_guidelines">Рекомендации по документированию API</a>
</li><li><a href="/ruby_on_rails_guides_guidelines">Рекомендации для руководств по Ruby on Rails</a>
</li><li><a href="/development_dependencies_install">Установка зависимостей для разработки</a>
</li><li><a href="/maintenance-policy">Политика поддержки (версий)</a>
</li></ul></li><li><p><strong>Заметки о релизах</strong></p><ul><li><a href="/upgrading-ruby-on-rails">Апгрейд Ruby on Rails</a>
</li><li><a href="/7_1_release_notes">Версия 7.1 - ?</a>
</li><li><a href="/7_0_release_notes">Версия 7.0 - Декабрь 2021</a>
</li><li><a href="/6_1_release_notes">Версия 6.1 - Декабрь 2020</a>
</li><li><a href="/6_0_release_notes">Версия 6.0 - Август 2019</a>
</li></ul></li></ul>
              </div>
            </li>
            <li>
              <a target="blank" href="http://api.rusrails.ru">Ruby &amp; Rails API</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="content-wrapper">
      <div class="container-fluid">
        <div class="row-fluid">
          <div class="span3 pull-right">
            <div class="well social">
              <h4>Принимаем пожелания и пул-реквесты!</h4>
              <iframe allowtransparency="true" frameborder="0" height="30" src="http://ghbtns.com/github-btn.html?user=rusrails&repo=rusrails&type=watch&count=true&size=large" width="180"></iframe>
              <p></p>
              <a class="twitter-follow-button" data-lang="ru" href="https://twitter.com/rusrails"></a>
            </div>
              <div class="well menu">
                    <ul class="nav nav-list">
      <li>
        <h4>
          <a href="#poehali">1. Поехали!</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#bin-rails">1.1. <code>bin/rails</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#config-boot-rb">1.2. <code>config/boot.rb</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#rails-commands-rb">1.3. <code>rails/commands.rb</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#rails-command-rb">1.4. <code>rails/command.rb</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#actionpack-lib-action_dispatch-rb">1.5. <code>actionpack/lib/action_dispatch.rb</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#rails-commands-server-server_command-rb">1.6. <code>rails/commands/server/server_command.rb</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#rack-lib-rack-server-rb">1.7. Rack: <code>lib/rack/server.rb</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#config-application">1.8. <code>config/application</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#rails-server-start">1.9. <code>Rails::Server#start</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#config-environment-rb">1.10. <code>config/environment.rb</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#config-application-rb">1.11. <code>config/application.rb</code></a>
</h5>      </li>
      <li>
        <h4>
          <a href="#zagruzka-rails">2. Загрузка Rails</a>
</h4>      </li>
      <li>
        <h5>
          <a href="#railties-lib-rails-all-rb">2.1. <code>railties/lib/rails/all.rb</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#vozvraschaemsya-v-config-environment-rb">2.2. Возвращаемся в <code>config/environment.rb</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#railties-lib-rails-application-rb">2.3. <code>railties/lib/rails/application.rb</code></a>
</h5>      </li>
      <li>
        <h5>
          <a href="#rack-lib-rack-server-rb2">2.4. Rack: lib/rack/server.rb</a>
</h5>      </li>
</ul>

              </div>
            <div class="well banner300 banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<!-- sidebar rusrails -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:600px"
     data-ad-client="ca-pub-7764391801669990"
     data-ad-slot="6089520660"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
          <div class="span9 content pull-left">
            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <!-- top rusrails -->
  <ins class="adsbygoogle"
       style="display:inline-block;width:980px;height:120px"
       data-ad-client="ca-pub-7764391801669990"
       data-ad-slot="4891989065"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
              <h2 id='protsess-initsializatsii-v-rails' class='inside_page_header'> Процесс инициализации в Rails</h2><p>Это руководство объясняет внутренние процессы инициализации в Rails. Это достаточно углубленное руководство, оно рекомендовано для продвинутых разработчиков на Rails.</p><p>После прочтения этого руководства вы узнаете:</p><ul><li>Как использовать <code>bin/rails server</code>.
</li><li>График инициализации Rails.
</li><li>Когда различные файлы подключаются в процессе загрузки.
</li><li>Как определен и используется интерфейс Rails::Server.
</li></ul><p>Это руководство рассмотрит каждый вызов методов, требуемых для загрузки стека Ruby on Rails для нового приложения на Rails, объяснив подробно каждую встреченную часть кода. Для целей этого руководства мы сосредоточимся на том, что произойдет при выполнении <code>bin/rails server</code> для загрузки вашего приложения.</p><div class="note"><p>Пути в этом руководстве указаны относительно Rails или приложения Rails, если не оговорено иное.</p></div><div class="info"><p>Если желаете параллельно чтению просматривать <a href="https://github.com/rails/rails">исходный код Rails</a>, мы рекомендуем использовать горячую клавишу <code>t</code>, чтобы открыть быстрый поиск файлов на GitHub.</p></div><h3 id='poehali' class='inside_page_header'><a href="#poehali">1.</a> Поехали!</h3><p>Давайте загрузим и инициализируем приложение. Приложение Rails обычно стартует с помощью запуска <code>bin/rails console</code> или <code>bin/rails server</code>.</p><h4 id='bin-rails' class='inside_page_header'><a href="#bin-rails">1.1.</a> <code>bin/rails</code></h4><p>Этот файл содержит следующее:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="no">APP_PATH</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../config/application'</span><span class="p">,</span> <span class="n">__dir__</span><span class="p">)</span>
<span class="nb">require_relative</span> <span class="s2">"../config/boot"</span>
<span class="nb">require</span> <span class="s2">"rails/commands"</span>
</code></pre>
</div>
<p>Константа <code>APP_PATH</code> будет использована позже в <code>rails/commands</code>. Файл <code>config/boot</code>, упомянутый тут, это файл <code>config/boot.rb</code> нашего приложения, который ответственен за загрузку Bundler и его настройку.</p><h4 id='config-boot-rb' class='inside_page_header'><a href="#config-boot-rb">1.2.</a> <code>config/boot.rb</code></h4><p><code>config/boot.rb</code> содержит:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="no">ENV</span><span class="p">[</span><span class="s1">'BUNDLE_GEMFILE'</span><span class="p">]</span> <span class="o">||=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../Gemfile'</span><span class="p">,</span> <span class="n">__dir__</span><span class="p">)</span>

<span class="nb">require</span> <span class="s2">"bundler/setup"</span> <span class="c1"># Set up gems listed in the Gemfile.</span>
</code></pre>
</div>
<p>В стандартном приложении Rails имеется <code>Gemfile</code>, объявляющий все зависимости приложения. <code>config/boot.rb</code> устанавливает <code>ENV[&#39;BUNDLE_GEMFILE&#39;]</code> как место расположения этого файла. Затем, если <code>Gemfile</code> существует, будет затребован <code>bundler/setup</code>. Строка используется Bundler-ом для настройки путей загрузки для зависимостей вашего <code>Gemfile</code>.</p><h4 id='rails-commands-rb' class='inside_page_header'><a href="#rails-commands-rb">1.3.</a> <code>rails/commands.rb</code></h4><p>Как только завершится <code>config/boot.rb</code>, следующим файлом, который будет затребован, является <code>rails/commands</code>, который помогает расширить псевдонимы. В нашем случае, массив <code>ARGV</code> просто содержит <code>server</code>, который будет передан дальше:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"rails/command"</span>

<span class="n">aliases</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">"g"</span>  <span class="o">=&gt;</span> <span class="s2">"generate"</span><span class="p">,</span>
  <span class="s2">"d"</span>  <span class="o">=&gt;</span> <span class="s2">"destroy"</span><span class="p">,</span>
  <span class="s2">"c"</span>  <span class="o">=&gt;</span> <span class="s2">"console"</span><span class="p">,</span>
  <span class="s2">"s"</span>  <span class="o">=&gt;</span> <span class="s2">"server"</span><span class="p">,</span>
  <span class="s2">"db"</span> <span class="o">=&gt;</span> <span class="s2">"dbconsole"</span><span class="p">,</span>
  <span class="s2">"r"</span>  <span class="o">=&gt;</span> <span class="s2">"runner"</span><span class="p">,</span>
  <span class="s2">"t"</span>  <span class="o">=&gt;</span> <span class="s2">"test"</span>
<span class="p">}</span>

<span class="n">command</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">shift</span>
<span class="n">command</span> <span class="o">=</span> <span class="n">aliases</span><span class="p">[</span><span class="n">command</span><span class="p">]</span> <span class="o">||</span> <span class="n">command</span>

<span class="no">Rails</span><span class="o">::</span><span class="no">Command</span><span class="p">.</span><span class="nf">invoke</span> <span class="n">command</span><span class="p">,</span> <span class="no">ARGV</span>
</code></pre>
</div>
<p>Если бы мы использовали <code>s</code> вместо <code>server</code>, Rails использовал бы определенные тут псевдонимы <code>aliases</code> для поиска соответствующей команды.</p><h4 id='rails-command-rb' class='inside_page_header'><a href="#rails-command-rb">1.4.</a> <code>rails/command.rb</code></h4><p>Когда кто-то вводит команду Rails, <code>invoke</code> пытается найти команду для данного пространства имен и выполняет команду, если она найдена.</p><p>Как показано, <code>Rails::Command</code> выводит справку автоматически, если <code>namespace</code> пустой.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rails</span>
  <span class="k">module</span> <span class="nn">Command</span>
    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
      <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">full_namespace</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">[],</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">full_namespace</span> <span class="o">=</span> <span class="n">full_namespace</span><span class="p">.</span><span class="nf">to_s</span>

        <span class="k">if</span> <span class="n">char</span> <span class="o">=</span> <span class="n">namespace</span> <span class="o">=~</span> <span class="sr">/:(\w+)$/</span>
          <span class="n">command_name</span><span class="p">,</span> <span class="n">namespace</span> <span class="o">=</span> <span class="vg">$1</span><span class="p">,</span> <span class="n">namespace</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">char</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="n">command_name</span> <span class="o">=</span> <span class="n">namespace</span>
        <span class="k">end</span>

        <span class="n">command_name</span><span class="p">,</span> <span class="n">namespace</span> <span class="o">=</span> <span class="s2">"help"</span><span class="p">,</span> <span class="s2">"help"</span> <span class="k">if</span> <span class="n">command_name</span><span class="p">.</span><span class="nf">blank?</span> <span class="o">||</span> <span class="no">HELP_MAPPINGS</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">command_name</span><span class="p">)</span>
        <span class="n">command_name</span><span class="p">,</span> <span class="n">namespace</span> <span class="o">=</span> <span class="s2">"version"</span><span class="p">,</span> <span class="s2">"version"</span> <span class="k">if</span> <span class="sx">%w( -v --version )</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">command_name</span><span class="p">)</span>

        <span class="n">command</span> <span class="o">=</span> <span class="n">find_by_namespace</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">command_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command</span> <span class="o">&amp;&amp;</span> <span class="n">command</span><span class="p">.</span><span class="nf">all_commands</span><span class="p">[</span><span class="n">command_name</span><span class="p">]</span>
          <span class="n">command</span><span class="p">.</span><span class="nf">perform</span><span class="p">(</span><span class="n">command_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="n">find_by_namespace</span><span class="p">(</span><span class="s2">"rake"</span><span class="p">).</span><span class="nf">perform</span><span class="p">(</span><span class="n">full_namespace</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>С помощью команды <code>server</code> Rails далее запустит следующий код:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rails</span>
  <span class="k">module</span> <span class="nn">Command</span>
    <span class="k">class</span> <span class="nc">ServerCommand</span> <span class="o">&lt;</span> <span class="no">Base</span> <span class="c1"># :nodoc:</span>
      <span class="k">def</span> <span class="nf">perform</span>
        <span class="n">extract_environment_option_from_argument</span>
        <span class="n">set_application_directory!</span>
        <span class="n">prepare_restart</span>

        <span class="no">Rails</span><span class="o">::</span><span class="no">Server</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">server_options</span><span class="p">).</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
          <span class="c1"># Require application after server sets environment to propagate</span>
          <span class="c1"># the --environment option.</span>
          <span class="nb">require</span> <span class="no">APP_PATH</span>
          <span class="no">Dir</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">root</span><span class="p">)</span>

          <span class="k">if</span> <span class="n">server</span><span class="p">.</span><span class="nf">serveable?</span>
            <span class="n">print_boot_information</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="nf">server</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="nf">served_url</span><span class="p">)</span>
            <span class="n">after_stop_callback</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">say</span> <span class="s2">"Exiting"</span> <span class="k">unless</span> <span class="n">options</span><span class="p">[</span><span class="ss">:daemon</span><span class="p">]</span> <span class="p">}</span>
            <span class="n">server</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">after_stop_callback</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="n">say</span> <span class="n">rack_server_suggestion</span><span class="p">(</span><span class="n">using</span><span class="p">)</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Этот файл изменит корень директории (путь на две директории выше <code>APP_PATH</code>, указывающего на <code>config/application.rb</code>), но только если не найден файл <code>config.ru</code>. Затем он запускает класс <code>Rails::Server</code>.</p><h4 id='actionpack-lib-action_dispatch-rb' class='inside_page_header'><a href="#actionpack-lib-action_dispatch-rb">1.5.</a> <code>actionpack/lib/action_dispatch.rb</code></h4><p>Action Dispatch - это компонент маршрутизации фреймворка Rails. Он добавляет такую функциональность, как роутинг, сессию и промежуточные программы.</p><h4 id='rails-commands-server-server_command-rb' class='inside_page_header'><a href="#rails-commands-server-server_command-rb">1.6.</a> <code>rails/commands/server/server_command.rb</code></h4><p>Класс <code>Rails::Server</code> определен в этом файле, как унаследованный от <code>Rack::Server</code>. Когда вызывается <code>Rails::Server.new</code>, вызывается метод <code>initialize</code> в <code>rails/commands/server/server_command.rb</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rails</span>
  <span class="k">class</span> <span class="nc">Server</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">Server</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
      <span class="vi">@default_options</span> <span class="o">=</span> <span class="n">options</span> <span class="o">||</span> <span class="p">{}</span>
      <span class="k">super</span><span class="p">(</span><span class="vi">@default_options</span><span class="p">)</span>
      <span class="n">set_environment</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Сперва вызывается <code>super</code>, что вызывает метод <code>initialize</code> у <code>Rack::Server</code>.</p><h4 id='rack-lib-rack-server-rb' class='inside_page_header'><a href="#rack-lib-rack-server-rb">1.7.</a> Rack: <code>lib/rack/server.rb</code></h4><p><code>Rack::Server</code> ответственен за представление обычного интерфейса сервера для всех приложений, основанных на Rack, частью которых сейчас является Rails.</p><p>Метод <code>initialize</code> в <code>Rack::Server</code> просто устанавливает несколько переменных:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">class</span> <span class="nc">Server</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
      <span class="vi">@ignore_options</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="k">if</span> <span class="n">options</span>
        <span class="vi">@use_default_options</span> <span class="o">=</span> <span class="kp">false</span>
        <span class="vi">@options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="vi">@app</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="ss">:app</span><span class="p">]</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:app</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="k">defined?</span><span class="p">(</span><span class="no">SPEC_ARGV</span><span class="p">)</span> <span class="p">?</span> <span class="no">SPEC_ARGV</span> <span class="p">:</span> <span class="no">ARGV</span>
        <span class="vi">@use_default_options</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="vi">@options</span> <span class="o">=</span> <span class="n">parse_options</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>В этом случае возвращаемое <code>Rails::Command::ServerCommand#server_options</code> значение будет присвоено <code>options</code>. Когда вычисляются строчки в выражении if, будет установлено ряд переменных экземпляра.</p><p>Метод <code>server_options</code> в <code>Rails::Command::ServerCommand</code> определен следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rails</span>
  <span class="k">module</span> <span class="nn">Command</span>
    <span class="k">class</span> <span class="nc">ServerCommand</span>
      <span class="n">no_commands</span> <span class="k">do</span>
        <span class="k">def</span> <span class="nf">server_options</span>
          <span class="p">{</span>
            <span class="ss">user_supplied_options: </span><span class="n">user_supplied_options</span><span class="p">,</span>
            <span class="ss">server:                </span><span class="n">using</span><span class="p">,</span>
            <span class="ss">log_stdout:            </span><span class="n">log_to_stdout?</span><span class="p">,</span>
            <span class="no">Port</span><span class="p">:</span>                  <span class="n">port</span><span class="p">,</span>
            <span class="no">Host</span><span class="p">:</span>                  <span class="n">host</span><span class="p">,</span>
            <span class="no">DoNotReverseLookup</span><span class="p">:</span>    <span class="kp">true</span><span class="p">,</span>
            <span class="ss">config:                </span><span class="n">options</span><span class="p">[</span><span class="ss">:config</span><span class="p">],</span>
            <span class="ss">environment:           </span><span class="n">environment</span><span class="p">,</span>
            <span class="ss">daemonize:             </span><span class="n">options</span><span class="p">[</span><span class="ss">:daemon</span><span class="p">],</span>
            <span class="ss">pid:                   </span><span class="n">pid</span><span class="p">,</span>
            <span class="ss">caching:               </span><span class="n">options</span><span class="p">[</span><span class="ss">:dev_caching</span><span class="p">],</span>
            <span class="ss">restart_cmd:           </span><span class="n">restart_command</span><span class="p">,</span>
            <span class="ss">early_hints:           </span><span class="n">early_hints</span>
          <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Значение будет присвоено переменной экземпляра <code>@options</code>.</p><p>После завершения <code>super</code> в <code>Rack::Server</code>, мы возвращаемся в <code>rails/commands/server/server_command.rb</code>. Здесь вызывается <code>set_environment</code> в контексте объекта <code>Rails::Server</code>.</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rails</span>
  <span class="k">module</span> <span class="nn">Server</span>
    <span class="k">def</span> <span class="nf">set_environment</span>
      <span class="no">ENV</span><span class="p">[</span><span class="s2">"RAILS_ENV"</span><span class="p">]</span> <span class="o">||=</span> <span class="n">options</span><span class="p">[</span><span class="ss">:environment</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>После того, как <code>initialize</code> будет закончен, мы вернемся обратно к серверной команде, где требуется <code>APP_PATH</code> (который был установлен ранее).</p><h4 id='config-application' class='inside_page_header'><a href="#config-application">1.8.</a> <code>config/application</code></h4><p>При выполнении <code>require APP_PATH</code> будет загружен <code>config/application.rb</code> (напоминаем, что <code>APP_PATH</code> определен в <code>bin/rails</code>). Этот файл находится в вашем приложении, и вы свободно можете изменять его под свои нужды.</p><h4 id='rails-server-start' class='inside_page_header'><a href="#rails-server-start">1.9.</a> <code>Rails::Server#start</code></h4><p>После загрузки <code>config/application</code> вызывается <code>server.start</code>. Этот метод определен следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rails</span>
  <span class="k">class</span> <span class="nc">Server</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">Server</span>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">after_stop_callback</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
      <span class="nb">trap</span><span class="p">(</span><span class="ss">:INT</span><span class="p">)</span> <span class="p">{</span> <span class="nb">exit</span> <span class="p">}</span>
      <span class="n">create_tmp_directories</span>
      <span class="n">setup_dev_caching</span>
      <span class="n">log_to_stdout</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:log_stdout</span><span class="p">]</span>

      <span class="k">super</span><span class="p">()</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>

    <span class="kp">private</span>
      <span class="k">def</span> <span class="nf">setup_dev_caching</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:environment</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"development"</span>
          <span class="no">Rails</span><span class="o">::</span><span class="no">DevCaching</span><span class="p">.</span><span class="nf">enable_by_argument</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="ss">:caching</span><span class="p">])</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">create_tmp_directories</span>
        <span class="sx">%w(cache pids sockets)</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir_to_make</span><span class="o">|</span>
          <span class="no">FileUtils</span><span class="p">.</span><span class="nf">mkdir_p</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">,</span> <span class="s2">"tmp"</span><span class="p">,</span> <span class="n">dir_to_make</span><span class="p">))</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">log_to_stdout</span>
        <span class="n">wrapped_app</span> <span class="c1"># touch the app so the logger is set up</span>

        <span class="n">console</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">)</span>
        <span class="n">console</span><span class="p">.</span><span class="nf">formatter</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">formatter</span>
        <span class="n">console</span><span class="p">.</span><span class="nf">level</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">level</span>

        <span class="k">unless</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">logger_outputs_to?</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">,</span> <span class="no">STDOUT</span><span class="p">)</span>
          <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span><span class="n">console</span><span class="p">))</span>
        <span class="k">end</span>
      <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Этот метод создает ловушку (trap) для сигналов <code>INT</code>, поэтому, при нажатии <code>CTRL-C</code>, сервер завершит процесс. Как видим дальше по коду, он создает директории <code>tmp/cache</code>, <code>tmp/pids</code> и <code>tmp/sockets</code>. Затем он включает кэширование в development, если <code>bin/rails server</code> вызывается с <code>--dev-caching</code>. Наконец, он вызывает <code>wrapped_app</code>, который ответственен за создание приложения Rack, а затем создает и присваивает экземпляр <code>ActiveSupport::Logger</code>.</p><p>Метод <code>super</code> вызовет <code>Rack::Server.start</code>, который определяется следующим образом:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">class</span> <span class="nc">Server</span>
    <span class="k">def</span> <span class="nf">start</span> <span class="o">&amp;</span><span class="n">blk</span>
      <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:warn</span><span class="p">]</span>
        <span class="vg">$-w</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">includes</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="ss">:include</span><span class="p">]</span>
        <span class="vg">$LOAD_PATH</span><span class="p">.</span><span class="nf">unshift</span><span class="p">(</span><span class="o">*</span><span class="n">includes</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">library</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="ss">:require</span><span class="p">]</span>
        <span class="nb">require</span> <span class="n">library</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:debug</span><span class="p">]</span>
        <span class="vg">$DEBUG</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="nb">require</span> <span class="s2">"pp"</span>
        <span class="nb">p</span> <span class="n">options</span><span class="p">[</span><span class="ss">:server</span><span class="p">]</span>
        <span class="n">pp</span> <span class="n">wrapped_app</span>
        <span class="n">pp</span> <span class="n">app</span>
      <span class="k">end</span>

      <span class="n">check_pid!</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:pid</span><span class="p">]</span>

      <span class="c1"># Touch the wrapped app, so that the config.ru is loaded before</span>
      <span class="c1"># daemonization (i.e. before chdir, etc).</span>
      <span class="n">handle_profiling</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="ss">:heapfile</span><span class="p">],</span> <span class="n">options</span><span class="p">[</span><span class="ss">:profile_mode</span><span class="p">],</span> <span class="n">options</span><span class="p">[</span><span class="ss">:profile_file</span><span class="p">])</span> <span class="k">do</span>
        <span class="n">wrapped_app</span>
      <span class="k">end</span>

      <span class="n">daemonize_app</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:daemonize</span><span class="p">]</span>

      <span class="n">write_pid</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:pid</span><span class="p">]</span>

      <span class="nb">trap</span><span class="p">(</span><span class="ss">:INT</span><span class="p">)</span> <span class="k">do</span>
        <span class="k">if</span> <span class="n">server</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="ss">:shutdown</span><span class="p">)</span>
          <span class="n">server</span><span class="p">.</span><span class="nf">shutdown</span>
        <span class="k">else</span>
          <span class="nb">exit</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">server</span><span class="p">.</span><span class="nf">run</span> <span class="n">wrapped_app</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Самой интересной частью для приложения Rails является последняя строчка, <code>server.run</code>. Здесь мы снова сталкиваемся с методом <code>wrapped_app</code>, но на этот раз мы собираемся копнуть глубже (несмотря на то, что он уже был выполнен ранее, и поэтому сейчас возвратится просто запомненный результат).</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">class</span> <span class="nc">Server</span>
    <span class="k">def</span> <span class="nf">wrapped_app</span>
      <span class="vi">@wrapped_app</span> <span class="o">||=</span> <span class="n">build_app</span> <span class="n">app</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Метод <code>app</code> отсюда определен так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">class</span> <span class="nc">Server</span>
    <span class="k">def</span> <span class="nf">app</span>
      <span class="vi">@app</span> <span class="o">||=</span> <span class="n">options</span><span class="p">[</span><span class="ss">:builder</span><span class="p">]</span> <span class="p">?</span> <span class="n">build_app_from_string</span> <span class="p">:</span> <span class="n">build_app_and_options_from_config</span>
    <span class="k">end</span>

    <span class="c1"># ...</span>

    <span class="kp">private</span>
      <span class="k">def</span> <span class="nf">build_app_and_options_from_config</span>
        <span class="k">if</span> <span class="o">!::</span><span class="no">File</span><span class="p">.</span><span class="nf">exist?</span> <span class="n">options</span><span class="p">[</span><span class="ss">:config</span><span class="p">]</span>
          <span class="nb">abort</span> <span class="s2">"configuration </span><span class="si">#{</span><span class="n">options</span><span class="p">[</span><span class="ss">:config</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found"</span>
        <span class="k">end</span>

        <span class="n">app</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Builder</span><span class="p">.</span><span class="nf">parse_file</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">options</span><span class="p">[</span><span class="ss">:config</span><span class="p">],</span> <span class="n">opt_parser</span><span class="p">)</span>
        <span class="vi">@options</span><span class="p">.</span><span class="nf">merge!</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="o">|</span> <span class="n">old</span> <span class="p">}</span>
        <span class="n">app</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">build_app_from_string</span>
        <span class="no">Rack</span><span class="o">::</span><span class="no">Builder</span><span class="p">.</span><span class="nf">new_from_string</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">options</span><span class="p">[</span><span class="ss">:builder</span><span class="p">])</span>
      <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Значение по умолчанию <code>options[:config]</code> - это <code>config.ru</code>, содержащий следующее:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="c1"># This file is used by Rack-based servers to start the application.</span>

<span class="nb">require_relative</span> <span class="s2">"config/environment"</span>

<span class="n">run</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span>
</code></pre>
</div>
<p>Метод <code>Rack::Builder.parse_file</code> принимает содержимое этого файла <code>config.ru</code> и парсит его, используя следующий код:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">class</span> <span class="nc">Builder</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">load_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">opts</span> <span class="o">=</span> <span class="no">Server</span><span class="o">::</span><span class="no">Options</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span>
      <span class="c1"># ...</span>
      <span class="n">app</span> <span class="o">=</span> <span class="n">new_from_string</span> <span class="n">cfgfile</span><span class="p">,</span> <span class="n">config</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>

    <span class="c1"># ...</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">new_from_string</span><span class="p">(</span><span class="n">builder_script</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">"(rackup)"</span><span class="p">)</span>
      <span class="nb">eval</span> <span class="s2">"Rack::Builder.new {</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">builder_script</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">}.to_app"</span><span class="p">,</span>
        <span class="no">TOPLEVEL_BINDING</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Метод <code>initialize</code> из <code>Rack::Builder</code> принимает блок и выполняет его в рамках экземпляра <code>Rack::Builder</code>. Это то место, в котором происходит большая часть процесса инициализации Rails. Сперва запускается строчка <code>require</code> для <code>config/environment.rb</code> в <code>config.ru</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="nb">require_relative</span> <span class="s2">"config/environment"</span>
</code></pre>
</div>
<h4 id='config-environment-rb' class='inside_page_header'><a href="#config-environment-rb">1.10.</a> <code>config/environment.rb</code></h4><p>Этот файл является общим файлом, требуемым и <code>config.ru</code> (<code>bin/rails server</code>), и Passenger. Тут встречаются два способа, как можно запустить сервер; все, что было до этой точки - была настройка Rack и Rails.</p><p>Этот файл начинается с затребования <code>config/application.rb</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="nb">require_relative</span> <span class="s2">"application"</span>
</code></pre>
</div>
<h4 id='config-application-rb' class='inside_page_header'><a href="#config-application-rb">1.11.</a> <code>config/application.rb</code></h4><p>Этот файл требует <code>config/boot.rb</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="nb">require_relative</span> <span class="s2">"boot"</span>
</code></pre>
</div>
<p>Но только если он не был затребован ранее, что уже было сделано в случае с <code>bin/rails server</code>, но <strong>не делалось</strong> в случае с Passenger.</p><p>Дальше начинается веселье!</p><h3 id='zagruzka-rails' class='inside_page_header'><a href="#zagruzka-rails">2.</a> Загрузка Rails</h3><p>Следующей строчкой в <code>config/application.rb</code> является:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"rails/all"</span>
</code></pre>
</div>
<h4 id='railties-lib-rails-all-rb' class='inside_page_header'><a href="#railties-lib-rails-all-rb">2.1.</a> <code>railties/lib/rails/all.rb</code></h4><p>Этот файл ответственен за подключение всех отдельных фреймворков Rails:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"rails"</span>

<span class="sx">%w(
  active_record/railtie
  active_storage/engine
  action_controller/railtie
  action_view/railtie
  action_mailer/railtie
  active_job/railtie
  action_cable/engine
  action_mailbox/engine
  action_text/engine
  rails/test_unit/railtie
)</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">railtie</span><span class="o">|</span>
  <span class="k">begin</span>
    <span class="nb">require</span> <span class="n">railtie</span>
  <span class="k">rescue</span> <span class="no">LoadError</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Это то место, где загружаются все фреймворки Rails и, поэтому, становятся доступны для приложения. Мы не будем вдаваться в подробности, что именно происходит внутри каждого фреймворка, но вы можете попробовать исследовать их самостоятельно.</p><p>Сейчас просто держите в памяти, что вся обычная функциональность, такая как Rails engines, I18n и конфигурация Rails, определена тут.</p><h4 id='vozvraschaemsya-v-config-environment-rb' class='inside_page_header'><a href="#vozvraschaemsya-v-config-environment-rb">2.2.</a> Возвращаемся в <code>config/environment.rb</code></h4><p>Оставшаяся часть <code>config/application.rb</code> определяет конфигурацию для <code>Rails::Application</code>, которая будет единожды использована после того, как приложение полностью инициализируется. Когда <code>config/application.rb</code> закончит загружать Rails и определит пространство имен приложения, вы вернетесь в <code>config/environment.rb</code>. Здесь инициализируется приложение с помощью <code>Rails.application.initialize!</code>, который определен в <code>rails/application.rb</code></p><h4 id='railties-lib-rails-application-rb' class='inside_page_header'><a href="#railties-lib-rails-application-rb">2.3.</a> <code>railties/lib/rails/application.rb</code></h4><p>Метод <code>initialize!</code> выглядит так:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">initialize!</span><span class="p">(</span><span class="n">group</span> <span class="o">=</span> <span class="ss">:default</span><span class="p">)</span> <span class="c1"># :nodoc:</span>
  <span class="k">raise</span> <span class="s2">"Application has been already initialized."</span> <span class="k">if</span> <span class="vi">@initialized</span>
  <span class="n">run_initializers</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span>
  <span class="vi">@initialized</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="nb">self</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Инициализировать приложение можно лишь единожды. <a href="/configuring#initializers">Инициализаторы Railtie</a> запускаются с помощью метода <code>run_initializers</code>, который определен в <code>railties/lib/rails/initializable.rb</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">run_initializers</span><span class="p">(</span><span class="n">group</span> <span class="o">=</span> <span class="ss">:default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="k">return</span> <span class="k">if</span> <span class="n">instance_variable_defined?</span><span class="p">(</span><span class="ss">:@ran</span><span class="p">)</span>
  <span class="n">initializers</span><span class="p">.</span><span class="nf">tsort_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">initializer</span><span class="o">|</span>
    <span class="n">initializer</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">initializer</span><span class="p">.</span><span class="nf">belongs_to?</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="vi">@ran</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Код <code>run_initializers</code> сам по себе является сложным. Тут Rails проходит всех предков класса, ищет тех, кто отвечает на метод <code>initializers</code>. Затем он сортирует предков по имени и запускает. Например, класс <code>Engine</code> делает доступными все engine, предоставляя в нем метод <code>initializers</code>.</p><p>Класс <code>Rails::Application</code>, как определено в <code>railties/lib/rails/application.rb</code>, определяет инициализаторы <code>bootstrap</code>, <code>railtie</code> и <code>finisher</code>. Инициализаторы <code>bootstrap</code> подготавливает приложение (такие как инициализатор логгера), в то время как инициализаторы <code>finisher</code> (такие как создание стека промежуточных программ) запускаются последними. Инициализаторы <code>railtie</code> – это инициализаторы, которые определены самим <code>Rails::Application</code> и запускаются между <code>bootstrap</code> и <code>finisher</code>.</p><p><em>Note:</em> Не путайте общие инициализаторы Railtie с экземпляром инициализатора <a href="/configuring#initialization">load_config_initializers</a> или связанные с ним инициализаторами конфигурации в <code>config/initializers</code>.</p><p>После того, как это закончится, мы вернемся в <code>Rack::Server</code>.</p><h4 id='rack-lib-rack-server-rb2' class='inside_page_header'><a href="#rack-lib-rack-server-rb2">2.4.</a> Rack: lib/rack/server.rb</h4><p>В прошлый раз мы ушли отсюда, когда был вызван метод <code>app</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">class</span> <span class="nc">Server</span>
    <span class="k">def</span> <span class="nf">app</span>
      <span class="vi">@app</span> <span class="o">||=</span> <span class="n">options</span><span class="p">[</span><span class="ss">:builder</span><span class="p">]</span> <span class="p">?</span> <span class="n">build_app_from_string</span> <span class="p">:</span> <span class="n">build_app_and_options_from_config</span>
    <span class="k">end</span>

    <span class="c1"># ...</span>

    <span class="kp">private</span>
      <span class="k">def</span> <span class="nf">build_app_and_options_from_config</span>
        <span class="k">if</span> <span class="o">!::</span><span class="no">File</span><span class="p">.</span><span class="nf">exist?</span> <span class="n">options</span><span class="p">[</span><span class="ss">:config</span><span class="p">]</span>
          <span class="nb">abort</span> <span class="s2">"configuration </span><span class="si">#{</span><span class="n">options</span><span class="p">[</span><span class="ss">:config</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found"</span>
        <span class="k">end</span>

        <span class="n">app</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Builder</span><span class="p">.</span><span class="nf">parse_file</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">options</span><span class="p">[</span><span class="ss">:config</span><span class="p">],</span> <span class="n">opt_parser</span><span class="p">)</span>
        <span class="vi">@options</span><span class="p">.</span><span class="nf">merge!</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="o">|</span> <span class="n">old</span> <span class="p">}</span>
        <span class="n">app</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">build_app_from_string</span>
        <span class="no">Rack</span><span class="o">::</span><span class="no">Builder</span><span class="p">.</span><span class="nf">new_from_string</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">options</span><span class="p">[</span><span class="ss">:builder</span><span class="p">])</span>
      <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>В этом месте <code>app</code> - это само приложение Rails (промежуточная программа, middleware), и дальше происходит то, что Rack вызывает все представленные промежуточные программы:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">class</span> <span class="nc">Server</span>
    <span class="kp">private</span>
      <span class="k">def</span> <span class="nf">build_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="n">middleware</span><span class="p">[</span><span class="n">options</span><span class="p">[</span><span class="ss">:environment</span><span class="p">]].</span><span class="nf">reverse_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">middleware</span><span class="o">|</span>
          <span class="n">middleware</span> <span class="o">=</span> <span class="n">middleware</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="k">if</span> <span class="n">middleware</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="ss">:call</span><span class="p">)</span>
          <span class="k">next</span> <span class="k">unless</span> <span class="n">middleware</span>
          <span class="n">klass</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">middleware</span>
          <span class="n">app</span> <span class="o">=</span> <span class="n">klass</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="n">app</span>
      <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Помните, что <code>build_app</code> был вызван (из <code>wrapped_app</code>) в последней строчке <code>Rack::Server#start</code>? Вот как она выглядела:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="n">server</span><span class="p">.</span><span class="nf">run</span> <span class="n">wrapped_app</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span>
</code></pre>
</div>
<p>С этого момента реализация <code>server.run</code> будет зависеть от используемого вами сервера. Например, при использовании Puma вот как выглядит метод <code>run</code>:</p><div class="code_container">
  <pre><code class="highlight ruby"><span class="o">...</span>
<span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">module</span> <span class="nn">Handler</span>
    <span class="k">module</span> <span class="nn">Puma</span>
      <span class="c1"># ...</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
        <span class="n">conf</span>   <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="n">events</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="ss">:Silent</span><span class="p">)</span> <span class="p">?</span> <span class="o">::</span><span class="no">Puma</span><span class="o">::</span><span class="no">Events</span><span class="p">.</span><span class="nf">strings</span> <span class="p">:</span> <span class="o">::</span><span class="no">Puma</span><span class="o">::</span><span class="no">Events</span><span class="p">.</span><span class="nf">stdio</span>

        <span class="n">launcher</span> <span class="o">=</span> <span class="o">::</span><span class="no">Puma</span><span class="o">::</span><span class="no">Launcher</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="ss">:events</span> <span class="o">=&gt;</span> <span class="n">events</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">launcher</span> <span class="k">if</span> <span class="nb">block_given?</span>
        <span class="k">begin</span>
          <span class="n">launcher</span><span class="p">.</span><span class="nf">run</span>
        <span class="k">rescue</span> <span class="no">Interrupt</span>
          <span class="nb">puts</span> <span class="s2">"* Gracefully stopping, waiting for requests to finish"</span>
          <span class="n">launcher</span><span class="p">.</span><span class="nf">stop</span>
          <span class="nb">puts</span> <span class="s2">"* Goodbye!"</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Мы не будем погружаться в саму конфигурацию сервера, но это последняя часть нашего путешествия в процесс инициализации Rails.</p><p>Надеемся, что этот поверхностный обзор помог вам понять, когда и как будет выполнен ваш код, и в целом стать более хорошим разработчиком на Rails. Если вы хотите узнать больше, лучшим источником для дальнейшего изучения будет являться сам исходный код Rails.</p>

            <div class="banner">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

   <!-- bottom rusrails -->
   <ins class="adsbygoogle"
        style="display:inline-block;width:580px;height:400px"
        data-ad-client="ca-pub-7764391801669990"
        data-ad-slot="7566253867"></ins>


<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

            </div>
          </div>
        </div>
        <div class="row-fluid">
          <div class="span12" id="footer">
            <p>
              <a target="blank" href="https://github.com/rusrails/rusrails"><img src="/assets/github-7cc23602a5ac2465f14c19492358a5a67dc24636761cc723e4d621cea0c09225.png" /></a>
              <a target="blank" href="http://twitter.com/rusrails"><img src="/assets/twitter-50e0e767c8793dec313a7dc5cfbcfe2067e3e89ea6ec64784eb7c6640f578758.png" /></a>
            </p>
            <p>
              <a href="https://creativecommons.org/licenses/by-sa/4.0/">Лицензия CC BY-SA 4.0</a>
              "Rails", "Ruby on Rails" и логотип Rails - торговые марки DHH
              <!-- Yandex.Metrika counter -->
<script>
  (function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter1006929 = new Ya.Metrika({id:1006929,
                    webvisor:true,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true});
        } catch(e) { }
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>

<noscript>
  <div>
    <img style="position:absolute; left:-9999px;" alt="" src="//mc.yandex.ru/watch/1006929" />
  </div>
</noscript>
<!-- /Yandex.Metrika counter -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64955373-1', 'auto');
  ga('send', 'pageview');

  var trackOutboundLink = function(url) {
    ga('send', 'event', 'outbound', 'click', url, {
      'transport': 'beacon',
      'hitCallback': function(){ }
    });
  }
</script>

            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="to_top" style="display: block">
      <div class="to_top_panel"></div>
    </div>
    <script src="/assets/application-8ee447905888b153d8458707061a14b1f15f69b6733e871a3ad91d80ae89e87b.js"></script>
  </body>
</html>
